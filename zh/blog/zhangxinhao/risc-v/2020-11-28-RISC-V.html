<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>RISC-V特权级架构与系统启动</title>
    <meta name="generator" content="VuePress 1.5.4">
    <link rel="icon" href="/favicon.ico">
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
  <script src="/js/analytics.js"></script>
  <meta name="keywords" content="openEuler, 操作系统, 开放, 生态, 开源, Linux 开源, OS, open, ecosystem, open source, Linux open source">
  <meta name="baidu-site-verification" content="code-EWzbQRssNU">
    <meta name="description" content="openEuler 是一个开源、免费的 Linux 发行版平台，将通过开放的社区形式与全球的开发者共同构建一个开放、多元和架构包容的软件生态体系。同时，openEuler 也是一个创新的平台，鼓励任何人在该平台上提出新想法、开拓新思路、实践新方案。">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    <meta name="keywords" content="openEuler, 操作系统, 开放, 生态, 开源, Linux 开源, OS, open, ecosystem, open source, Linux open source">
    <meta name="baidu-site-verification" content="code-EWzbQRssNU">
    <link rel="preload" href="/assets/css/0.styles.0df284ed.css" as="style"><link rel="preload" href="/assets/js/app.cdfb7ee7.js" as="script"><link rel="preload" href="/assets/js/14.8a38dea1.js" as="script"><link rel="preload" href="/assets/js/57.2ef9eaed.js" as="script">
    <link rel="stylesheet" href="/assets/css/0.styles.0df284ed.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div id="euler-app" data-v-34596062><div class="nav-fill " data-v-fe04bb58 data-v-34596062><div class="nav-wrapper" data-v-fe04bb58><div class="nav-bar" data-v-fe04bb58><img src="/openeuler-logo.png" alt class="nav-logo" data-v-fe04bb58> <img src="/openeuler-logo.png" alt class="nav-logo nav-logo-mobile" data-v-fe04bb58> <ul class="nav-menu" data-v-fe04bb58><li data-v-fe04bb58><a class="menu-link" data-v-fe04bb58>下载
                        <span data-v-fe04bb58></span></a> <div class="sub-menu" data-v-fe04bb58><ul class="sig-menu-content" data-v-fe04bb58><li data-v-fe04bb58>
                                ISO
                            </li><li data-v-fe04bb58>
                                镜像仓列表
                            </li></ul> <span class="submenu-arrow" data-v-fe04bb58></span></div></li><li data-v-fe04bb58><a class="menu-link" data-v-fe04bb58>学习
                        <span data-v-fe04bb58></span></a> <div class="sub-menu" data-v-fe04bb58><ul class="sig-menu-content" data-v-fe04bb58><li data-v-fe04bb58>
                                文档
                            </li><li data-v-fe04bb58>
                                慕课
                            </li><li data-v-fe04bb58>
                                实习
                            </li></ul> <span class="submenu-arrow" data-v-fe04bb58></span></div></li><li data-v-fe04bb58><a class="menu-link menu-active" data-v-fe04bb58>互动
                        <span data-v-fe04bb58></span></a> <div class="sub-menu" data-v-fe04bb58><ul class="sig-menu-content" data-v-fe04bb58><li data-v-fe04bb58>
                                新闻
                            </li><li data-v-fe04bb58>
                                博客
                            </li><li data-v-fe04bb58>
                                直播
                            </li><li data-v-fe04bb58>
                                沙龙
                            </li><li data-v-fe04bb58>
                                峰会
                            </li></ul> <span class="submenu-arrow" data-v-fe04bb58></span></div></li><li data-v-fe04bb58><a class="menu-link" data-v-fe04bb58>社区
                        <span data-v-fe04bb58></span></a> <div class="sub-menu" data-v-fe04bb58><ul class="sig-menu-content" data-v-fe04bb58><li data-v-fe04bb58>
                                贡献攻略
                            </li><li data-v-fe04bb58>
                                行为守则
                            </li><li data-v-fe04bb58>
                                邮件列表
                            </li><li data-v-fe04bb58>
                                个人认证
                            </li></ul> <span class="submenu-arrow" data-v-fe04bb58></span></div></li><li data-v-fe04bb58><a class="menu-link" data-v-fe04bb58>SIG
                        <span data-v-fe04bb58></span></a> <div class="sub-menu" data-v-fe04bb58><ul class="sig-menu-content" data-v-fe04bb58><li data-v-fe04bb58>
                                查看SIG
                            </li><li data-v-fe04bb58>
                                申请流程
                            </li><li data-v-fe04bb58>
                                角色说明
                            </li></ul> <span class="submenu-arrow" data-v-fe04bb58></span></div></li><li data-v-fe04bb58><a class="menu-link" data-v-fe04bb58>探索
                        <span data-v-fe04bb58></span></a> <div class="sub-menu" data-v-fe04bb58><ul class="sig-menu-content" data-v-fe04bb58><li data-v-fe04bb58>
                                A-Tune
                            </li><li data-v-fe04bb58>
                                Bisheng JDK
                            </li><li data-v-fe04bb58>
                                iSula
                            </li><li data-v-fe04bb58>
                                secGear
                            </li><li data-v-fe04bb58>
                                StratoVirt
                            </li><li data-v-fe04bb58>
                                Compass-CI
                            </li><li data-v-fe04bb58>
                                Compliance
                            </li><li data-v-fe04bb58>
                                Pkgship
                            </li></ul> <span class="submenu-arrow" data-v-fe04bb58></span></div></li><li data-v-fe04bb58><a class="menu-link" data-v-fe04bb58>支持
                        <span data-v-fe04bb58></span></a> <div class="sub-menu" data-v-fe04bb58><ul class="sig-menu-content" data-v-fe04bb58><li data-v-fe04bb58>
                                漏洞管理
                            </li><li data-v-fe04bb58>
                                安全公告
                            </li><li data-v-fe04bb58>
                                CVE
                            </li><li data-v-fe04bb58>
                                兼容性列表
                            </li><li data-v-fe04bb58>
                                迁移指南
                            </li></ul> <span class="submenu-arrow" data-v-fe04bb58></span></div></li></ul> <ul class="nav-menu-mobile" style="display:none;" data-v-fe04bb58 data-v-fe04bb58><li data-v-fe04bb58><a class="menu-link" data-v-fe04bb58>下载<i class="icon-arrow" data-v-fe04bb58></i></a> <ul class="sub-menu" style="display:none;" data-v-fe04bb58 data-v-fe04bb58><li data-v-fe04bb58>
                                    ISO
                                </li><li data-v-fe04bb58>
                                    镜像仓列表
                                </li></ul></li><li data-v-fe04bb58><a class="menu-link" data-v-fe04bb58>学习<i class="icon-arrow" data-v-fe04bb58></i></a> <ul class="sub-menu" style="display:none;" data-v-fe04bb58 data-v-fe04bb58><li data-v-fe04bb58>
                                    文档
                                </li><li data-v-fe04bb58>
                                    慕课
                                </li><li data-v-fe04bb58>
                                    实习
                                </li></ul></li><li data-v-fe04bb58><a class="menu-link" data-v-fe04bb58>互动<i class="icon-arrow arrow-active" data-v-fe04bb58></i></a> <ul class="sub-menu" data-v-fe04bb58 data-v-fe04bb58><li data-v-fe04bb58>
                                    新闻
                                </li><li data-v-fe04bb58>
                                    博客
                                </li><li data-v-fe04bb58>
                                    直播
                                </li><li data-v-fe04bb58>
                                    沙龙
                                </li><li data-v-fe04bb58>
                                    峰会
                                </li></ul></li><li data-v-fe04bb58><a class="menu-link" data-v-fe04bb58>社区<i class="icon-arrow" data-v-fe04bb58></i></a> <ul class="sub-menu" style="display:none;" data-v-fe04bb58 data-v-fe04bb58><li data-v-fe04bb58>
                                    贡献攻略
                                </li><li data-v-fe04bb58>
                                    行为守则
                                </li><li data-v-fe04bb58>
                                    邮件列表
                                </li><li data-v-fe04bb58>
                                    个人认证
                                </li></ul></li><li data-v-fe04bb58><a class="menu-link" data-v-fe04bb58>SIG<i class="icon-arrow" data-v-fe04bb58></i></a> <ul class="sub-menu" style="display:none;" data-v-fe04bb58 data-v-fe04bb58><li data-v-fe04bb58>
                                    查看SIG
                                </li><li data-v-fe04bb58>
                                    申请流程
                                </li><li data-v-fe04bb58>
                                    角色说明
                                </li></ul></li><li data-v-fe04bb58><a class="menu-link" data-v-fe04bb58>探索<i class="icon-arrow" data-v-fe04bb58></i></a> <ul class="sub-menu" style="display:none;" data-v-fe04bb58 data-v-fe04bb58><li data-v-fe04bb58>
                                    A-Tune
                                </li><li data-v-fe04bb58>
                                    Bisheng JDK
                                </li><li data-v-fe04bb58>
                                    iSula
                                </li><li data-v-fe04bb58>
                                    secGear
                                </li><li data-v-fe04bb58>
                                    StratoVirt
                                </li><li data-v-fe04bb58>
                                    Compass-CI
                                </li><li data-v-fe04bb58>
                                    Compliance
                                </li><li data-v-fe04bb58>
                                    Pkgship
                                </li></ul></li><li data-v-fe04bb58><a class="menu-link" data-v-fe04bb58>支持<i class="icon-arrow" data-v-fe04bb58></i></a> <ul class="sub-menu" style="display:none;" data-v-fe04bb58 data-v-fe04bb58><li data-v-fe04bb58>
                                    漏洞管理
                                </li><li data-v-fe04bb58>
                                    安全公告
                                </li><li data-v-fe04bb58>
                                    CVE
                                </li><li data-v-fe04bb58>
                                    兼容性列表
                                </li><li data-v-fe04bb58>
                                    迁移指南
                                </li></ul></li> <li data-v-fe04bb58><a class="menu-link" data-v-fe04bb58>源码<i class="icon-arrow" data-v-fe04bb58></i></a> <ul class="sub-menu" style="display:none;" data-v-fe04bb58 data-v-fe04bb58><li data-v-fe04bb58>
                                    代码仓
                                </li><li data-v-fe04bb58>
                                    软件包仓
                                </li><li data-v-fe04bb58>
                                    GitHub镜像仓
                                </li></ul></li></ul> <div data-v-fe04bb58></div> <div class="search-mobile" data-v-fe04bb58><div class="el-input el-input--suffix" data-v-fe04bb58><!----><input type="text" autocomplete="off" placeholder="输入内容" class="el-input__inner"><!----><span class="el-input__suffix"><span class="el-input__suffix-inner"><i class="icon-search el-input__icon" data-v-fe04bb58></i><!----><!----><!----><!----></span><!----></span><!----><!----></div></div> <ul class="nav-other" style="display:;" data-v-fe04bb58><li class="lang" data-v-fe04bb58><span class="icon-lang" data-v-fe04bb58></span> <ul data-v-fe04bb58><li class="lang-list" data-v-fe04bb58>
                            中文
                        </li><li data-v-fe04bb58>
                            English
                        </li><li data-v-fe04bb58>
                            Русский
                        </li> <span class="submenu-arrow" data-v-fe04bb58></span></ul></li> <li data-v-fe04bb58><span data-v-fe04bb58>代码</span> <ul data-v-fe04bb58><li data-v-fe04bb58>
                            代码仓
                        </li><li data-v-fe04bb58>
                            软件包仓
                        </li><li data-v-fe04bb58>
                            GitHub镜像仓
                        </li> <span class="submenu-arrow" data-v-fe04bb58></span></ul></li> <li class="search" data-v-fe04bb58><img src="/search.png" alt data-v-fe04bb58></li></ul> <div class="search-input" style="display:none;" data-v-fe04bb58><div class="el-input el-input--small el-input--suffix" data-v-fe04bb58><!----><input type="text" autocomplete="off" placeholder="输入内容" class="el-input__inner"><!----><span class="el-input__suffix"><span class="el-input__suffix-inner"><i class="icon-search el-input__icon" data-v-fe04bb58></i><!----><!----><!----><!----></span><!----></span><!----><!----></div></div> <ul class="nav-other-mobile nav-other" data-v-fe04bb58><li class="lang" data-v-fe04bb58><span class="icon-lang" data-v-fe04bb58></span> <ul data-v-fe04bb58><li class="lang-list" data-v-fe04bb58>
                            中文
                        </li><li data-v-fe04bb58>
                            English
                        </li><li data-v-fe04bb58>
                            Русский
                        </li> <span class="submenu-arrow" data-v-fe04bb58></span></ul></li> <li class="search" data-v-fe04bb58><span class="icon-search" data-v-fe04bb58></span></li> <li class="menu" data-v-fe04bb58><span class="icon-menu" data-v-fe04bb58></span></li></ul></div></div> <!----></div> <!----> <div id="vuepress-theme-blog__post-layout" class="content" data-v-8dab3852 data-v-34596062><div class="blog-link-post" data-v-8dab3852>
        博客\
    </div> <div class="post-left" data-v-8dab3852><p class="blog-img mobile-hide" data-v-8dab3852><img src="/img/blog/blog_user.png" alt class="middle-img" data-v-8dab3852></p> <p class="mobile-hide" data-v-8dab3852><img src="/img/blog/account.svg" alt class="mobile-middle-img" data-v-8dab3852> <span class="blog-author" data-v-8dab3852>Xinhao Zhang</span></p> <p class="mobile-hide" data-v-8dab3852><img src="/img/blog/date.svg" alt class="mobile-middle-img" data-v-8dab3852> <span class="blog-date mobile" data-v-8dab3852>2020-11-28</span></p> <p class="mobile-hide" data-v-8dab3852><img src="/img/blog/visibility.svg" alt class="mobile-middle-img" data-v-8dab3852> <span class="blog-date" data-v-8dab3852><span data-v-8dab3852><span data-v-8dab3852>浏览</span> <span data-v-8dab3852></span> <span data-v-8dab3852>次</span></span></span></p> <p class="bottom-line bottom-line-none" data-v-8dab3852></p> <!----> <p class="other-blog-item" data-v-8dab3852></p></div> <div class="post-right" data-v-8dab3852><p class="blog-title" data-v-8dab3852>RISC-V特权级架构与系统启动</p> <div class="user-info-mobile" data-v-8dab3852><div class="left" data-v-8dab3852><img src="/img/blog/blog_user.png" alt data-v-8dab3852></div> <div class="right" data-v-8dab3852><p class="name" data-v-8dab3852>Xinhao Zhang</p> <p class="date-count" data-v-8dab3852><span class="date" data-v-8dab3852>2020-11-28</span> <span class="count" data-v-8dab3852>浏览次</span></p></div></div> <p class="blog-item-tag" data-v-8dab3852><span data-v-8dab3852>标签: </span> <span data-v-8dab3852><span class="tag-item" data-v-8dab3852>RISC-V</span> <span data-v-8dab3852>, </span></span><span data-v-8dab3852><span class="tag-item" data-v-8dab3852>opensbi</span> <span data-v-8dab3852>, </span></span><span data-v-8dab3852><span class="tag-item" data-v-8dab3852>kernel</span> <!----></span></p> <p class="bottom-line bottom-line-none" data-v-8dab3852></p> <div id="blog_content" class="markdown content__default" data-v-8dab3852><h3 id="risc-v"><a href="#risc-v" class="header-anchor">#</a> RISC-V</h3> <p>RISC-V架构主要由美国加州大学伯克利分校发明，相比于x86和ARM架构，RISC-V开源采用BSD协议，它允许用户自由地使用、修改源代码，也可以将修改后的代码作为开源或者专有软件再发布。计算机体系结构的传统方法是增量ISA，新处理器不仅必须实现新的ISA扩展，还必须 实现过去的所有扩展。目的是为了保持向后的二进制兼容性，这样几十年前程序的二进制 版本仍然可以在最新的处理器上正确运行。导致了传统ISA的体量随时间大幅增长。而RISC-V是模块化的。它的核心是一个名为RV32I的基础ISA，支持运行一个完整的软件栈。RV32I是固定的，永远不会改变。这为编译器编写者，操作系统开发人员和汇编语言程序员提供了稳定的目标。模块化来源于可选的标准扩展，根据应用程序的需要，硬件可以包含或不包含这些扩展。</p> <h3 id="_1-risc-v-特权级架构"><a href="#_1-risc-v-特权级架构" class="header-anchor">#</a> 1. RISC-V 特权级架构</h3> <p>RISC-V定义了三种特权模式，分别为Machine Mode（M Mode），Supervisor Mode（S Mode），User Mode（U Mode）。</p> <p><img src="/assets/img/img1.ef2276c6.png" alt=""></p> <p>在特权级架构实现中，M Mode为必选模式，另外两种为可选模式。通过不同的模式组合可以实现不同用途的系统。</p> <p><img src="/assets/img/img2.4012df4b.png" alt=""></p> <ul><li>M Mode：通常为简单的嵌入式系统</li> <li>M Mode + U Mode：该系统可以实现用户和机器模式的区分，从而实现资源的保护</li> <li>M Mode + U Mode + U Mode：该系统可以实现类Unix操作系统</li></ul> <h3 id="_2-risc-v-通用寄存器"><a href="#_2-risc-v-通用寄存器" class="header-anchor">#</a> 2. RISC-V 通用寄存器</h3> <p>基本整数指令集是RISC-V最基本也是唯一强制要求实现的指令集模块，能够实现完整的软件编译器，支持现代操作系统运行。RV32I是其中一种整数指令集，支持32个通用整数寄存器，每一个寄存器有32位，由x0~x31表示，其中x0寄存器被预留为常数0.在汇编语言中，通用寄存器组中的每一个寄存器都有别名。</p> <table><thead><tr><th style="text-align:left;">Register</th> <th style="text-align:left;">ABI Name</th> <th style="text-align:left;">Description</th></tr></thead> <tbody><tr><td style="text-align:left;">x0</td> <td style="text-align:left;">zero</td> <td style="text-align:left;">Hard-wired zero</td></tr> <tr><td style="text-align:left;">x1</td> <td style="text-align:left;">ra</td> <td style="text-align:left;">Return address</td></tr> <tr><td style="text-align:left;">x2</td> <td style="text-align:left;">sp</td> <td style="text-align:left;">Stack pointer</td></tr> <tr><td style="text-align:left;">x3</td> <td style="text-align:left;">gp</td> <td style="text-align:left;">Global pointer</td></tr> <tr><td style="text-align:left;">x4</td> <td style="text-align:left;">tp</td> <td style="text-align:left;">Thread pointer</td></tr> <tr><td style="text-align:left;">x5-7</td> <td style="text-align:left;">t0-2</td> <td style="text-align:left;">Temporaries</td></tr> <tr><td style="text-align:left;">x8</td> <td style="text-align:left;">s0/fp</td> <td style="text-align:left;">Saved register/frame pointer</td></tr> <tr><td style="text-align:left;">x9</td> <td style="text-align:left;">s1</td> <td style="text-align:left;">Saved register</td></tr> <tr><td style="text-align:left;">x10-11</td> <td style="text-align:left;">a0-1</td> <td style="text-align:left;">Function arguments/retrurn values</td></tr> <tr><td style="text-align:left;">x12-17</td> <td style="text-align:left;">a2-7</td> <td style="text-align:left;">Function arguments</td></tr> <tr><td style="text-align:left;">x18-27</td> <td style="text-align:left;">s2-11</td> <td style="text-align:left;">Saved register</td></tr> <tr><td style="text-align:left;">x28-31</td> <td style="text-align:left;">t3-6</td> <td style="text-align:left;">Temporaries</td></tr></tbody></table> <h3 id="_3-risc-v-特权级寄存器"><a href="#_3-risc-v-特权级寄存器" class="header-anchor">#</a> 3. RISC-V 特权级寄存器</h3> <p>除了通用寄存器，RISC-V针对各个特权级，还定义了一系列特权级控制状态寄存器。本节以M模式为例介绍相关控制状态寄存器。</p> <ul><li>misa：表示hart支持的架构扩展，包括整数、乘除、原子、浮点数、双精度浮点数和压缩指令扩展等</li> <li>mhartid：当前正在执行代码的hart id</li> <li>medeleg：默认情况下，所有的异常都是在M模式下处理。当相应的medeleg位置1时，该异常直接由S模式或U模式处理。</li> <li>mideleg：默认情况下，所有的中断都是在M模式下处理。当相应的mideleg位置1时，该中断直接由S模式或U模式处理。</li> <li>mtime：存储当前的时钟计数值</li> <li>mtimecmp：时钟计数比较器。当当前mtime寄存器中的值大于mtimecmp中的值时，触发时钟中断</li> <li>mstatus：表示当前处理器的控制状态，包括全局中断使能位。内存特权级，字节序控制位等</li> <li>mtvec：保存发生trap时处理器需要跳转到的地址</li> <li>mip：指示正准备处理的中断类型。EIP表示外部中断，TIP表示时钟中断，SIP表示软件中断。当相应的中断位置1时，表示存在该类型中断待处理
<img src="/assets/img/mip.b98067f8.png" alt=""></li> <li>mie：指示处理器目前使能和忽略的中断类型。EIP表示外部中断，TIP表示时钟中断，SIP表示软件中断。当相应的中断位置1时，表示该类型中断可以被处理器响应
<img src="/assets/img/mie.9c1b8cef.png" alt=""></li> <li>mscratch：保存指向当前hart上下文的指针</li> <li>mepc：保存引发异常的指令</li> <li>mtval：它保存了trap的附加信息:地址例外中出错的地址、发生非法指令例外的指令本身，对于其他trap，它的值为 0</li> <li>mcause：指示发生trap的种类。当最高位为1时，低位字段表示发生中断的类型；当最高位为0时，低位字段表示发生异常或系统调用的类型。</li></ul> <table><thead><tr><th style="text-align:left;">Interrupt</th> <th style="text-align:left;">Exception Code</th> <th style="text-align:left;">Description</th></tr></thead> <tbody><tr><td style="text-align:left;">1</td> <td style="text-align:left;">0</td> <td style="text-align:left;">Reserved</td></tr> <tr><td style="text-align:left;">1</td> <td style="text-align:left;">1</td> <td style="text-align:left;">Supervisor software interrupt</td></tr> <tr><td style="text-align:left;">1</td> <td style="text-align:left;">2</td> <td style="text-align:left;">Reserved</td></tr> <tr><td style="text-align:left;">1</td> <td style="text-align:left;">3</td> <td style="text-align:left;">Machine software interrupt</td></tr> <tr><td style="text-align:left;">1</td> <td style="text-align:left;">4</td> <td style="text-align:left;">Reserved</td></tr> <tr><td style="text-align:left;">1</td> <td style="text-align:left;">5</td> <td style="text-align:left;">Supervisor timer interrupt</td></tr> <tr><td style="text-align:left;">1</td> <td style="text-align:left;">6</td> <td style="text-align:left;">Reserved</td></tr> <tr><td style="text-align:left;">1</td> <td style="text-align:left;">7</td> <td style="text-align:left;">Machine timer interrupt</td></tr> <tr><td style="text-align:left;">1</td> <td style="text-align:left;">8</td> <td style="text-align:left;">Reserved</td></tr> <tr><td style="text-align:left;">1</td> <td style="text-align:left;">9</td> <td style="text-align:left;">Supervisor external interrupt</td></tr> <tr><td style="text-align:left;">1</td> <td style="text-align:left;">10</td> <td style="text-align:left;">Reserved</td></tr> <tr><td style="text-align:left;">1</td> <td style="text-align:left;">11</td> <td style="text-align:left;">Machine external interrupt</td></tr> <tr><td style="text-align:left;">1</td> <td style="text-align:left;">12-15</td> <td style="text-align:left;">Reserved</td></tr> <tr><td style="text-align:left;">1</td> <td style="text-align:left;">&gt;=16</td> <td style="text-align:left;">Available for platform use</td></tr> <tr><td style="text-align:left;">0</td> <td style="text-align:left;">0</td> <td style="text-align:left;">Instruction address misaligned</td></tr> <tr><td style="text-align:left;">0</td> <td style="text-align:left;">1</td> <td style="text-align:left;">Instruction access fault</td></tr> <tr><td style="text-align:left;">0</td> <td style="text-align:left;">2</td> <td style="text-align:left;">Illegal instruction</td></tr> <tr><td style="text-align:left;">0</td> <td style="text-align:left;">3</td> <td style="text-align:left;">Breakpoint</td></tr> <tr><td style="text-align:left;">0</td> <td style="text-align:left;">4</td> <td style="text-align:left;">Load address misaligned</td></tr> <tr><td style="text-align:left;">0</td> <td style="text-align:left;">5</td> <td style="text-align:left;">Load access fault</td></tr> <tr><td style="text-align:left;">0</td> <td style="text-align:left;">6</td> <td style="text-align:left;">Store/AMO address misaligned</td></tr> <tr><td style="text-align:left;">0</td> <td style="text-align:left;">7</td> <td style="text-align:left;">Store/AMO access fault</td></tr> <tr><td style="text-align:left;">0</td> <td style="text-align:left;">8</td> <td style="text-align:left;">Environment call from U-mode</td></tr> <tr><td style="text-align:left;">0</td> <td style="text-align:left;">9</td> <td style="text-align:left;">Environment call from S-mode</td></tr> <tr><td style="text-align:left;">0</td> <td style="text-align:left;">10</td> <td style="text-align:left;">Reserved</td></tr> <tr><td style="text-align:left;">0</td> <td style="text-align:left;">11</td> <td style="text-align:left;">Environment call from M-mode</td></tr> <tr><td style="text-align:left;">0</td> <td style="text-align:left;">12</td> <td style="text-align:left;">Instruction page fault</td></tr> <tr><td style="text-align:left;">0</td> <td style="text-align:left;">13</td> <td style="text-align:left;">Load page fault</td></tr> <tr><td style="text-align:left;">0</td> <td style="text-align:left;">14</td> <td style="text-align:left;">Reserved</td></tr> <tr><td style="text-align:left;">0</td> <td style="text-align:left;">15</td> <td style="text-align:left;">Store/AMO page fault</td></tr> <tr><td style="text-align:left;">0</td> <td style="text-align:left;">16-23</td> <td style="text-align:left;">Reserved</td></tr> <tr><td style="text-align:left;">0</td> <td style="text-align:left;">24-31</td> <td style="text-align:left;">Available for custom use</td></tr> <tr><td style="text-align:left;">0</td> <td style="text-align:left;">32-47</td> <td style="text-align:left;">Reserved</td></tr> <tr><td style="text-align:left;">0</td> <td style="text-align:left;">48-63</td> <td style="text-align:left;">Available for custom use</td></tr> <tr><td style="text-align:left;">0</td> <td style="text-align:left;">&gt;=64</td> <td style="text-align:left;">Reserved</td></tr></tbody></table> <h3 id="_4-risc-v-cpu初始化"><a href="#_4-risc-v-cpu初始化" class="header-anchor">#</a> 4. RISC-V CPU初始化</h3> <p>opensbi是M模式的一种实现。本节以opensbi为例介绍M模式下的CPU初始化。在硬件超线程处理器中，一个处理器核存在多个硬件线程，单以处理器核描述一个硬件线程不太精准。RISC-V提出了hart的概念（Hardware Thread），表示一个硬件线程。opensbi可以作为一种固件为其他特权级模式的软件提供运行时服务。在机器上电后，作为加载的第一个启动阶段代码，opensbi固件需要对cpu进行初始化。</p> <p>每一个hart都有自己的上下文状态，上下文状态的指针保存在mscratch寄存器中。opensbi首先根据平台定义的hart的数量和hart栈的大小分配栈空间，然后依次为每一个hart初始化sbi scratch结构体，包括固件在内存中的地址，下一个启动阶段要执行的代码入口地址，参数以及特权级等信息，并将sbi scratch的地址赋值给mscratch寄存器。</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token comment">/* sbi_scratch结构体定义 */</span>
<span class="token keyword">struct</span> <span class="token class-name">sbi_scratch</span> <span class="token punctuation">{</span>
    <span class="token comment">/** opensbi固件地址 */</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> fw_start<span class="token punctuation">;</span>
    <span class="token comment">/** opensbi固件大小 */</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> fw_size<span class="token punctuation">;</span>
    <span class="token comment">/** 下一个启动阶段的参数 */</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> next_arg1<span class="token punctuation">;</span>
    <span class="token comment">/** 下一个启动阶段代码入口 */</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> next_addr<span class="token punctuation">;</span>
    <span class="token comment">/** 下一个启动阶段执行特权级 */</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> next_mode<span class="token punctuation">;</span>
···
···
<span class="token punctuation">}</span> __packed<span class="token punctuation">;</span>
</code></pre></div><div class="language-c extra-class"><pre class="language-c"><code>_relocate_done<span class="token operator">:</span>
···
···
    <span class="token comment">/* 根据hart的数量和hart栈的大小分配栈空间 */</span>
    la  tp<span class="token punctuation">,</span> _fw_end
    mul a5<span class="token punctuation">,</span> s7<span class="token punctuation">,</span> s8
    add tp<span class="token punctuation">,</span> tp<span class="token punctuation">,</span> a5
   
_scratch_init<span class="token operator">:</span>
    <span class="token comment">/* 对第t1个hart进行初始化，将指针指向第t1个hart的栈空间 */</span>
    add tp<span class="token punctuation">,</span> t3<span class="token punctuation">,</span> zero
    mul a5<span class="token punctuation">,</span> s8<span class="token punctuation">,</span> t1
    sub tp<span class="token punctuation">,</span> tp<span class="token punctuation">,</span> a5
    li  a5<span class="token punctuation">,</span> SBI_SCRATCH_SIZE
    sub tp<span class="token punctuation">,</span> tp<span class="token punctuation">,</span> a5

    <span class="token comment">/* 初始化第t1个hart的sbi_scratch结构体 */</span>
    <span class="token comment">/* 初始化fw_start和fw_size */</span>
    la  a4<span class="token punctuation">,</span> _fw_start
    la  a5<span class="token punctuation">,</span> _fw_end
    mul t0<span class="token punctuation">,</span> s7<span class="token punctuation">,</span> s8
    add a5<span class="token punctuation">,</span> a5<span class="token punctuation">,</span> t0
    sub a5<span class="token punctuation">,</span> a5<span class="token punctuation">,</span> a4
    REG_S   a4<span class="token punctuation">,</span> <span class="token function">SBI_SCRATCH_FW_START_OFFSET</span><span class="token punctuation">(</span>tp<span class="token punctuation">)</span>
    REG_S   a5<span class="token punctuation">,</span> <span class="token function">SBI_SCRATCH_FW_SIZE_OFFSET</span><span class="token punctuation">(</span>tp<span class="token punctuation">)</span>
    <span class="token comment">/* 将下一阶段传入的参数赋值给next_arg1，通常是fdt的地址 */</span>
    MOV_3R  s0<span class="token punctuation">,</span> a0<span class="token punctuation">,</span> s1<span class="token punctuation">,</span> a1<span class="token punctuation">,</span> s2<span class="token punctuation">,</span> a2
    call    fw_next_arg1
    REG_S   a0<span class="token punctuation">,</span> <span class="token function">SBI_SCRATCH_NEXT_ARG1_OFFSET</span><span class="token punctuation">(</span>tp<span class="token punctuation">)</span>
    MOV_3R  a0<span class="token punctuation">,</span> s0<span class="token punctuation">,</span> a1<span class="token punctuation">,</span> s1<span class="token punctuation">,</span> a2<span class="token punctuation">,</span> s2
    <span class="token comment">/* 将下一阶段代码的入口地址赋值给next_addr */</span>
    MOV_3R  s0<span class="token punctuation">,</span> a0<span class="token punctuation">,</span> s1<span class="token punctuation">,</span> a1<span class="token punctuation">,</span> s2<span class="token punctuation">,</span> a2
    call    fw_next_addr
    REG_S   a0<span class="token punctuation">,</span> <span class="token function">SBI_SCRATCH_NEXT_ADDR_OFFSET</span><span class="token punctuation">(</span>tp<span class="token punctuation">)</span>
    MOV_3R  a0<span class="token punctuation">,</span> s0<span class="token punctuation">,</span> a1<span class="token punctuation">,</span> s1<span class="token punctuation">,</span> a2<span class="token punctuation">,</span> s2
    <span class="token comment">/* 将下一阶段执行特权级模式赋值给next_mode */</span>
    MOV_3R  s0<span class="token punctuation">,</span> a0<span class="token punctuation">,</span> s1<span class="token punctuation">,</span> a1<span class="token punctuation">,</span> s2<span class="token punctuation">,</span> a2
    call    fw_next_mode
    REG_S   a0<span class="token punctuation">,</span> <span class="token function">SBI_SCRATCH_NEXT_MODE_OFFSET</span><span class="token punctuation">(</span>tp<span class="token punctuation">)</span>
    <span class="token comment">/* 初始化下一个hart */</span>
    add t1<span class="token punctuation">,</span> t1<span class="token punctuation">,</span> t2
    blt t1<span class="token punctuation">,</span> s7<span class="token punctuation">,</span> _scratch_init
···
···
</code></pre></div><p>hart上下文初始化完成后，需要初始化trap。通过清空mie寄存器和mip寄存器关闭所有中断，将trap handler的地址赋值给mtvec寄存器，作为trap服务总控函数的入口地址。当系统发生中断时，将通过tvec寄存器找到trap处理函数。</p> <div class="language-c extra-class"><pre class="language-c"><code>_start_warm<span class="token operator">:</span>
    <span class="token comment">/* 清空通用寄存器 */</span>
    li  ra<span class="token punctuation">,</span> <span class="token number">0</span>
    call    _reset_regs

    <span class="token comment">/* 关闭中断，清空mie寄存器和mip寄存器 */</span>
    csrw    CSR_MIE<span class="token punctuation">,</span> zero
    csrw    CSR_MIP<span class="token punctuation">,</span> zero
···
···
    <span class="token comment">/* 设置trap处理函数 */</span>
    la  a4<span class="token punctuation">,</span> _trap_handler
    csrw    CSR_MTVEC<span class="token punctuation">,</span> a4

    <span class="token comment">/* 进入启动阶段 */</span>
    csrr    a0<span class="token punctuation">,</span> CSR_MSCRATCH
    call    sbi_init
</code></pre></div><p>启动hart。随机选择一个hart作为主hart。其他hart通过将mie寄存器中的MSIE位置1打开软件中断开关，并陷入WFI，等待主hart发出中断唤醒。主hart执行冷启动，进行一系列初始化，初始化完成后向其他hart发出处理器间中断以唤醒其他hart，并执行下一阶段代码。如果是目标是裸机程序，则下一段代码为用户程序代码；如果想启动内核，则下一段为内核代码，并将fdt地址作为参数传给下一段代码，进入下一阶段。</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">void</span> __noreturn <span class="token function">sbi_init</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sbi_scratch</span> <span class="token operator">*</span>scratch<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    bool coldboot           <span class="token operator">=</span> FALSE<span class="token punctuation">;</span>
    u32 hartid          <span class="token operator">=</span> <span class="token function">current_hartid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
···
···
    <span class="token comment">/* 随机选择一个hart作为主hart，执行冷启动，其他hart执行热启动 */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>next_mode_supported <span class="token operator">&amp;&amp;</span> <span class="token function">atomic_xchg</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>coldboot_lottery<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
        coldboot <span class="token operator">=</span> TRUE<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>coldboot<span class="token punctuation">)</span>
        <span class="token function">init_coldboot</span><span class="token punctuation">(</span>scratch<span class="token punctuation">,</span> hartid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span>
        <span class="token function">init_warmboot</span><span class="token punctuation">(</span>scratch<span class="token punctuation">,</span> hartid<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> __noreturn <span class="token function">init_warmboot</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sbi_scratch</span> <span class="token operator">*</span>scratch<span class="token punctuation">,</span> u32 hartid<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> rc<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token operator">*</span>init_count<span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">sbi_platform</span> <span class="token operator">*</span>plat <span class="token operator">=</span> <span class="token function">sbi_platform_ptr</span><span class="token punctuation">(</span>scratch<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/* 打开进程间中断开关，陷入WFI，等待冷启动结束 */</span>
    <span class="token function">wait_for_coldboot</span><span class="token punctuation">(</span>scratch<span class="token punctuation">,</span> hartid<span class="token punctuation">)</span><span class="token punctuation">;</span>
···
···
    <span class="token comment">/* 执行下一阶段代码 */</span>
    <span class="token function">sbi_hsm_prepare_next_jump</span><span class="token punctuation">(</span>scratch<span class="token punctuation">,</span> hartid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">sbi_hart_switch_mode</span><span class="token punctuation">(</span>hartid<span class="token punctuation">,</span> scratch<span class="token operator">-&gt;</span>next_arg1<span class="token punctuation">,</span>
                 scratch<span class="token operator">-&gt;</span>next_addr<span class="token punctuation">,</span>
                 scratch<span class="token operator">-&gt;</span>next_mode<span class="token punctuation">,</span> FALSE<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> __noreturn <span class="token function">init_coldboot</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sbi_scratch</span> <span class="token operator">*</span>scratch<span class="token punctuation">,</span> u32 hartid<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> rc<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token operator">*</span>init_count<span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">sbi_platform</span> <span class="token operator">*</span>plat <span class="token operator">=</span> <span class="token function">sbi_platform_ptr</span><span class="token punctuation">(</span>scratch<span class="token punctuation">)</span><span class="token punctuation">;</span>
    ···
    ···

    <span class="token comment">/* 初始化终端串口 */</span>
    rc <span class="token operator">=</span> <span class="token function">sbi_console_init</span><span class="token punctuation">(</span>scratch<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>rc<span class="token punctuation">)</span>
        <span class="token function">sbi_hart_hang</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* 初始化中断控制器 */</span>
    rc <span class="token operator">=</span> <span class="token function">sbi_platform_irqchip_init</span><span class="token punctuation">(</span>plat<span class="token punctuation">,</span> TRUE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>rc<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">sbi_printf</span><span class="token punctuation">(</span><span class="token string">&quot;%s: platform irqchip init failed (error %d)\n&quot;</span><span class="token punctuation">,</span>
               <span class="token constant">__func__</span><span class="token punctuation">,</span> rc<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">sbi_hart_hang</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/* 处理器间中断初始化 */</span>
    rc <span class="token operator">=</span> <span class="token function">sbi_ipi_init</span><span class="token punctuation">(</span>scratch<span class="token punctuation">,</span> TRUE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>rc<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">sbi_printf</span><span class="token punctuation">(</span><span class="token string">&quot;%s: ipi init failed (error %d)\n&quot;</span><span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">,</span> rc<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">sbi_hart_hang</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/* TLB初始化 */</span>
    rc <span class="token operator">=</span> <span class="token function">sbi_tlb_init</span><span class="token punctuation">(</span>scratch<span class="token punctuation">,</span> TRUE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>rc<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">sbi_printf</span><span class="token punctuation">(</span><span class="token string">&quot;%s: tlb init failed (error %d)\n&quot;</span><span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">,</span> rc<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">sbi_hart_hang</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/* 时钟初始化 */</span>
    rc <span class="token operator">=</span> <span class="token function">sbi_timer_init</span><span class="token punctuation">(</span>scratch<span class="token punctuation">,</span> TRUE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>rc<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">sbi_printf</span><span class="token punctuation">(</span><span class="token string">&quot;%s: timer init failed (error %d)\n&quot;</span><span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">,</span> rc<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">sbi_hart_hang</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/* 注册系统调用 */</span>
    rc <span class="token operator">=</span> <span class="token function">sbi_ecall_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>rc<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">sbi_printf</span><span class="token punctuation">(</span><span class="token string">&quot;%s: ecall init failed (error %d)\n&quot;</span><span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">,</span> rc<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">sbi_hart_hang</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/* 物理内存保护机制配置 */</span>
    rc <span class="token operator">=</span> <span class="token function">sbi_hart_pmp_configure</span><span class="token punctuation">(</span>scratch<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>rc<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">sbi_printf</span><span class="token punctuation">(</span><span class="token string">&quot;%s: PMP configure failed (error %d)\n&quot;</span><span class="token punctuation">,</span>
               <span class="token constant">__func__</span><span class="token punctuation">,</span> rc<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">sbi_hart_hang</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/* 调整ftd内存布局 */</span>
    rc <span class="token operator">=</span> <span class="token function">sbi_platform_final_init</span><span class="token punctuation">(</span>plat<span class="token punctuation">,</span> TRUE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>rc<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">sbi_printf</span><span class="token punctuation">(</span><span class="token string">&quot;%s: platform final init failed (error %d)\n&quot;</span><span class="token punctuation">,</span>
               <span class="token constant">__func__</span><span class="token punctuation">,</span> rc<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">sbi_hart_hang</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/* 发出软件中断，唤醒其他hart */</span>
    <span class="token function">wake_coldboot_harts</span><span class="token punctuation">(</span>scratch<span class="token punctuation">,</span> hartid<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* 执行下一阶段代码 */</span>
    init_count <span class="token operator">=</span> <span class="token function">sbi_scratch_offset_ptr</span><span class="token punctuation">(</span>scratch<span class="token punctuation">,</span> init_count_offset<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">(</span><span class="token operator">*</span>init_count<span class="token punctuation">)</span><span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token function">sbi_hsm_prepare_next_jump</span><span class="token punctuation">(</span>scratch<span class="token punctuation">,</span> hartid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">sbi_hart_switch_mode</span><span class="token punctuation">(</span>hartid<span class="token punctuation">,</span> scratch<span class="token operator">-&gt;</span>next_arg1<span class="token punctuation">,</span> scratch<span class="token operator">-&gt;</span>next_addr<span class="token punctuation">,</span>
                 scratch<span class="token operator">-&gt;</span>next_mode<span class="token punctuation">,</span> FALSE<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><h3 id="_5-risc-v-中断、异常、系统调用"><a href="#_5-risc-v-中断、异常、系统调用" class="header-anchor">#</a> 5. RISC-V 中断、异常、系统调用</h3> <p>RISC-V将trap分为两类，一类是同步trap，在指令执行期间产生，包括地址访问错误异常，断点异常，非法指令异常，非对齐地址异常和系统调用。另一类是中断。RISC-V中定义了三种标准的中断源，软件中断、时钟中断和外部中断。</p> <p>当发生trap时，硬件会将mpec寄存器设置为触发trap的指令地址，将mcause寄存器设置为trap的来源，将mstatus寄存器的SIE位置零以禁用中断，将mtval寄存器设置为trap相关的附加信息，将pc寄存器设置为stvec寄存器中指向的trap服务总控函数的入口地址。</p> <p>opensbi将 trap handler设置为stvec寄存器指向的trap服务总控函数入口地址。trap handler首先在异常栈上存储sp寄存器，通过改变sp寄存器的值以分配异常栈空间，然后保存通用寄存器，调用sbi trap handler处理trap，trap处理结束后恢复通用寄存器和sp寄存器。</p> <div class="language-c extra-class"><pre class="language-c"><code>_trap_handler<span class="token operator">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token comment">/* 保存sp寄存器 */</span>
    REG_S   sp<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token function">SBI_TRAP_REGS_OFFSET</span><span class="token punctuation">(</span>sp<span class="token punctuation">)</span> <span class="token operator">-</span> SBI_TRAP_REGS_SIZE<span class="token punctuation">)</span><span class="token punctuation">(</span>t0<span class="token punctuation">)</span>

    <span class="token comment">/* 分配异常栈空间 */</span>
    add sp<span class="token punctuation">,</span> t0<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token punctuation">(</span>SBI_TRAP_REGS_SIZE<span class="token punctuation">)</span>
    
    <span class="token comment">/* 保存通用寄存器 */</span>
    REG_S   zero<span class="token punctuation">,</span> <span class="token function">SBI_TRAP_REGS_OFFSET</span><span class="token punctuation">(</span>zero<span class="token punctuation">)</span><span class="token punctuation">(</span>sp<span class="token punctuation">)</span>
    REG_S   ra<span class="token punctuation">,</span> <span class="token function">SBI_TRAP_REGS_OFFSET</span><span class="token punctuation">(</span>ra<span class="token punctuation">)</span><span class="token punctuation">(</span>sp<span class="token punctuation">)</span>
    REG_S   gp<span class="token punctuation">,</span> <span class="token function">SBI_TRAP_REGS_OFFSET</span><span class="token punctuation">(</span>gp<span class="token punctuation">)</span><span class="token punctuation">(</span>sp<span class="token punctuation">)</span>
    REG_S   tp<span class="token punctuation">,</span> <span class="token function">SBI_TRAP_REGS_OFFSET</span><span class="token punctuation">(</span>tp<span class="token punctuation">)</span><span class="token punctuation">(</span>sp<span class="token punctuation">)</span>
    REG_S   t1<span class="token punctuation">,</span> <span class="token function">SBI_TRAP_REGS_OFFSET</span><span class="token punctuation">(</span>t1<span class="token punctuation">)</span><span class="token punctuation">(</span>sp<span class="token punctuation">)</span>
    REG_S   t2<span class="token punctuation">,</span> <span class="token function">SBI_TRAP_REGS_OFFSET</span><span class="token punctuation">(</span>t2<span class="token punctuation">)</span><span class="token punctuation">(</span>sp<span class="token punctuation">)</span>
    REG_S   s0<span class="token punctuation">,</span> <span class="token function">SBI_TRAP_REGS_OFFSET</span><span class="token punctuation">(</span>s0<span class="token punctuation">)</span><span class="token punctuation">(</span>sp<span class="token punctuation">)</span>
    REG_S   s1<span class="token punctuation">,</span> <span class="token function">SBI_TRAP_REGS_OFFSET</span><span class="token punctuation">(</span>s1<span class="token punctuation">)</span><span class="token punctuation">(</span>sp<span class="token punctuation">)</span>
    REG_S   a0<span class="token punctuation">,</span> <span class="token function">SBI_TRAP_REGS_OFFSET</span><span class="token punctuation">(</span>a0<span class="token punctuation">)</span><span class="token punctuation">(</span>sp<span class="token punctuation">)</span>
    REG_S   a1<span class="token punctuation">,</span> <span class="token function">SBI_TRAP_REGS_OFFSET</span><span class="token punctuation">(</span>a1<span class="token punctuation">)</span><span class="token punctuation">(</span>sp<span class="token punctuation">)</span>
    REG_S   a2<span class="token punctuation">,</span> <span class="token function">SBI_TRAP_REGS_OFFSET</span><span class="token punctuation">(</span>a2<span class="token punctuation">)</span><span class="token punctuation">(</span>sp<span class="token punctuation">)</span>
    REG_S   a3<span class="token punctuation">,</span> <span class="token function">SBI_TRAP_REGS_OFFSET</span><span class="token punctuation">(</span>a3<span class="token punctuation">)</span><span class="token punctuation">(</span>sp<span class="token punctuation">)</span>
    REG_S   a4<span class="token punctuation">,</span> <span class="token function">SBI_TRAP_REGS_OFFSET</span><span class="token punctuation">(</span>a4<span class="token punctuation">)</span><span class="token punctuation">(</span>sp<span class="token punctuation">)</span>
    REG_S   a5<span class="token punctuation">,</span> <span class="token function">SBI_TRAP_REGS_OFFSET</span><span class="token punctuation">(</span>a5<span class="token punctuation">)</span><span class="token punctuation">(</span>sp<span class="token punctuation">)</span>
    REG_S   a6<span class="token punctuation">,</span> <span class="token function">SBI_TRAP_REGS_OFFSET</span><span class="token punctuation">(</span>a6<span class="token punctuation">)</span><span class="token punctuation">(</span>sp<span class="token punctuation">)</span>
    REG_S   a7<span class="token punctuation">,</span> <span class="token function">SBI_TRAP_REGS_OFFSET</span><span class="token punctuation">(</span>a7<span class="token punctuation">)</span><span class="token punctuation">(</span>sp<span class="token punctuation">)</span>
    REG_S   s2<span class="token punctuation">,</span> <span class="token function">SBI_TRAP_REGS_OFFSET</span><span class="token punctuation">(</span>s2<span class="token punctuation">)</span><span class="token punctuation">(</span>sp<span class="token punctuation">)</span>
    REG_S   s3<span class="token punctuation">,</span> <span class="token function">SBI_TRAP_REGS_OFFSET</span><span class="token punctuation">(</span>s3<span class="token punctuation">)</span><span class="token punctuation">(</span>sp<span class="token punctuation">)</span>
    REG_S   s4<span class="token punctuation">,</span> <span class="token function">SBI_TRAP_REGS_OFFSET</span><span class="token punctuation">(</span>s4<span class="token punctuation">)</span><span class="token punctuation">(</span>sp<span class="token punctuation">)</span>
    REG_S   s5<span class="token punctuation">,</span> <span class="token function">SBI_TRAP_REGS_OFFSET</span><span class="token punctuation">(</span>s5<span class="token punctuation">)</span><span class="token punctuation">(</span>sp<span class="token punctuation">)</span>
    REG_S   s6<span class="token punctuation">,</span> <span class="token function">SBI_TRAP_REGS_OFFSET</span><span class="token punctuation">(</span>s6<span class="token punctuation">)</span><span class="token punctuation">(</span>sp<span class="token punctuation">)</span>
    REG_S   s7<span class="token punctuation">,</span> <span class="token function">SBI_TRAP_REGS_OFFSET</span><span class="token punctuation">(</span>s7<span class="token punctuation">)</span><span class="token punctuation">(</span>sp<span class="token punctuation">)</span>
    REG_S   s8<span class="token punctuation">,</span> <span class="token function">SBI_TRAP_REGS_OFFSET</span><span class="token punctuation">(</span>s8<span class="token punctuation">)</span><span class="token punctuation">(</span>sp<span class="token punctuation">)</span>
    REG_S   s9<span class="token punctuation">,</span> <span class="token function">SBI_TRAP_REGS_OFFSET</span><span class="token punctuation">(</span>s9<span class="token punctuation">)</span><span class="token punctuation">(</span>sp<span class="token punctuation">)</span>
    REG_S   s10<span class="token punctuation">,</span> <span class="token function">SBI_TRAP_REGS_OFFSET</span><span class="token punctuation">(</span>s10<span class="token punctuation">)</span><span class="token punctuation">(</span>sp<span class="token punctuation">)</span>
    REG_S   s11<span class="token punctuation">,</span> <span class="token function">SBI_TRAP_REGS_OFFSET</span><span class="token punctuation">(</span>s11<span class="token punctuation">)</span><span class="token punctuation">(</span>sp<span class="token punctuation">)</span>
    REG_S   t3<span class="token punctuation">,</span> <span class="token function">SBI_TRAP_REGS_OFFSET</span><span class="token punctuation">(</span>t3<span class="token punctuation">)</span><span class="token punctuation">(</span>sp<span class="token punctuation">)</span>
    REG_S   t4<span class="token punctuation">,</span> <span class="token function">SBI_TRAP_REGS_OFFSET</span><span class="token punctuation">(</span>t4<span class="token punctuation">)</span><span class="token punctuation">(</span>sp<span class="token punctuation">)</span>
    REG_S   t5<span class="token punctuation">,</span> <span class="token function">SBI_TRAP_REGS_OFFSET</span><span class="token punctuation">(</span>t5<span class="token punctuation">)</span><span class="token punctuation">(</span>sp<span class="token punctuation">)</span>
    REG_S   t6<span class="token punctuation">,</span> <span class="token function">SBI_TRAP_REGS_OFFSET</span><span class="token punctuation">(</span>t6<span class="token punctuation">)</span><span class="token punctuation">(</span>sp<span class="token punctuation">)</span>

    <span class="token comment">/* 调用sbi_trap_handler处理trap */</span>
    add a0<span class="token punctuation">,</span> sp<span class="token punctuation">,</span> zero
    call    sbi_trap_handler
    
    <span class="token comment">/* 恢复通用寄存器 */</span>
    REG_L   ra<span class="token punctuation">,</span> <span class="token function">SBI_TRAP_REGS_OFFSET</span><span class="token punctuation">(</span>ra<span class="token punctuation">)</span><span class="token punctuation">(</span>sp<span class="token punctuation">)</span>
    REG_L   gp<span class="token punctuation">,</span> <span class="token function">SBI_TRAP_REGS_OFFSET</span><span class="token punctuation">(</span>gp<span class="token punctuation">)</span><span class="token punctuation">(</span>sp<span class="token punctuation">)</span>
    REG_L   tp<span class="token punctuation">,</span> <span class="token function">SBI_TRAP_REGS_OFFSET</span><span class="token punctuation">(</span>tp<span class="token punctuation">)</span><span class="token punctuation">(</span>sp<span class="token punctuation">)</span>
    REG_L   t1<span class="token punctuation">,</span> <span class="token function">SBI_TRAP_REGS_OFFSET</span><span class="token punctuation">(</span>t1<span class="token punctuation">)</span><span class="token punctuation">(</span>sp<span class="token punctuation">)</span>
    REG_L   t2<span class="token punctuation">,</span> <span class="token function">SBI_TRAP_REGS_OFFSET</span><span class="token punctuation">(</span>t2<span class="token punctuation">)</span><span class="token punctuation">(</span>sp<span class="token punctuation">)</span>
    REG_L   s0<span class="token punctuation">,</span> <span class="token function">SBI_TRAP_REGS_OFFSET</span><span class="token punctuation">(</span>s0<span class="token punctuation">)</span><span class="token punctuation">(</span>sp<span class="token punctuation">)</span>
    REG_L   s1<span class="token punctuation">,</span> <span class="token function">SBI_TRAP_REGS_OFFSET</span><span class="token punctuation">(</span>s1<span class="token punctuation">)</span><span class="token punctuation">(</span>sp<span class="token punctuation">)</span>
    REG_L   a0<span class="token punctuation">,</span> <span class="token function">SBI_TRAP_REGS_OFFSET</span><span class="token punctuation">(</span>a0<span class="token punctuation">)</span><span class="token punctuation">(</span>sp<span class="token punctuation">)</span>
    REG_L   a1<span class="token punctuation">,</span> <span class="token function">SBI_TRAP_REGS_OFFSET</span><span class="token punctuation">(</span>a1<span class="token punctuation">)</span><span class="token punctuation">(</span>sp<span class="token punctuation">)</span>
    REG_L   a2<span class="token punctuation">,</span> <span class="token function">SBI_TRAP_REGS_OFFSET</span><span class="token punctuation">(</span>a2<span class="token punctuation">)</span><span class="token punctuation">(</span>sp<span class="token punctuation">)</span>
    REG_L   a3<span class="token punctuation">,</span> <span class="token function">SBI_TRAP_REGS_OFFSET</span><span class="token punctuation">(</span>a3<span class="token punctuation">)</span><span class="token punctuation">(</span>sp<span class="token punctuation">)</span>
    REG_L   a4<span class="token punctuation">,</span> <span class="token function">SBI_TRAP_REGS_OFFSET</span><span class="token punctuation">(</span>a4<span class="token punctuation">)</span><span class="token punctuation">(</span>sp<span class="token punctuation">)</span>
    REG_L   a5<span class="token punctuation">,</span> <span class="token function">SBI_TRAP_REGS_OFFSET</span><span class="token punctuation">(</span>a5<span class="token punctuation">)</span><span class="token punctuation">(</span>sp<span class="token punctuation">)</span>
    REG_L   a6<span class="token punctuation">,</span> <span class="token function">SBI_TRAP_REGS_OFFSET</span><span class="token punctuation">(</span>a6<span class="token punctuation">)</span><span class="token punctuation">(</span>sp<span class="token punctuation">)</span>
    REG_L   a7<span class="token punctuation">,</span> <span class="token function">SBI_TRAP_REGS_OFFSET</span><span class="token punctuation">(</span>a7<span class="token punctuation">)</span><span class="token punctuation">(</span>sp<span class="token punctuation">)</span>
    REG_L   s2<span class="token punctuation">,</span> <span class="token function">SBI_TRAP_REGS_OFFSET</span><span class="token punctuation">(</span>s2<span class="token punctuation">)</span><span class="token punctuation">(</span>sp<span class="token punctuation">)</span>
    REG_L   s3<span class="token punctuation">,</span> <span class="token function">SBI_TRAP_REGS_OFFSET</span><span class="token punctuation">(</span>s3<span class="token punctuation">)</span><span class="token punctuation">(</span>sp<span class="token punctuation">)</span>
    REG_L   s4<span class="token punctuation">,</span> <span class="token function">SBI_TRAP_REGS_OFFSET</span><span class="token punctuation">(</span>s4<span class="token punctuation">)</span><span class="token punctuation">(</span>sp<span class="token punctuation">)</span>
    REG_L   s5<span class="token punctuation">,</span> <span class="token function">SBI_TRAP_REGS_OFFSET</span><span class="token punctuation">(</span>s5<span class="token punctuation">)</span><span class="token punctuation">(</span>sp<span class="token punctuation">)</span>
    REG_L   s6<span class="token punctuation">,</span> <span class="token function">SBI_TRAP_REGS_OFFSET</span><span class="token punctuation">(</span>s6<span class="token punctuation">)</span><span class="token punctuation">(</span>sp<span class="token punctuation">)</span>
    REG_L   s7<span class="token punctuation">,</span> <span class="token function">SBI_TRAP_REGS_OFFSET</span><span class="token punctuation">(</span>s7<span class="token punctuation">)</span><span class="token punctuation">(</span>sp<span class="token punctuation">)</span>
    REG_L   s8<span class="token punctuation">,</span> <span class="token function">SBI_TRAP_REGS_OFFSET</span><span class="token punctuation">(</span>s8<span class="token punctuation">)</span><span class="token punctuation">(</span>sp<span class="token punctuation">)</span>
    REG_L   s9<span class="token punctuation">,</span> <span class="token function">SBI_TRAP_REGS_OFFSET</span><span class="token punctuation">(</span>s9<span class="token punctuation">)</span><span class="token punctuation">(</span>sp<span class="token punctuation">)</span>
    REG_L   s10<span class="token punctuation">,</span> <span class="token function">SBI_TRAP_REGS_OFFSET</span><span class="token punctuation">(</span>s10<span class="token punctuation">)</span><span class="token punctuation">(</span>sp<span class="token punctuation">)</span>
    REG_L   s11<span class="token punctuation">,</span> <span class="token function">SBI_TRAP_REGS_OFFSET</span><span class="token punctuation">(</span>s11<span class="token punctuation">)</span><span class="token punctuation">(</span>sp<span class="token punctuation">)</span>
    REG_L   t3<span class="token punctuation">,</span> <span class="token function">SBI_TRAP_REGS_OFFSET</span><span class="token punctuation">(</span>t3<span class="token punctuation">)</span><span class="token punctuation">(</span>sp<span class="token punctuation">)</span>
    REG_L   t4<span class="token punctuation">,</span> <span class="token function">SBI_TRAP_REGS_OFFSET</span><span class="token punctuation">(</span>t4<span class="token punctuation">)</span><span class="token punctuation">(</span>sp<span class="token punctuation">)</span>
    REG_L   t5<span class="token punctuation">,</span> <span class="token function">SBI_TRAP_REGS_OFFSET</span><span class="token punctuation">(</span>t5<span class="token punctuation">)</span><span class="token punctuation">(</span>sp<span class="token punctuation">)</span>
    REG_L   t6<span class="token punctuation">,</span> <span class="token function">SBI_TRAP_REGS_OFFSET</span><span class="token punctuation">(</span>t6<span class="token punctuation">)</span><span class="token punctuation">(</span>sp<span class="token punctuation">)</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token comment">/* 恢复sp寄存器 */</span>
    REG_L   sp<span class="token punctuation">,</span> <span class="token function">SBI_TRAP_REGS_OFFSET</span><span class="token punctuation">(</span>sp<span class="token punctuation">)</span><span class="token punctuation">(</span>sp<span class="token punctuation">)</span>
</code></pre></div><p>sbi trap handler作为trap处理服务，首先会读取mcause寄存器的最高位，判断trap类型。</p> <ul><li>当mcause寄存器的最高位为1时，此时trap类型为中断。读取mcause的Exception Code.
<ul><li>若Exception Code为7，则此时trap为时钟中断，调用时钟中断处理函数</li> <li>若Exception Code为3，则此时trap为软件中断，调用软件中断处理函数</li></ul></li> <li>当mcause寄存器的最高位为0时，此时trap类型为异常或系统调用。读取mcause的Exception Code.
<ul><li>若Exception Code为2，4或者6，则此时trap为异常，调用相应的异常处理函数</li> <li>若Exception Code为9或11，则此时trap为系统调用，调用ecall处理函数。</li></ul></li></ul> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">void</span> <span class="token function">sbi_trap_handler</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sbi_trap_regs</span> <span class="token operator">*</span>regs<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token comment">/** 当mcause寄存器的最高位为1时，此时trap类型为中断  **/</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mcause <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token number">1UL</span> <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span>__riscv_xlen <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mcause <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token punctuation">(</span><span class="token number">1UL</span> <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span>__riscv_xlen <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>mcause<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">/** 时钟中断  **/</span>
        <span class="token keyword">case</span> IRQ_M_TIMER<span class="token operator">:</span>
            <span class="token function">sbi_timer_process</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token comment">/** 软件中断  **/</span>
        <span class="token keyword">case</span> IRQ_M_SOFT<span class="token operator">:</span>
            <span class="token function">sbi_ipi_process</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">default</span><span class="token operator">:</span>
            msg <span class="token operator">=</span> <span class="token string">&quot;unhandled external interrupt&quot;</span><span class="token punctuation">;</span>
            <span class="token keyword">goto</span> trap_error<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/** 当mcause寄存器的最高位为0时，此时trap类型为异常或系统调用 **/</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>mcause<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">/** 异常 **/</span>
    <span class="token keyword">case</span> CAUSE_ILLEGAL_INSTRUCTION<span class="token operator">:</span>
        rc  <span class="token operator">=</span> <span class="token function">sbi_illegal_insn_handler</span><span class="token punctuation">(</span>mtval<span class="token punctuation">,</span> regs<span class="token punctuation">)</span><span class="token punctuation">;</span>
        msg <span class="token operator">=</span> <span class="token string">&quot;illegal instruction handler failed&quot;</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> CAUSE_MISALIGNED_LOAD<span class="token operator">:</span>
        rc <span class="token operator">=</span> <span class="token function">sbi_misaligned_load_handler</span><span class="token punctuation">(</span>mtval<span class="token punctuation">,</span> mtval2<span class="token punctuation">,</span> mtinst<span class="token punctuation">,</span> regs<span class="token punctuation">)</span><span class="token punctuation">;</span>
        msg <span class="token operator">=</span> <span class="token string">&quot;misaligned load handler failed&quot;</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> CAUSE_MISALIGNED_STORE<span class="token operator">:</span>
        rc  <span class="token operator">=</span> <span class="token function">sbi_misaligned_store_handler</span><span class="token punctuation">(</span>mtval<span class="token punctuation">,</span> mtval2<span class="token punctuation">,</span> mtinst<span class="token punctuation">,</span> regs<span class="token punctuation">)</span><span class="token punctuation">;</span>
        msg <span class="token operator">=</span> <span class="token string">&quot;misaligned store handler failed&quot;</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token comment">/** 系统调用 **/</span>
    <span class="token keyword">case</span> CAUSE_SUPERVISOR_ECALL<span class="token operator">:</span>
    <span class="token keyword">case</span> CAUSE_MACHINE_ECALL<span class="token operator">:</span>
        rc  <span class="token operator">=</span> <span class="token function">sbi_ecall_handler</span><span class="token punctuation">(</span>regs<span class="token punctuation">)</span><span class="token punctuation">;</span>
        msg <span class="token operator">=</span> <span class="token string">&quot;ecall handler failed&quot;</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">default</span><span class="token operator">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

trap_error<span class="token operator">:</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>rc<span class="token punctuation">)</span>
        <span class="token function">sbi_trap_error</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> rc<span class="token punctuation">,</span> mcause<span class="token punctuation">,</span> mtval<span class="token punctuation">,</span> mtval2<span class="token punctuation">,</span> mtinst<span class="token punctuation">,</span> regs<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><h3 id="_6-risc-v-虚拟内存"><a href="#_6-risc-v-虚拟内存" class="header-anchor">#</a> 6. RISC-V 虚拟内存</h3> <p>相比于M模式，S模式提供了基于页面的虚拟内存系统，将内存划分为固定大小的页来进行地址的转换和对内存内容的保护。RISC-V的分页方案有很多种，linux kernel使用Sv39作为页表的实现。</p> <p>Sv39模式支持39位的虚拟内存地址空间，其中第38-12位为虚拟页号，第11-0位为页内偏移，每一个页面4KB。物理内存地址为56位，其中第55-12位为物理页号。27位的虚拟页号通过三级页表映射到44位的物理页号。</p> <p><img src="/assets/img/img5.a7fe8674.png" alt=""></p> <p><img src="/assets/img/img4.3a0e6a4e.png" alt=""></p> <p>Sv39模式中每一个页表项为64位。其中63-54位为保留位。53-10位为物理页号。9-0位为页状态的描述位。V表示该页表项是否有效。R，W，X为权限控制位，分别表示页的可读可写可执行权限，当R，W，X为都为0时，表示该页表项指向的是下一级页表，为非叶页表项。U表示该页是否可以被User模式访问，只有当U位为1时，User模式的软件才可以访问该页。G为为全局映射位。当G位为1且该页表项为非叶页表项时，表示该页表项所指向的下一级页表为全局可访问的。A表示Accessed，当A位为1时，表示该页表项所指向的页面自从上次A位被清零后有被访问过。D表示Dirty，当D位为1时，表示该页表项所指向的页面自从上次D位被清零后有被修改过。RSW位为预留位。</p> <p><img src="/assets/img/img6.f66dcc7f.png" alt=""></p> <p>每一级的页表项都可以为叶页表项。当三级页表的页表项为叶页表项时，所指向的页面大小为4KB；当二级页表的页表项为叶页表项时，所指向的页面大小为2MB；当一级页表的页表项为叶页表项时，所指向的页面大小为1GB。</p> <p>S模式使用satp寄存器控制虚拟内存分页系统。satp有三个域。MODE可以开启分页并选择页表级数。ASID是地址空间标识符，可以用来降低上下文切换的开销。PPN字段保存了页表的基址地址。</p> <p><img src="/assets/img/satp.cb19cf00.png" alt=""></p> <p>当在satp寄存器中启用了分页时，S 模式和 U 模式中的虚拟地址会以从根部遍历页表 的方式转换为物理地址。</p> <ol><li>satp.PPN 给出了一级页表的基址，VA[31:22]给出了一级页号，因此处理器会读取 位于地址(satp. PPN × 4096 + VA[31: 22] × 4)的页表项。</li> <li>该PTE包含二级页表的基址，VA[21:12]给出了二级页号，因此处理器读取位于地址(PTE. PPN × 4096 + VA[21: 12] × 4)的叶节点页表项。</li> <li>叶节点页表项的PPN字段和页内偏移(原始虚址的最低12个有效位)组成了最终结果:物理地址就是(LeafPTE. PPN × 4096 + VA[11: 0])</li></ol> <p><img src="/assets/img/img3.034e273a.png" alt=""></p> <p>linux kernel使用Sv39作为页表的实现。当内核开启了MMU选项时，会读取已经分配好的页表数组的物理地址，并将其作为参数传入relocate函数。relocate函数中首先会获取页表数组的物理页号，与SATP MODE39拼接在一起赋值给satp寄存器。在CPU内部，使用TLB来作为虚拟页号到物理页号映射的缓存。当修改了satp寄存器时，TLB中的将失效。S模式使用sfence.vma解决这个问题，会通知处理器，软件可能已经修改了页表，于是处理器可以相应地刷新转换缓存。在赋值satp寄存器后，使用sfence.vma刷新TLB。</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PAGE_SHIFT</span> <span class="token expression"><span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SATP_MODE_39</span> <span class="token expression"><span class="token function">_AC</span><span class="token punctuation">(</span><span class="token number">0x8000000000000000</span><span class="token punctuation">,</span> UL<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SATP_MODE</span> <span class="token expression">SATP_MODE_39</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CONFIG_MMU</span></span>
	<span class="token comment">/* 使能虚拟内存并重新分配虚拟地址并重新分配虚拟地址 */</span>
	<span class="token comment">/* swapper_pg_dir为页表基地址 */</span>
	la a0<span class="token punctuation">,</span> swapper_pg_dir
	call relocate
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token punctuation">.</span>align <span class="token number">2</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CONFIG_MMU</span></span>
relocate<span class="token operator">:</span>
	<span class="token comment">/* 重新分配返回地址 */</span>
	li a1<span class="token punctuation">,</span> PAGE_OFFSET
	la a2<span class="token punctuation">,</span> _start
	sub a1<span class="token punctuation">,</span> a1<span class="token punctuation">,</span> a2
	add ra<span class="token punctuation">,</span> ra<span class="token punctuation">,</span> a1

	<span class="token comment">/* 计算satp寄存器的值 */</span>
	srl a2<span class="token punctuation">,</span> a0<span class="token punctuation">,</span> PAGE_SHIFT
	li a1<span class="token punctuation">,</span> SATP_MODE
	or a2<span class="token punctuation">,</span> a2<span class="token punctuation">,</span> a1
···
···
	<span class="token comment">/* 设置satp寄存器的值并刷新TLB */</span>
	csrw CSR_SATP<span class="token punctuation">,</span> a2
	sfence<span class="token punctuation">.</span>vma
</code></pre></div><h3 id="_7-参考文献"><a href="#_7-参考文献" class="header-anchor">#</a> 7. 参考文献</h3> <ol><li><a href="https://github.com/riscv/riscv-isa-manual/releases/download/Ratified-IMAFDQC/riscv-spec-20191213.pdf" target="_blank" rel="noopener noreferrer">RISC-V spec<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://github.com/riscv/riscv-isa-manual/releases/download/Ratified-IMFDQC-and-Priv-v1.11/riscv-privileged-20190608.pdf" target="_blank" rel="noopener noreferrer">RISC-V privileged spec<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="http://riscvbook.com/chinese/RISC-V-Reader-Chinese-v2p1.pdf" target="_blank" rel="noopener noreferrer">RISC-V-Reader-Chinese<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ol></div></div> <div class="bottom-line" data-v-8dab3852></div> <div class="disclaimer" data-v-8dab3852>【版权声明】Copyright © 2021 openEuler Community。本文由openEuler社区首发，欢迎遵照 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/legalcode" data-v-8dab3852>CC-BY-SA 4.0</a> 协议规定转载。转载时敬请在正文注明并保留原文链接和作者信息。</div> <div class="disclaimer" data-v-8dab3852>
        【免责声明】本文仅代表作者本人观点，与本网站无关。本网站对文中陈述、观点判断保持中立，不对所包含内容的准确性、可靠性或完整性提供任何明示或暗示的保证。本文仅供读者参考，由此产生的所有法律责任均由读者本人承担。
    </div></div> <div class="footer-wrapper" data-v-0b78f953 data-v-34596062><div class="qr-code" data-v-0b78f953><img src="/img/common/newyear-qr.png" alt data-v-0b78f953> <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyJpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMy1jMDExIDY2LjE0NTY2MSwgMjAxMi8wMi8wNi0xNDo1NjoyNyAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNiAoV2luZG93cykiIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6MTBGRjQxMDc4MTFBMTFFNDg4RUU4NENEQTQxODZDMjciIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6MTBGRjQxMDg4MTFBMTFFNDg4RUU4NENEQTQxODZDMjciPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDoxMEZGNDEwNTgxMUExMUU0ODhFRTg0Q0RBNDE4NkMyNyIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDoxMEZGNDEwNjgxMUExMUU0ODhFRTg0Q0RBNDE4NkMyNyIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/PvJh/V0AAAJMSURBVHja5Je7L0RBFMatCEEiQYcCBYKo6IgQu0SnIhuFXUsUdBL/gEqt8dhVSNajUbJsSFBqiHeBSsUqiHeyvknOTcaYuffsI9nCSX7Z2bsz8317Z848XPF4PCuTkZ2V4cixCl6vl9umCDSBOlBMz57AJTgGz5xOwuHwbwOMaABDoBfUG+qcgU2wBM7TNQSlIAhOwaSNuGVykowsgpJUDXSDa+BPYniHqa0nWQMDYIvzLxzeXgT0J2qgHaykcbKvgjaugUJyne7YAQUcA/MgT/P8C2wzhESdb81z0eeck4EqsSRoGt+DTpqUQRvxINXpoDZqDIJKOwMTNvl9SOUACBnEA1Q+pDa6GDcZEOPTZ2jkpryWU0w2EZLELTNuQ19CI//PUoxoUV+PJq9d9Gl9L5fKshmfTT/VoBkcqAZqGRPMrwj2KL87ictaB+oQcBccP6VUrvRMlKNM8V9aGd+OZQMxZhtrgn1Kz0S5i3ZBTsR0Bi6Z4vJsjyirpt+Qompc6QwcgVubRouKeIh2Oo8iOuywWN2Q1h8Dr2DDZnkdsZntPkU0QBNVF0LjzTQJZw2NGkGrNAw+Q3ZYJtrocKKLWe2ZkEIMQVizH5SBPbDrcMAQJipo39Ad95bBndNuKF71h+EA62FMMI9B/B2McbbjV6ZQouGmvlknon06kqUr+qXdlH0mXKO9/TEF4Qf65+vJnopF+tU45LUpFqhtNNV7QYzyWtwHZuh+YIpTqiPqjtKNiXc1Y8QFmALThquZ+P0EvCTymlz//nb8I8AA0Ah5h1oiyB4AAAAASUVORK5CYII=" alt class="close" data-v-0b78f953></div> <div class="atom" data-v-0b78f953><p data-v-0b78f953>openEuler 是由开放原子开源基金会（OpenAtom Foundation）孵化及运营的开源项目</p> <img src="/atom-pc.png" alt class="atom-pc" data-v-0b78f953></div> <div class="footer-content" data-v-0b78f953><div class="footer-left" data-v-0b78f953><img src="/footer-logo2.svg" class="footer-logo" data-v-0b78f953> <div class="footer-mail" data-v-0b78f953>contact@openeuler.io</div></div> <div class="footer-center" data-v-0b78f953><ul class="right-list" data-v-0b78f953><li data-v-0b78f953><a data-v-0b78f953>品牌</a></li><li data-v-0b78f953><a data-v-0b78f953>隐私政策</a></li><li data-v-0b78f953><a data-v-0b78f953>法律声明</a></li><li data-v-0b78f953><a data-v-0b78f953>服务状态</a></li></ul> <p class="footer-copyright" data-v-0b78f953>
        版权所有 © 2022 openEuler 保留一切权利
      </p></div> <div class="footer-right" data-v-0b78f953><img src="/qrcode.png" class="footer-qrcode" data-v-0b78f953> <div class="qrcode-desc" data-v-0b78f953>扫码关注公众号</div></div></div></div></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.cdfb7ee7.js" defer></script><script src="/assets/js/14.8a38dea1.js" defer></script><script src="/assets/js/57.2ef9eaed.js" defer></script>
  </body>
</html>
