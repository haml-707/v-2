(window.webpackJsonp=window.webpackJsonp||[]).push([[57],{1337:function(t,s,a){t.exports=a.p+"assets/img/img1.ef2276c6.png"},1338:function(t,s,a){t.exports=a.p+"assets/img/img2.4012df4b.png"},1339:function(t,s,a){t.exports=a.p+"assets/img/mip.b98067f8.png"},1340:function(t,s,a){t.exports=a.p+"assets/img/mie.9c1b8cef.png"},1341:function(t,s,a){t.exports=a.p+"assets/img/img5.a7fe8674.png"},1342:function(t,s,a){t.exports=a.p+"assets/img/img4.3a0e6a4e.png"},1343:function(t,s,a){t.exports=a.p+"assets/img/img6.f66dcc7f.png"},1344:function(t,s,a){t.exports=a.p+"assets/img/satp.cb19cf00.png"},1345:function(t,s,a){t.exports=a.p+"assets/img/img3.034e273a.png"},1759:function(t,s,a){"use strict";a.r(s);var n=a(42),e=Object(n.a)({},(function(){var t=this,s=t.$createElement,n=t._self._c||s;return n("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[n("h3",{attrs:{id:"risc-v"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#risc-v"}},[t._v("#")]),t._v(" RISC-V")]),t._v(" "),n("p",[t._v("RISC-V架构主要由美国加州大学伯克利分校发明，相比于x86和ARM架构，RISC-V开源采用BSD协议，它允许用户自由地使用、修改源代码，也可以将修改后的代码作为开源或者专有软件再发布。计算机体系结构的传统方法是增量ISA，新处理器不仅必须实现新的ISA扩展，还必须 实现过去的所有扩展。目的是为了保持向后的二进制兼容性，这样几十年前程序的二进制 版本仍然可以在最新的处理器上正确运行。导致了传统ISA的体量随时间大幅增长。而RISC-V是模块化的。它的核心是一个名为RV32I的基础ISA，支持运行一个完整的软件栈。RV32I是固定的，永远不会改变。这为编译器编写者，操作系统开发人员和汇编语言程序员提供了稳定的目标。模块化来源于可选的标准扩展，根据应用程序的需要，硬件可以包含或不包含这些扩展。")]),t._v(" "),n("h3",{attrs:{id:"_1-risc-v-特权级架构"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-risc-v-特权级架构"}},[t._v("#")]),t._v(" 1. RISC-V 特权级架构")]),t._v(" "),n("p",[t._v("RISC-V定义了三种特权模式，分别为Machine Mode（M Mode），Supervisor Mode（S Mode），User Mode（U Mode）。")]),t._v(" "),n("p",[n("img",{attrs:{src:a(1337),alt:""}})]),t._v(" "),n("p",[t._v("在特权级架构实现中，M Mode为必选模式，另外两种为可选模式。通过不同的模式组合可以实现不同用途的系统。")]),t._v(" "),n("p",[n("img",{attrs:{src:a(1338),alt:""}})]),t._v(" "),n("ul",[n("li",[t._v("M Mode：通常为简单的嵌入式系统")]),t._v(" "),n("li",[t._v("M Mode + U Mode：该系统可以实现用户和机器模式的区分，从而实现资源的保护")]),t._v(" "),n("li",[t._v("M Mode + U Mode + U Mode：该系统可以实现类Unix操作系统")])]),t._v(" "),n("h3",{attrs:{id:"_2-risc-v-通用寄存器"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-risc-v-通用寄存器"}},[t._v("#")]),t._v(" 2. RISC-V 通用寄存器")]),t._v(" "),n("p",[t._v("基本整数指令集是RISC-V最基本也是唯一强制要求实现的指令集模块，能够实现完整的软件编译器，支持现代操作系统运行。RV32I是其中一种整数指令集，支持32个通用整数寄存器，每一个寄存器有32位，由x0~x31表示，其中x0寄存器被预留为常数0.在汇编语言中，通用寄存器组中的每一个寄存器都有别名。")]),t._v(" "),n("table",[n("thead",[n("tr",[n("th",{staticStyle:{"text-align":"left"}},[t._v("Register")]),t._v(" "),n("th",{staticStyle:{"text-align":"left"}},[t._v("ABI Name")]),t._v(" "),n("th",{staticStyle:{"text-align":"left"}},[t._v("Description")])])]),t._v(" "),n("tbody",[n("tr",[n("td",{staticStyle:{"text-align":"left"}},[t._v("x0")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("zero")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("Hard-wired zero")])]),t._v(" "),n("tr",[n("td",{staticStyle:{"text-align":"left"}},[t._v("x1")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("ra")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("Return address")])]),t._v(" "),n("tr",[n("td",{staticStyle:{"text-align":"left"}},[t._v("x2")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("sp")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("Stack pointer")])]),t._v(" "),n("tr",[n("td",{staticStyle:{"text-align":"left"}},[t._v("x3")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("gp")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("Global pointer")])]),t._v(" "),n("tr",[n("td",{staticStyle:{"text-align":"left"}},[t._v("x4")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("tp")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("Thread pointer")])]),t._v(" "),n("tr",[n("td",{staticStyle:{"text-align":"left"}},[t._v("x5-7")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("t0-2")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("Temporaries")])]),t._v(" "),n("tr",[n("td",{staticStyle:{"text-align":"left"}},[t._v("x8")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("s0/fp")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("Saved register/frame pointer")])]),t._v(" "),n("tr",[n("td",{staticStyle:{"text-align":"left"}},[t._v("x9")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("s1")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("Saved register")])]),t._v(" "),n("tr",[n("td",{staticStyle:{"text-align":"left"}},[t._v("x10-11")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("a0-1")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("Function arguments/retrurn values")])]),t._v(" "),n("tr",[n("td",{staticStyle:{"text-align":"left"}},[t._v("x12-17")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("a2-7")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("Function arguments")])]),t._v(" "),n("tr",[n("td",{staticStyle:{"text-align":"left"}},[t._v("x18-27")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("s2-11")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("Saved register")])]),t._v(" "),n("tr",[n("td",{staticStyle:{"text-align":"left"}},[t._v("x28-31")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("t3-6")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("Temporaries")])])])]),t._v(" "),n("h3",{attrs:{id:"_3-risc-v-特权级寄存器"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-risc-v-特权级寄存器"}},[t._v("#")]),t._v(" 3. RISC-V 特权级寄存器")]),t._v(" "),n("p",[t._v("除了通用寄存器，RISC-V针对各个特权级，还定义了一系列特权级控制状态寄存器。本节以M模式为例介绍相关控制状态寄存器。")]),t._v(" "),n("ul",[n("li",[t._v("misa：表示hart支持的架构扩展，包括整数、乘除、原子、浮点数、双精度浮点数和压缩指令扩展等")]),t._v(" "),n("li",[t._v("mhartid：当前正在执行代码的hart id")]),t._v(" "),n("li",[t._v("medeleg：默认情况下，所有的异常都是在M模式下处理。当相应的medeleg位置1时，该异常直接由S模式或U模式处理。")]),t._v(" "),n("li",[t._v("mideleg：默认情况下，所有的中断都是在M模式下处理。当相应的mideleg位置1时，该中断直接由S模式或U模式处理。")]),t._v(" "),n("li",[t._v("mtime：存储当前的时钟计数值")]),t._v(" "),n("li",[t._v("mtimecmp：时钟计数比较器。当当前mtime寄存器中的值大于mtimecmp中的值时，触发时钟中断")]),t._v(" "),n("li",[t._v("mstatus：表示当前处理器的控制状态，包括全局中断使能位。内存特权级，字节序控制位等")]),t._v(" "),n("li",[t._v("mtvec：保存发生trap时处理器需要跳转到的地址")]),t._v(" "),n("li",[t._v("mip：指示正准备处理的中断类型。EIP表示外部中断，TIP表示时钟中断，SIP表示软件中断。当相应的中断位置1时，表示存在该类型中断待处理\n"),n("img",{attrs:{src:a(1339),alt:""}})]),t._v(" "),n("li",[t._v("mie：指示处理器目前使能和忽略的中断类型。EIP表示外部中断，TIP表示时钟中断，SIP表示软件中断。当相应的中断位置1时，表示该类型中断可以被处理器响应\n"),n("img",{attrs:{src:a(1340),alt:""}})]),t._v(" "),n("li",[t._v("mscratch：保存指向当前hart上下文的指针")]),t._v(" "),n("li",[t._v("mepc：保存引发异常的指令")]),t._v(" "),n("li",[t._v("mtval：它保存了trap的附加信息:地址例外中出错的地址、发生非法指令例外的指令本身，对于其他trap，它的值为 0")]),t._v(" "),n("li",[t._v("mcause：指示发生trap的种类。当最高位为1时，低位字段表示发生中断的类型；当最高位为0时，低位字段表示发生异常或系统调用的类型。")])]),t._v(" "),n("table",[n("thead",[n("tr",[n("th",{staticStyle:{"text-align":"left"}},[t._v("Interrupt")]),t._v(" "),n("th",{staticStyle:{"text-align":"left"}},[t._v("Exception Code")]),t._v(" "),n("th",{staticStyle:{"text-align":"left"}},[t._v("Description")])])]),t._v(" "),n("tbody",[n("tr",[n("td",{staticStyle:{"text-align":"left"}},[t._v("1")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("0")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("Reserved")])]),t._v(" "),n("tr",[n("td",{staticStyle:{"text-align":"left"}},[t._v("1")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("1")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("Supervisor software interrupt")])]),t._v(" "),n("tr",[n("td",{staticStyle:{"text-align":"left"}},[t._v("1")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("2")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("Reserved")])]),t._v(" "),n("tr",[n("td",{staticStyle:{"text-align":"left"}},[t._v("1")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("3")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("Machine software interrupt")])]),t._v(" "),n("tr",[n("td",{staticStyle:{"text-align":"left"}},[t._v("1")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("4")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("Reserved")])]),t._v(" "),n("tr",[n("td",{staticStyle:{"text-align":"left"}},[t._v("1")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("5")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("Supervisor timer interrupt")])]),t._v(" "),n("tr",[n("td",{staticStyle:{"text-align":"left"}},[t._v("1")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("6")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("Reserved")])]),t._v(" "),n("tr",[n("td",{staticStyle:{"text-align":"left"}},[t._v("1")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("7")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("Machine timer interrupt")])]),t._v(" "),n("tr",[n("td",{staticStyle:{"text-align":"left"}},[t._v("1")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("8")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("Reserved")])]),t._v(" "),n("tr",[n("td",{staticStyle:{"text-align":"left"}},[t._v("1")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("9")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("Supervisor external interrupt")])]),t._v(" "),n("tr",[n("td",{staticStyle:{"text-align":"left"}},[t._v("1")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("10")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("Reserved")])]),t._v(" "),n("tr",[n("td",{staticStyle:{"text-align":"left"}},[t._v("1")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("11")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("Machine external interrupt")])]),t._v(" "),n("tr",[n("td",{staticStyle:{"text-align":"left"}},[t._v("1")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("12-15")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("Reserved")])]),t._v(" "),n("tr",[n("td",{staticStyle:{"text-align":"left"}},[t._v("1")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v(">=16")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("Available for platform use")])]),t._v(" "),n("tr",[n("td",{staticStyle:{"text-align":"left"}},[t._v("0")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("0")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("Instruction address misaligned")])]),t._v(" "),n("tr",[n("td",{staticStyle:{"text-align":"left"}},[t._v("0")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("1")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("Instruction access fault")])]),t._v(" "),n("tr",[n("td",{staticStyle:{"text-align":"left"}},[t._v("0")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("2")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("Illegal instruction")])]),t._v(" "),n("tr",[n("td",{staticStyle:{"text-align":"left"}},[t._v("0")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("3")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("Breakpoint")])]),t._v(" "),n("tr",[n("td",{staticStyle:{"text-align":"left"}},[t._v("0")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("4")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("Load address misaligned")])]),t._v(" "),n("tr",[n("td",{staticStyle:{"text-align":"left"}},[t._v("0")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("5")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("Load access fault")])]),t._v(" "),n("tr",[n("td",{staticStyle:{"text-align":"left"}},[t._v("0")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("6")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("Store/AMO address misaligned")])]),t._v(" "),n("tr",[n("td",{staticStyle:{"text-align":"left"}},[t._v("0")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("7")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("Store/AMO access fault")])]),t._v(" "),n("tr",[n("td",{staticStyle:{"text-align":"left"}},[t._v("0")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("8")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("Environment call from U-mode")])]),t._v(" "),n("tr",[n("td",{staticStyle:{"text-align":"left"}},[t._v("0")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("9")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("Environment call from S-mode")])]),t._v(" "),n("tr",[n("td",{staticStyle:{"text-align":"left"}},[t._v("0")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("10")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("Reserved")])]),t._v(" "),n("tr",[n("td",{staticStyle:{"text-align":"left"}},[t._v("0")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("11")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("Environment call from M-mode")])]),t._v(" "),n("tr",[n("td",{staticStyle:{"text-align":"left"}},[t._v("0")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("12")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("Instruction page fault")])]),t._v(" "),n("tr",[n("td",{staticStyle:{"text-align":"left"}},[t._v("0")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("13")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("Load page fault")])]),t._v(" "),n("tr",[n("td",{staticStyle:{"text-align":"left"}},[t._v("0")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("14")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("Reserved")])]),t._v(" "),n("tr",[n("td",{staticStyle:{"text-align":"left"}},[t._v("0")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("15")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("Store/AMO page fault")])]),t._v(" "),n("tr",[n("td",{staticStyle:{"text-align":"left"}},[t._v("0")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("16-23")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("Reserved")])]),t._v(" "),n("tr",[n("td",{staticStyle:{"text-align":"left"}},[t._v("0")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("24-31")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("Available for custom use")])]),t._v(" "),n("tr",[n("td",{staticStyle:{"text-align":"left"}},[t._v("0")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("32-47")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("Reserved")])]),t._v(" "),n("tr",[n("td",{staticStyle:{"text-align":"left"}},[t._v("0")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("48-63")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("Available for custom use")])]),t._v(" "),n("tr",[n("td",{staticStyle:{"text-align":"left"}},[t._v("0")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v(">=64")]),t._v(" "),n("td",{staticStyle:{"text-align":"left"}},[t._v("Reserved")])])])]),t._v(" "),n("h3",{attrs:{id:"_4-risc-v-cpu初始化"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_4-risc-v-cpu初始化"}},[t._v("#")]),t._v(" 4. RISC-V CPU初始化")]),t._v(" "),n("p",[t._v("opensbi是M模式的一种实现。本节以opensbi为例介绍M模式下的CPU初始化。在硬件超线程处理器中，一个处理器核存在多个硬件线程，单以处理器核描述一个硬件线程不太精准。RISC-V提出了hart的概念（Hardware Thread），表示一个硬件线程。opensbi可以作为一种固件为其他特权级模式的软件提供运行时服务。在机器上电后，作为加载的第一个启动阶段代码，opensbi固件需要对cpu进行初始化。")]),t._v(" "),n("p",[t._v("每一个hart都有自己的上下文状态，上下文状态的指针保存在mscratch寄存器中。opensbi首先根据平台定义的hart的数量和hart栈的大小分配栈空间，然后依次为每一个hart初始化sbi scratch结构体，包括固件在内存中的地址，下一个启动阶段要执行的代码入口地址，参数以及特权级等信息，并将sbi scratch的地址赋值给mscratch寄存器。")]),t._v(" "),n("div",{staticClass:"language-c extra-class"},[n("pre",{pre:!0,attrs:{class:"language-c"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* sbi_scratch结构体定义 */")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("sbi_scratch")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/** opensbi固件地址 */")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("unsigned")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("long")]),t._v(" fw_start"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/** opensbi固件大小 */")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("unsigned")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("long")]),t._v(" fw_size"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/** 下一个启动阶段的参数 */")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("unsigned")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("long")]),t._v(" next_arg1"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/** 下一个启动阶段代码入口 */")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("unsigned")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("long")]),t._v(" next_addr"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/** 下一个启动阶段执行特权级 */")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("unsigned")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("long")]),t._v(" next_mode"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n···\n···\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" __packed"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),n("div",{staticClass:"language-c extra-class"},[n("pre",{pre:!0,attrs:{class:"language-c"}},[n("code",[t._v("_relocate_done"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("\n···\n···\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* 根据hart的数量和hart栈的大小分配栈空间 */")]),t._v("\n    la  tp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" _fw_end\n    mul a5"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" s7"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" s8\n    add tp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" tp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" a5\n   \n_scratch_init"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* 对第t1个hart进行初始化，将指针指向第t1个hart的栈空间 */")]),t._v("\n    add tp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" t3"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" zero\n    mul a5"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" s8"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" t1\n    sub tp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" tp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" a5\n    li  a5"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" SBI_SCRATCH_SIZE\n    sub tp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" tp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" a5\n\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* 初始化第t1个hart的sbi_scratch结构体 */")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* 初始化fw_start和fw_size */")]),t._v("\n    la  a4"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" _fw_start\n    la  a5"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" _fw_end\n    mul t0"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" s7"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" s8\n    add a5"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" a5"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" t0\n    sub a5"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" a5"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" a4\n    REG_S   a4"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("SBI_SCRATCH_FW_START_OFFSET")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("tp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    REG_S   a5"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("SBI_SCRATCH_FW_SIZE_OFFSET")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("tp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* 将下一阶段传入的参数赋值给next_arg1，通常是fdt的地址 */")]),t._v("\n    MOV_3R  s0"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" a0"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" s1"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" a1"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" s2"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" a2\n    call    fw_next_arg1\n    REG_S   a0"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("SBI_SCRATCH_NEXT_ARG1_OFFSET")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("tp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    MOV_3R  a0"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" s0"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" a1"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" s1"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" a2"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" s2\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* 将下一阶段代码的入口地址赋值给next_addr */")]),t._v("\n    MOV_3R  s0"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" a0"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" s1"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" a1"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" s2"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" a2\n    call    fw_next_addr\n    REG_S   a0"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("SBI_SCRATCH_NEXT_ADDR_OFFSET")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("tp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    MOV_3R  a0"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" s0"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" a1"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" s1"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" a2"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" s2\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* 将下一阶段执行特权级模式赋值给next_mode */")]),t._v("\n    MOV_3R  s0"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" a0"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" s1"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" a1"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" s2"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" a2\n    call    fw_next_mode\n    REG_S   a0"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("SBI_SCRATCH_NEXT_MODE_OFFSET")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("tp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* 初始化下一个hart */")]),t._v("\n    add t1"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" t1"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" t2\n    blt t1"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" s7"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" _scratch_init\n···\n···\n")])])]),n("p",[t._v("hart上下文初始化完成后，需要初始化trap。通过清空mie寄存器和mip寄存器关闭所有中断，将trap handler的地址赋值给mtvec寄存器，作为trap服务总控函数的入口地址。当系统发生中断时，将通过tvec寄存器找到trap处理函数。")]),t._v(" "),n("div",{staticClass:"language-c extra-class"},[n("pre",{pre:!0,attrs:{class:"language-c"}},[n("code",[t._v("_start_warm"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* 清空通用寄存器 */")]),t._v("\n    li  ra"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("\n    call    _reset_regs\n\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* 关闭中断，清空mie寄存器和mip寄存器 */")]),t._v("\n    csrw    CSR_MIE"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" zero\n    csrw    CSR_MIP"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" zero\n···\n···\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* 设置trap处理函数 */")]),t._v("\n    la  a4"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" _trap_handler\n    csrw    CSR_MTVEC"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" a4\n\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* 进入启动阶段 */")]),t._v("\n    csrr    a0"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" CSR_MSCRATCH\n    call    sbi_init\n")])])]),n("p",[t._v("启动hart。随机选择一个hart作为主hart。其他hart通过将mie寄存器中的MSIE位置1打开软件中断开关，并陷入WFI，等待主hart发出中断唤醒。主hart执行冷启动，进行一系列初始化，初始化完成后向其他hart发出处理器间中断以唤醒其他hart，并执行下一阶段代码。如果是目标是裸机程序，则下一段代码为用户程序代码；如果想启动内核，则下一段为内核代码，并将fdt地址作为参数传给下一段代码，进入下一阶段。")]),t._v(" "),n("div",{staticClass:"language-c extra-class"},[n("pre",{pre:!0,attrs:{class:"language-c"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" __noreturn "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("sbi_init")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("sbi_scratch")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("scratch"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    bool coldboot           "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" FALSE"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    u32 hartid          "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("current_hartid")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n···\n···\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* 随机选择一个hart作为主hart，执行冷启动，其他hart执行热启动 */")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("next_mode_supported "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("atomic_xchg")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("coldboot_lottery"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        coldboot "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" TRUE"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("coldboot"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("init_coldboot")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("scratch"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" hartid"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("else")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("init_warmboot")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("scratch"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" hartid"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("static")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" __noreturn "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("init_warmboot")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("sbi_scratch")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("scratch"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" u32 hartid"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" rc"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("unsigned")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("long")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("init_count"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("sbi_platform")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("plat "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("sbi_platform_ptr")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("scratch"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* 打开进程间中断开关，陷入WFI，等待冷启动结束 */")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("wait_for_coldboot")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("scratch"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" hartid"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n···\n···\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* 执行下一阶段代码 */")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("sbi_hsm_prepare_next_jump")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("scratch"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" hartid"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("sbi_hart_switch_mode")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("hartid"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" scratch"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("next_arg1"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n                 scratch"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("next_addr"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n                 scratch"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("next_mode"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" FALSE"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("static")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" __noreturn "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("init_coldboot")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("sbi_scratch")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("scratch"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" u32 hartid"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" rc"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("unsigned")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("long")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("init_count"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("sbi_platform")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("plat "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("sbi_platform_ptr")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("scratch"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    ···\n    ···\n\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* 初始化终端串口 */")]),t._v("\n    rc "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("sbi_console_init")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("scratch"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("rc"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("sbi_hart_hang")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* 初始化中断控制器 */")]),t._v("\n    rc "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("sbi_platform_irqchip_init")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("plat"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" TRUE"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("rc"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("sbi_printf")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"%s: platform irqchip init failed (error %d)\\n"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n               "),n("span",{pre:!0,attrs:{class:"token constant"}},[t._v("__func__")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" rc"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("sbi_hart_hang")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* 处理器间中断初始化 */")]),t._v("\n    rc "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("sbi_ipi_init")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("scratch"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" TRUE"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("rc"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("sbi_printf")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"%s: ipi init failed (error %d)\\n"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token constant"}},[t._v("__func__")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" rc"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("sbi_hart_hang")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* TLB初始化 */")]),t._v("\n    rc "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("sbi_tlb_init")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("scratch"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" TRUE"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("rc"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("sbi_printf")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"%s: tlb init failed (error %d)\\n"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token constant"}},[t._v("__func__")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" rc"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("sbi_hart_hang")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* 时钟初始化 */")]),t._v("\n    rc "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("sbi_timer_init")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("scratch"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" TRUE"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("rc"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("sbi_printf")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"%s: timer init failed (error %d)\\n"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token constant"}},[t._v("__func__")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" rc"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("sbi_hart_hang")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* 注册系统调用 */")]),t._v("\n    rc "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("sbi_ecall_init")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("rc"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("sbi_printf")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"%s: ecall init failed (error %d)\\n"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token constant"}},[t._v("__func__")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" rc"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("sbi_hart_hang")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* 物理内存保护机制配置 */")]),t._v("\n    rc "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("sbi_hart_pmp_configure")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("scratch"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("rc"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("sbi_printf")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"%s: PMP configure failed (error %d)\\n"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n               "),n("span",{pre:!0,attrs:{class:"token constant"}},[t._v("__func__")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" rc"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("sbi_hart_hang")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* 调整ftd内存布局 */")]),t._v("\n    rc "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("sbi_platform_final_init")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("plat"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" TRUE"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("rc"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("sbi_printf")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"%s: platform final init failed (error %d)\\n"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n               "),n("span",{pre:!0,attrs:{class:"token constant"}},[t._v("__func__")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" rc"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("sbi_hart_hang")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* 发出软件中断，唤醒其他hart */")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("wake_coldboot_harts")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("scratch"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" hartid"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* 执行下一阶段代码 */")]),t._v("\n    init_count "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("sbi_scratch_offset_ptr")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("scratch"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" init_count_offset"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("init_count"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("++")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("sbi_hsm_prepare_next_jump")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("scratch"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" hartid"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("sbi_hart_switch_mode")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("hartid"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" scratch"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("next_arg1"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" scratch"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("next_addr"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n                 scratch"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("next_mode"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" FALSE"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n")])])]),n("h3",{attrs:{id:"_5-risc-v-中断、异常、系统调用"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_5-risc-v-中断、异常、系统调用"}},[t._v("#")]),t._v(" 5. RISC-V 中断、异常、系统调用")]),t._v(" "),n("p",[t._v("RISC-V将trap分为两类，一类是同步trap，在指令执行期间产生，包括地址访问错误异常，断点异常，非法指令异常，非对齐地址异常和系统调用。另一类是中断。RISC-V中定义了三种标准的中断源，软件中断、时钟中断和外部中断。")]),t._v(" "),n("p",[t._v("当发生trap时，硬件会将mpec寄存器设置为触发trap的指令地址，将mcause寄存器设置为trap的来源，将mstatus寄存器的SIE位置零以禁用中断，将mtval寄存器设置为trap相关的附加信息，将pc寄存器设置为stvec寄存器中指向的trap服务总控函数的入口地址。")]),t._v(" "),n("p",[t._v("opensbi将 trap handler设置为stvec寄存器指向的trap服务总控函数入口地址。trap handler首先在异常栈上存储sp寄存器，通过改变sp寄存器的值以分配异常栈空间，然后保存通用寄存器，调用sbi trap handler处理trap，trap处理结束后恢复通用寄存器和sp寄存器。")]),t._v(" "),n("div",{staticClass:"language-c extra-class"},[n("pre",{pre:!0,attrs:{class:"language-c"}},[n("code",[t._v("_trap_handler"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* 保存sp寄存器 */")]),t._v("\n    REG_S   sp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("SBI_TRAP_REGS_OFFSET")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("sp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" SBI_TRAP_REGS_SIZE"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("t0"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* 分配异常栈空间 */")]),t._v("\n    add sp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" t0"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("SBI_TRAP_REGS_SIZE"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    \n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* 保存通用寄存器 */")]),t._v("\n    REG_S   zero"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("SBI_TRAP_REGS_OFFSET")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("zero"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("sp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    REG_S   ra"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("SBI_TRAP_REGS_OFFSET")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ra"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("sp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    REG_S   gp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("SBI_TRAP_REGS_OFFSET")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("gp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("sp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    REG_S   tp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("SBI_TRAP_REGS_OFFSET")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("tp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("sp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    REG_S   t1"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("SBI_TRAP_REGS_OFFSET")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("t1"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("sp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    REG_S   t2"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("SBI_TRAP_REGS_OFFSET")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("t2"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("sp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    REG_S   s0"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("SBI_TRAP_REGS_OFFSET")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("s0"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("sp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    REG_S   s1"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("SBI_TRAP_REGS_OFFSET")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("s1"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("sp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    REG_S   a0"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("SBI_TRAP_REGS_OFFSET")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("a0"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("sp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    REG_S   a1"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("SBI_TRAP_REGS_OFFSET")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("a1"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("sp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    REG_S   a2"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("SBI_TRAP_REGS_OFFSET")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("a2"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("sp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    REG_S   a3"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("SBI_TRAP_REGS_OFFSET")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("a3"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("sp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    REG_S   a4"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("SBI_TRAP_REGS_OFFSET")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("a4"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("sp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    REG_S   a5"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("SBI_TRAP_REGS_OFFSET")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("a5"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("sp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    REG_S   a6"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("SBI_TRAP_REGS_OFFSET")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("a6"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("sp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    REG_S   a7"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("SBI_TRAP_REGS_OFFSET")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("a7"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("sp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    REG_S   s2"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("SBI_TRAP_REGS_OFFSET")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("s2"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("sp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    REG_S   s3"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("SBI_TRAP_REGS_OFFSET")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("s3"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("sp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    REG_S   s4"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("SBI_TRAP_REGS_OFFSET")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("s4"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("sp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    REG_S   s5"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("SBI_TRAP_REGS_OFFSET")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("s5"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("sp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    REG_S   s6"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("SBI_TRAP_REGS_OFFSET")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("s6"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("sp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    REG_S   s7"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("SBI_TRAP_REGS_OFFSET")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("s7"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("sp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    REG_S   s8"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("SBI_TRAP_REGS_OFFSET")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("s8"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("sp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    REG_S   s9"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("SBI_TRAP_REGS_OFFSET")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("s9"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("sp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    REG_S   s10"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("SBI_TRAP_REGS_OFFSET")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("s10"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("sp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    REG_S   s11"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("SBI_TRAP_REGS_OFFSET")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("s11"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("sp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    REG_S   t3"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("SBI_TRAP_REGS_OFFSET")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("t3"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("sp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    REG_S   t4"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("SBI_TRAP_REGS_OFFSET")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("t4"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("sp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    REG_S   t5"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("SBI_TRAP_REGS_OFFSET")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("t5"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("sp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    REG_S   t6"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("SBI_TRAP_REGS_OFFSET")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("t6"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("sp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* 调用sbi_trap_handler处理trap */")]),t._v("\n    add a0"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" sp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" zero\n    call    sbi_trap_handler\n    \n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* 恢复通用寄存器 */")]),t._v("\n    REG_L   ra"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("SBI_TRAP_REGS_OFFSET")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ra"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("sp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    REG_L   gp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("SBI_TRAP_REGS_OFFSET")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("gp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("sp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    REG_L   tp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("SBI_TRAP_REGS_OFFSET")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("tp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("sp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    REG_L   t1"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("SBI_TRAP_REGS_OFFSET")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("t1"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("sp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    REG_L   t2"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("SBI_TRAP_REGS_OFFSET")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("t2"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("sp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    REG_L   s0"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("SBI_TRAP_REGS_OFFSET")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("s0"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("sp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    REG_L   s1"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("SBI_TRAP_REGS_OFFSET")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("s1"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("sp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    REG_L   a0"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("SBI_TRAP_REGS_OFFSET")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("a0"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("sp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    REG_L   a1"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("SBI_TRAP_REGS_OFFSET")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("a1"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("sp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    REG_L   a2"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("SBI_TRAP_REGS_OFFSET")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("a2"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("sp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    REG_L   a3"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("SBI_TRAP_REGS_OFFSET")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("a3"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("sp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    REG_L   a4"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("SBI_TRAP_REGS_OFFSET")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("a4"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("sp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    REG_L   a5"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("SBI_TRAP_REGS_OFFSET")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("a5"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("sp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    REG_L   a6"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("SBI_TRAP_REGS_OFFSET")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("a6"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("sp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    REG_L   a7"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("SBI_TRAP_REGS_OFFSET")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("a7"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("sp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    REG_L   s2"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("SBI_TRAP_REGS_OFFSET")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("s2"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("sp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    REG_L   s3"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("SBI_TRAP_REGS_OFFSET")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("s3"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("sp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    REG_L   s4"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("SBI_TRAP_REGS_OFFSET")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("s4"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("sp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    REG_L   s5"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("SBI_TRAP_REGS_OFFSET")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("s5"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("sp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    REG_L   s6"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("SBI_TRAP_REGS_OFFSET")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("s6"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("sp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    REG_L   s7"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("SBI_TRAP_REGS_OFFSET")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("s7"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("sp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    REG_L   s8"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("SBI_TRAP_REGS_OFFSET")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("s8"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("sp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    REG_L   s9"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("SBI_TRAP_REGS_OFFSET")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("s9"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("sp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    REG_L   s10"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("SBI_TRAP_REGS_OFFSET")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("s10"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("sp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    REG_L   s11"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("SBI_TRAP_REGS_OFFSET")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("s11"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("sp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    REG_L   t3"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("SBI_TRAP_REGS_OFFSET")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("t3"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("sp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    REG_L   t4"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("SBI_TRAP_REGS_OFFSET")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("t4"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("sp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    REG_L   t5"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("SBI_TRAP_REGS_OFFSET")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("t5"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("sp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    REG_L   t6"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("SBI_TRAP_REGS_OFFSET")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("t6"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("sp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* 恢复sp寄存器 */")]),t._v("\n    REG_L   sp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("SBI_TRAP_REGS_OFFSET")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("sp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("sp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),n("p",[t._v("sbi trap handler作为trap处理服务，首先会读取mcause寄存器的最高位，判断trap类型。")]),t._v(" "),n("ul",[n("li",[t._v("当mcause寄存器的最高位为1时，此时trap类型为中断。读取mcause的Exception Code.\n"),n("ul",[n("li",[t._v("若Exception Code为7，则此时trap为时钟中断，调用时钟中断处理函数")]),t._v(" "),n("li",[t._v("若Exception Code为3，则此时trap为软件中断，调用软件中断处理函数")])])]),t._v(" "),n("li",[t._v("当mcause寄存器的最高位为0时，此时trap类型为异常或系统调用。读取mcause的Exception Code.\n"),n("ul",[n("li",[t._v("若Exception Code为2，4或者6，则此时trap为异常，调用相应的异常处理函数")]),t._v(" "),n("li",[t._v("若Exception Code为9或11，则此时trap为系统调用，调用ecall处理函数。")])])])]),t._v(" "),n("div",{staticClass:"language-c extra-class"},[n("pre",{pre:!0,attrs:{class:"language-c"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("sbi_trap_handler")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("sbi_trap_regs")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("regs"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/** 当mcause寄存器的最高位为1时，此时trap类型为中断  **/")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("mcause "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("1UL")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<<")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("__riscv_xlen "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        mcause "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("~")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("1UL")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<<")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("__riscv_xlen "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("switch")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("mcause"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/** 时钟中断  **/")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("case")]),t._v(" IRQ_M_TIMER"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("\n            "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("sbi_timer_process")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("break")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/** 软件中断  **/")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("case")]),t._v(" IRQ_M_SOFT"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("\n            "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("sbi_ipi_process")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("break")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("default")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("\n            msg "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"unhandled external interrupt"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("goto")]),t._v(" trap_error"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/** 当mcause寄存器的最高位为0时，此时trap类型为异常或系统调用 **/")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("switch")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("mcause"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/** 异常 **/")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("case")]),t._v(" CAUSE_ILLEGAL_INSTRUCTION"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("\n        rc  "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("sbi_illegal_insn_handler")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("mtval"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" regs"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        msg "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"illegal instruction handler failed"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("break")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("case")]),t._v(" CAUSE_MISALIGNED_LOAD"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("\n        rc "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("sbi_misaligned_load_handler")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("mtval"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" mtval2"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" mtinst"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" regs"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        msg "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"misaligned load handler failed"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("break")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("case")]),t._v(" CAUSE_MISALIGNED_STORE"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("\n        rc  "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("sbi_misaligned_store_handler")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("mtval"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" mtval2"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" mtinst"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" regs"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        msg "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"misaligned store handler failed"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("break")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/** 系统调用 **/")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("case")]),t._v(" CAUSE_SUPERVISOR_ECALL"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("case")]),t._v(" CAUSE_MACHINE_ECALL"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("\n        rc  "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("sbi_ecall_handler")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("regs"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        msg "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"ecall handler failed"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("break")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("default")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("break")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\ntrap_error"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("rc"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("sbi_trap_error")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("msg"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" rc"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" mcause"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" mtval"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" mtval2"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" mtinst"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" regs"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n")])])]),n("h3",{attrs:{id:"_6-risc-v-虚拟内存"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_6-risc-v-虚拟内存"}},[t._v("#")]),t._v(" 6. RISC-V 虚拟内存")]),t._v(" "),n("p",[t._v("相比于M模式，S模式提供了基于页面的虚拟内存系统，将内存划分为固定大小的页来进行地址的转换和对内存内容的保护。RISC-V的分页方案有很多种，linux kernel使用Sv39作为页表的实现。")]),t._v(" "),n("p",[t._v("Sv39模式支持39位的虚拟内存地址空间，其中第38-12位为虚拟页号，第11-0位为页内偏移，每一个页面4KB。物理内存地址为56位，其中第55-12位为物理页号。27位的虚拟页号通过三级页表映射到44位的物理页号。")]),t._v(" "),n("p",[n("img",{attrs:{src:a(1341),alt:""}})]),t._v(" "),n("p",[n("img",{attrs:{src:a(1342),alt:""}})]),t._v(" "),n("p",[t._v("Sv39模式中每一个页表项为64位。其中63-54位为保留位。53-10位为物理页号。9-0位为页状态的描述位。V表示该页表项是否有效。R，W，X为权限控制位，分别表示页的可读可写可执行权限，当R，W，X为都为0时，表示该页表项指向的是下一级页表，为非叶页表项。U表示该页是否可以被User模式访问，只有当U位为1时，User模式的软件才可以访问该页。G为为全局映射位。当G位为1且该页表项为非叶页表项时，表示该页表项所指向的下一级页表为全局可访问的。A表示Accessed，当A位为1时，表示该页表项所指向的页面自从上次A位被清零后有被访问过。D表示Dirty，当D位为1时，表示该页表项所指向的页面自从上次D位被清零后有被修改过。RSW位为预留位。")]),t._v(" "),n("p",[n("img",{attrs:{src:a(1343),alt:""}})]),t._v(" "),n("p",[t._v("每一级的页表项都可以为叶页表项。当三级页表的页表项为叶页表项时，所指向的页面大小为4KB；当二级页表的页表项为叶页表项时，所指向的页面大小为2MB；当一级页表的页表项为叶页表项时，所指向的页面大小为1GB。")]),t._v(" "),n("p",[t._v("S模式使用satp寄存器控制虚拟内存分页系统。satp有三个域。MODE可以开启分页并选择页表级数。ASID是地址空间标识符，可以用来降低上下文切换的开销。PPN字段保存了页表的基址地址。")]),t._v(" "),n("p",[n("img",{attrs:{src:a(1344),alt:""}})]),t._v(" "),n("p",[t._v("当在satp寄存器中启用了分页时，S 模式和 U 模式中的虚拟地址会以从根部遍历页表 的方式转换为物理地址。")]),t._v(" "),n("ol",[n("li",[t._v("satp.PPN 给出了一级页表的基址，VA[31:22]给出了一级页号，因此处理器会读取 位于地址(satp. PPN × 4096 + VA[31: 22] × 4)的页表项。")]),t._v(" "),n("li",[t._v("该PTE包含二级页表的基址，VA[21:12]给出了二级页号，因此处理器读取位于地址(PTE. PPN × 4096 + VA[21: 12] × 4)的叶节点页表项。")]),t._v(" "),n("li",[t._v("叶节点页表项的PPN字段和页内偏移(原始虚址的最低12个有效位)组成了最终结果:物理地址就是(LeafPTE. PPN × 4096 + VA[11: 0])")])]),t._v(" "),n("p",[n("img",{attrs:{src:a(1345),alt:""}})]),t._v(" "),n("p",[t._v("linux kernel使用Sv39作为页表的实现。当内核开启了MMU选项时，会读取已经分配好的页表数组的物理地址，并将其作为参数传入relocate函数。relocate函数中首先会获取页表数组的物理页号，与SATP MODE39拼接在一起赋值给satp寄存器。在CPU内部，使用TLB来作为虚拟页号到物理页号映射的缓存。当修改了satp寄存器时，TLB中的将失效。S模式使用sfence.vma解决这个问题，会通知处理器，软件可能已经修改了页表，于是处理器可以相应地刷新转换缓存。在赋值satp寄存器后，使用sfence.vma刷新TLB。")]),t._v(" "),n("div",{staticClass:"language-c extra-class"},[n("pre",{pre:!0,attrs:{class:"language-c"}},[n("code",[n("span",{pre:!0,attrs:{class:"token macro property"}},[n("span",{pre:!0,attrs:{class:"token directive-hash"}},[t._v("#")]),n("span",{pre:!0,attrs:{class:"token directive keyword"}},[t._v("define")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token macro-name"}},[t._v("PAGE_SHIFT")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token expression"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("12")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")])])]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token macro property"}},[n("span",{pre:!0,attrs:{class:"token directive-hash"}},[t._v("#")]),n("span",{pre:!0,attrs:{class:"token directive keyword"}},[t._v("define")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token macro-name"}},[t._v("SATP_MODE_39")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token expression"}},[n("span",{pre:!0,attrs:{class:"token function"}},[t._v("_AC")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0x8000000000000000")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" UL"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")])])]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token macro property"}},[n("span",{pre:!0,attrs:{class:"token directive-hash"}},[t._v("#")]),n("span",{pre:!0,attrs:{class:"token directive keyword"}},[t._v("define")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token macro-name"}},[t._v("SATP_MODE")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token expression"}},[t._v("SATP_MODE_39")])]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token macro property"}},[n("span",{pre:!0,attrs:{class:"token directive-hash"}},[t._v("#")]),n("span",{pre:!0,attrs:{class:"token directive keyword"}},[t._v("ifdef")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token expression"}},[t._v("CONFIG_MMU")])]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* 使能虚拟内存并重新分配虚拟地址并重新分配虚拟地址 */")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* swapper_pg_dir为页表基地址 */")]),t._v("\n\tla a0"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" swapper_pg_dir\n\tcall relocate\n"),n("span",{pre:!0,attrs:{class:"token macro property"}},[n("span",{pre:!0,attrs:{class:"token directive-hash"}},[t._v("#")]),n("span",{pre:!0,attrs:{class:"token directive keyword"}},[t._v("endif")])]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("align "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token macro property"}},[n("span",{pre:!0,attrs:{class:"token directive-hash"}},[t._v("#")]),n("span",{pre:!0,attrs:{class:"token directive keyword"}},[t._v("ifdef")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token expression"}},[t._v("CONFIG_MMU")])]),t._v("\nrelocate"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* 重新分配返回地址 */")]),t._v("\n\tli a1"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" PAGE_OFFSET\n\tla a2"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" _start\n\tsub a1"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" a1"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" a2\n\tadd ra"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" ra"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" a1\n\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* 计算satp寄存器的值 */")]),t._v("\n\tsrl a2"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" a0"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" PAGE_SHIFT\n\tli a1"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" SATP_MODE\n\tor a2"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" a2"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" a1\n···\n···\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* 设置satp寄存器的值并刷新TLB */")]),t._v("\n\tcsrw CSR_SATP"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" a2\n\tsfence"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("vma\n")])])]),n("h3",{attrs:{id:"_7-参考文献"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_7-参考文献"}},[t._v("#")]),t._v(" 7. 参考文献")]),t._v(" "),n("ol",[n("li",[n("a",{attrs:{href:"https://github.com/riscv/riscv-isa-manual/releases/download/Ratified-IMAFDQC/riscv-spec-20191213.pdf",target:"_blank",rel:"noopener noreferrer"}},[t._v("RISC-V spec"),n("OutboundLink")],1)]),t._v(" "),n("li",[n("a",{attrs:{href:"https://github.com/riscv/riscv-isa-manual/releases/download/Ratified-IMFDQC-and-Priv-v1.11/riscv-privileged-20190608.pdf",target:"_blank",rel:"noopener noreferrer"}},[t._v("RISC-V privileged spec"),n("OutboundLink")],1)]),t._v(" "),n("li",[n("a",{attrs:{href:"http://riscvbook.com/chinese/RISC-V-Reader-Chinese-v2p1.pdf",target:"_blank",rel:"noopener noreferrer"}},[t._v("RISC-V-Reader-Chinese"),n("OutboundLink")],1)])])])}),[],!1,null,null,null);s.default=e.exports}}]);