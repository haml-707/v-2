(window.webpackJsonp=window.webpackJsonp||[]).push([[42],{1651:function(e,s,a){"use strict";a.r(s);var t=a(42),l=Object(t.a)({},(function(){var e=this,s=e.$createElement,t=e._self._c||s;return t("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[t("p",[e._v("在观看了前几期"),t("a",{attrs:{href:"https://www.bilibili.com/video/BV1Gp4y1i7Rs",target:"_blank",rel:"noopener noreferrer"}},[e._v("容器镜像构建工具的使用和介绍"),t("OutboundLink")],1),e._v("之后，你或许想去研究下这个工具的内部逻辑，或者想去给这个初生的小工具提一些建议或者改进，那么，你需要一个快速入手"),t("code",[e._v("isula-build")]),e._v("开源项目的方法，本期文章就来带你一起走进"),t("code",[e._v("isula-build")]),e._v("容器镜像构建工具的内部("),t("a",{attrs:{href:"https://www.bilibili.com/video/BV1Ca4y177te",target:"_blank",rel:"noopener noreferrer"}},[e._v("视频链接"),t("OutboundLink")],1),e._v(")。话不多说，一起来看看吧。")]),e._v(" "),t("h2",{attrs:{id:"isula-build代码剖析"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#isula-build代码剖析"}},[e._v("#")]),e._v(" isula-build代码剖析")]),e._v(" "),t("p",[e._v("本期文章目标")]),e._v(" "),t("ol",[t("li",[t("p",[e._v("介绍isula-build是什么")])]),e._v(" "),t("li",[t("p",[e._v("深入代码，搞懂你敲下的指令在做什么")])]),e._v(" "),t("li",[t("p",[e._v("社区发布流程、如何参与isula-build社区")])])]),e._v(" "),t("h3",{attrs:{id:"isula-build-是什么"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#isula-build-是什么"}},[e._v("#")]),e._v(" isula-build 是什么")]),e._v(" "),t("p",[e._v("说起isula-build，就不得不提及"),t("code",[e._v("iSulad")])]),e._v(" "),t("p",[t("img",{attrs:{src:a(920),alt:"isula_build_code_exploration_isula_logo"}})]),e._v(" "),t("p",[t("code",[e._v("iSulad")]),e._v("是华为自主研发的通用容器引擎，旨在统一的架构设计来满足 CT 和 IT 领域的不同需求。相比 Golang 编写的 Docker，轻量级容器具有"),t("strong",[e._v("轻、灵、巧、快")]),e._v("的特点，不受硬件规格和架构的限制，底噪开销更小，可应用领域更为广泛。目前"),t("strong",[e._v("已开源")]),e._v("（开源地址：https://gitee.com/openeuler/iSulad）。")]),e._v(" "),t("p",[e._v("作为"),t("code",[e._v("iSulad")]),e._v("生态的一员，"),t("code",[e._v("isula-build")]),e._v(" 承载了镜像构建、管理、分发等功能。")]),e._v(" "),t("h3",{attrs:{id:"isula-build-能做什么"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#isula-build-能做什么"}},[e._v("#")]),e._v(" isula-build 能做什么")]),e._v(" "),t("ul",[t("li",[e._v("安全快速构建容器镜像、管理镜像")]),e._v(" "),t("li",[e._v("与isulad、docker均可快速集成，部署方便")]),e._v(" "),t("li",[e._v("镜像管理增删改查功能，麻雀虽小五脏俱全")]),e._v(" "),t("li",[e._v("构成容器全栈解决方案")])]),e._v(" "),t("h3",{attrs:{id:"isula-build-架构全景图"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#isula-build-架构全景图"}},[e._v("#")]),e._v(" isula-build 架构全景图")]),e._v(" "),t("p",[t("code",[e._v("isula-build")]),e._v("采用经典的 C-S 架构，分为客户端"),t("code",[e._v("isula-build")]),e._v("和服务端"),t("code",[e._v("isula-builder")]),e._v("，客户端和服务端使用"),t("code",[e._v("GRPC")]),e._v("通信。用户可通过"),t("code",[e._v("isula-build")]),e._v("命令行与服务端"),t("code",[e._v("isula-builder")]),e._v("进行交互，发起镜像构建、镜像管理等请求。")]),e._v(" "),t("p",[t("img",{attrs:{src:a(921),alt:"isula_build_code_exploration_struct_overview"}})]),e._v(" "),t("h3",{attrs:{id:"isula-build-代码全景图"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#isula-build-代码全景图"}},[e._v("#")]),e._v(" isula-build 代码全景图")]),e._v(" "),t("p",[e._v("isula-build使用"),t("code",[e._v("golang")]),e._v("作为开发语言，目前自研代码行数超过2w+")]),e._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[e._v("--------------------------------------------------------------------------------\nLanguage                      files          blank        comment           code\n--------------------------------------------------------------------------------\nGo                              "),t("span",{pre:!0,attrs:{class:"token number"}},[e._v("134")]),e._v("           "),t("span",{pre:!0,attrs:{class:"token number"}},[e._v("3293")]),e._v("           "),t("span",{pre:!0,attrs:{class:"token number"}},[e._v("2676")]),e._v("          "),t("span",{pre:!0,attrs:{class:"token number"}},[e._v("25038")]),e._v("\nMarkdown                          "),t("span",{pre:!0,attrs:{class:"token number"}},[e._v("9")]),e._v("            "),t("span",{pre:!0,attrs:{class:"token number"}},[e._v("486")]),e._v("              "),t("span",{pre:!0,attrs:{class:"token number"}},[e._v("0")]),e._v("           "),t("span",{pre:!0,attrs:{class:"token number"}},[e._v("1098")]),e._v("\nBourne Shell                     "),t("span",{pre:!0,attrs:{class:"token number"}},[e._v("15")]),e._v("             "),t("span",{pre:!0,attrs:{class:"token number"}},[e._v("95")]),e._v("            "),t("span",{pre:!0,attrs:{class:"token number"}},[e._v("225")]),e._v("            "),t("span",{pre:!0,attrs:{class:"token number"}},[e._v("499")]),e._v("\nXML                               "),t("span",{pre:!0,attrs:{class:"token number"}},[e._v("9")]),e._v("              "),t("span",{pre:!0,attrs:{class:"token number"}},[e._v("0")]),e._v("              "),t("span",{pre:!0,attrs:{class:"token number"}},[e._v("0")]),e._v("            "),t("span",{pre:!0,attrs:{class:"token number"}},[e._v("419")]),e._v("\nProtocol Buffers                  "),t("span",{pre:!0,attrs:{class:"token number"}},[e._v("2")]),e._v("             "),t("span",{pre:!0,attrs:{class:"token number"}},[e._v("41")]),e._v("             "),t("span",{pre:!0,attrs:{class:"token number"}},[e._v("97")]),e._v("            "),t("span",{pre:!0,attrs:{class:"token number"}},[e._v("193")]),e._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[e._v("make")]),e._v("                              "),t("span",{pre:!0,attrs:{class:"token number"}},[e._v("1")]),e._v("             "),t("span",{pre:!0,attrs:{class:"token number"}},[e._v("18")]),e._v("              "),t("span",{pre:!0,attrs:{class:"token number"}},[e._v("1")]),e._v("             "),t("span",{pre:!0,attrs:{class:"token number"}},[e._v("89")]),e._v("\nDockerfile                        "),t("span",{pre:!0,attrs:{class:"token number"}},[e._v("6")]),e._v("             "),t("span",{pre:!0,attrs:{class:"token number"}},[e._v("14")]),e._v("              "),t("span",{pre:!0,attrs:{class:"token number"}},[e._v("0")]),e._v("             "),t("span",{pre:!0,attrs:{class:"token number"}},[e._v("68")]),e._v("\nBourne Again Shell                "),t("span",{pre:!0,attrs:{class:"token number"}},[e._v("1")]),e._v("              "),t("span",{pre:!0,attrs:{class:"token number"}},[e._v("8")]),e._v("              "),t("span",{pre:!0,attrs:{class:"token number"}},[e._v("4")]),e._v("             "),t("span",{pre:!0,attrs:{class:"token number"}},[e._v("31")]),e._v("\nTOML                              "),t("span",{pre:!0,attrs:{class:"token number"}},[e._v("3")]),e._v("             "),t("span",{pre:!0,attrs:{class:"token number"}},[e._v("37")]),e._v("            "),t("span",{pre:!0,attrs:{class:"token number"}},[e._v("255")]),e._v("             "),t("span",{pre:!0,attrs:{class:"token number"}},[e._v("15")]),e._v("\nJSON                              "),t("span",{pre:!0,attrs:{class:"token number"}},[e._v("1")]),e._v("              "),t("span",{pre:!0,attrs:{class:"token number"}},[e._v("0")]),e._v("              "),t("span",{pre:!0,attrs:{class:"token number"}},[e._v("0")]),e._v("              "),t("span",{pre:!0,attrs:{class:"token number"}},[e._v("8")]),e._v("\n--------------------------------------------------------------------------------\nSUM:                            "),t("span",{pre:!0,attrs:{class:"token number"}},[e._v("181")]),e._v("           "),t("span",{pre:!0,attrs:{class:"token number"}},[e._v("3992")]),e._v("           "),t("span",{pre:!0,attrs:{class:"token number"}},[e._v("3258")]),e._v("          "),t("span",{pre:!0,attrs:{class:"token number"}},[e._v("27458")]),e._v("\n--------------------------------------------------------------------------------\n")])])]),t("p",[e._v("进入isula-build项目，我们可以看到有一系列文件夹，分别承载了不同的功能和设计")]),e._v(" "),t("p",[t("img",{attrs:{src:a(922),alt:"isula_build_code_exploration_code_overview"}})]),e._v(" "),t("p",[e._v("下图为一些文件夹的主要功能概述")]),e._v(" "),t("p",[t("img",{attrs:{src:a(923),alt:"isula_build_code_exploration_folder_overview"}})]),e._v(" "),t("p",[e._v("看到这里你可能已经懵逼了，如何快速的了解代码呢？")]),e._v(" "),t("h3",{attrs:{id:"isula-build-代码解析-编译"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#isula-build-代码解析-编译"}},[e._v("#")]),e._v(" isula-build 代码解析 --- 编译")]),e._v(" "),t("p",[e._v("首先在我看来，如何最快了解一个项目的最快方法就是不要一开始就钻进代码里，而是先去"),t("code",[e._v("编译和运行")]),e._v("这个软件，然后通过将外在表象和内在逻辑一一对应的方法，来熟悉整个项目。")]),e._v(" "),t("p",[e._v("那么，如何运行isula-build？如果我们没有安装rpm包，那么就需要我们去手动编译二进制了，那目标就是找到"),t("code",[e._v("Makefile")]),e._v("，在其中查找蛛丝马迹。")]),e._v(" "),t("p",[e._v("我们看到了项目里有Makefile，那么里面肯定写了如何编译这个项目。我们打开文件，找到isula-build和isula-builder这两个二进制是在哪里编译的，就能找到代码最开始的地方，也就是我们即将进入的程序入口。")]),e._v(" "),t("p",[t("img",{attrs:{src:a(924),alt:"isula_build_code_exploration_makefile"}})]),e._v(" "),t("p",[e._v("那么，我们尝试着去编译一下，看看会发生什么")]),e._v(" "),t("p",[t("img",{attrs:{src:a(925),alt:"isula_build_code_exploration_make"}})]),e._v(" "),t("p",[e._v("我们发现，在isula-build/bin目录下，生成了两个二进制，那这两个二进制就是我们的成品啦，试着去运行下吧~")]),e._v(" "),t("h3",{attrs:{id:"isula-build-代码解析-命令行入口"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#isula-build-代码解析-命令行入口"}},[e._v("#")]),e._v(" isula-build 代码解析 --- 命令行入口")]),e._v(" "),t("p",[e._v("学过go语言的朋友都知道，每个二进制都是由"),t("code",[e._v("main.go")]),e._v("文件生成的，那么我们根据之前的isula-build代码全景图可以知道，"),t("code",[e._v("isula-build")]),e._v("的入口就在"),t("code",[e._v("cmd/cli/main.go")]),e._v("里面，而"),t("code",[e._v("isula-builder")]),e._v("的入口也就在对应的"),t("code",[e._v("cmd/daemon/main.go")]),e._v("里面啦。")]),e._v(" "),t("p",[t("img",{attrs:{src:a(926),alt:"isula_build_code_exploration_cli_main"}}),t("img",{attrs:{src:a(927),alt:"isula_build_code_exploration_daemon_main"}})]),e._v(" "),t("p",[e._v("试着敲敲"),t("code",[e._v("isula-build -h")]),e._v("和"),t("code",[e._v("isula-builder -h")]),e._v("帮助信息，看看都有什么吧！")]),e._v(" "),t("p",[t("img",{attrs:{src:a(928),alt:"isula_build_code_exploration_help_info"}})]),e._v(" "),t("h3",{attrs:{id:"isula-build-代码解析-外在表现和内部逻辑"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#isula-build-代码解析-外在表现和内部逻辑"}},[e._v("#")]),e._v(" isula-build 代码解析 --- 外在表现和内部逻辑")]),e._v(" "),t("p",[e._v("那么，知道了程序入口，我们就好比拿到了开启宝藏的钥匙，那么，我们就以一条"),t("code",[e._v("构建容器镜像并将其保存为本地tar包")]),e._v("的命令来讲述代码的流程：")]),e._v(" "),t("blockquote",[t("p",[e._v("例子：isula-build ctr-img build –f Dockerfile –o docker-archive:busybox.tar:busybox:latest .")])]),e._v(" "),t("p",[t("img",{attrs:{src:a(929),alt:"isula_build_code_exploration_core"}})]),e._v(" "),t("p",[e._v("限于篇幅，上图为大家准备了小抄，可以方便快速的找到整个构建流程的每一处关键点位，大家可以参考上图的"),t("code",[e._v("S")]),e._v("形，按图索骥，找到对应的代码，并加以扩展")]),e._v(" "),t("blockquote",[t("p",[e._v("考考你：到目前为止，isula-build 有多少个二级子命令？")])]),e._v(" "),t("h3",{attrs:{id:"isula-build-社区开发"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#isula-build-社区开发"}},[e._v("#")]),e._v(" isula-build 社区开发")]),e._v(" "),t("p",[e._v("那么，在熟悉了isula-build代码框架之后，你是否已经跃跃欲试，想给我们的小工具提点建议或者改进的方向。那么，如何参与到开源社区的开发中呢？")]),e._v(" "),t("p",[e._v("首先不得不说下我们代码开发和发布的流程")]),e._v(" "),t("p",[t("img",{attrs:{src:a(930),alt:"isula_build_code_exploration_release"}})]),e._v(" "),t("p",[e._v("上图概述了开发的整个流程。")]),e._v(" "),t("p",[e._v("如图所示，首先作为用户或者开发者的你会拿到我们发布的isula-build "),t("code",[e._v("rpm")]),e._v("包或者源码。在你的使用过程中，你会有一些问题不明白或者你想参与改进，你就需要去我们的"),t("a",{attrs:{href:"https://gitee.com/openeuler/isula-build",target:"_blank",rel:"noopener noreferrer"}},[e._v("源码仓"),t("OutboundLink")],1),e._v(" "),t("code",[e._v("提交issue")]),e._v("。")]),e._v(" "),t("p",[e._v("那比如我发现，哦哟，小伙子不错哦，还真是个好的改进点，办它！那你的issue就进入了"),t("code",[e._v("issue accepted")]),e._v("阶段。我们会根据问题的紧急、难易程度等要素进行排期。")]),e._v(" "),t("p",[e._v("接下来，有热心群众就会去认领该issue并开始码代码，也就进入了"),t("code",[e._v("coding")]),e._v("阶段。本地代码写完之后，功能也测试完毕，你兴奋的点击了提交按钮。那么你的提交就会来到了代码仓的pull request中。这里存放着大家的奇思妙想~")]),e._v(" "),t("p",[e._v("那是不是就意味着你的代码可以直接合入了呢？当然不能啦！所有人提交的代码要经过严格的审核，这里包括大佬们（maintainer)肉眼的review和机器人（ci bot）无情的自动化用例检查，确保每一次合入都是OK的~ 经过了一系列的审查，大家都觉得你提交的代码又短小又精悍（#手动狗头），那么你的代码进可以合入"),t("code",[e._v("源码仓")]),e._v("啦。至此，所有在源码仓中的活动也就告一段落了。")]),e._v(" "),t("p",[e._v("你以为这就完了？你写的代码是如何变成一个rpm包让你使用简单的"),t("code",[e._v("yum install isula-build")]),e._v("就能装在你的电脑中并运行的呢？这里就涉及到我们的另一个仓库，"),t("a",{attrs:{href:"https://gitee.com/src-openeuler/isula-build",target:"_blank",rel:"noopener noreferrer"}},[e._v("制品仓"),t("OutboundLink")],1),e._v("。")]),e._v(" "),t("p",[e._v("制品仓中的isula-build代码会以tar包的形式存在，也就是"),t("code",[e._v("源码打包")]),e._v("，并伴随有相应的spec文件，进行"),t("code",[e._v("rpm 包构建")]),e._v("，最终集成到我们openEuler的"),t("code",[e._v("发布件")]),e._v("中一起发布。当然，你也可以单独获取我们的"),t("a",{attrs:{href:"https://build.openeuler.org/package/show/openEuler:Mainline/isula-build",target:"_blank",rel:"noopener noreferrer"}},[e._v("rpm包"),t("OutboundLink")],1)]),e._v(" "),t("p",[e._v("到这里，我们整体的isula-build代码架构和流程剖析就告一段落了，接下来，我们唯一需要的，就是屏幕前观看文章的你，加入我们，一起收获更多！")]),e._v(" "),t("p",[t("img",{attrs:{src:a(931),alt:"isula_build_code_exploration_join_us"}})]),e._v(" "),t("blockquote",[t("p",[e._v("isula-build 源码仓：https://gitee.com/openeuler/isula-build")]),e._v(" "),t("p",[e._v("isula-build 制品仓：https://gitee.com/src-openeuler/isula-build")]),e._v(" "),t("p",[e._v("isula-build obs地址：https://build.openeuler.org/package/show/openEuler:Mainline/isula-build")])])])}),[],!1,null,null,null);s.default=l.exports},920:function(e,s,a){e.exports=a.p+"assets/img/2020-09-15-isula-build-code-exploration-isula-logo.0e40ea3a.png"},921:function(e,s,a){e.exports=a.p+"assets/img/2020-09-15-isula-build-code-exploration-struct-overview.6c668e94.png"},922:function(e,s,a){e.exports=a.p+"assets/img/2020-09-15-isula-build-code-exploration-code-overview.ad73266a.png"},923:function(e,s,a){e.exports=a.p+"assets/img/2020-09-15-isula-build-code-exploration-folder-overview.398ea418.png"},924:function(e,s,a){e.exports=a.p+"assets/img/2020-09-15-isula-build-code-exploration-makefile.f8db017e.png"},925:function(e,s,a){e.exports=a.p+"assets/img/2020-09-15-isula-build-code-exploration-make.7d455ef3.png"},926:function(e,s,a){e.exports=a.p+"assets/img/2020-09-15-isula-build-code-exploration-cli-main.c0c41be1.png"},927:function(e,s,a){e.exports=a.p+"assets/img/2020-09-15-isula-build-code-exploration-daemon-main.75ae36cc.png"},928:function(e,s,a){e.exports=a.p+"assets/img/2020-09-15-isula-build-code-exploration-help-info.144e0845.png"},929:function(e,s,a){e.exports=a.p+"assets/img/2020-09-15-isula-build-code-exploration-core.55c4c35e.png"},930:function(e,s,a){e.exports=a.p+"assets/img/2020-09-15-isula-build-code-exploration-release.3dc9b7a3.png"},931:function(e,s,a){e.exports=a.p+"assets/img/2020-09-15-isula-build-code-exploration-join-us.fa309645.png"}}]);