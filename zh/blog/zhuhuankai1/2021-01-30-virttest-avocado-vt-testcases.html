<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>玩转虚拟化测试框架avocado-vt之用例编写</title>
    <meta name="generator" content="VuePress 1.5.4">
    <link rel="icon" href="/favicon.ico">
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
  <script src="/js/analytics.js"></script>
  <meta name="keywords" content="openEuler, 操作系统, 开放, 生态, 开源, Linux 开源, OS, open, ecosystem, open source, Linux open source">
  <meta name="baidu-site-verification" content="code-EWzbQRssNU">
    <meta name="description" content="openEuler 是一个开源、免费的 Linux 发行版平台，将通过开放的社区形式与全球的开发者共同构建一个开放、多元和架构包容的软件生态体系。同时，openEuler 也是一个创新的平台，鼓励任何人在该平台上提出新想法、开拓新思路、实践新方案。">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    <meta name="keywords" content="openEuler, 操作系统, 开放, 生态, 开源, Linux 开源, OS, open, ecosystem, open source, Linux open source">
    <meta name="baidu-site-verification" content="code-EWzbQRssNU">
    <link rel="preload" href="/assets/css/0.styles.0df284ed.css" as="style"><link rel="preload" href="/assets/js/app.cdfb7ee7.js" as="script"><link rel="preload" href="/assets/js/14.8a38dea1.js" as="script"><link rel="preload" href="/assets/js/316.47a23e9c.js" as="script">
    <link rel="stylesheet" href="/assets/css/0.styles.0df284ed.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div id="euler-app" data-v-34596062><div class="nav-fill " data-v-fe04bb58 data-v-34596062><div class="nav-wrapper" data-v-fe04bb58><div class="nav-bar" data-v-fe04bb58><img src="/openeuler-logo.png" alt class="nav-logo" data-v-fe04bb58> <img src="/openeuler-logo.png" alt class="nav-logo nav-logo-mobile" data-v-fe04bb58> <ul class="nav-menu" data-v-fe04bb58><li data-v-fe04bb58><a class="menu-link" data-v-fe04bb58>下载
                        <span data-v-fe04bb58></span></a> <div class="sub-menu" data-v-fe04bb58><ul class="sig-menu-content" data-v-fe04bb58><li data-v-fe04bb58>
                                ISO
                            </li><li data-v-fe04bb58>
                                镜像仓列表
                            </li></ul> <span class="submenu-arrow" data-v-fe04bb58></span></div></li><li data-v-fe04bb58><a class="menu-link" data-v-fe04bb58>学习
                        <span data-v-fe04bb58></span></a> <div class="sub-menu" data-v-fe04bb58><ul class="sig-menu-content" data-v-fe04bb58><li data-v-fe04bb58>
                                文档
                            </li><li data-v-fe04bb58>
                                慕课
                            </li><li data-v-fe04bb58>
                                实习
                            </li></ul> <span class="submenu-arrow" data-v-fe04bb58></span></div></li><li data-v-fe04bb58><a class="menu-link menu-active" data-v-fe04bb58>互动
                        <span data-v-fe04bb58></span></a> <div class="sub-menu" data-v-fe04bb58><ul class="sig-menu-content" data-v-fe04bb58><li data-v-fe04bb58>
                                新闻
                            </li><li data-v-fe04bb58>
                                博客
                            </li><li data-v-fe04bb58>
                                直播
                            </li><li data-v-fe04bb58>
                                沙龙
                            </li><li data-v-fe04bb58>
                                峰会
                            </li></ul> <span class="submenu-arrow" data-v-fe04bb58></span></div></li><li data-v-fe04bb58><a class="menu-link" data-v-fe04bb58>社区
                        <span data-v-fe04bb58></span></a> <div class="sub-menu" data-v-fe04bb58><ul class="sig-menu-content" data-v-fe04bb58><li data-v-fe04bb58>
                                贡献攻略
                            </li><li data-v-fe04bb58>
                                行为守则
                            </li><li data-v-fe04bb58>
                                邮件列表
                            </li><li data-v-fe04bb58>
                                个人认证
                            </li></ul> <span class="submenu-arrow" data-v-fe04bb58></span></div></li><li data-v-fe04bb58><a class="menu-link" data-v-fe04bb58>SIG
                        <span data-v-fe04bb58></span></a> <div class="sub-menu" data-v-fe04bb58><ul class="sig-menu-content" data-v-fe04bb58><li data-v-fe04bb58>
                                查看SIG
                            </li><li data-v-fe04bb58>
                                申请流程
                            </li><li data-v-fe04bb58>
                                角色说明
                            </li></ul> <span class="submenu-arrow" data-v-fe04bb58></span></div></li><li data-v-fe04bb58><a class="menu-link" data-v-fe04bb58>探索
                        <span data-v-fe04bb58></span></a> <div class="sub-menu" data-v-fe04bb58><ul class="sig-menu-content" data-v-fe04bb58><li data-v-fe04bb58>
                                A-Tune
                            </li><li data-v-fe04bb58>
                                Bisheng JDK
                            </li><li data-v-fe04bb58>
                                iSula
                            </li><li data-v-fe04bb58>
                                secGear
                            </li><li data-v-fe04bb58>
                                StratoVirt
                            </li><li data-v-fe04bb58>
                                Compass-CI
                            </li><li data-v-fe04bb58>
                                Compliance
                            </li><li data-v-fe04bb58>
                                Pkgship
                            </li></ul> <span class="submenu-arrow" data-v-fe04bb58></span></div></li><li data-v-fe04bb58><a class="menu-link" data-v-fe04bb58>支持
                        <span data-v-fe04bb58></span></a> <div class="sub-menu" data-v-fe04bb58><ul class="sig-menu-content" data-v-fe04bb58><li data-v-fe04bb58>
                                漏洞管理
                            </li><li data-v-fe04bb58>
                                安全公告
                            </li><li data-v-fe04bb58>
                                CVE
                            </li><li data-v-fe04bb58>
                                兼容性列表
                            </li><li data-v-fe04bb58>
                                迁移指南
                            </li></ul> <span class="submenu-arrow" data-v-fe04bb58></span></div></li></ul> <ul class="nav-menu-mobile" style="display:none;" data-v-fe04bb58 data-v-fe04bb58><li data-v-fe04bb58><a class="menu-link" data-v-fe04bb58>下载<i class="icon-arrow" data-v-fe04bb58></i></a> <ul class="sub-menu" style="display:none;" data-v-fe04bb58 data-v-fe04bb58><li data-v-fe04bb58>
                                    ISO
                                </li><li data-v-fe04bb58>
                                    镜像仓列表
                                </li></ul></li><li data-v-fe04bb58><a class="menu-link" data-v-fe04bb58>学习<i class="icon-arrow" data-v-fe04bb58></i></a> <ul class="sub-menu" style="display:none;" data-v-fe04bb58 data-v-fe04bb58><li data-v-fe04bb58>
                                    文档
                                </li><li data-v-fe04bb58>
                                    慕课
                                </li><li data-v-fe04bb58>
                                    实习
                                </li></ul></li><li data-v-fe04bb58><a class="menu-link" data-v-fe04bb58>互动<i class="icon-arrow arrow-active" data-v-fe04bb58></i></a> <ul class="sub-menu" data-v-fe04bb58 data-v-fe04bb58><li data-v-fe04bb58>
                                    新闻
                                </li><li data-v-fe04bb58>
                                    博客
                                </li><li data-v-fe04bb58>
                                    直播
                                </li><li data-v-fe04bb58>
                                    沙龙
                                </li><li data-v-fe04bb58>
                                    峰会
                                </li></ul></li><li data-v-fe04bb58><a class="menu-link" data-v-fe04bb58>社区<i class="icon-arrow" data-v-fe04bb58></i></a> <ul class="sub-menu" style="display:none;" data-v-fe04bb58 data-v-fe04bb58><li data-v-fe04bb58>
                                    贡献攻略
                                </li><li data-v-fe04bb58>
                                    行为守则
                                </li><li data-v-fe04bb58>
                                    邮件列表
                                </li><li data-v-fe04bb58>
                                    个人认证
                                </li></ul></li><li data-v-fe04bb58><a class="menu-link" data-v-fe04bb58>SIG<i class="icon-arrow" data-v-fe04bb58></i></a> <ul class="sub-menu" style="display:none;" data-v-fe04bb58 data-v-fe04bb58><li data-v-fe04bb58>
                                    查看SIG
                                </li><li data-v-fe04bb58>
                                    申请流程
                                </li><li data-v-fe04bb58>
                                    角色说明
                                </li></ul></li><li data-v-fe04bb58><a class="menu-link" data-v-fe04bb58>探索<i class="icon-arrow" data-v-fe04bb58></i></a> <ul class="sub-menu" style="display:none;" data-v-fe04bb58 data-v-fe04bb58><li data-v-fe04bb58>
                                    A-Tune
                                </li><li data-v-fe04bb58>
                                    Bisheng JDK
                                </li><li data-v-fe04bb58>
                                    iSula
                                </li><li data-v-fe04bb58>
                                    secGear
                                </li><li data-v-fe04bb58>
                                    StratoVirt
                                </li><li data-v-fe04bb58>
                                    Compass-CI
                                </li><li data-v-fe04bb58>
                                    Compliance
                                </li><li data-v-fe04bb58>
                                    Pkgship
                                </li></ul></li><li data-v-fe04bb58><a class="menu-link" data-v-fe04bb58>支持<i class="icon-arrow" data-v-fe04bb58></i></a> <ul class="sub-menu" style="display:none;" data-v-fe04bb58 data-v-fe04bb58><li data-v-fe04bb58>
                                    漏洞管理
                                </li><li data-v-fe04bb58>
                                    安全公告
                                </li><li data-v-fe04bb58>
                                    CVE
                                </li><li data-v-fe04bb58>
                                    兼容性列表
                                </li><li data-v-fe04bb58>
                                    迁移指南
                                </li></ul></li> <li data-v-fe04bb58><a class="menu-link" data-v-fe04bb58>源码<i class="icon-arrow" data-v-fe04bb58></i></a> <ul class="sub-menu" style="display:none;" data-v-fe04bb58 data-v-fe04bb58><li data-v-fe04bb58>
                                    代码仓
                                </li><li data-v-fe04bb58>
                                    软件包仓
                                </li><li data-v-fe04bb58>
                                    GitHub镜像仓
                                </li></ul></li></ul> <div data-v-fe04bb58></div> <div class="search-mobile" data-v-fe04bb58><div class="el-input el-input--suffix" data-v-fe04bb58><!----><input type="text" autocomplete="off" placeholder="输入内容" class="el-input__inner"><!----><span class="el-input__suffix"><span class="el-input__suffix-inner"><i class="icon-search el-input__icon" data-v-fe04bb58></i><!----><!----><!----><!----></span><!----></span><!----><!----></div></div> <ul class="nav-other" style="display:;" data-v-fe04bb58><li class="lang" data-v-fe04bb58><span class="icon-lang" data-v-fe04bb58></span> <ul data-v-fe04bb58><li class="lang-list" data-v-fe04bb58>
                            中文
                        </li><li data-v-fe04bb58>
                            English
                        </li><li data-v-fe04bb58>
                            Русский
                        </li> <span class="submenu-arrow" data-v-fe04bb58></span></ul></li> <li data-v-fe04bb58><span data-v-fe04bb58>代码</span> <ul data-v-fe04bb58><li data-v-fe04bb58>
                            代码仓
                        </li><li data-v-fe04bb58>
                            软件包仓
                        </li><li data-v-fe04bb58>
                            GitHub镜像仓
                        </li> <span class="submenu-arrow" data-v-fe04bb58></span></ul></li> <li class="search" data-v-fe04bb58><img src="/search.png" alt data-v-fe04bb58></li></ul> <div class="search-input" style="display:none;" data-v-fe04bb58><div class="el-input el-input--small el-input--suffix" data-v-fe04bb58><!----><input type="text" autocomplete="off" placeholder="输入内容" class="el-input__inner"><!----><span class="el-input__suffix"><span class="el-input__suffix-inner"><i class="icon-search el-input__icon" data-v-fe04bb58></i><!----><!----><!----><!----></span><!----></span><!----><!----></div></div> <ul class="nav-other-mobile nav-other" data-v-fe04bb58><li class="lang" data-v-fe04bb58><span class="icon-lang" data-v-fe04bb58></span> <ul data-v-fe04bb58><li class="lang-list" data-v-fe04bb58>
                            中文
                        </li><li data-v-fe04bb58>
                            English
                        </li><li data-v-fe04bb58>
                            Русский
                        </li> <span class="submenu-arrow" data-v-fe04bb58></span></ul></li> <li class="search" data-v-fe04bb58><span class="icon-search" data-v-fe04bb58></span></li> <li class="menu" data-v-fe04bb58><span class="icon-menu" data-v-fe04bb58></span></li></ul></div></div> <!----></div> <!----> <div id="vuepress-theme-blog__post-layout" class="content" data-v-8dab3852 data-v-34596062><div class="blog-link-post" data-v-8dab3852>
        博客\
    </div> <div class="post-left" data-v-8dab3852><p class="blog-img mobile-hide" data-v-8dab3852><img src="/img/blog/blog_user.png" alt class="middle-img" data-v-8dab3852></p> <p class="mobile-hide" data-v-8dab3852><img src="/img/blog/account.svg" alt class="mobile-middle-img" data-v-8dab3852> <span class="blog-author" data-v-8dab3852>zhuhuankai</span></p> <p class="mobile-hide" data-v-8dab3852><img src="/img/blog/date.svg" alt class="mobile-middle-img" data-v-8dab3852> <span class="blog-date mobile" data-v-8dab3852>2021-01-30</span></p> <p class="mobile-hide" data-v-8dab3852><img src="/img/blog/visibility.svg" alt class="mobile-middle-img" data-v-8dab3852> <span class="blog-date" data-v-8dab3852><span data-v-8dab3852><span data-v-8dab3852>浏览</span> <span data-v-8dab3852></span> <span data-v-8dab3852>次</span></span></span></p> <p class="bottom-line bottom-line-none" data-v-8dab3852></p> <!----> <p class="other-blog-item" data-v-8dab3852></p></div> <div class="post-right" data-v-8dab3852><p class="blog-title" data-v-8dab3852>玩转虚拟化测试框架avocado-vt之用例编写</p> <div class="user-info-mobile" data-v-8dab3852><div class="left" data-v-8dab3852><img src="/img/blog/blog_user.png" alt data-v-8dab3852></div> <div class="right" data-v-8dab3852><p class="name" data-v-8dab3852>zhuhuankai</p> <p class="date-count" data-v-8dab3852><span class="date" data-v-8dab3852>2021-01-30</span> <span class="count" data-v-8dab3852>浏览次</span></p></div></div> <p class="blog-item-tag" data-v-8dab3852><span data-v-8dab3852>标签: </span> <span data-v-8dab3852><span class="tag-item" data-v-8dab3852>virttest</span> <span data-v-8dab3852>, </span></span><span data-v-8dab3852><span class="tag-item" data-v-8dab3852>avocado-vt</span> <!----></span></p> <p class="bottom-line bottom-line-none" data-v-8dab3852></p> <div id="blog_content" class="markdown content__default" data-v-8dab3852><h1 id="简介"><a href="#简介" class="header-anchor">#</a> 简介</h1> <p>本文以vmtop的用例为例，介绍如何使用avocado-vt框架来编写用例，执行测试。如果还没完成前置部署，可以前往本系列文章《玩转虚拟化测试框架avocado-vt之安装部署》。</p> <h1 id="用例执行流程"><a href="#用例执行流程" class="header-anchor">#</a> 用例执行流程</h1> <ul><li><p>获取配置的参数</p> <p>框架配置好的默认参数和开发者自定义配置的参数</p></li> <li><p>根据配置的参数，准备环境</p> <p>比如创建或销毁虚拟机实例</p></li> <li><p>执行测试主体</p> <p>使用前面配置好的参数，进行测试。通常在经过每个测试点时，如果引发了TestFail异常则失败，如果没有引发异常，则通过。</p></li> <li><p>结束阶段，清理环境</p> <p>根据测试过程中的情况来执行清理环境的操作。包括销毁虚拟机，删除镜像等等。</p></li></ul> <h1 id="笛卡尔配置"><a href="#笛卡尔配置" class="header-anchor">#</a> 笛卡尔配置</h1> <ul><li><p>Keys and values</p> <p>Avocado-VT框架用 &quot;key&quot; = &quot;value“ 的方式来定义参数key，如下图中第16行中test_type就是&quot;key&quot;, start就是&quot;value&quot;。
要注意的是，Avocado-VT框架的参数解析是自顶向下的。所以后面的key实际上会覆盖前面的key。其实这也很符合正常的逻辑。</p></li> <li><p>Variants</p> <p>Variants是参数配置的关键，每个Variant块都可以包含多个同级别的参数。</p> <p>两个不同的variants间可以组成所有可能的组合。</p> <p>可以看到下图中，第10行的variants下，包含了positive_test和negative_test两个分支，这两个分支是独立的，分别代表正向测试用例和反向测试用例。在positive_test的分支里面包含了两个variants，第一个variant里的有life_cycle、data_events、cmdline_d、multivmtop、vcpu_hotplug五个元素，第二个variant里有single_vm、multi_vms两个元素。单就这两个同级的variants最大可以得到10个组合。</p> <p>因为life_cycle下还有一个variant，其中有start、destroy、reboot、pause_resume四个元素。所以理论上最大可以得到8乘2共16个组合。组合出来的名称会形如：positive_test.single_vm.life_cycle.start。</p></li> <li><p>Filters</p> <p>过滤器，帮助筛选用例组合，常用的过滤器一共两种，分别是only 和 no。下图中，因为第41行的only过滤器的存在。所以multi_vms只会和life_cycle.start组合，不会和其余的7个元素组合。positive_test一共有共9个组合。</p></li></ul> <div class="language- extra-class"><pre class="language-text"><code>- vmtop:
    type = vmtop
    start_vm = &quot;no&quot;
    output_file = &quot;vmtop_output&quot;
    vcpu_max = 8
    vcpu_cur = 4
    vcpu_live = 6
    vm_num = 1
    only aarch64
    variants:
        - positive_test:
            variants:
                - life_cycle:
                    variants:
                        - start:
                            test_type = start
                        - destroy:
                            test_type = destroy
                        - reboot:
                            test_type = reboot
                        - pause_resume:
                            test_type = pause
                - data_events:
                    test_type = data_events
                - cmdline_d:
                    option = &quot;d&quot;
                    interval = 2
                - multivmtop:
                    test_type = multivmtop
                    vmtopnum = 6
                - vcpu_hotplug:
                    test_type = vcpu_hotplug
                    vcpu_placement = &quot;static&quot;
            variants:
                - single_vm:
                    test_type = single_vm
                    vm_num = 1
                - multi_vms:
                    test_type = multi_vms
                    vm_num = 3
                    only life_cycle.start
        - negative_test:
            variants:
                - invalid_cmdline:
                    option = &quot;x&quot;
</code></pre></div><h1 id="用例要点"><a href="#用例要点" class="header-anchor">#</a> 用例要点</h1> <ul><li><p>依赖库</p> <p>Python和avocado-vt框架提供了大量的封装好的库。利用好这些库，可以大大提升编写用例的效率，精简用例的代码，提高可读性。</p></li></ul> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">import</span> os
<span class="token keyword">import</span> logging

<span class="token keyword">from</span> avocado<span class="token punctuation">.</span>utils <span class="token keyword">import</span> process
<span class="token keyword">from</span> avocado<span class="token punctuation">.</span>utils <span class="token keyword">import</span> path
<span class="token keyword">from</span> avocado<span class="token punctuation">.</span>core <span class="token keyword">import</span> exceptions

<span class="token keyword">import</span> virttest<span class="token punctuation">.</span>utils_libguestfs <span class="token keyword">as</span> lgf
<span class="token keyword">from</span> virttest<span class="token punctuation">.</span>utils_test <span class="token keyword">import</span> libvirt
<span class="token keyword">from</span> virttest<span class="token punctuation">.</span>libvirt_xml <span class="token keyword">import</span> vm_xml
<span class="token keyword">from</span> virttest <span class="token keyword">import</span> virsh
<span class="token keyword">from</span> virttest <span class="token keyword">import</span> data_dir
</code></pre></div><ul><li><p>run函数</p> <p>run函数是avocado-vt用例必不可缺的部分，我们所要做的就是往run函数中添加测试逻辑，run函数提供的test、params、env三个参数将帮助我们完成对虚拟机实例的大量操作以及对测试点的设计和实现。</p> <p>test：avocado/avocado/core/test.py
params: avocado-vt/virttest/utils_params.py
env: avocado-vt/virttest/utils_env.py</p></li></ul> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>test<span class="token punctuation">,</span> params<span class="token punctuation">,</span> env<span class="token punctuation">)</span><span class="token punctuation">:</span>
</code></pre></div><ul><li><p>参数配置</p> <p>包括获取虚拟机实例，从cfg文件获取预置的参数。这部分类似于定义和初始化变量。</p></li></ul> <div class="language-python extra-class"><pre class="language-python"><code>vmname <span class="token operator">=</span> params<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&quot;main_vm&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;avocado-vt-vm1&quot;</span><span class="token punctuation">)</span>
vm <span class="token operator">=</span> env<span class="token punctuation">.</span>get_vm<span class="token punctuation">(</span>vmname<span class="token punctuation">)</span>

output <span class="token operator">=</span> params<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&quot;output_file&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;output&quot;</span><span class="token punctuation">)</span>
output_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>data_dir<span class="token punctuation">.</span>get_tmp_dir<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> output<span class="token punctuation">)</span>
option <span class="token operator">=</span> params<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&quot;option&quot;</span><span class="token punctuation">)</span>
interval <span class="token operator">=</span> params<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&quot;interval&quot;</span><span class="token punctuation">)</span>
test_type <span class="token operator">=</span> params<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&quot;test_type&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span>
vcpu_placement <span class="token operator">=</span> params<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&quot;vcpu_placement&quot;</span><span class="token punctuation">)</span>
vcpu_cur <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>params<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&quot;vcpu_cur&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
vcpu_max <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>params<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&quot;vcpu_max&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
vcpu_live <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>params<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&quot;vcpu_live&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
vm_num <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>params<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&quot;vm_num&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
vmtopnum <span class="token operator">=</span> params<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&quot;vmtopnum&quot;</span><span class="token punctuation">)</span>
</code></pre></div><ul><li><p>对虚拟机实例的操作最常用的库来源</p> <p>libvirt: avocado-vt/virttest/libvirt_vm.py
avocado-vt/virttest/virsh.py
qemu: avocado-vt/virttest/qemu_vm.py</p></li></ul> <h1 id="用例测试点"><a href="#用例测试点" class="header-anchor">#</a> 用例测试点</h1> <ul><li><p>在环境上安装vmtop</p> <p>在hostos上使用“yum install -y vmtop”命令来安装vmtop工具。process.run是python提供的库，这里用于执行shell命令。如果没有成功安装，利用try-except的语法，合理地抛出异常。</p></li></ul> <div class="language-python extra-class"><pre class="language-python"><code><span class="token comment">#Install vmtop command</span>
install_cmd <span class="token operator">=</span> <span class="token string">&quot;yum install -y vmtop&quot;</span>
process<span class="token punctuation">.</span>run<span class="token punctuation">(</span>install_cmd<span class="token punctuation">,</span> shell<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
<span class="token comment">#Find vmtop command</span>
<span class="token keyword">try</span><span class="token punctuation">:</span>
    vmtop <span class="token operator">=</span> path<span class="token punctuation">.</span>find_command<span class="token punctuation">(</span><span class="token string">&quot;vmtop&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">except</span> path<span class="token punctuation">.</span>CmdNotFoundError <span class="token keyword">as</span> info<span class="token punctuation">:</span>
    <span class="token keyword">raise</span> exceptions<span class="token punctuation">.</span>TestSkipError<span class="token punctuation">(</span><span class="token string">&quot;No vmtop command found - %s&quot;</span> <span class="token operator">%</span> info<span class="token punctuation">)</span>
</code></pre></div><ul><li><p>virsh.start</p> <p>利用virsh.start来启动libvirt虚拟机实例。注意libvirt类型的用例需要先用xml文件define一个虚拟机。</p></li></ul> <div class="language-python extra-class"><pre class="language-python"><code>virsh<span class="token punctuation">.</span>start<span class="token punctuation">(</span>vmname<span class="token punctuation">,</span> ignore_status<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
</code></pre></div><ul><li><p>test.fail</p> <p>编写一个vmtop_info函数，获取其返回值，根据返回值来判断是否符合我们的预期。如果不符合，进入test.fail，用例执行失败。这就是一个典型的测试点。</p></li></ul> <div class="language-python extra-class"><pre class="language-python"><code><span class="token comment">#Test vmtop when start vm</span>
res <span class="token operator">=</span> vmtop_info<span class="token punctuation">(</span>vmtop<span class="token punctuation">,</span> output_path<span class="token punctuation">,</span> info_type<span class="token operator">=</span><span class="token string">&quot;Domains&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> <span class="token builtin">int</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token operator">!=</span> vm_num<span class="token punctuation">:</span>
    test<span class="token punctuation">.</span>fail<span class="token punctuation">(</span><span class="token string">&quot;start failed and the res = %s&quot;</span> <span class="token operator">%</span> res<span class="token punctuation">)</span>
</code></pre></div><ul><li><p>vmtop_info</p> <p>该函数使用vmtop命令，将vmtop显示的结果存放到在参数配置阶段就预置好的临时路径output_path里（临时路径的能力是os库提供的，没人希望跑完用例后，产生一堆东西占用磁盘吧，用例执行过程中的临时存放路径很好地解决了这个问题）
通常单独提取出这样一个函数，而不直接在run函数中测试，是为了能更好的复用。如果要对vmtop显示出的其他信息进行验证，只要在这个vmtop_info函数中去扩充即可。</p></li></ul> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">vmtop_info</span><span class="token punctuation">(</span>vmtop<span class="token punctuation">,</span> output_path<span class="token punctuation">,</span> info_type<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;
    Collect and return vmtop infomation
    &quot;&quot;&quot;</span>
    cmd <span class="token operator">=</span> <span class="token string">&quot;%s -b -H -n 1 &gt; %s&quot;</span> <span class="token operator">%</span> <span class="token punctuation">(</span>vmtop<span class="token punctuation">,</span> output_path<span class="token punctuation">)</span>
    process<span class="token punctuation">.</span>run<span class="token punctuation">(</span>cmd<span class="token punctuation">,</span> ignore_status<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> shell<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> info_type <span class="token operator">==</span> <span class="token string">&quot;Domains&quot;</span><span class="token punctuation">:</span>
        cmd <span class="token operator">=</span> <span class="token string">&quot;cat %s | grep  Domains | awk '{ print $2 }'&quot;</span> <span class="token operator">%</span> output_path
        res <span class="token operator">=</span> process<span class="token punctuation">.</span>run<span class="token punctuation">(</span>cmd<span class="token punctuation">,</span> ignore_status<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> shell<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    <span class="token keyword">elif</span> info_type <span class="token operator">==</span> <span class="token string">&quot;Cpu&quot;</span><span class="token punctuation">:</span>
        cmd <span class="token operator">=</span> <span class="token string">&quot;cat %s | grep /KVM | awk 'END{ print NR }'&quot;</span> <span class="token operator">%</span> output_path
        res <span class="token operator">=</span> process<span class="token punctuation">.</span>run<span class="token punctuation">(</span>cmd<span class="token punctuation">,</span> ignore_status<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> shell<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    <span class="token keyword">elif</span> info_type <span class="token operator">==</span> <span class="token string">&quot;Data&quot;</span><span class="token punctuation">:</span>
        cmd <span class="token operator">=</span> <span class="token string">&quot;cat %s | grep  DID&quot;</span> <span class="token operator">%</span> output_path
        res <span class="token operator">=</span> process<span class="token punctuation">.</span>run<span class="token punctuation">(</span>cmd<span class="token punctuation">,</span> ignore_status<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> shell<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> res<span class="token punctuation">.</span>stdout_text
</code></pre></div><ul><li><p>环境清理</p> <p>为了保证每个用例之间不要相互影响，我们需要在用例执行的结尾阶段，清理一下我们的环境。比如清除虚拟机实例，删除磁盘等等</p></li></ul> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">finally</span><span class="token punctuation">:</span>
    <span class="token comment"># Destroy vm_clone</span>
    <span class="token keyword">if</span> test_type <span class="token operator">==</span> <span class="token string">&quot;multi_vms&quot;</span><span class="token punctuation">:</span>
        num <span class="token operator">=</span> <span class="token number">1</span>
        <span class="token keyword">while</span> num <span class="token operator">&lt;</span> vm_num<span class="token punctuation">:</span>
            <span class="token keyword">if</span> virsh<span class="token punctuation">.</span>domain_exists<span class="token punctuation">(</span>vm_clone_name<span class="token punctuation">[</span>num <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token keyword">if</span> virsh<span class="token punctuation">.</span>is_alive<span class="token punctuation">(</span>vm_clone_name<span class="token punctuation">[</span>num <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                    virsh<span class="token punctuation">.</span>destroy<span class="token punctuation">(</span>vm_clone_name<span class="token punctuation">[</span>num <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                    virsh<span class="token punctuation">.</span>remove_domain<span class="token punctuation">(</span>vm_clone_name<span class="token punctuation">[</span>num <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> \
                                        <span class="token string">&quot;--remove-all-storage&quot;</span><span class="token punctuation">,</span> debug<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
            num <span class="token operator">=</span> num <span class="token operator">+</span> <span class="token number">1</span>

    <span class="token keyword">if</span> vm<span class="token punctuation">.</span>is_alive<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        vm<span class="token punctuation">.</span>destroy<span class="token punctuation">(</span><span class="token punctuation">)</span>
    vmxml<span class="token punctuation">.</span>sync<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><ul><li><p>完整的用例源码</p> <p><a href="https://gitee.com/openeuler/tp-libvirt/tree/openEuler-20.03/libvirt/tests/src/virt_cmd/vmtop.py" target="_blank" rel="noopener noreferrer">1.python文件<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> <a href="https://gitee.com/openeuler/tp-libvirt/tree/openEuler-20.03/libvirt/tests/cfg/virt_cmd/vmtop.cfg" target="_blank" rel="noopener noreferrer">2.cfg文件<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></li></ul></div></div> <div class="bottom-line" data-v-8dab3852></div> <div class="disclaimer" data-v-8dab3852>【版权声明】Copyright © 2021 openEuler Community。本文由openEuler社区首发，欢迎遵照 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/legalcode" data-v-8dab3852>CC-BY-SA 4.0</a> 协议规定转载。转载时敬请在正文注明并保留原文链接和作者信息。</div> <div class="disclaimer" data-v-8dab3852>
        【免责声明】本文仅代表作者本人观点，与本网站无关。本网站对文中陈述、观点判断保持中立，不对所包含内容的准确性、可靠性或完整性提供任何明示或暗示的保证。本文仅供读者参考，由此产生的所有法律责任均由读者本人承担。
    </div></div> <div class="footer-wrapper" data-v-0b78f953 data-v-34596062><div class="qr-code" data-v-0b78f953><img src="/img/common/newyear-qr.png" alt data-v-0b78f953> <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyJpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMy1jMDExIDY2LjE0NTY2MSwgMjAxMi8wMi8wNi0xNDo1NjoyNyAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNiAoV2luZG93cykiIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6MTBGRjQxMDc4MTFBMTFFNDg4RUU4NENEQTQxODZDMjciIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6MTBGRjQxMDg4MTFBMTFFNDg4RUU4NENEQTQxODZDMjciPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDoxMEZGNDEwNTgxMUExMUU0ODhFRTg0Q0RBNDE4NkMyNyIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDoxMEZGNDEwNjgxMUExMUU0ODhFRTg0Q0RBNDE4NkMyNyIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/PvJh/V0AAAJMSURBVHja5Je7L0RBFMatCEEiQYcCBYKo6IgQu0SnIhuFXUsUdBL/gEqt8dhVSNajUbJsSFBqiHeBSsUqiHeyvknOTcaYuffsI9nCSX7Z2bsz8317Z848XPF4PCuTkZ2V4cixCl6vl9umCDSBOlBMz57AJTgGz5xOwuHwbwOMaABDoBfUG+qcgU2wBM7TNQSlIAhOwaSNuGVykowsgpJUDXSDa+BPYniHqa0nWQMDYIvzLxzeXgT0J2qgHaykcbKvgjaugUJyne7YAQUcA/MgT/P8C2wzhESdb81z0eeck4EqsSRoGt+DTpqUQRvxINXpoDZqDIJKOwMTNvl9SOUACBnEA1Q+pDa6GDcZEOPTZ2jkpryWU0w2EZLELTNuQ19CI//PUoxoUV+PJq9d9Gl9L5fKshmfTT/VoBkcqAZqGRPMrwj2KL87ictaB+oQcBccP6VUrvRMlKNM8V9aGd+OZQMxZhtrgn1Kz0S5i3ZBTsR0Bi6Z4vJsjyirpt+Qompc6QwcgVubRouKeIh2Oo8iOuywWN2Q1h8Dr2DDZnkdsZntPkU0QBNVF0LjzTQJZw2NGkGrNAw+Q3ZYJtrocKKLWe2ZkEIMQVizH5SBPbDrcMAQJipo39Ad95bBndNuKF71h+EA62FMMI9B/B2McbbjV6ZQouGmvlknon06kqUr+qXdlH0mXKO9/TEF4Qf65+vJnopF+tU45LUpFqhtNNV7QYzyWtwHZuh+YIpTqiPqjtKNiXc1Y8QFmALThquZ+P0EvCTymlz//nb8I8AA0Ah5h1oiyB4AAAAASUVORK5CYII=" alt class="close" data-v-0b78f953></div> <div class="atom" data-v-0b78f953><p data-v-0b78f953>openEuler 是由开放原子开源基金会（OpenAtom Foundation）孵化及运营的开源项目</p> <img src="/atom-pc.png" alt class="atom-pc" data-v-0b78f953></div> <div class="footer-content" data-v-0b78f953><div class="footer-left" data-v-0b78f953><img src="/footer-logo2.svg" class="footer-logo" data-v-0b78f953> <div class="footer-mail" data-v-0b78f953>contact@openeuler.io</div></div> <div class="footer-center" data-v-0b78f953><ul class="right-list" data-v-0b78f953><li data-v-0b78f953><a data-v-0b78f953>品牌</a></li><li data-v-0b78f953><a data-v-0b78f953>隐私政策</a></li><li data-v-0b78f953><a data-v-0b78f953>法律声明</a></li><li data-v-0b78f953><a data-v-0b78f953>服务状态</a></li></ul> <p class="footer-copyright" data-v-0b78f953>
        版权所有 © 2022 openEuler 保留一切权利
      </p></div> <div class="footer-right" data-v-0b78f953><img src="/qrcode.png" class="footer-qrcode" data-v-0b78f953> <div class="qrcode-desc" data-v-0b78f953>扫码关注公众号</div></div></div></div></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.cdfb7ee7.js" defer></script><script src="/assets/js/14.8a38dea1.js" defer></script><script src="/assets/js/316.47a23e9c.js" defer></script>
  </body>
</html>
