<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>iSula与JSON的斗争</title>
    <meta name="generator" content="VuePress 1.5.4">
    <link rel="icon" href="/favicon.ico">
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
  <script src="/js/analytics.js"></script>
  <meta name="keywords" content="openEuler, 操作系统, 开放, 生态, 开源, Linux 开源, OS, open, ecosystem, open source, Linux open source">
  <meta name="baidu-site-verification" content="code-EWzbQRssNU">
    <meta name="description" content="openEuler 是一个开源、免费的 Linux 发行版平台，将通过开放的社区形式与全球的开发者共同构建一个开放、多元和架构包容的软件生态体系。同时，openEuler 也是一个创新的平台，鼓励任何人在该平台上提出新想法、开拓新思路、实践新方案。">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    <meta name="keywords" content="openEuler, 操作系统, 开放, 生态, 开源, Linux 开源, OS, open, ecosystem, open source, Linux open source">
    <meta name="baidu-site-verification" content="code-EWzbQRssNU">
    <link rel="preload" href="/assets/css/0.styles.0df284ed.css" as="style"><link rel="preload" href="/assets/js/app.cdfb7ee7.js" as="script"><link rel="preload" href="/assets/js/14.8a38dea1.js" as="script"><link rel="preload" href="/assets/js/280.a88a25e1.js" as="script">
    <link rel="stylesheet" href="/assets/css/0.styles.0df284ed.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div id="euler-app" data-v-34596062><div class="nav-fill " data-v-fe04bb58 data-v-34596062><div class="nav-wrapper" data-v-fe04bb58><div class="nav-bar" data-v-fe04bb58><img src="/openeuler-logo.png" alt class="nav-logo" data-v-fe04bb58> <img src="/openeuler-logo.png" alt class="nav-logo nav-logo-mobile" data-v-fe04bb58> <ul class="nav-menu" data-v-fe04bb58><li data-v-fe04bb58><a class="menu-link" data-v-fe04bb58>下载
                        <span data-v-fe04bb58></span></a> <div class="sub-menu" data-v-fe04bb58><ul class="sig-menu-content" data-v-fe04bb58><li data-v-fe04bb58>
                                ISO
                            </li><li data-v-fe04bb58>
                                镜像仓列表
                            </li></ul> <span class="submenu-arrow" data-v-fe04bb58></span></div></li><li data-v-fe04bb58><a class="menu-link" data-v-fe04bb58>学习
                        <span data-v-fe04bb58></span></a> <div class="sub-menu" data-v-fe04bb58><ul class="sig-menu-content" data-v-fe04bb58><li data-v-fe04bb58>
                                文档
                            </li><li data-v-fe04bb58>
                                慕课
                            </li><li data-v-fe04bb58>
                                实习
                            </li></ul> <span class="submenu-arrow" data-v-fe04bb58></span></div></li><li data-v-fe04bb58><a class="menu-link menu-active" data-v-fe04bb58>互动
                        <span data-v-fe04bb58></span></a> <div class="sub-menu" data-v-fe04bb58><ul class="sig-menu-content" data-v-fe04bb58><li data-v-fe04bb58>
                                新闻
                            </li><li data-v-fe04bb58>
                                博客
                            </li><li data-v-fe04bb58>
                                直播
                            </li><li data-v-fe04bb58>
                                沙龙
                            </li><li data-v-fe04bb58>
                                峰会
                            </li></ul> <span class="submenu-arrow" data-v-fe04bb58></span></div></li><li data-v-fe04bb58><a class="menu-link" data-v-fe04bb58>社区
                        <span data-v-fe04bb58></span></a> <div class="sub-menu" data-v-fe04bb58><ul class="sig-menu-content" data-v-fe04bb58><li data-v-fe04bb58>
                                贡献攻略
                            </li><li data-v-fe04bb58>
                                行为守则
                            </li><li data-v-fe04bb58>
                                邮件列表
                            </li><li data-v-fe04bb58>
                                个人认证
                            </li></ul> <span class="submenu-arrow" data-v-fe04bb58></span></div></li><li data-v-fe04bb58><a class="menu-link" data-v-fe04bb58>SIG
                        <span data-v-fe04bb58></span></a> <div class="sub-menu" data-v-fe04bb58><ul class="sig-menu-content" data-v-fe04bb58><li data-v-fe04bb58>
                                查看SIG
                            </li><li data-v-fe04bb58>
                                申请流程
                            </li><li data-v-fe04bb58>
                                角色说明
                            </li></ul> <span class="submenu-arrow" data-v-fe04bb58></span></div></li><li data-v-fe04bb58><a class="menu-link" data-v-fe04bb58>探索
                        <span data-v-fe04bb58></span></a> <div class="sub-menu" data-v-fe04bb58><ul class="sig-menu-content" data-v-fe04bb58><li data-v-fe04bb58>
                                A-Tune
                            </li><li data-v-fe04bb58>
                                Bisheng JDK
                            </li><li data-v-fe04bb58>
                                iSula
                            </li><li data-v-fe04bb58>
                                secGear
                            </li><li data-v-fe04bb58>
                                StratoVirt
                            </li><li data-v-fe04bb58>
                                Compass-CI
                            </li><li data-v-fe04bb58>
                                Compliance
                            </li><li data-v-fe04bb58>
                                Pkgship
                            </li></ul> <span class="submenu-arrow" data-v-fe04bb58></span></div></li><li data-v-fe04bb58><a class="menu-link" data-v-fe04bb58>支持
                        <span data-v-fe04bb58></span></a> <div class="sub-menu" data-v-fe04bb58><ul class="sig-menu-content" data-v-fe04bb58><li data-v-fe04bb58>
                                漏洞管理
                            </li><li data-v-fe04bb58>
                                安全公告
                            </li><li data-v-fe04bb58>
                                CVE
                            </li><li data-v-fe04bb58>
                                兼容性列表
                            </li><li data-v-fe04bb58>
                                迁移指南
                            </li></ul> <span class="submenu-arrow" data-v-fe04bb58></span></div></li></ul> <ul class="nav-menu-mobile" style="display:none;" data-v-fe04bb58 data-v-fe04bb58><li data-v-fe04bb58><a class="menu-link" data-v-fe04bb58>下载<i class="icon-arrow" data-v-fe04bb58></i></a> <ul class="sub-menu" style="display:none;" data-v-fe04bb58 data-v-fe04bb58><li data-v-fe04bb58>
                                    ISO
                                </li><li data-v-fe04bb58>
                                    镜像仓列表
                                </li></ul></li><li data-v-fe04bb58><a class="menu-link" data-v-fe04bb58>学习<i class="icon-arrow" data-v-fe04bb58></i></a> <ul class="sub-menu" style="display:none;" data-v-fe04bb58 data-v-fe04bb58><li data-v-fe04bb58>
                                    文档
                                </li><li data-v-fe04bb58>
                                    慕课
                                </li><li data-v-fe04bb58>
                                    实习
                                </li></ul></li><li data-v-fe04bb58><a class="menu-link" data-v-fe04bb58>互动<i class="icon-arrow arrow-active" data-v-fe04bb58></i></a> <ul class="sub-menu" data-v-fe04bb58 data-v-fe04bb58><li data-v-fe04bb58>
                                    新闻
                                </li><li data-v-fe04bb58>
                                    博客
                                </li><li data-v-fe04bb58>
                                    直播
                                </li><li data-v-fe04bb58>
                                    沙龙
                                </li><li data-v-fe04bb58>
                                    峰会
                                </li></ul></li><li data-v-fe04bb58><a class="menu-link" data-v-fe04bb58>社区<i class="icon-arrow" data-v-fe04bb58></i></a> <ul class="sub-menu" style="display:none;" data-v-fe04bb58 data-v-fe04bb58><li data-v-fe04bb58>
                                    贡献攻略
                                </li><li data-v-fe04bb58>
                                    行为守则
                                </li><li data-v-fe04bb58>
                                    邮件列表
                                </li><li data-v-fe04bb58>
                                    个人认证
                                </li></ul></li><li data-v-fe04bb58><a class="menu-link" data-v-fe04bb58>SIG<i class="icon-arrow" data-v-fe04bb58></i></a> <ul class="sub-menu" style="display:none;" data-v-fe04bb58 data-v-fe04bb58><li data-v-fe04bb58>
                                    查看SIG
                                </li><li data-v-fe04bb58>
                                    申请流程
                                </li><li data-v-fe04bb58>
                                    角色说明
                                </li></ul></li><li data-v-fe04bb58><a class="menu-link" data-v-fe04bb58>探索<i class="icon-arrow" data-v-fe04bb58></i></a> <ul class="sub-menu" style="display:none;" data-v-fe04bb58 data-v-fe04bb58><li data-v-fe04bb58>
                                    A-Tune
                                </li><li data-v-fe04bb58>
                                    Bisheng JDK
                                </li><li data-v-fe04bb58>
                                    iSula
                                </li><li data-v-fe04bb58>
                                    secGear
                                </li><li data-v-fe04bb58>
                                    StratoVirt
                                </li><li data-v-fe04bb58>
                                    Compass-CI
                                </li><li data-v-fe04bb58>
                                    Compliance
                                </li><li data-v-fe04bb58>
                                    Pkgship
                                </li></ul></li><li data-v-fe04bb58><a class="menu-link" data-v-fe04bb58>支持<i class="icon-arrow" data-v-fe04bb58></i></a> <ul class="sub-menu" style="display:none;" data-v-fe04bb58 data-v-fe04bb58><li data-v-fe04bb58>
                                    漏洞管理
                                </li><li data-v-fe04bb58>
                                    安全公告
                                </li><li data-v-fe04bb58>
                                    CVE
                                </li><li data-v-fe04bb58>
                                    兼容性列表
                                </li><li data-v-fe04bb58>
                                    迁移指南
                                </li></ul></li> <li data-v-fe04bb58><a class="menu-link" data-v-fe04bb58>源码<i class="icon-arrow" data-v-fe04bb58></i></a> <ul class="sub-menu" style="display:none;" data-v-fe04bb58 data-v-fe04bb58><li data-v-fe04bb58>
                                    代码仓
                                </li><li data-v-fe04bb58>
                                    软件包仓
                                </li><li data-v-fe04bb58>
                                    GitHub镜像仓
                                </li></ul></li></ul> <div data-v-fe04bb58></div> <div class="search-mobile" data-v-fe04bb58><div class="el-input el-input--suffix" data-v-fe04bb58><!----><input type="text" autocomplete="off" placeholder="输入内容" class="el-input__inner"><!----><span class="el-input__suffix"><span class="el-input__suffix-inner"><i class="icon-search el-input__icon" data-v-fe04bb58></i><!----><!----><!----><!----></span><!----></span><!----><!----></div></div> <ul class="nav-other" style="display:;" data-v-fe04bb58><li class="lang" data-v-fe04bb58><span class="icon-lang" data-v-fe04bb58></span> <ul data-v-fe04bb58><li class="lang-list" data-v-fe04bb58>
                            中文
                        </li><li data-v-fe04bb58>
                            English
                        </li><li data-v-fe04bb58>
                            Русский
                        </li> <span class="submenu-arrow" data-v-fe04bb58></span></ul></li> <li data-v-fe04bb58><span data-v-fe04bb58>代码</span> <ul data-v-fe04bb58><li data-v-fe04bb58>
                            代码仓
                        </li><li data-v-fe04bb58>
                            软件包仓
                        </li><li data-v-fe04bb58>
                            GitHub镜像仓
                        </li> <span class="submenu-arrow" data-v-fe04bb58></span></ul></li> <li class="search" data-v-fe04bb58><img src="/search.png" alt data-v-fe04bb58></li></ul> <div class="search-input" style="display:none;" data-v-fe04bb58><div class="el-input el-input--small el-input--suffix" data-v-fe04bb58><!----><input type="text" autocomplete="off" placeholder="输入内容" class="el-input__inner"><!----><span class="el-input__suffix"><span class="el-input__suffix-inner"><i class="icon-search el-input__icon" data-v-fe04bb58></i><!----><!----><!----><!----></span><!----></span><!----><!----></div></div> <ul class="nav-other-mobile nav-other" data-v-fe04bb58><li class="lang" data-v-fe04bb58><span class="icon-lang" data-v-fe04bb58></span> <ul data-v-fe04bb58><li class="lang-list" data-v-fe04bb58>
                            中文
                        </li><li data-v-fe04bb58>
                            English
                        </li><li data-v-fe04bb58>
                            Русский
                        </li> <span class="submenu-arrow" data-v-fe04bb58></span></ul></li> <li class="search" data-v-fe04bb58><span class="icon-search" data-v-fe04bb58></span></li> <li class="menu" data-v-fe04bb58><span class="icon-menu" data-v-fe04bb58></span></li></ul></div></div> <!----></div> <!----> <div id="vuepress-theme-blog__post-layout" class="content" data-v-8dab3852 data-v-34596062><div class="blog-link-post" data-v-8dab3852>
        博客\
    </div> <div class="post-left" data-v-8dab3852><p class="blog-img mobile-hide" data-v-8dab3852><img src="/img/blog/blog_user.png" alt class="middle-img" data-v-8dab3852></p> <p class="mobile-hide" data-v-8dab3852><img src="/img/blog/account.svg" alt class="mobile-middle-img" data-v-8dab3852> <span class="blog-author" data-v-8dab3852>haozi007</span></p> <p class="mobile-hide" data-v-8dab3852><img src="/img/blog/date.svg" alt class="mobile-middle-img" data-v-8dab3852> <span class="blog-date mobile" data-v-8dab3852>2020-09-09</span></p> <p class="mobile-hide" data-v-8dab3852><img src="/img/blog/visibility.svg" alt class="mobile-middle-img" data-v-8dab3852> <span class="blog-date" data-v-8dab3852><span data-v-8dab3852><span data-v-8dab3852>浏览</span> <span data-v-8dab3852></span> <span data-v-8dab3852>次</span></span></span></p> <p class="bottom-line bottom-line-none" data-v-8dab3852></p> <!----> <p class="other-blog-item" data-v-8dab3852></p></div> <div class="post-right" data-v-8dab3852><p class="blog-title" data-v-8dab3852>iSula与JSON的斗争</p> <div class="user-info-mobile" data-v-8dab3852><div class="left" data-v-8dab3852><img src="/img/blog/blog_user.png" alt data-v-8dab3852></div> <div class="right" data-v-8dab3852><p class="name" data-v-8dab3852>haozi007</p> <p class="date-count" data-v-8dab3852><span class="date" data-v-8dab3852>2020-09-09</span> <span class="count" data-v-8dab3852>浏览次</span></p></div></div> <p class="blog-item-tag" data-v-8dab3852><span data-v-8dab3852>标签: </span> <span data-v-8dab3852><span class="tag-item" data-v-8dab3852>iSulad</span> <span data-v-8dab3852>, </span></span><span data-v-8dab3852><span class="tag-item" data-v-8dab3852>JSON</span> <!----></span></p> <p class="bottom-line bottom-line-none" data-v-8dab3852></p> <div id="blog_content" class="markdown content__default" data-v-8dab3852><p>对于各位习惯各种高级语言的伙伴们来说，JSON的解析和生成是如呼吸般简单自然的事情。但是对于C语言，JSON的解析和生成就麻烦了。根本原因是由于C语言不支持反射，没办法对JSON作动态解析和生成。但是，容器引擎中涉及大量的JSON解析和生成。那么，我们为了更好的和JSON进行和谐相处，做了那些努力呢？</p> <p>大体上，iSula经历了几个阶段，为了更好的感受这几个阶段的差距；我觉得通过武器的不同时代来感受一下。</p> <h2 id="冷兵器时代"><a href="#冷兵器时代" class="header-anchor">#</a> 冷兵器时代</h2> <p>C语言还是有一些JSON解析的库的，例如<code>yajl</code>，<code>cjson</code>等等；这些库提供了把JSON字符串解析为tree结构的元素集合，然后通过遍历书可以快速的找到JSON的<code>key/value</code>的对应关系和值。而且也能自己构建对应的元素结合tree，然后生成JSON字符串。那么，如何通过这些库来做JSON和C结构体直接的相互转换呢？</p> <h3 id="用法"><a href="#用法" class="header-anchor">#</a> 用法</h3> <p>以<code>yajl</code>为例，实现一个<code>isula_version</code>结构体的marshal和unmarshal.</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;yajl/yajl_tree.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;yajl/yajl_gen.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>

<span class="token keyword">struct</span> <span class="token class-name">isula_version</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> large<span class="token punctuation">;</span>
    <span class="token keyword">int</span> middle<span class="token punctuation">;</span>
    <span class="token keyword">int</span> small<span class="token punctuation">;</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>version<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">free_isula_version</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">isula_version</span> <span class="token operator">*</span>ptr<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ptr <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">free</span><span class="token punctuation">(</span>ptr<span class="token operator">-&gt;</span>version<span class="token punctuation">)</span><span class="token punctuation">;</span>
    ptr<span class="token operator">-&gt;</span>version <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token function">free</span><span class="token punctuation">(</span>ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">inline</span> yajl_val <span class="token function">get_val</span><span class="token punctuation">(</span>yajl_val tree<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">,</span> yajl_type type<span class="token punctuation">)</span> <span class="token punctuation">{</span>                                                                                     
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>path<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span> name<span class="token punctuation">,</span> <span class="token constant">NULL</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">yajl_tree_get</span><span class="token punctuation">(</span>tree<span class="token punctuation">,</span> path<span class="token punctuation">,</span> type<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">struct</span> <span class="token class-name">isula_version</span> <span class="token operator">*</span><span class="token function">unmarshal</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>json_str<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    yajl_val tree<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">isula_version</span> <span class="token operator">*</span>result <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>json_str <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    result <span class="token operator">=</span> <span class="token function">calloc</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">isula_version</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    tree <span class="token operator">=</span> <span class="token function">yajl_tree_parse</span><span class="token punctuation">(</span>json_str<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>tree <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Invalid json string: %s\n&quot;</span><span class="token punctuation">,</span> json_str<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> err_out<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">{</span>
        yajl_val val <span class="token operator">=</span> <span class="token function">get_val</span><span class="token punctuation">(</span>tree<span class="token punctuation">,</span> <span class="token string">&quot;Large&quot;</span><span class="token punctuation">,</span> yajl_t_number<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>val <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            result<span class="token operator">-&gt;</span>large <span class="token operator">=</span> <span class="token function">YAJL_GET_INTEGER</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">{</span>
        yajl_val val <span class="token operator">=</span> <span class="token function">get_val</span><span class="token punctuation">(</span>tree<span class="token punctuation">,</span> <span class="token string">&quot;Small&quot;</span><span class="token punctuation">,</span> yajl_t_number<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>val <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            result<span class="token operator">-&gt;</span>small <span class="token operator">=</span> <span class="token function">YAJL_GET_INTEGER</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">{</span>
        yajl_val val <span class="token operator">=</span> <span class="token function">get_val</span><span class="token punctuation">(</span>tree<span class="token punctuation">,</span> <span class="token string">&quot;Middle&quot;</span><span class="token punctuation">,</span> yajl_t_number<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>val <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            result<span class="token operator">-&gt;</span>middle <span class="token operator">=</span> <span class="token function">YAJL_GET_INTEGER</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">{</span>
        yajl_val val <span class="token operator">=</span> <span class="token function">get_val</span><span class="token punctuation">(</span>tree<span class="token punctuation">,</span> <span class="token string">&quot;Version&quot;</span><span class="token punctuation">,</span> yajl_t_string<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>val <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">char</span> <span class="token operator">*</span>str <span class="token operator">=</span> <span class="token function">YAJL_GET_STRING</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>
            result<span class="token operator">-&gt;</span>version <span class="token operator">=</span> <span class="token function">strdup</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">goto</span> out<span class="token punctuation">;</span>
err_out<span class="token operator">:</span>
    <span class="token function">free_isula_version</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    result <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
out<span class="token operator">:</span>
    <span class="token function">yajl_tree_free</span><span class="token punctuation">(</span>tree<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">char</span> <span class="token operator">*</span><span class="token function">marshal</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">isula_version</span> <span class="token operator">*</span>ptr<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>result <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>gen_buf <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token class-name">size_t</span> gen_len <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>ptr <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    yajl_gen g <span class="token operator">=</span> <span class="token function">yajl_gen_alloc</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    yajl_gen_status stat <span class="token operator">=</span> yajl_gen_status_ok<span class="token punctuation">;</span>

    stat <span class="token operator">=</span> <span class="token function">yajl_gen_map_open</span><span class="token punctuation">(</span><span class="token punctuation">(</span>yajl_gen<span class="token punctuation">)</span>g<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>stat <span class="token operator">!=</span> yajl_gen_status_ok<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">goto</span> free_out<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/* gen struct items */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ptr<span class="token operator">-&gt;</span>version <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        stat <span class="token operator">=</span> <span class="token function">yajl_gen_string</span><span class="token punctuation">(</span><span class="token punctuation">(</span>yajl_gen<span class="token punctuation">)</span>g<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token string">&quot;Version&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span><span class="token string">&quot;Version&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>yajl_gen_status_ok <span class="token operator">!=</span> stat<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">goto</span> free_out<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        stat <span class="token operator">=</span> <span class="token function">yajl_gen_string</span><span class="token punctuation">(</span><span class="token punctuation">(</span>yajl_gen<span class="token punctuation">)</span>g<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>ptr<span class="token operator">-&gt;</span>version<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>ptr<span class="token operator">-&gt;</span>version<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>yajl_gen_status_ok <span class="token operator">!=</span> stat<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">goto</span> free_out<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    stat <span class="token operator">=</span> <span class="token function">yajl_gen_string</span><span class="token punctuation">(</span><span class="token punctuation">(</span>yajl_gen<span class="token punctuation">)</span>g<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token string">&quot;Large&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span><span class="token string">&quot;Large&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>yajl_gen_status_ok <span class="token operator">!=</span> stat<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">goto</span> free_out<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    stat <span class="token operator">=</span> <span class="token function">yajl_gen_integer</span><span class="token punctuation">(</span><span class="token punctuation">(</span>yajl_gen<span class="token punctuation">)</span>g<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">long</span> <span class="token keyword">long</span> <span class="token keyword">int</span><span class="token punctuation">)</span>ptr<span class="token operator">-&gt;</span>large<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>yajl_gen_status_ok <span class="token operator">!=</span> stat<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">goto</span> free_out<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    stat <span class="token operator">=</span> <span class="token function">yajl_gen_string</span><span class="token punctuation">(</span><span class="token punctuation">(</span>yajl_gen<span class="token punctuation">)</span>g<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token string">&quot;Middle&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span><span class="token string">&quot;Middle&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>yajl_gen_status_ok <span class="token operator">!=</span> stat<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">goto</span> free_out<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    stat <span class="token operator">=</span> <span class="token function">yajl_gen_integer</span><span class="token punctuation">(</span><span class="token punctuation">(</span>yajl_gen<span class="token punctuation">)</span>g<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">long</span> <span class="token keyword">long</span> <span class="token keyword">int</span><span class="token punctuation">)</span>ptr<span class="token operator">-&gt;</span>middle<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>yajl_gen_status_ok <span class="token operator">!=</span> stat<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">goto</span> free_out<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    stat <span class="token operator">=</span> <span class="token function">yajl_gen_string</span><span class="token punctuation">(</span><span class="token punctuation">(</span>yajl_gen<span class="token punctuation">)</span>g<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token string">&quot;Small&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span><span class="token string">&quot;Small&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>yajl_gen_status_ok <span class="token operator">!=</span> stat<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">goto</span> free_out<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    stat <span class="token operator">=</span> <span class="token function">yajl_gen_integer</span><span class="token punctuation">(</span><span class="token punctuation">(</span>yajl_gen<span class="token punctuation">)</span>g<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">long</span> <span class="token keyword">long</span> <span class="token keyword">int</span><span class="token punctuation">)</span>ptr<span class="token operator">-&gt;</span>small<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>yajl_gen_status_ok <span class="token operator">!=</span> stat<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">goto</span> free_out<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    stat <span class="token operator">=</span> <span class="token function">yajl_gen_map_close</span><span class="token punctuation">(</span><span class="token punctuation">(</span>yajl_gen<span class="token punctuation">)</span>g<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>stat <span class="token operator">!=</span> yajl_gen_status_ok<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">goto</span> free_out<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">yajl_gen_get_buf</span><span class="token punctuation">(</span>g<span class="token punctuation">,</span> <span class="token operator">&amp;</span>gen_buf<span class="token punctuation">,</span> <span class="token operator">&amp;</span>gen_len<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>gen_buf <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;gen buf failed\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> free_out<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    result <span class="token operator">=</span> <span class="token function">calloc</span><span class="token punctuation">(</span>gen_len <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;out of memory\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> free_out<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token function">memcpy</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> gen_buf<span class="token punctuation">,</span> gen_len<span class="token punctuation">)</span><span class="token punctuation">;</span>

free_out<span class="token operator">:</span>
    <span class="token function">yajl_gen_clear</span><span class="token punctuation">(</span>g<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">yajl_gen_free</span><span class="token punctuation">(</span>g<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">show_isula_version</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">isula_version</span> <span class="token operator">*</span>ptr<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;iSula version: \n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ptr <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;large: %d\nmiddle: %d\nsmall: %d\n&quot;</span><span class="token punctuation">,</span> ptr<span class="token operator">-&gt;</span>large<span class="token punctuation">,</span> ptr<span class="token operator">-&gt;</span>middle<span class="token punctuation">,</span> ptr<span class="token operator">-&gt;</span>small<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;version: %s\n&quot;</span><span class="token punctuation">,</span> ptr<span class="token operator">-&gt;</span>version<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>json_str <span class="token operator">=</span> <span class="token string">&quot;{\&quot;Version\&quot;:\&quot;1.0.0\&quot;, \&quot;Large\&quot;: 1, \&quot;Middle\&quot;: 0, \&quot;Small\&quot;: 0}&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">isula_version</span> <span class="token operator">*</span>ptr <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>marshaled <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

    <span class="token comment">// step 1: unmarshal json string</span>
    ptr <span class="token operator">=</span> <span class="token function">unmarshal</span><span class="token punctuation">(</span>json_str<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ptr <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;unmarshal failed\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">show_isula_version</span><span class="token punctuation">(</span>ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// step 2: marshal isula version</span>
    <span class="token function">free</span><span class="token punctuation">(</span>ptr<span class="token operator">-&gt;</span>version<span class="token punctuation">)</span><span class="token punctuation">;</span>
    ptr<span class="token operator">-&gt;</span>version <span class="token operator">=</span> <span class="token function">strdup</span><span class="token punctuation">(</span><span class="token string">&quot;2.0.0&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ptr<span class="token operator">-&gt;</span>large <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
    ptr<span class="token operator">-&gt;</span>middle <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    ptr<span class="token operator">-&gt;</span>small <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    marshaled <span class="token operator">=</span> <span class="token function">marshal</span><span class="token punctuation">(</span>ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;marshal isula version:\n\t%s\n&quot;</span><span class="token punctuation">,</span> marshaled<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">free</span><span class="token punctuation">(</span>marshaled<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">free_isula_version</span><span class="token punctuation">(</span>ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>执行效果如下：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ ./a.out 
iSula version: 
large: <span class="token number">1</span>
middle: <span class="token number">0</span>
small: <span class="token number">0</span>
version: <span class="token number">1.0</span>.0
marshal isula version:
	<span class="token punctuation">{</span><span class="token string">&quot;Version&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;2.0.0&quot;</span>,<span class="token string">&quot;Large&quot;</span>:2,<span class="token string">&quot;Middle&quot;</span>:1,<span class="token string">&quot;Small&quot;</span>:1<span class="token punctuation">}</span>
</code></pre></div><p>这种方式虽然没法和支持动态解析的语言一样高效简单，但是也算完成了任务。如果动态解析是热兵器，这个勉强能算是长矛了。</p> <h3 id="缺陷"><a href="#缺陷" class="header-anchor">#</a> 缺陷</h3> <p>从示例来看，完成一个结构体和JSON的映射大概需要160行左右的代码。而上面只是一个简单的结构体，而且有的项目有很多这种结构体需要做映射。这种原始的方式在大型项目中很难保证参与人员代码质量可控；而且效率低下。主要的缺陷总结如下：</p> <ul><li>映射工作量较大；</li> <li>对每种结构体需要单独适配代码，无法实现自动化；</li> <li>效率低下；</li> <li>代码质量不可控；</li></ul> <h2 id="伪热兵器时代"><a href="#伪热兵器时代" class="header-anchor">#</a> 伪热兵器时代</h2> <p>由于C不支持反射，没法做到动态解析。但是可以通过其他途径简化解析流程、提高效率、实现自动化以及实现代码质量可控。为了避免重复造论子，17年的时候发现了<a href="https://github.com/containers/libocispec" target="_blank" rel="noopener noreferrer">libocispec项目<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，提供了一个解决C语言JSON映射的思路：</p> <ul><li>通过<a href="http://json-schema.org/" target="_blank" rel="noopener noreferrer">json schema<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>描述JSON字符串的结构信息；</li> <li>通过python解析<code>json schema</code>信息；</li> <li>根据<code>json schema</code>信息自动生成C结构体和JSON的映射代码；</li></ul> <p>这种方式，可以解决上面的上一章节的几个缺陷：</p> <ul><li>工作量大大减小，这需要写好<code>json schema</code>文件即可；</li> <li>自动化解析代码工作；</li> <li>效率很高；</li> <li>代码质量可控，取决于于生成框架的质量；</li></ul> <p><strong>注：libocispec早期只能用于解析oci spec的json，在我们发现之后，多个开发人员参与社区，提供了大量的功能升级，才有了今天的强大能力。</strong></p> <h3 id="isula集成libocispec结构"><a href="#isula集成libocispec结构" class="header-anchor">#</a> iSula集成libocispec结构</h3> <p>iSula当前把JSON映射相关的代码，统一放到<code>lcr</code>项目中进行管理，通过一个动态库和头文件提供相应功能。</p> <p>生成代码的开源python框架结构如下：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ tree third_party/libocispec/
third_party/libocispec/
├── CMakeLists.txt
├── common_c.py
├── common_h.py
├── generate.py
├── headers.py
├── helpers.py
├── read_file.c
├── read_file.h
└── sources.py
</code></pre></div><p><code>json schema</code>文件存放结构（由于iSula涉及的所有JSON结构都在该目录下，所以存在大量的schema文件）如下：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ tree -d <span class="token number">1</span> src/json/schema/
src/json/schema/
├── cni
│   └── network
├── container
├── cri
├── docker
│   ├── image
│   └── types
├── embedded
├── <span class="token function">host</span>
├── image
├── imagetool
├── logger
├── oci
│   ├── image
│   └── runtime
├── plugin
├── registry
├── shim
│   └── client
└── storage
</code></pre></div><p>然后在<code>cmake</code>的时候，会触发python框架，根据schema目录下面所有的schema来生成对应的映射代码。会看到如下提示信息：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token function">mkdir</span> build
$ <span class="token builtin class-name">cd</span> build
$ cmake <span class="token punctuation">..</span>/
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>
Reflection:	isulad-daemon-configs.json                                   Success
Reflection:	timestamp.json                                               Success
Reflection:	web-signature.json                                           Success
Reflection:	host-config.json                                             Success
Reflection:	defs.json                                                    Success
Reflection:	config.json                                                  Success
Reflection:	manifest.json                                                Success
Reflection:	layers.json                                                  Success
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>
</code></pre></div><h3 id="用法-2"><a href="#用法-2" class="header-anchor">#</a> 用法</h3> <p>那么，现在我们如果需要对一个新的结构体和JSON进行映射，需要做的事情就是在<code>json schema</code>目录下面新增一个对应的schema文件即可。这里以上一章节的<code>isula_version</code>为例。</p> <p>新增schema文件<code>isula_version.json</code>：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token function">cat</span> <span class="token punctuation">..</span>/src/json/schema/isula_version.json
<span class="token punctuation">{</span>
	<span class="token string">&quot;<span class="token variable">$schema</span>&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;http://json-schema.org/draft-04/schema#&quot;</span>,
	<span class="token string">&quot;type&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;object&quot;</span>,
	<span class="token string">&quot;properties&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
		<span class="token string">&quot;Version&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
			<span class="token string">&quot;type&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;string&quot;</span>
		<span class="token punctuation">}</span>,
        <span class="token string">&quot;Large&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
			<span class="token string">&quot;type&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;int32&quot;</span>
        <span class="token punctuation">}</span>,
        <span class="token string">&quot;Middle&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
			<span class="token string">&quot;type&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;int32&quot;</span>
        <span class="token punctuation">}</span>,
        <span class="token string">&quot;Small&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
			<span class="token string">&quot;type&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;int32&quot;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>重新<code>cmake</code>，可以看到新生成了两个文件：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token function">ls</span> build/json/isula_version.*
build/json/isula_version.c  build/json/isula_version.h
</code></pre></div><p>生成的代码对外的接口如下：</p> <div class="language-c extra-class"><pre class="language-c"><code>$ cat build<span class="token operator">/</span>json<span class="token operator">/</span>isula_version<span class="token punctuation">.</span>h 
<span class="token comment">// Generated from isula_version.json. Do not edit!</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">ISULA_VERSION_SCHEMA_H</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ISULA_VERSION_SCHEMA_H</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdint.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;json_common.h&quot;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">__cplusplus</span></span>
<span class="token keyword">extern</span> <span class="token string">&quot;C&quot;</span> <span class="token punctuation">{</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>version<span class="token punctuation">;</span>

    <span class="token class-name">int32_t</span> large<span class="token punctuation">;</span>

    <span class="token class-name">int32_t</span> middle<span class="token punctuation">;</span>

    <span class="token class-name">int32_t</span> small<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
isula_version<span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">free_isula_version</span><span class="token punctuation">(</span>isula_version <span class="token operator">*</span>ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>

isula_version <span class="token operator">*</span><span class="token function">make_isula_version</span><span class="token punctuation">(</span>yajl_val tree<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">parser_context</span> <span class="token operator">*</span>ctx<span class="token punctuation">,</span> parser_error <span class="token operator">*</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>

yajl_gen_status <span class="token function">gen_isula_version</span><span class="token punctuation">(</span>yajl_gen g<span class="token punctuation">,</span> <span class="token keyword">const</span> isula_version <span class="token operator">*</span>ptr<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">parser_context</span> <span class="token operator">*</span>ctx<span class="token punctuation">,</span> parser_error <span class="token operator">*</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>

isula_version <span class="token operator">*</span><span class="token function">isula_version_parse_file</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>filename<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">parser_context</span> <span class="token operator">*</span>ctx<span class="token punctuation">,</span> parser_error <span class="token operator">*</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>

isula_version <span class="token operator">*</span><span class="token function">isula_version_parse_file_stream</span><span class="token punctuation">(</span>FILE <span class="token operator">*</span>stream<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">parser_context</span> <span class="token operator">*</span>ctx<span class="token punctuation">,</span> parser_error <span class="token operator">*</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>

isula_version <span class="token operator">*</span><span class="token function">isula_version_parse_data</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>jsondata<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">parser_context</span> <span class="token operator">*</span>ctx<span class="token punctuation">,</span> parser_error <span class="token operator">*</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">char</span> <span class="token operator">*</span><span class="token function">isula_version_generate_json</span><span class="token punctuation">(</span><span class="token keyword">const</span> isula_version <span class="token operator">*</span>ptr<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">parser_context</span> <span class="token operator">*</span>ctx<span class="token punctuation">,</span> parser_error <span class="token operator">*</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">__cplusplus</span></span>
<span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

</code></pre></div><p>测试用例：</p> <div class="language-c extra-class"><pre class="language-c"><code>$ cat test<span class="token punctuation">.</span>c 
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;isula_version.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>

<span class="token keyword">void</span> <span class="token function">show_isula_version</span><span class="token punctuation">(</span><span class="token keyword">const</span> isula_version <span class="token operator">*</span>ptr<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;iSula version: \n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ptr <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;large: %d\nmiddle: %d\nsmall: %d\n&quot;</span><span class="token punctuation">,</span> ptr<span class="token operator">-&gt;</span>large<span class="token punctuation">,</span> ptr<span class="token operator">-&gt;</span>middle<span class="token punctuation">,</span> ptr<span class="token operator">-&gt;</span>small<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;version: %s\n&quot;</span><span class="token punctuation">,</span> ptr<span class="token operator">-&gt;</span>version<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>json_str <span class="token operator">=</span> <span class="token string">&quot;{\&quot;Version\&quot;:\&quot;1.0.0\&quot;, \&quot;Large\&quot;: 1, \&quot;Middle\&quot;: 0, \&quot;Small\&quot;: 0}&quot;</span><span class="token punctuation">;</span>
    isula_version <span class="token operator">*</span>ptr <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    parser_error err <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>marshaled <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

    <span class="token comment">// step 1: unmarshal</span>
    ptr <span class="token operator">=</span> <span class="token function">isula_version_parse_data</span><span class="token punctuation">(</span>json_str<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ptr <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">show_isula_version</span><span class="token punctuation">(</span>ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// step 2: marshal</span>
    <span class="token function">free</span><span class="token punctuation">(</span>ptr<span class="token operator">-&gt;</span>version<span class="token punctuation">)</span><span class="token punctuation">;</span>
    ptr<span class="token operator">-&gt;</span>version <span class="token operator">=</span> <span class="token function">strdup</span><span class="token punctuation">(</span><span class="token string">&quot;2.0.0&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ptr<span class="token operator">-&gt;</span>large <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
    ptr<span class="token operator">-&gt;</span>middle <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    ptr<span class="token operator">-&gt;</span>small <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    marshaled <span class="token operator">=</span> <span class="token function">isula_version_generate_json</span><span class="token punctuation">(</span>ptr<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ptr <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">goto</span> out<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;marshal isula version:\n\t%s\n&quot;</span><span class="token punctuation">,</span> marshaled<span class="token punctuation">)</span><span class="token punctuation">;</span>

out<span class="token operator">:</span>
    <span class="token function">free</span><span class="token punctuation">(</span>marshaled<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">free_isula_version</span><span class="token punctuation">(</span>ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>执行结果如下：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ ./a.out 
iSula version: 
large: <span class="token number">1</span>
middle: <span class="token number">0</span>
small: <span class="token number">0</span>
version: <span class="token number">1.0</span>.0
marshal isula version:
	<span class="token punctuation">{</span>
    <span class="token string">&quot;Version&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;2.0.0&quot;</span>,
    <span class="token string">&quot;Large&quot;</span><span class="token builtin class-name">:</span> <span class="token number">2</span>,
    <span class="token string">&quot;Middle&quot;</span><span class="token builtin class-name">:</span> <span class="token number">1</span>,
    <span class="token string">&quot;Small&quot;</span><span class="token builtin class-name">:</span> <span class="token number">1</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="缺陷-2"><a href="#缺陷-2" class="header-anchor">#</a> 缺陷</h3> <p>通过libocispec可以实现接近于高级语言的<code>marshal</code>和<code>unmarshal</code>了，只需要简单编写schema文件即可，极大的提高了效率，并且依托开源社区可以提高代码质量。但是，还是存在一些缺陷。</p> <p>例如<code>golang</code>中，marshal之后的结构体可以通过map[string]interface保存，可以完整的记录JSON字符串中的信息。而我们当前的实现，只能根据schema来解析JSON字符串，因此，存在信息丢失的情况。有些场景，规范只规定了主体的JSON结构，并且支持拓展配置，例如CNI规范。</p> <h2 id="近乎热兵器时代"><a href="#近乎热兵器时代" class="header-anchor">#</a> 近乎热兵器时代</h2> <p>为了解决信息丢失的问题，我们通过在结构体中记录原始的元素集合tree的方案，unmarshal的时候不会丢失原始信息，marshal的时候解析记录的元素信息，从而实现原始数据完整的传递。</p> <p>具体解决方案见官方PR：https://github.com/containers/libocispec/pull/56</p> <h3 id="用法-3"><a href="#用法-3" class="header-anchor">#</a> 用法</h3> <p>使用方式和上面的基本一致，差异主要包括以下几部分：</p> <ol><li><p>生成的代码有部分差异（_residual）；</p> <div class="language-c extra-class"><pre class="language-c"><code>$ cat isula_version<span class="token punctuation">.</span>h 
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>version<span class="token punctuation">;</span>

    <span class="token class-name">int32_t</span> large<span class="token punctuation">;</span>

    <span class="token class-name">int32_t</span> middle<span class="token punctuation">;</span>

    <span class="token class-name">int32_t</span> small<span class="token punctuation">;</span>

    yajl_val _residual<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
isula_version<span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre></div></li> <li><p>解析是需要指定<code>struct parser_context</code>参数为<code>OPT_PARSE_FULLKEY</code>；</p> <div class="language-c extra-class"><pre class="language-c"><code>$ cat test<span class="token punctuation">.</span>c 
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;isula_version.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>

<span class="token keyword">void</span> <span class="token function">show_isula_version</span><span class="token punctuation">(</span><span class="token keyword">const</span> isula_version <span class="token operator">*</span>ptr<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;iSula version: \n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ptr <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;large: %d\nmiddle: %d\nsmall: %d\n&quot;</span><span class="token punctuation">,</span> ptr<span class="token operator">-&gt;</span>large<span class="token punctuation">,</span> ptr<span class="token operator">-&gt;</span>middle<span class="token punctuation">,</span> ptr<span class="token operator">-&gt;</span>small<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;version: %s\n&quot;</span><span class="token punctuation">,</span> ptr<span class="token operator">-&gt;</span>version<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>json_str <span class="token operator">=</span> <span class="token string">&quot;{\&quot;Version\&quot;:\&quot;1.0.0\&quot;, \&quot;Large\&quot;: 1, \&quot;Middle\&quot;: 0, \&quot;Small\&quot;: 0, \&quot;resi_int\&quot;: 1, \&quot;resi_str\&quot;: \&quot;test\&quot;}&quot;</span><span class="token punctuation">;</span>
    isula_version <span class="token operator">*</span>ptr <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    parser_error err <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>marshaled <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">parser_context</span> ctx<span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span>options <span class="token operator">=</span> OPT_PARSE_FULLKEY<span class="token punctuation">;</span>

    <span class="token comment">// step 1: unmarshal</span>
    ptr <span class="token operator">=</span> <span class="token function">isula_version_parse_data</span><span class="token punctuation">(</span>json_str<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ctx<span class="token punctuation">,</span> <span class="token operator">&amp;</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ptr <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">show_isula_version</span><span class="token punctuation">(</span>ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// step 2: marshal</span>
    <span class="token function">free</span><span class="token punctuation">(</span>ptr<span class="token operator">-&gt;</span>version<span class="token punctuation">)</span><span class="token punctuation">;</span>
    ptr<span class="token operator">-&gt;</span>version <span class="token operator">=</span> <span class="token function">strdup</span><span class="token punctuation">(</span><span class="token string">&quot;2.0.0&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ptr<span class="token operator">-&gt;</span>large <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
    ptr<span class="token operator">-&gt;</span>middle <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    ptr<span class="token operator">-&gt;</span>small <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    marshaled <span class="token operator">=</span> <span class="token function">isula_version_generate_json</span><span class="token punctuation">(</span>ptr<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ctx<span class="token punctuation">,</span> <span class="token operator">&amp;</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ptr <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">goto</span> out<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;marshal isula version:\n\t%s\n&quot;</span><span class="token punctuation">,</span> marshaled<span class="token punctuation">)</span><span class="token punctuation">;</span>

out<span class="token operator">:</span>
    <span class="token function">free</span><span class="token punctuation">(</span>marshaled<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">free_isula_version</span><span class="token punctuation">(</span>ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>效果如下</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ ./a.out 
iSula version: 
large: <span class="token number">1</span>
middle: <span class="token number">0</span>
small: <span class="token number">0</span>
version: <span class="token number">1.0</span>.0
marshal isula version:
	<span class="token punctuation">{</span>
    <span class="token string">&quot;Version&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;2.0.0&quot;</span>,
    <span class="token string">&quot;Large&quot;</span><span class="token builtin class-name">:</span> <span class="token number">2</span>,
    <span class="token string">&quot;Middle&quot;</span><span class="token builtin class-name">:</span> <span class="token number">1</span>,
    <span class="token string">&quot;Small&quot;</span><span class="token builtin class-name">:</span> <span class="token number">1</span>,
    <span class="token string">&quot;resi_int&quot;</span><span class="token builtin class-name">:</span> <span class="token number">1</span>,
    <span class="token string">&quot;resi_str&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;test&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ol> <p>可以看到拓展的信息，完整的传递下去了。<strong>通过这种方式完美的解决了CNI的拓展配置的支持，从而解决了iSulad动态支持多种插件的技术瓶颈。</strong></p> <h3 id="缺陷-3"><a href="#缺陷-3" class="header-anchor">#</a> 缺陷</h3> <p>上面的方案已经基本和支持反射的语言实现的功能相近了，但是，还是存在部分缺陷的。例如，动态修改JSON结构的数据会比较麻烦，需要对底层的解析库比较了解，而且比较麻烦。</p> <h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2> <p>虽然当前的框架还有一些缺陷，但是，我们的目标并不是实现一个完美的JSON和C结构体的映射框架，而是解决容器引擎使用JSON的问题。而上面的方案，已经完全满足iSula当前的需求。</p> <p>因此，目前没有进一步优化的需求。如果后续使用场景或者其他用户有需求，可以到<a href="https://github.com/containers/libocispec" target="_blank" rel="noopener noreferrer">libocispec的社区<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>进行进一步的优化。</p> <h1 id="参考文章"><a href="#参考文章" class="header-anchor">#</a> 参考文章</h1> <ul><li>https://github.com/containers/libocispec</li> <li>http://json-schema.org/</li> <li>https://github.com/lloyd/yajl/tree/master/example</li></ul></div></div> <div class="bottom-line" data-v-8dab3852></div> <div class="disclaimer" data-v-8dab3852>【版权声明】Copyright © 2021 openEuler Community。本文由openEuler社区首发，欢迎遵照 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/legalcode" data-v-8dab3852>CC-BY-SA 4.0</a> 协议规定转载。转载时敬请在正文注明并保留原文链接和作者信息。</div> <div class="disclaimer" data-v-8dab3852>
        【免责声明】本文仅代表作者本人观点，与本网站无关。本网站对文中陈述、观点判断保持中立，不对所包含内容的准确性、可靠性或完整性提供任何明示或暗示的保证。本文仅供读者参考，由此产生的所有法律责任均由读者本人承担。
    </div></div> <div class="footer-wrapper" data-v-0b78f953 data-v-34596062><div class="qr-code" data-v-0b78f953><img src="/img/common/newyear-qr.png" alt data-v-0b78f953> <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyJpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMy1jMDExIDY2LjE0NTY2MSwgMjAxMi8wMi8wNi0xNDo1NjoyNyAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNiAoV2luZG93cykiIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6MTBGRjQxMDc4MTFBMTFFNDg4RUU4NENEQTQxODZDMjciIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6MTBGRjQxMDg4MTFBMTFFNDg4RUU4NENEQTQxODZDMjciPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDoxMEZGNDEwNTgxMUExMUU0ODhFRTg0Q0RBNDE4NkMyNyIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDoxMEZGNDEwNjgxMUExMUU0ODhFRTg0Q0RBNDE4NkMyNyIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/PvJh/V0AAAJMSURBVHja5Je7L0RBFMatCEEiQYcCBYKo6IgQu0SnIhuFXUsUdBL/gEqt8dhVSNajUbJsSFBqiHeBSsUqiHeyvknOTcaYuffsI9nCSX7Z2bsz8317Z848XPF4PCuTkZ2V4cixCl6vl9umCDSBOlBMz57AJTgGz5xOwuHwbwOMaABDoBfUG+qcgU2wBM7TNQSlIAhOwaSNuGVykowsgpJUDXSDa+BPYniHqa0nWQMDYIvzLxzeXgT0J2qgHaykcbKvgjaugUJyne7YAQUcA/MgT/P8C2wzhESdb81z0eeck4EqsSRoGt+DTpqUQRvxINXpoDZqDIJKOwMTNvl9SOUACBnEA1Q+pDa6GDcZEOPTZ2jkpryWU0w2EZLELTNuQ19CI//PUoxoUV+PJq9d9Gl9L5fKshmfTT/VoBkcqAZqGRPMrwj2KL87ictaB+oQcBccP6VUrvRMlKNM8V9aGd+OZQMxZhtrgn1Kz0S5i3ZBTsR0Bi6Z4vJsjyirpt+Qompc6QwcgVubRouKeIh2Oo8iOuywWN2Q1h8Dr2DDZnkdsZntPkU0QBNVF0LjzTQJZw2NGkGrNAw+Q3ZYJtrocKKLWe2ZkEIMQVizH5SBPbDrcMAQJipo39Ad95bBndNuKF71h+EA62FMMI9B/B2McbbjV6ZQouGmvlknon06kqUr+qXdlH0mXKO9/TEF4Qf65+vJnopF+tU45LUpFqhtNNV7QYzyWtwHZuh+YIpTqiPqjtKNiXc1Y8QFmALThquZ+P0EvCTymlz//nb8I8AA0Ah5h1oiyB4AAAAASUVORK5CYII=" alt class="close" data-v-0b78f953></div> <div class="atom" data-v-0b78f953><p data-v-0b78f953>openEuler 是由开放原子开源基金会（OpenAtom Foundation）孵化及运营的开源项目</p> <img src="/atom-pc.png" alt class="atom-pc" data-v-0b78f953></div> <div class="footer-content" data-v-0b78f953><div class="footer-left" data-v-0b78f953><img src="/footer-logo2.svg" class="footer-logo" data-v-0b78f953> <div class="footer-mail" data-v-0b78f953>contact@openeuler.io</div></div> <div class="footer-center" data-v-0b78f953><ul class="right-list" data-v-0b78f953><li data-v-0b78f953><a data-v-0b78f953>品牌</a></li><li data-v-0b78f953><a data-v-0b78f953>隐私政策</a></li><li data-v-0b78f953><a data-v-0b78f953>法律声明</a></li><li data-v-0b78f953><a data-v-0b78f953>服务状态</a></li></ul> <p class="footer-copyright" data-v-0b78f953>
        版权所有 © 2022 openEuler 保留一切权利
      </p></div> <div class="footer-right" data-v-0b78f953><img src="/qrcode.png" class="footer-qrcode" data-v-0b78f953> <div class="qrcode-desc" data-v-0b78f953>扫码关注公众号</div></div></div></div></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.cdfb7ee7.js" defer></script><script src="/assets/js/14.8a38dea1.js" defer></script><script src="/assets/js/280.a88a25e1.js" defer></script>
  </body>
</html>
