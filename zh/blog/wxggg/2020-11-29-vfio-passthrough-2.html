<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>VFIO设备直通原理（二）</title>
    <meta name="generator" content="VuePress 1.5.4">
    <link rel="icon" href="/favicon.ico">
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
  <script src="/js/analytics.js"></script>
  <meta name="keywords" content="openEuler, 操作系统, 开放, 生态, 开源, Linux 开源, OS, open, ecosystem, open source, Linux open source">
  <meta name="baidu-site-verification" content="code-EWzbQRssNU">
    <meta name="description" content="openEuler 是一个开源、免费的 Linux 发行版平台，将通过开放的社区形式与全球的开发者共同构建一个开放、多元和架构包容的软件生态体系。同时，openEuler 也是一个创新的平台，鼓励任何人在该平台上提出新想法、开拓新思路、实践新方案。">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    <meta name="keywords" content="openEuler, 操作系统, 开放, 生态, 开源, Linux 开源, OS, open, ecosystem, open source, Linux open source">
    <meta name="baidu-site-verification" content="code-EWzbQRssNU">
    <link rel="preload" href="/assets/css/0.styles.0df284ed.css" as="style"><link rel="preload" href="/assets/js/app.cdfb7ee7.js" as="script"><link rel="preload" href="/assets/js/14.8a38dea1.js" as="script"><link rel="preload" href="/assets/js/312.77db13fd.js" as="script">
    <link rel="stylesheet" href="/assets/css/0.styles.0df284ed.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div id="euler-app" data-v-34596062><div class="nav-fill " data-v-fe04bb58 data-v-34596062><div class="nav-wrapper" data-v-fe04bb58><div class="nav-bar" data-v-fe04bb58><img src="/openeuler-logo.png" alt class="nav-logo" data-v-fe04bb58> <img src="/openeuler-logo.png" alt class="nav-logo nav-logo-mobile" data-v-fe04bb58> <ul class="nav-menu" data-v-fe04bb58><li data-v-fe04bb58><a class="menu-link" data-v-fe04bb58>下载
                        <span data-v-fe04bb58></span></a> <div class="sub-menu" data-v-fe04bb58><ul class="sig-menu-content" data-v-fe04bb58><li data-v-fe04bb58>
                                ISO
                            </li><li data-v-fe04bb58>
                                镜像仓列表
                            </li></ul> <span class="submenu-arrow" data-v-fe04bb58></span></div></li><li data-v-fe04bb58><a class="menu-link" data-v-fe04bb58>学习
                        <span data-v-fe04bb58></span></a> <div class="sub-menu" data-v-fe04bb58><ul class="sig-menu-content" data-v-fe04bb58><li data-v-fe04bb58>
                                文档
                            </li><li data-v-fe04bb58>
                                慕课
                            </li><li data-v-fe04bb58>
                                实习
                            </li></ul> <span class="submenu-arrow" data-v-fe04bb58></span></div></li><li data-v-fe04bb58><a class="menu-link menu-active" data-v-fe04bb58>互动
                        <span data-v-fe04bb58></span></a> <div class="sub-menu" data-v-fe04bb58><ul class="sig-menu-content" data-v-fe04bb58><li data-v-fe04bb58>
                                新闻
                            </li><li data-v-fe04bb58>
                                博客
                            </li><li data-v-fe04bb58>
                                直播
                            </li><li data-v-fe04bb58>
                                沙龙
                            </li><li data-v-fe04bb58>
                                峰会
                            </li></ul> <span class="submenu-arrow" data-v-fe04bb58></span></div></li><li data-v-fe04bb58><a class="menu-link" data-v-fe04bb58>社区
                        <span data-v-fe04bb58></span></a> <div class="sub-menu" data-v-fe04bb58><ul class="sig-menu-content" data-v-fe04bb58><li data-v-fe04bb58>
                                贡献攻略
                            </li><li data-v-fe04bb58>
                                行为守则
                            </li><li data-v-fe04bb58>
                                邮件列表
                            </li><li data-v-fe04bb58>
                                个人认证
                            </li></ul> <span class="submenu-arrow" data-v-fe04bb58></span></div></li><li data-v-fe04bb58><a class="menu-link" data-v-fe04bb58>SIG
                        <span data-v-fe04bb58></span></a> <div class="sub-menu" data-v-fe04bb58><ul class="sig-menu-content" data-v-fe04bb58><li data-v-fe04bb58>
                                查看SIG
                            </li><li data-v-fe04bb58>
                                申请流程
                            </li><li data-v-fe04bb58>
                                角色说明
                            </li></ul> <span class="submenu-arrow" data-v-fe04bb58></span></div></li><li data-v-fe04bb58><a class="menu-link" data-v-fe04bb58>探索
                        <span data-v-fe04bb58></span></a> <div class="sub-menu" data-v-fe04bb58><ul class="sig-menu-content" data-v-fe04bb58><li data-v-fe04bb58>
                                A-Tune
                            </li><li data-v-fe04bb58>
                                Bisheng JDK
                            </li><li data-v-fe04bb58>
                                iSula
                            </li><li data-v-fe04bb58>
                                secGear
                            </li><li data-v-fe04bb58>
                                StratoVirt
                            </li><li data-v-fe04bb58>
                                Compass-CI
                            </li><li data-v-fe04bb58>
                                Compliance
                            </li><li data-v-fe04bb58>
                                Pkgship
                            </li></ul> <span class="submenu-arrow" data-v-fe04bb58></span></div></li><li data-v-fe04bb58><a class="menu-link" data-v-fe04bb58>支持
                        <span data-v-fe04bb58></span></a> <div class="sub-menu" data-v-fe04bb58><ul class="sig-menu-content" data-v-fe04bb58><li data-v-fe04bb58>
                                漏洞管理
                            </li><li data-v-fe04bb58>
                                安全公告
                            </li><li data-v-fe04bb58>
                                CVE
                            </li><li data-v-fe04bb58>
                                兼容性列表
                            </li><li data-v-fe04bb58>
                                迁移指南
                            </li></ul> <span class="submenu-arrow" data-v-fe04bb58></span></div></li></ul> <ul class="nav-menu-mobile" style="display:none;" data-v-fe04bb58 data-v-fe04bb58><li data-v-fe04bb58><a class="menu-link" data-v-fe04bb58>下载<i class="icon-arrow" data-v-fe04bb58></i></a> <ul class="sub-menu" style="display:none;" data-v-fe04bb58 data-v-fe04bb58><li data-v-fe04bb58>
                                    ISO
                                </li><li data-v-fe04bb58>
                                    镜像仓列表
                                </li></ul></li><li data-v-fe04bb58><a class="menu-link" data-v-fe04bb58>学习<i class="icon-arrow" data-v-fe04bb58></i></a> <ul class="sub-menu" style="display:none;" data-v-fe04bb58 data-v-fe04bb58><li data-v-fe04bb58>
                                    文档
                                </li><li data-v-fe04bb58>
                                    慕课
                                </li><li data-v-fe04bb58>
                                    实习
                                </li></ul></li><li data-v-fe04bb58><a class="menu-link" data-v-fe04bb58>互动<i class="icon-arrow arrow-active" data-v-fe04bb58></i></a> <ul class="sub-menu" data-v-fe04bb58 data-v-fe04bb58><li data-v-fe04bb58>
                                    新闻
                                </li><li data-v-fe04bb58>
                                    博客
                                </li><li data-v-fe04bb58>
                                    直播
                                </li><li data-v-fe04bb58>
                                    沙龙
                                </li><li data-v-fe04bb58>
                                    峰会
                                </li></ul></li><li data-v-fe04bb58><a class="menu-link" data-v-fe04bb58>社区<i class="icon-arrow" data-v-fe04bb58></i></a> <ul class="sub-menu" style="display:none;" data-v-fe04bb58 data-v-fe04bb58><li data-v-fe04bb58>
                                    贡献攻略
                                </li><li data-v-fe04bb58>
                                    行为守则
                                </li><li data-v-fe04bb58>
                                    邮件列表
                                </li><li data-v-fe04bb58>
                                    个人认证
                                </li></ul></li><li data-v-fe04bb58><a class="menu-link" data-v-fe04bb58>SIG<i class="icon-arrow" data-v-fe04bb58></i></a> <ul class="sub-menu" style="display:none;" data-v-fe04bb58 data-v-fe04bb58><li data-v-fe04bb58>
                                    查看SIG
                                </li><li data-v-fe04bb58>
                                    申请流程
                                </li><li data-v-fe04bb58>
                                    角色说明
                                </li></ul></li><li data-v-fe04bb58><a class="menu-link" data-v-fe04bb58>探索<i class="icon-arrow" data-v-fe04bb58></i></a> <ul class="sub-menu" style="display:none;" data-v-fe04bb58 data-v-fe04bb58><li data-v-fe04bb58>
                                    A-Tune
                                </li><li data-v-fe04bb58>
                                    Bisheng JDK
                                </li><li data-v-fe04bb58>
                                    iSula
                                </li><li data-v-fe04bb58>
                                    secGear
                                </li><li data-v-fe04bb58>
                                    StratoVirt
                                </li><li data-v-fe04bb58>
                                    Compass-CI
                                </li><li data-v-fe04bb58>
                                    Compliance
                                </li><li data-v-fe04bb58>
                                    Pkgship
                                </li></ul></li><li data-v-fe04bb58><a class="menu-link" data-v-fe04bb58>支持<i class="icon-arrow" data-v-fe04bb58></i></a> <ul class="sub-menu" style="display:none;" data-v-fe04bb58 data-v-fe04bb58><li data-v-fe04bb58>
                                    漏洞管理
                                </li><li data-v-fe04bb58>
                                    安全公告
                                </li><li data-v-fe04bb58>
                                    CVE
                                </li><li data-v-fe04bb58>
                                    兼容性列表
                                </li><li data-v-fe04bb58>
                                    迁移指南
                                </li></ul></li> <li data-v-fe04bb58><a class="menu-link" data-v-fe04bb58>源码<i class="icon-arrow" data-v-fe04bb58></i></a> <ul class="sub-menu" style="display:none;" data-v-fe04bb58 data-v-fe04bb58><li data-v-fe04bb58>
                                    代码仓
                                </li><li data-v-fe04bb58>
                                    软件包仓
                                </li><li data-v-fe04bb58>
                                    GitHub镜像仓
                                </li></ul></li></ul> <div data-v-fe04bb58></div> <div class="search-mobile" data-v-fe04bb58><div class="el-input el-input--suffix" data-v-fe04bb58><!----><input type="text" autocomplete="off" placeholder="输入内容" class="el-input__inner"><!----><span class="el-input__suffix"><span class="el-input__suffix-inner"><i class="icon-search el-input__icon" data-v-fe04bb58></i><!----><!----><!----><!----></span><!----></span><!----><!----></div></div> <ul class="nav-other" style="display:;" data-v-fe04bb58><li class="lang" data-v-fe04bb58><span class="icon-lang" data-v-fe04bb58></span> <ul data-v-fe04bb58><li class="lang-list" data-v-fe04bb58>
                            中文
                        </li><li data-v-fe04bb58>
                            English
                        </li><li data-v-fe04bb58>
                            Русский
                        </li> <span class="submenu-arrow" data-v-fe04bb58></span></ul></li> <li data-v-fe04bb58><span data-v-fe04bb58>代码</span> <ul data-v-fe04bb58><li data-v-fe04bb58>
                            代码仓
                        </li><li data-v-fe04bb58>
                            软件包仓
                        </li><li data-v-fe04bb58>
                            GitHub镜像仓
                        </li> <span class="submenu-arrow" data-v-fe04bb58></span></ul></li> <li class="search" data-v-fe04bb58><img src="/search.png" alt data-v-fe04bb58></li></ul> <div class="search-input" style="display:none;" data-v-fe04bb58><div class="el-input el-input--small el-input--suffix" data-v-fe04bb58><!----><input type="text" autocomplete="off" placeholder="输入内容" class="el-input__inner"><!----><span class="el-input__suffix"><span class="el-input__suffix-inner"><i class="icon-search el-input__icon" data-v-fe04bb58></i><!----><!----><!----><!----></span><!----></span><!----><!----></div></div> <ul class="nav-other-mobile nav-other" data-v-fe04bb58><li class="lang" data-v-fe04bb58><span class="icon-lang" data-v-fe04bb58></span> <ul data-v-fe04bb58><li class="lang-list" data-v-fe04bb58>
                            中文
                        </li><li data-v-fe04bb58>
                            English
                        </li><li data-v-fe04bb58>
                            Русский
                        </li> <span class="submenu-arrow" data-v-fe04bb58></span></ul></li> <li class="search" data-v-fe04bb58><span class="icon-search" data-v-fe04bb58></span></li> <li class="menu" data-v-fe04bb58><span class="icon-menu" data-v-fe04bb58></span></li></ul></div></div> <!----></div> <!----> <div id="vuepress-theme-blog__post-layout" class="content" data-v-8dab3852 data-v-34596062><div class="blog-link-post" data-v-8dab3852>
        博客\
    </div> <div class="post-left" data-v-8dab3852><p class="blog-img mobile-hide" data-v-8dab3852><img src="/img/blog/blog_user.png" alt class="middle-img" data-v-8dab3852></p> <p class="mobile-hide" data-v-8dab3852><img src="/img/blog/account.svg" alt class="mobile-middle-img" data-v-8dab3852> <span class="blog-author" data-v-8dab3852>Wang Xingang</span></p> <p class="mobile-hide" data-v-8dab3852><img src="/img/blog/date.svg" alt class="mobile-middle-img" data-v-8dab3852> <span class="blog-date mobile" data-v-8dab3852>2020-11-21</span></p> <p class="mobile-hide" data-v-8dab3852><img src="/img/blog/visibility.svg" alt class="mobile-middle-img" data-v-8dab3852> <span class="blog-date" data-v-8dab3852><span data-v-8dab3852><span data-v-8dab3852>浏览</span> <span data-v-8dab3852></span> <span data-v-8dab3852>次</span></span></span></p> <p class="bottom-line bottom-line-none" data-v-8dab3852></p> <!----> <p class="other-blog-item" data-v-8dab3852></p></div> <div class="post-right" data-v-8dab3852><p class="blog-title" data-v-8dab3852>VFIO设备直通原理（二）</p> <div class="user-info-mobile" data-v-8dab3852><div class="left" data-v-8dab3852><img src="/img/blog/blog_user.png" alt data-v-8dab3852></div> <div class="right" data-v-8dab3852><p class="name" data-v-8dab3852>Wang Xingang</p> <p class="date-count" data-v-8dab3852><span class="date" data-v-8dab3852>2020-11-21</span> <span class="count" data-v-8dab3852>浏览次</span></p></div></div> <p class="blog-item-tag" data-v-8dab3852><span data-v-8dab3852>标签: </span> <span data-v-8dab3852><span class="tag-item" data-v-8dab3852>IOMMU</span> <span data-v-8dab3852>, </span></span><span data-v-8dab3852><span class="tag-item" data-v-8dab3852>SMMU</span> <span data-v-8dab3852>, </span></span><span data-v-8dab3852><span class="tag-item" data-v-8dab3852>DMA</span> <!----></span></p> <p class="bottom-line bottom-line-none" data-v-8dab3852></p> <div id="blog_content" class="markdown content__default" data-v-8dab3852><p>设备直通给虚拟机能够极大提升虚拟机对物理设备访问的性能,本文通过vfio内核模块和qemu用户态实现介绍vfio设备直通时的关键部分,包括:用户态访问设备IO地址空间,DMA重映射,中断重映射等.</p> <h2 id="vfio访问直通设备io地址空间"><a href="#vfio访问直通设备io地址空间" class="header-anchor">#</a> VFIO访问直通设备IO地址空间</h2> <p>1.PIO和MMIO</p> <p>设备的IO地址空间的访问有PIO和MMIO两种方式,前者通过独立的IO端口访问设备,而MMIO是在物理内存中映射一段区间,直接访问该内存就可以访问设备的配置空间.在虚拟化的场景下,虚拟机通过PIO访问直通设备时,首先会VM-exit到qemu,由qemu通过转换表完成对该PIO操作的转发.对于PCI设备而言，其bar空间地址是通过PIO的方式设置的,如果将设备的PIO访问完全暴露给虚拟机,虚拟机修改了真实的物理设备的PCI Bar空间基地址配置,与host上不一致,可能会出现严重的问题,所以对于设备的PIO访问需要建立转换表,在VM-exit之后由qemu来完成设置的转发.</p> <p>对于设备的MMIO空间访问,则可以通过建立EPT页表将设备的MMIO物理内存映射到虚拟的MMIO地址空间,让虚拟机能够直接通过MMIO访问PCI设备的bar空间,提高IO性能.</p> <p>2.获取直通设备信息</p> <p>通过VFIO提供的接口可以获取到设备的基本信息，包括设备的描述符、region的数量等。</p> <div class="language-c extra-class"><pre class="language-c"><code>vfio_get_device<span class="token operator">:</span>
    fd <span class="token operator">=</span> <span class="token function">ioctl</span><span class="token punctuation">(</span>group<span class="token operator">-&gt;</span>fd<span class="token punctuation">,</span> VFIO_GROUP_GET_DEVICE_FD<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    ret <span class="token operator">=</span> <span class="token function">ioctl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> VFIO_DEVICE_GET_INFO<span class="token punctuation">,</span> <span class="token operator">&amp;</span>dev_info<span class="token punctuation">)</span><span class="token punctuation">;</span>

    vbasedev<span class="token operator">-&gt;</span>fd <span class="token operator">=</span> fd<span class="token punctuation">;</span>
    vbasedev<span class="token operator">-&gt;</span>group <span class="token operator">=</span> group<span class="token punctuation">;</span>
    <span class="token function">QLIST_INSERT_HEAD</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>group<span class="token operator">-&gt;</span>device_list<span class="token punctuation">,</span> vbasedev<span class="token punctuation">,</span> next<span class="token punctuation">)</span><span class="token punctuation">;</span>

    vbasedev<span class="token operator">-&gt;</span>num_irqs <span class="token operator">=</span> dev_info<span class="token punctuation">.</span>num_irqs<span class="token punctuation">;</span>
    vbasedev<span class="token operator">-&gt;</span>num_regions <span class="token operator">=</span> dev_info<span class="token punctuation">.</span>num_regions<span class="token punctuation">;</span>
    vbasedev<span class="token operator">-&gt;</span>flags <span class="token operator">=</span> dev_info<span class="token punctuation">.</span>flags<span class="token punctuation">;</span>

</code></pre></div><p>2.直通设备PCI配置空间模拟</p> <p>Qemu为每个PCI直通设备都建立一个虚拟数据结构 VFIOPCIDevice，保存物理PCI设备的相关信息，由vfio_get_device来获取，保存到vbasedev中。</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">VFIOPCIDevice</span> <span class="token punctuation">{</span>
    PCIDevice pdev<span class="token punctuation">;</span>
    VFIODevice vbasedev<span class="token punctuation">;</span>
</code></pre></div><p>VFIO设备作为qemu的设备模型的一部分,qemu对直通设备的模拟初始化入口在 vfio_realize，通过vfio_get_device获取到直通设备的基本信息之后，会调用pread设备的fd获取到设备的配置空间信息的一份拷贝，qemu会写入一些自定义的config配置。</p> <div class="language-c extra-class"><pre class="language-c"><code>vfio_realize<span class="token operator">:</span>
    <span class="token comment">/* Get a copy of config space */</span>
    ret <span class="token operator">=</span> <span class="token function">pread</span><span class="token punctuation">(</span>vdev<span class="token operator">-&gt;</span>vbasedev<span class="token punctuation">.</span>fd<span class="token punctuation">,</span> vdev<span class="token operator">-&gt;</span>pdev<span class="token punctuation">.</span>config<span class="token punctuation">,</span>
                <span class="token function">MIN</span><span class="token punctuation">(</span><span class="token function">pci_config_size</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>vdev<span class="token operator">-&gt;</span>pdev<span class="token punctuation">)</span><span class="token punctuation">,</span> vdev<span class="token operator">-&gt;</span>config_size<span class="token punctuation">)</span><span class="token punctuation">,</span>
                vdev<span class="token operator">-&gt;</span>config_offset<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token function">MIN</span><span class="token punctuation">(</span><span class="token function">pci_config_size</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>vdev<span class="token operator">-&gt;</span>pdev<span class="token punctuation">)</span><span class="token punctuation">,</span> vdev<span class="token operator">-&gt;</span>config_size<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ret <span class="token operator">=</span> ret <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token operator">-</span>errno <span class="token operator">:</span> <span class="token operator">-</span>EFAULT<span class="token punctuation">;</span>
        <span class="token function">error_setg_errno</span><span class="token punctuation">(</span>errp<span class="token punctuation">,</span> <span class="token operator">-</span>ret<span class="token punctuation">,</span> <span class="token string">&quot;failed to read device config space&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> error<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/* vfio emulates a lot for us, but some bits need extra love */</span>
    vdev<span class="token operator">-&gt;</span>emulated_config_bits <span class="token operator">=</span> <span class="token function">g_malloc0</span><span class="token punctuation">(</span>vdev<span class="token operator">-&gt;</span>config_size<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* QEMU can choose to expose the ROM or not */</span>
    <span class="token function">memset</span><span class="token punctuation">(</span>vdev<span class="token operator">-&gt;</span>emulated_config_bits <span class="token operator">+</span> PCI_ROM_ADDRESS<span class="token punctuation">,</span> <span class="token number">0xff</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* QEMU can change multi-function devices to single function, or reverse */</span>
    vdev<span class="token operator">-&gt;</span>emulated_config_bits<span class="token punctuation">[</span>PCI_HEADER_TYPE<span class="token punctuation">]</span> <span class="token operator">=</span>
                                              PCI_HEADER_TYPE_MULTI_FUNCTION<span class="token punctuation">;</span>

    <span class="token comment">/* Restore or clear multifunction, this is always controlled by QEMU */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>vdev<span class="token operator">-&gt;</span>pdev<span class="token punctuation">.</span>cap_present <span class="token operator">&amp;</span> QEMU_PCI_CAP_MULTIFUNCTION<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        vdev<span class="token operator">-&gt;</span>pdev<span class="token punctuation">.</span>config<span class="token punctuation">[</span>PCI_HEADER_TYPE<span class="token punctuation">]</span> <span class="token operator">|=</span> PCI_HEADER_TYPE_MULTI_FUNCTION<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        vdev<span class="token operator">-&gt;</span>pdev<span class="token punctuation">.</span>config<span class="token punctuation">[</span>PCI_HEADER_TYPE<span class="token punctuation">]</span> <span class="token operator">&amp;=</span> <span class="token operator">~</span>PCI_HEADER_TYPE_MULTI_FUNCTION<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/*
     * Clear host resource mapping info.  If we choose not to register a
     * BAR, such as might be the case with the option ROM, we can get
     * confusing, unwritable, residual addresses from the host here.
     */</span>
    <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>vdev<span class="token operator">-&gt;</span>pdev<span class="token punctuation">.</span>config<span class="token punctuation">[</span>PCI_BASE_ADDRESS_0<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>vdev<span class="token operator">-&gt;</span>pdev<span class="token punctuation">.</span>config<span class="token punctuation">[</span>PCI_ROM_ADDRESS<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>3.直通设备MMIO映射</p> <p>直通PCI设备的MMIO内存主要是指其Bar空间，qemu使用vfio_populate_device函数调用VFIO接口获取到PCI设备的Bar空间信息，然后通过vfio_region_setup获取到对应region的信息，并将qemu内存虚拟化的MemoryRegion设置为IO类型的region。重要的是，qemu会为该IO类型的MemoryRegion设置ops为vfio_region_ops，这样后续对于该块内存的读写会经过qemu VFIO模块注册的接口来进行。</p> <div class="language-c extra-class"><pre class="language-c"><code>vfio_populate_device<span class="token operator">:</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> VFIO_PCI_BAR0_REGION_INDEX<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> VFIO_PCI_ROM_REGION_INDEX<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">char</span> <span class="token operator">*</span>name <span class="token operator">=</span> <span class="token function">g_strdup_printf</span><span class="token punctuation">(</span><span class="token string">&quot;%s BAR %d&quot;</span><span class="token punctuation">,</span> vbasedev<span class="token operator">-&gt;</span>name<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>

        ret <span class="token operator">=</span> <span class="token function">vfio_region_setup</span><span class="token punctuation">(</span><span class="token function">OBJECT</span><span class="token punctuation">(</span>vdev<span class="token punctuation">)</span><span class="token punctuation">,</span> vbasedev<span class="token punctuation">,</span> <span class="token operator">&amp;</span>vdev<span class="token operator">-&gt;</span>bars<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>region<span class="token punctuation">,</span> i<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token operator">-&gt;</span> vfio_get_region_info
			<span class="token operator">-&gt;</span> <span class="token function">memory_region_init_io</span><span class="token punctuation">(</span>region<span class="token operator">-&gt;</span>mem<span class="token punctuation">,</span> obj<span class="token punctuation">,</span> <span class="token operator">&amp;</span>vfio_region_ops<span class="token punctuation">,</span>
                              region<span class="token punctuation">,</span> name<span class="token punctuation">,</span> region<span class="token operator">-&gt;</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">QLIST_INIT</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>vdev<span class="token operator">-&gt;</span>bars<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>quirks<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    ret <span class="token operator">=</span> <span class="token function">vfio_get_region_info</span><span class="token punctuation">(</span>vbasedev<span class="token punctuation">,</span> VFIO_PCI_CONFIG_REGION_INDEX<span class="token punctuation">,</span> <span class="token operator">&amp;</span>reg_info<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token operator">-&gt;</span>	<span class="token function">ioctl</span><span class="token punctuation">(</span>vbasedev<span class="token operator">-&gt;</span>fd<span class="token punctuation">,</span> VFIO_DEVICE_GET_REGION_INFO<span class="token punctuation">,</span> <span class="token operator">*</span>info<span class="token punctuation">)</span><span class="token punctuation">)</span>
    ret <span class="token operator">=</span> <span class="token function">ioctl</span><span class="token punctuation">(</span>vdev<span class="token operator">-&gt;</span>vbasedev<span class="token punctuation">.</span>fd<span class="token punctuation">,</span> VFIO_DEVICE_GET_IRQ_INFO<span class="token punctuation">,</span> <span class="token operator">&amp;</span>irq_info<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>到这里已经获取到了PCI设备的MMIO内存信息，但是还没有真正的将物理内存中的Bar空间映射到qemu，这一动作在vfio_bars_setup中完成，vfio_region_mmap会对region中每个需要map的内存地址完成映射，然后将映射的物理内存通过qemu注册到虚拟机作为一段虚拟机的物理地址空间。</p> <div class="language-c extra-class"><pre class="language-c"><code>vfio_bars_setup<span class="token operator">:</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> PCI_ROM_SLOT<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token function">vfio_bar_setup</span><span class="token punctuation">(</span>vdev<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">vfio_region_mmap</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>bar<span class="token operator">-&gt;</span>region<span class="token punctuation">)</span>
				    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> region<span class="token operator">-&gt;</span>nr_mmaps<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
					region<span class="token operator">-&gt;</span>mmaps<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>mmap <span class="token operator">=</span> <span class="token function">mmap</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> region<span class="token operator">-&gt;</span>mmaps<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>size<span class="token punctuation">,</span> prot<span class="token punctuation">,</span>
												MAP_SHARED<span class="token punctuation">,</span> region<span class="token operator">-&gt;</span>vbasedev<span class="token operator">-&gt;</span>fd<span class="token punctuation">,</span>
												region<span class="token operator">-&gt;</span>fd_offset <span class="token operator">+</span>
												region<span class="token operator">-&gt;</span>mmaps<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>offset<span class="token punctuation">)</span><span class="token punctuation">;</span>
					memory_region_init_ram_device_ptr
					memory_region_add_subregion
			<span class="token function">pci_register_bar</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>vdev<span class="token operator">-&gt;</span>pdev<span class="token punctuation">,</span> nr<span class="token punctuation">,</span> type<span class="token punctuation">,</span> bar<span class="token operator">-&gt;</span>region<span class="token punctuation">.</span>mem<span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><p>这里的映射mmap接口对应的是VFIO设备在内核中注册的vfio_pci_mmap 函数，在内核中，该函数会为vma注册一个mmap的ops，对应着注册了一个缺页处理函数，当用户态程序访问该段虚拟内存缺页时，调用注册的缺页处理函数，完成虚拟地址到实际物理地址的映射。</p> <div class="language-c extra-class"><pre class="language-c"><code>vfio_pci_mmap<span class="token operator">:</span>
	vma<span class="token operator">-&gt;</span>vm_flags <span class="token operator">|=</span> VM_IO <span class="token operator">|</span> VM_PFNMAP <span class="token operator">|</span> VM_DONTEXPAND <span class="token operator">|</span> VM_DONTDUMP<span class="token punctuation">;</span>
	vma<span class="token operator">-&gt;</span>vm_ops <span class="token operator">=</span> <span class="token operator">&amp;</span>vfio_pci_mmap_ops<span class="token punctuation">;</span>
		<span class="token operator">-&gt;</span> <span class="token punctuation">.</span>fault <span class="token operator">=</span> vfio_pci_mmap_fault<span class="token punctuation">,</span>
				<span class="token operator">-&gt;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">remap_pfn_range</span><span class="token punctuation">(</span>vma<span class="token punctuation">,</span> vma<span class="token operator">-&gt;</span>vm_start<span class="token punctuation">,</span> vma<span class="token operator">-&gt;</span>vm_pgoff<span class="token punctuation">,</span>
					vma<span class="token operator">-&gt;</span>vm_end <span class="token operator">-</span> vma<span class="token operator">-&gt;</span>vm_start<span class="token punctuation">,</span> vma<span class="token operator">-&gt;</span>vm_page_prot<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>简单来说，对于MMIO内存的的映射，主要是将物理内存中的MMIO空间映射到了qemu的虚拟地址空间，然后再由qemu将该段内存注册进虚拟机作为虚拟机的一段物理内存，在这个过程中会建立从gpa到hpa的EPT页表映射，提升MMIO的性能。</p> <h2 id="dma重映射"><a href="#dma重映射" class="header-anchor">#</a> DMA重映射</h2> <p>首先关于DMA，设备通过DMA可以直接使用iova地址访问物理内存，从iova到实际物理地址的映射是在IOMMU中完成的，一般在dma_allooc分配设备能够访问的内存的时候，会分配iova地址和实际的物理地址空间，并在iommu中建立映射关系。
所以说要让设备进行DMA最关键的几个部分：</p> <ul><li>设备能够识别的地址：IOVA</li> <li>一段物理内存</li> <li>IOVA到物理内存在IOMMU中的映射关系</li></ul> <p>基于这几点来看VFIO的DMA重映射就比较清晰，首先从VFIO设备的初始化开始，在获取设备信息之前会先获取到设备所属的group和Container，并调用VFIO_SET_IOMMU完成container和IOMMU的绑定，并attach由VFIO管理的所有设备。此外注意到这里的 pci_device_iommu_address_space 函数，意思是qemu为设备dma注册了一段专门的地址空间，这段内存作为虚拟机的一段物理内存存在，在VFIO_SET_IOMMU之后，注册该地址空间，其region_add函数为 vfio_listener_region_add，意思是当内存空间布局发生变化这里是增加内存的时候都会调用该接口。</p> <div class="language-c extra-class"><pre class="language-c"><code>vfio_realize<span class="token operator">:</span>
    group <span class="token operator">=</span> <span class="token function">vfio_get_group</span><span class="token punctuation">(</span>groupid<span class="token punctuation">,</span> <span class="token function">pci_device_iommu_address_space</span><span class="token punctuation">(</span>pdev<span class="token punctuation">)</span><span class="token punctuation">,</span> errp<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">vfio_connect_container</span><span class="token punctuation">(</span>group<span class="token punctuation">,</span> as<span class="token punctuation">,</span> errp<span class="token punctuation">)</span>
			ret <span class="token operator">=</span> <span class="token function">ioctl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> VFIO_SET_IOMMU<span class="token punctuation">,</span> container<span class="token operator">-&gt;</span>iommu_type<span class="token punctuation">)</span><span class="token punctuation">;</span>
			container<span class="token operator">-&gt;</span>listener <span class="token operator">=</span> vfio_memory_listener<span class="token punctuation">;</span>
			<span class="token function">memory_listener_register</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>container<span class="token operator">-&gt;</span>listener<span class="token punctuation">,</span> container<span class="token operator">-&gt;</span>space<span class="token operator">-&gt;</span>as<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token operator">-&gt;</span> <span class="token punctuation">.</span>region_add <span class="token operator">=</span> vfio_listener_region_add<span class="token punctuation">,</span>
</code></pre></div><p>那么跟DMA有什么关系呢，当为设备进行DMA分配一块内存时，实际是以MemoryRegion的形式存在的，也就是说虚拟机进行dma alloc 会调用region_add函数，进而调用注册的memory_listener_region_add函数，MemoryRegion有了意味着分配了一块物理内存，还需要IOVA和映射关系才行。这里，IOVA地址使用的是section-&gt;offset_within_address_space，为什么可以这样，因为IOVA地址只是作为设备识别的地址，只要建立了映射关系就有意义。</p> <div class="language-c extra-class"><pre class="language-c"><code>vfio_listener_region_add<span class="token operator">:</span>
	iova <span class="token operator">=</span> <span class="token function">TARGET_PAGE_ALIGN</span><span class="token punctuation">(</span>section<span class="token operator">-&gt;</span>offset_within_address_space<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">/* Here we assume that memory_region_is_ram(section-&gt;mr)==true */</span>
    vaddr <span class="token operator">=</span> <span class="token function">memory_region_get_ram_ptr</span><span class="token punctuation">(</span>section<span class="token operator">-&gt;</span>mr<span class="token punctuation">)</span> <span class="token operator">+</span>
            section<span class="token operator">-&gt;</span>offset_within_region <span class="token operator">+</span>
            <span class="token punctuation">(</span>iova <span class="token operator">-</span> section<span class="token operator">-&gt;</span>offset_within_address_space<span class="token punctuation">)</span><span class="token punctuation">;</span>
    ret <span class="token operator">=</span> <span class="token function">vfio_dma_map</span><span class="token punctuation">(</span>container<span class="token punctuation">,</span> iova<span class="token punctuation">,</span> <span class="token function">int128_get64</span><span class="token punctuation">(</span>llsize<span class="token punctuation">)</span><span class="token punctuation">,</span>
                       vaddr<span class="token punctuation">,</span> section<span class="token operator">-&gt;</span>readonly<span class="token punctuation">)</span><span class="token punctuation">;</span>

vfio_dma_map<span class="token operator">:</span>
    <span class="token keyword">struct</span> <span class="token class-name">vfio_iommu_type1_dma_map</span> map <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span>argsz <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">.</span>flags <span class="token operator">=</span> VFIO_DMA_MAP_FLAG_READ<span class="token punctuation">,</span>
        <span class="token punctuation">.</span>vaddr <span class="token operator">=</span> <span class="token punctuation">(</span>__u64<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token class-name">uintptr_t</span><span class="token punctuation">)</span>vaddr<span class="token punctuation">,</span>
        <span class="token punctuation">.</span>iova <span class="token operator">=</span> iova<span class="token punctuation">,</span>
        <span class="token punctuation">.</span>size <span class="token operator">=</span> size<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token function">ioctl</span><span class="token punctuation">(</span>container<span class="token operator">-&gt;</span>fd<span class="token punctuation">,</span> VFIO_IOMMU_MAP_DMA<span class="token punctuation">,</span> <span class="token operator">&amp;</span>map<span class="token punctuation">)</span>
</code></pre></div><p>建立映射的关键在于vfio_dma_map，通过ioctl调用container-&gt;fd接口VFIO_IOMMU_MAP_DMA完成DMA重映射。为什么是container-&gt;fd，因为VFIO Container管理内存资源，与IOMMU直接绑定，而IOMMU是完成IOVA到实际物理内存映射的关键。值得注意的是qemu只知道这一段内存的虚拟地址vaddr，所以将vaddr,iova和size传给内核，由内核获取物理内存信息完成映射。</p> <div class="language-c extra-class"><pre class="language-c"><code>vfio_dma_do_map<span class="token operator">:</span>
	vfio_pin_map_dma
		<span class="token keyword">while</span> <span class="token punctuation">(</span>size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token comment">/* Pin a contiguous chunk of memory */</span>
			npage <span class="token operator">=</span> <span class="token function">vfio_pin_pages_remote</span><span class="token punctuation">(</span>dma<span class="token punctuation">,</span> vaddr <span class="token operator">+</span> dma<span class="token operator">-&gt;</span>size<span class="token punctuation">,</span>
								size <span class="token operator">&gt;&gt;</span> PAGE_SHIFT<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pfn<span class="token punctuation">,</span> limit<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">/* Map it! */</span>
			<span class="token function">vfio_iommu_map</span><span class="token punctuation">(</span>iommu<span class="token punctuation">,</span> iova <span class="token operator">+</span> dma<span class="token operator">-&gt;</span>size<span class="token punctuation">,</span> pfn<span class="token punctuation">,</span> npage<span class="token punctuation">,</span>
							dma<span class="token operator">-&gt;</span>prot<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token function">list_for_each_entry</span><span class="token punctuation">(</span>d<span class="token punctuation">,</span> <span class="token operator">&amp;</span>iommu<span class="token operator">-&gt;</span>domain_list<span class="token punctuation">,</span> next<span class="token punctuation">)</span>
					<span class="token function">iommu_map</span><span class="token punctuation">(</span>d<span class="token operator">-&gt;</span>domain<span class="token punctuation">,</span> iova<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">phys_addr_t</span><span class="token punctuation">)</span>pfn <span class="token operator">&lt;&lt;</span> PAGE_SHIFT<span class="token punctuation">,</span>
							npage <span class="token operator">&lt;&lt;</span> PAGE_SHIFT<span class="token punctuation">,</span> prot <span class="token operator">|</span> d<span class="token operator">-&gt;</span>prot<span class="token punctuation">)</span><span class="token punctuation">;</span>
						arm_smmu_map
							__arm_lpae_map
			size <span class="token operator">-=</span> npage <span class="token operator">&lt;&lt;</span> PAGE_SHIFT<span class="token punctuation">;</span>
			dma<span class="token operator">-&gt;</span>size <span class="token operator">+=</span> npage <span class="token operator">&lt;&lt;</span> PAGE_SHIFT<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
</code></pre></div><p>内核完成建立iova到物理内存的映射之前会将分配的DMA内存给pin住，使用vfio_pin_pages_remote接口可以获取到虚拟地址对应的物理地址和pin住的页数量，然后vfio_iommu_map进而调用iommu以及smmu的map函数，最终用iova，物理地址信息pfn以及要映射的页数量在设备IO页表中建立映射关系。</p> <div class="language- extra-class"><pre class="language-text"><code>+--------+  iova  +--------+  gpa  +----+
| device |   -&gt;   | memory |   &lt;-  | vm |
+--------+        +--------+       +----+
</code></pre></div><p>最终完成了DMA重映射，设备使用qemu分配的iova地址通过IOMMU映射访问内存，虚拟机使用gpa通过Stage 2页表映射访问内存</p> <h2 id="中断重映射"><a href="#中断重映射" class="header-anchor">#</a> 中断重映射</h2> <p>对于PCI直通设备中断的虚拟化，主要包括三种类型INTx,Msi和Msi-X。</p> <p>1.INTx中断初始化及enable</p> <p>对于INTx类型的中断，在初始化的时候就进行使能了，qemu通过VFIO device的接口将中断irq set设置到内核中，并且会注册一个eventfd，设置了eventfd的handler，当发生intx类型的中断时，内核会通过eventfd通知qemu进行处理，qemu会通知虚拟机进行处理。</p> <div class="language-c extra-class"><pre class="language-c"><code>vfio_realize<span class="token operator">:</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">vfio_pci_read_config</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>vdev<span class="token operator">-&gt;</span>pdev<span class="token punctuation">,</span> PCI_INTERRUPT_PIN<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">pci_device_set_intx_routing_notifier</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>vdev<span class="token operator">-&gt;</span>pdev<span class="token punctuation">,</span> vfio_intx_update<span class="token punctuation">)</span><span class="token punctuation">;</span>
        ret <span class="token operator">=</span> <span class="token function">vfio_intx_enable</span><span class="token punctuation">(</span>vdev<span class="token punctuation">,</span> errp<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token operator">*</span>pfd <span class="token operator">=</span> <span class="token function">event_notifier_get_fd</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>vdev<span class="token operator">-&gt;</span>intx<span class="token punctuation">.</span>interrupt<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">qemu_set_fd_handler</span><span class="token punctuation">(</span><span class="token operator">*</span>pfd<span class="token punctuation">,</span> vfio_intx_interrupt<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> vdev<span class="token punctuation">)</span><span class="token punctuation">;</span>
			ret <span class="token operator">=</span> <span class="token function">ioctl</span><span class="token punctuation">(</span>vdev<span class="token operator">-&gt;</span>vbasedev<span class="token punctuation">.</span>fd<span class="token punctuation">,</span> VFIO_DEVICE_SET_IRQS<span class="token punctuation">,</span> irq_set<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>2.MSI-X初始化</p> <p>MSIX在vfio_realzie初始化时，首先获取到物理设备的中断相关的配置信息，将其设置到注册给对应的MMIO内存中</p> <div class="language-c extra-class"><pre class="language-c"><code>vfio_msix_early_setup<span class="token operator">:</span>
	pos <span class="token operator">=</span> <span class="token function">pci_find_capability</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>vdev<span class="token operator">-&gt;</span>pdev<span class="token punctuation">,</span> PCI_CAP_ID_MSIX<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">pread</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ctrl<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>ctrl<span class="token punctuation">)</span><span class="token punctuation">,</span>
			vdev<span class="token operator">-&gt;</span>config_offset <span class="token operator">+</span> pos <span class="token operator">+</span> PCI_MSIX_FLAGS<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>ctrl<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">pread</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>table<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>table<span class="token punctuation">)</span><span class="token punctuation">,</span>
			vdev<span class="token operator">-&gt;</span>config_offset <span class="token operator">+</span> pos <span class="token operator">+</span> PCI_MSIX_TABLE<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>table<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">pread</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pba<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>pba<span class="token punctuation">)</span><span class="token punctuation">,</span>
			vdev<span class="token operator">-&gt;</span>config_offset <span class="token operator">+</span> pos <span class="token operator">+</span> PCI_MSIX_PBA<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>pba<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

	ctrl <span class="token operator">=</span> <span class="token function">le16_to_cpu</span><span class="token punctuation">(</span>ctrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
	table <span class="token operator">=</span> <span class="token function">le32_to_cpu</span><span class="token punctuation">(</span>table<span class="token punctuation">)</span><span class="token punctuation">;</span>
	pba <span class="token operator">=</span> <span class="token function">le32_to_cpu</span><span class="token punctuation">(</span>pba<span class="token punctuation">)</span><span class="token punctuation">;</span>

	msix <span class="token operator">=</span> <span class="token function">g_malloc0</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>msix<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	msix<span class="token operator">-&gt;</span>table_bar <span class="token operator">=</span> table <span class="token operator">&amp;</span> PCI_MSIX_FLAGS_BIRMASK<span class="token punctuation">;</span>
	msix<span class="token operator">-&gt;</span>table_offset <span class="token operator">=</span> table <span class="token operator">&amp;</span> <span class="token operator">~</span>PCI_MSIX_FLAGS_BIRMASK<span class="token punctuation">;</span>
	msix<span class="token operator">-&gt;</span>pba_bar <span class="token operator">=</span> pba <span class="token operator">&amp;</span> PCI_MSIX_FLAGS_BIRMASK<span class="token punctuation">;</span>
	msix<span class="token operator">-&gt;</span>pba_offset <span class="token operator">=</span> pba <span class="token operator">&amp;</span> <span class="token operator">~</span>PCI_MSIX_FLAGS_BIRMASK<span class="token punctuation">;</span>
	msix<span class="token operator">-&gt;</span>entries <span class="token operator">=</span> <span class="token punctuation">(</span>ctrl <span class="token operator">&amp;</span> PCI_MSIX_FLAGS_QSIZE<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>

vfio_msix_setup<span class="token operator">:</span>
    <span class="token function">msix_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>vdev<span class="token operator">-&gt;</span>pdev<span class="token punctuation">,</span> vdev<span class="token operator">-&gt;</span>msix<span class="token operator">-&gt;</span>entries<span class="token punctuation">,</span>
                    vdev<span class="token operator">-&gt;</span>bars<span class="token punctuation">[</span>vdev<span class="token operator">-&gt;</span>msix<span class="token operator">-&gt;</span>table_bar<span class="token punctuation">]</span><span class="token punctuation">.</span>region<span class="token punctuation">.</span>mem<span class="token punctuation">,</span>
                    vdev<span class="token operator">-&gt;</span>msix<span class="token operator">-&gt;</span>table_bar<span class="token punctuation">,</span> vdev<span class="token operator">-&gt;</span>msix<span class="token operator">-&gt;</span>table_offset<span class="token punctuation">,</span>
                    vdev<span class="token operator">-&gt;</span>bars<span class="token punctuation">[</span>vdev<span class="token operator">-&gt;</span>msix<span class="token operator">-&gt;</span>pba_bar<span class="token punctuation">]</span><span class="token punctuation">.</span>region<span class="token punctuation">.</span>mem<span class="token punctuation">,</span>
                    vdev<span class="token operator">-&gt;</span>msix<span class="token operator">-&gt;</span>pba_bar<span class="token punctuation">,</span> vdev<span class="token operator">-&gt;</span>msix<span class="token operator">-&gt;</span>pba_offset<span class="token punctuation">,</span> pos<span class="token punctuation">)</span><span class="token punctuation">;</span>
		
		<span class="token function">memory_region_init_io</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev<span class="token operator">-&gt;</span>msix_table_mmio<span class="token punctuation">,</span> <span class="token function">OBJECT</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>msix_table_mmio_ops<span class="token punctuation">,</span> dev<span class="token punctuation">,</span>
                          <span class="token string">&quot;msix-table&quot;</span><span class="token punctuation">,</span> table_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">memory_region_add_subregion</span><span class="token punctuation">(</span>table_bar<span class="token punctuation">,</span> table_offset<span class="token punctuation">,</span> <span class="token operator">&amp;</span>dev<span class="token operator">-&gt;</span>msix_table_mmio<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">memory_region_init_io</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev<span class="token operator">-&gt;</span>msix_pba_mmio<span class="token punctuation">,</span> <span class="token function">OBJECT</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>msix_pba_mmio_ops<span class="token punctuation">,</span> dev<span class="token punctuation">,</span>
							<span class="token string">&quot;msix-pba&quot;</span><span class="token punctuation">,</span> pba_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">memory_region_add_subregion</span><span class="token punctuation">(</span>pba_bar<span class="token punctuation">,</span> pba_offset<span class="token punctuation">,</span> <span class="token operator">&amp;</span>dev<span class="token operator">-&gt;</span>msix_pba_mmio<span class="token punctuation">)</span><span class="token punctuation">;</span>

vfio_realize<span class="token operator">:</span>
    <span class="token comment">/* QEMU emulates all of MSI &amp; MSIX */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>pdev<span class="token operator">-&gt;</span>cap_present <span class="token operator">&amp;</span> QEMU_PCI_CAP_MSIX<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">memset</span><span class="token punctuation">(</span>vdev<span class="token operator">-&gt;</span>emulated_config_bits <span class="token operator">+</span> pdev<span class="token operator">-&gt;</span>msix_cap<span class="token punctuation">,</span> <span class="token number">0xff</span><span class="token punctuation">,</span>
               MSIX_CAP_LENGTH<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>pdev<span class="token operator">-&gt;</span>cap_present <span class="token operator">&amp;</span> QEMU_PCI_CAP_MSI<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">memset</span><span class="token punctuation">(</span>vdev<span class="token operator">-&gt;</span>emulated_config_bits <span class="token operator">+</span> pdev<span class="token operator">-&gt;</span>msi_cap<span class="token punctuation">,</span> <span class="token number">0xff</span><span class="token punctuation">,</span>
               vdev<span class="token operator">-&gt;</span>msi_cap_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ol start="3"><li>MSI/MSI-X enable 与 irqfd的注册</li></ol> <p>当虚拟机因为写PCI配置空间而发生VM-exit时，最终会完成msi和msix的使能，以MSIX的使能为例，在qemu侧会设置eventfd的处理函数，并通过kvm将irqfd注册到内核中，进而注册虚拟中断给虚拟机。</p> <div class="language-c extra-class"><pre class="language-c"><code>kvm_cpu_exec<span class="token operator">:</span>
	vfio_pci_write_config<span class="token operator">:</span>
		<span class="token function">vfio_msi_enable</span><span class="token punctuation">(</span>vdev<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">vfio_msix_enable</span><span class="token punctuation">(</span>vdev<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> vdev<span class="token operator">-&gt;</span>nr_vectors<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">event_notifier_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>vector<span class="token operator">-&gt;</span>interrupt<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

				<span class="token function">qemu_set_fd_handler</span><span class="token punctuation">(</span><span class="token function">event_notifier_get_fd</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>vector<span class="token operator">-&gt;</span>interrupt<span class="token punctuation">)</span><span class="token punctuation">,</span>
									vfio_msi_interrupt<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> vector<span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token function">vfio_add_kvm_msi_virq</span><span class="token punctuation">(</span>vdev<span class="token punctuation">,</span> vector<span class="token punctuation">,</span> i<span class="token punctuation">,</span> false<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token function">kvm_irqchip_add_msi_route</span><span class="token punctuation">(</span>kvm_state<span class="token punctuation">,</span> vector_n<span class="token punctuation">,</span> <span class="token operator">&amp;</span>vdev<span class="token operator">-&gt;</span>pdev<span class="token punctuation">)</span><span class="token punctuation">;</span>
					vfio_add_kvm_msi_virq
						kvm_irqchip_add_irqfd_notifier_gsi
							<span class="token function">kvm_vm_ioctl</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> KVM_IRQFD<span class="token punctuation">,</span> <span class="token operator">&amp;</span>irqfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">/* Set interrupt type prior to possible interrupts */</span>
			vdev<span class="token operator">-&gt;</span>interrupt <span class="token operator">=</span> VFIO_INT_MSI<span class="token punctuation">;</span>
			ret <span class="token operator">=</span> <span class="token function">vfio_enable_vectors</span><span class="token punctuation">(</span>vdev<span class="token punctuation">,</span> false<span class="token punctuation">)</span><span class="token punctuation">;</span>
				ret <span class="token operator">=</span> <span class="token function">ioctl</span><span class="token punctuation">(</span>vdev<span class="token operator">-&gt;</span>vbasedev<span class="token punctuation">.</span>fd<span class="token punctuation">,</span> VFIO_DEVICE_SET_IRQS<span class="token punctuation">,</span> irq_set<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="小结"><a href="#小结" class="header-anchor">#</a> 小结</h2> <p>要让设备直通给虚拟机，需要将设备的DMA能力、中断响应和IO地址空间访问安全地暴露给用户态，本文主要介绍了VFIO设备直通关键的几个环节，包括如何在用户态访问物理设备的IO地址空间、如何进行DMA重映射和中断重映射。</p> <h2 id="reference"><a href="#reference" class="header-anchor">#</a> Reference</h2> <ul><li>https://kernelgo.org/vfio-insight.html</li></ul></div></div> <div class="bottom-line" data-v-8dab3852></div> <div class="disclaimer" data-v-8dab3852>【版权声明】Copyright © 2021 openEuler Community。本文由openEuler社区首发，欢迎遵照 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/legalcode" data-v-8dab3852>CC-BY-SA 4.0</a> 协议规定转载。转载时敬请在正文注明并保留原文链接和作者信息。</div> <div class="disclaimer" data-v-8dab3852>
        【免责声明】本文仅代表作者本人观点，与本网站无关。本网站对文中陈述、观点判断保持中立，不对所包含内容的准确性、可靠性或完整性提供任何明示或暗示的保证。本文仅供读者参考，由此产生的所有法律责任均由读者本人承担。
    </div></div> <div class="footer-wrapper" data-v-0b78f953 data-v-34596062><div class="qr-code" data-v-0b78f953><img src="/img/common/newyear-qr.png" alt data-v-0b78f953> <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyJpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMy1jMDExIDY2LjE0NTY2MSwgMjAxMi8wMi8wNi0xNDo1NjoyNyAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNiAoV2luZG93cykiIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6MTBGRjQxMDc4MTFBMTFFNDg4RUU4NENEQTQxODZDMjciIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6MTBGRjQxMDg4MTFBMTFFNDg4RUU4NENEQTQxODZDMjciPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDoxMEZGNDEwNTgxMUExMUU0ODhFRTg0Q0RBNDE4NkMyNyIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDoxMEZGNDEwNjgxMUExMUU0ODhFRTg0Q0RBNDE4NkMyNyIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/PvJh/V0AAAJMSURBVHja5Je7L0RBFMatCEEiQYcCBYKo6IgQu0SnIhuFXUsUdBL/gEqt8dhVSNajUbJsSFBqiHeBSsUqiHeyvknOTcaYuffsI9nCSX7Z2bsz8317Z848XPF4PCuTkZ2V4cixCl6vl9umCDSBOlBMz57AJTgGz5xOwuHwbwOMaABDoBfUG+qcgU2wBM7TNQSlIAhOwaSNuGVykowsgpJUDXSDa+BPYniHqa0nWQMDYIvzLxzeXgT0J2qgHaykcbKvgjaugUJyne7YAQUcA/MgT/P8C2wzhESdb81z0eeck4EqsSRoGt+DTpqUQRvxINXpoDZqDIJKOwMTNvl9SOUACBnEA1Q+pDa6GDcZEOPTZ2jkpryWU0w2EZLELTNuQ19CI//PUoxoUV+PJq9d9Gl9L5fKshmfTT/VoBkcqAZqGRPMrwj2KL87ictaB+oQcBccP6VUrvRMlKNM8V9aGd+OZQMxZhtrgn1Kz0S5i3ZBTsR0Bi6Z4vJsjyirpt+Qompc6QwcgVubRouKeIh2Oo8iOuywWN2Q1h8Dr2DDZnkdsZntPkU0QBNVF0LjzTQJZw2NGkGrNAw+Q3ZYJtrocKKLWe2ZkEIMQVizH5SBPbDrcMAQJipo39Ad95bBndNuKF71h+EA62FMMI9B/B2McbbjV6ZQouGmvlknon06kqUr+qXdlH0mXKO9/TEF4Qf65+vJnopF+tU45LUpFqhtNNV7QYzyWtwHZuh+YIpTqiPqjtKNiXc1Y8QFmALThquZ+P0EvCTymlz//nb8I8AA0Ah5h1oiyB4AAAAASUVORK5CYII=" alt class="close" data-v-0b78f953></div> <div class="atom" data-v-0b78f953><p data-v-0b78f953>openEuler 是由开放原子开源基金会（OpenAtom Foundation）孵化及运营的开源项目</p> <img src="/atom-pc.png" alt class="atom-pc" data-v-0b78f953></div> <div class="footer-content" data-v-0b78f953><div class="footer-left" data-v-0b78f953><img src="/footer-logo2.svg" class="footer-logo" data-v-0b78f953> <div class="footer-mail" data-v-0b78f953>contact@openeuler.io</div></div> <div class="footer-center" data-v-0b78f953><ul class="right-list" data-v-0b78f953><li data-v-0b78f953><a data-v-0b78f953>品牌</a></li><li data-v-0b78f953><a data-v-0b78f953>隐私政策</a></li><li data-v-0b78f953><a data-v-0b78f953>法律声明</a></li><li data-v-0b78f953><a data-v-0b78f953>服务状态</a></li></ul> <p class="footer-copyright" data-v-0b78f953>
        版权所有 © 2022 openEuler 保留一切权利
      </p></div> <div class="footer-right" data-v-0b78f953><img src="/qrcode.png" class="footer-qrcode" data-v-0b78f953> <div class="qrcode-desc" data-v-0b78f953>扫码关注公众号</div></div></div></div></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.cdfb7ee7.js" defer></script><script src="/assets/js/14.8a38dea1.js" defer></script><script src="/assets/js/312.77db13fd.js" defer></script>
  </body>
</html>
