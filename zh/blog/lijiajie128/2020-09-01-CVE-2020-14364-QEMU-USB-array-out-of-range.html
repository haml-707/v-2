<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>CVE-2020-14364 QEMU USB数组越界读写问题</title>
    <meta name="generator" content="VuePress 1.5.4">
    <link rel="icon" href="/favicon.ico">
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
  <script src="/js/analytics.js"></script>
  <meta name="keywords" content="openEuler, 操作系统, 开放, 生态, 开源, Linux 开源, OS, open, ecosystem, open source, Linux open source">
  <meta name="baidu-site-verification" content="code-EWzbQRssNU">
    <meta name="description" content="openEuler 是一个开源、免费的 Linux 发行版平台，将通过开放的社区形式与全球的开发者共同构建一个开放、多元和架构包容的软件生态体系。同时，openEuler 也是一个创新的平台，鼓励任何人在该平台上提出新想法、开拓新思路、实践新方案。">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    <meta name="keywords" content="openEuler, 操作系统, 开放, 生态, 开源, Linux 开源, OS, open, ecosystem, open source, Linux open source">
    <meta name="baidu-site-verification" content="code-EWzbQRssNU">
    <link rel="preload" href="/assets/css/0.styles.0df284ed.css" as="style"><link rel="preload" href="/assets/js/app.cdfb7ee7.js" as="script"><link rel="preload" href="/assets/js/14.8a38dea1.js" as="script"><link rel="preload" href="/assets/js/282.d571fd41.js" as="script">
    <link rel="stylesheet" href="/assets/css/0.styles.0df284ed.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div id="euler-app" data-v-34596062><div class="nav-fill " data-v-fe04bb58 data-v-34596062><div class="nav-wrapper" data-v-fe04bb58><div class="nav-bar" data-v-fe04bb58><img src="/openeuler-logo.png" alt class="nav-logo" data-v-fe04bb58> <img src="/openeuler-logo.png" alt class="nav-logo nav-logo-mobile" data-v-fe04bb58> <ul class="nav-menu" data-v-fe04bb58><li data-v-fe04bb58><a class="menu-link" data-v-fe04bb58>下载
                        <span data-v-fe04bb58></span></a> <div class="sub-menu" data-v-fe04bb58><ul class="sig-menu-content" data-v-fe04bb58><li data-v-fe04bb58>
                                ISO
                            </li><li data-v-fe04bb58>
                                镜像仓列表
                            </li></ul> <span class="submenu-arrow" data-v-fe04bb58></span></div></li><li data-v-fe04bb58><a class="menu-link" data-v-fe04bb58>学习
                        <span data-v-fe04bb58></span></a> <div class="sub-menu" data-v-fe04bb58><ul class="sig-menu-content" data-v-fe04bb58><li data-v-fe04bb58>
                                文档
                            </li><li data-v-fe04bb58>
                                慕课
                            </li><li data-v-fe04bb58>
                                实习
                            </li></ul> <span class="submenu-arrow" data-v-fe04bb58></span></div></li><li data-v-fe04bb58><a class="menu-link menu-active" data-v-fe04bb58>互动
                        <span data-v-fe04bb58></span></a> <div class="sub-menu" data-v-fe04bb58><ul class="sig-menu-content" data-v-fe04bb58><li data-v-fe04bb58>
                                新闻
                            </li><li data-v-fe04bb58>
                                博客
                            </li><li data-v-fe04bb58>
                                直播
                            </li><li data-v-fe04bb58>
                                沙龙
                            </li><li data-v-fe04bb58>
                                峰会
                            </li></ul> <span class="submenu-arrow" data-v-fe04bb58></span></div></li><li data-v-fe04bb58><a class="menu-link" data-v-fe04bb58>社区
                        <span data-v-fe04bb58></span></a> <div class="sub-menu" data-v-fe04bb58><ul class="sig-menu-content" data-v-fe04bb58><li data-v-fe04bb58>
                                贡献攻略
                            </li><li data-v-fe04bb58>
                                行为守则
                            </li><li data-v-fe04bb58>
                                邮件列表
                            </li><li data-v-fe04bb58>
                                个人认证
                            </li></ul> <span class="submenu-arrow" data-v-fe04bb58></span></div></li><li data-v-fe04bb58><a class="menu-link" data-v-fe04bb58>SIG
                        <span data-v-fe04bb58></span></a> <div class="sub-menu" data-v-fe04bb58><ul class="sig-menu-content" data-v-fe04bb58><li data-v-fe04bb58>
                                查看SIG
                            </li><li data-v-fe04bb58>
                                申请流程
                            </li><li data-v-fe04bb58>
                                角色说明
                            </li></ul> <span class="submenu-arrow" data-v-fe04bb58></span></div></li><li data-v-fe04bb58><a class="menu-link" data-v-fe04bb58>探索
                        <span data-v-fe04bb58></span></a> <div class="sub-menu" data-v-fe04bb58><ul class="sig-menu-content" data-v-fe04bb58><li data-v-fe04bb58>
                                A-Tune
                            </li><li data-v-fe04bb58>
                                Bisheng JDK
                            </li><li data-v-fe04bb58>
                                iSula
                            </li><li data-v-fe04bb58>
                                secGear
                            </li><li data-v-fe04bb58>
                                StratoVirt
                            </li><li data-v-fe04bb58>
                                Compass-CI
                            </li><li data-v-fe04bb58>
                                Compliance
                            </li><li data-v-fe04bb58>
                                Pkgship
                            </li></ul> <span class="submenu-arrow" data-v-fe04bb58></span></div></li><li data-v-fe04bb58><a class="menu-link" data-v-fe04bb58>支持
                        <span data-v-fe04bb58></span></a> <div class="sub-menu" data-v-fe04bb58><ul class="sig-menu-content" data-v-fe04bb58><li data-v-fe04bb58>
                                漏洞管理
                            </li><li data-v-fe04bb58>
                                安全公告
                            </li><li data-v-fe04bb58>
                                CVE
                            </li><li data-v-fe04bb58>
                                兼容性列表
                            </li><li data-v-fe04bb58>
                                迁移指南
                            </li></ul> <span class="submenu-arrow" data-v-fe04bb58></span></div></li></ul> <ul class="nav-menu-mobile" style="display:none;" data-v-fe04bb58 data-v-fe04bb58><li data-v-fe04bb58><a class="menu-link" data-v-fe04bb58>下载<i class="icon-arrow" data-v-fe04bb58></i></a> <ul class="sub-menu" style="display:none;" data-v-fe04bb58 data-v-fe04bb58><li data-v-fe04bb58>
                                    ISO
                                </li><li data-v-fe04bb58>
                                    镜像仓列表
                                </li></ul></li><li data-v-fe04bb58><a class="menu-link" data-v-fe04bb58>学习<i class="icon-arrow" data-v-fe04bb58></i></a> <ul class="sub-menu" style="display:none;" data-v-fe04bb58 data-v-fe04bb58><li data-v-fe04bb58>
                                    文档
                                </li><li data-v-fe04bb58>
                                    慕课
                                </li><li data-v-fe04bb58>
                                    实习
                                </li></ul></li><li data-v-fe04bb58><a class="menu-link" data-v-fe04bb58>互动<i class="icon-arrow arrow-active" data-v-fe04bb58></i></a> <ul class="sub-menu" data-v-fe04bb58 data-v-fe04bb58><li data-v-fe04bb58>
                                    新闻
                                </li><li data-v-fe04bb58>
                                    博客
                                </li><li data-v-fe04bb58>
                                    直播
                                </li><li data-v-fe04bb58>
                                    沙龙
                                </li><li data-v-fe04bb58>
                                    峰会
                                </li></ul></li><li data-v-fe04bb58><a class="menu-link" data-v-fe04bb58>社区<i class="icon-arrow" data-v-fe04bb58></i></a> <ul class="sub-menu" style="display:none;" data-v-fe04bb58 data-v-fe04bb58><li data-v-fe04bb58>
                                    贡献攻略
                                </li><li data-v-fe04bb58>
                                    行为守则
                                </li><li data-v-fe04bb58>
                                    邮件列表
                                </li><li data-v-fe04bb58>
                                    个人认证
                                </li></ul></li><li data-v-fe04bb58><a class="menu-link" data-v-fe04bb58>SIG<i class="icon-arrow" data-v-fe04bb58></i></a> <ul class="sub-menu" style="display:none;" data-v-fe04bb58 data-v-fe04bb58><li data-v-fe04bb58>
                                    查看SIG
                                </li><li data-v-fe04bb58>
                                    申请流程
                                </li><li data-v-fe04bb58>
                                    角色说明
                                </li></ul></li><li data-v-fe04bb58><a class="menu-link" data-v-fe04bb58>探索<i class="icon-arrow" data-v-fe04bb58></i></a> <ul class="sub-menu" style="display:none;" data-v-fe04bb58 data-v-fe04bb58><li data-v-fe04bb58>
                                    A-Tune
                                </li><li data-v-fe04bb58>
                                    Bisheng JDK
                                </li><li data-v-fe04bb58>
                                    iSula
                                </li><li data-v-fe04bb58>
                                    secGear
                                </li><li data-v-fe04bb58>
                                    StratoVirt
                                </li><li data-v-fe04bb58>
                                    Compass-CI
                                </li><li data-v-fe04bb58>
                                    Compliance
                                </li><li data-v-fe04bb58>
                                    Pkgship
                                </li></ul></li><li data-v-fe04bb58><a class="menu-link" data-v-fe04bb58>支持<i class="icon-arrow" data-v-fe04bb58></i></a> <ul class="sub-menu" style="display:none;" data-v-fe04bb58 data-v-fe04bb58><li data-v-fe04bb58>
                                    漏洞管理
                                </li><li data-v-fe04bb58>
                                    安全公告
                                </li><li data-v-fe04bb58>
                                    CVE
                                </li><li data-v-fe04bb58>
                                    兼容性列表
                                </li><li data-v-fe04bb58>
                                    迁移指南
                                </li></ul></li> <li data-v-fe04bb58><a class="menu-link" data-v-fe04bb58>源码<i class="icon-arrow" data-v-fe04bb58></i></a> <ul class="sub-menu" style="display:none;" data-v-fe04bb58 data-v-fe04bb58><li data-v-fe04bb58>
                                    代码仓
                                </li><li data-v-fe04bb58>
                                    软件包仓
                                </li><li data-v-fe04bb58>
                                    GitHub镜像仓
                                </li></ul></li></ul> <div data-v-fe04bb58></div> <div class="search-mobile" data-v-fe04bb58><div class="el-input el-input--suffix" data-v-fe04bb58><!----><input type="text" autocomplete="off" placeholder="输入内容" class="el-input__inner"><!----><span class="el-input__suffix"><span class="el-input__suffix-inner"><i class="icon-search el-input__icon" data-v-fe04bb58></i><!----><!----><!----><!----></span><!----></span><!----><!----></div></div> <ul class="nav-other" style="display:;" data-v-fe04bb58><li class="lang" data-v-fe04bb58><span class="icon-lang" data-v-fe04bb58></span> <ul data-v-fe04bb58><li class="lang-list" data-v-fe04bb58>
                            中文
                        </li><li data-v-fe04bb58>
                            English
                        </li><li data-v-fe04bb58>
                            Русский
                        </li> <span class="submenu-arrow" data-v-fe04bb58></span></ul></li> <li data-v-fe04bb58><span data-v-fe04bb58>代码</span> <ul data-v-fe04bb58><li data-v-fe04bb58>
                            代码仓
                        </li><li data-v-fe04bb58>
                            软件包仓
                        </li><li data-v-fe04bb58>
                            GitHub镜像仓
                        </li> <span class="submenu-arrow" data-v-fe04bb58></span></ul></li> <li class="search" data-v-fe04bb58><img src="/search.png" alt data-v-fe04bb58></li></ul> <div class="search-input" style="display:none;" data-v-fe04bb58><div class="el-input el-input--small el-input--suffix" data-v-fe04bb58><!----><input type="text" autocomplete="off" placeholder="输入内容" class="el-input__inner"><!----><span class="el-input__suffix"><span class="el-input__suffix-inner"><i class="icon-search el-input__icon" data-v-fe04bb58></i><!----><!----><!----><!----></span><!----></span><!----><!----></div></div> <ul class="nav-other-mobile nav-other" data-v-fe04bb58><li class="lang" data-v-fe04bb58><span class="icon-lang" data-v-fe04bb58></span> <ul data-v-fe04bb58><li class="lang-list" data-v-fe04bb58>
                            中文
                        </li><li data-v-fe04bb58>
                            English
                        </li><li data-v-fe04bb58>
                            Русский
                        </li> <span class="submenu-arrow" data-v-fe04bb58></span></ul></li> <li class="search" data-v-fe04bb58><span class="icon-search" data-v-fe04bb58></span></li> <li class="menu" data-v-fe04bb58><span class="icon-menu" data-v-fe04bb58></span></li></ul></div></div> <!----></div> <!----> <div id="vuepress-theme-blog__post-layout" class="content" data-v-8dab3852 data-v-34596062><div class="blog-link-post" data-v-8dab3852>
        博客\
    </div> <div class="post-left" data-v-8dab3852><p class="blog-img mobile-hide" data-v-8dab3852><img src="/img/blog/blog_user.png" alt class="middle-img" data-v-8dab3852></p> <p class="mobile-hide" data-v-8dab3852><img src="/img/blog/account.svg" alt class="mobile-middle-img" data-v-8dab3852> <span class="blog-author" data-v-8dab3852>Jiajie Li</span></p> <p class="mobile-hide" data-v-8dab3852><img src="/img/blog/date.svg" alt class="mobile-middle-img" data-v-8dab3852> <span class="blog-date mobile" data-v-8dab3852>2020-09-01</span></p> <p class="mobile-hide" data-v-8dab3852><img src="/img/blog/visibility.svg" alt class="mobile-middle-img" data-v-8dab3852> <span class="blog-date" data-v-8dab3852><span data-v-8dab3852><span data-v-8dab3852>浏览</span> <span data-v-8dab3852></span> <span data-v-8dab3852>次</span></span></span></p> <p class="bottom-line bottom-line-none" data-v-8dab3852></p> <!----> <p class="other-blog-item" data-v-8dab3852></p></div> <div class="post-right" data-v-8dab3852><p class="blog-title" data-v-8dab3852>CVE-2020-14364 QEMU USB数组越界读写问题</p> <div class="user-info-mobile" data-v-8dab3852><div class="left" data-v-8dab3852><img src="/img/blog/blog_user.png" alt data-v-8dab3852></div> <div class="right" data-v-8dab3852><p class="name" data-v-8dab3852>Jiajie Li</p> <p class="date-count" data-v-8dab3852><span class="date" data-v-8dab3852>2020-09-01</span> <span class="count" data-v-8dab3852>浏览次</span></p></div></div> <p class="blog-item-tag" data-v-8dab3852><span data-v-8dab3852>标签: </span> <span data-v-8dab3852><span class="tag-item" data-v-8dab3852>Qemu</span> <span data-v-8dab3852>, </span></span><span data-v-8dab3852><span class="tag-item" data-v-8dab3852>CVE</span> <span data-v-8dab3852>, </span></span><span data-v-8dab3852><span class="tag-item" data-v-8dab3852>USB</span> <span data-v-8dab3852>, </span></span><span data-v-8dab3852><span class="tag-item" data-v-8dab3852>Buffer overflow</span> <span data-v-8dab3852>, </span></span><span data-v-8dab3852><span class="tag-item" data-v-8dab3852>Patch</span> <!----></span></p> <p class="bottom-line bottom-line-none" data-v-8dab3852></p> <div id="blog_content" class="markdown content__default" data-v-8dab3852><h1 id="cve-2020-14364-qemu-usb数组越界读写问题"><a href="#cve-2020-14364-qemu-usb数组越界读写问题" class="header-anchor">#</a> CVE-2020-14364 QEMU USB数组越界读写问题</h1> <h1 id="漏洞描述"><a href="#漏洞描述" class="header-anchor">#</a> 漏洞描述</h1> <p>QEMU（quick emulator）是一款由Fabrice Bellard等人编写的免费的可执行硬件虚拟化的开源托管虚拟机。其与Bochs，PearPC类似，但拥有高速（配合KVM），跨平台的特性。QEMU通过动态的二进制转换，模拟CPU，并且提供一组设备模型，使其能够运行多种未修改的客户机OS。通过QEMU与KVM一起使用，可以实现以接近本地速度来运行虚拟机，被广泛应用到虚拟化和云计算场景中。</p> <p>近日360公司发现QEMU USB控制器模拟源代码hw/usb/core.c之中存在数组越界读写的问题，攻击者可以利用该漏洞获得qemu用户的执行权限进而实现<strong>完整的QEMU虚拟机逃逸</strong>。（CVE-2020-14364）</p> <h1 id="漏洞分析"><a href="#漏洞分析" class="header-anchor">#</a> 漏洞分析</h1> <ul><li>经过分析，该漏洞存在于USB控制器模拟代码usb_process_one中，s-&gt;setup_len未经验证就赋值可能会引入的数组越界读写的风险 。由于libvirt启动的虚拟机默认会有配置有usb设备，而任何usb控制器（如uhci,ehci,xhci）与usb设备（如usb-tablet，usb-mouse等）之间交互都会经过core.c文件中的usb_process_one函数，因此理论上只要虚拟机有使用usb设备都存在漏洞攻击的风险。 此外，usb_process_one函数中可能进入的两个分支do_parameter和do_token_setup均存在该问题，即：<strong>在检查最终需要使用的数组长度前已经提前设置了该数组长度（s-&gt;setup_len）</strong>。</li> <li>该漏洞的影响后果<strong>非常严重</strong>，因为攻击者可以利用该漏洞实现任意地址读取和写入，从而获得qemu进程的所有权限从而实现<strong>虚拟机逃逸</strong>，实现恶意代码执行攻击。此外，如果qemu进程处于root用户组那么攻击者就可以完整获得操作系统的控制权进而执行任意linux系统命令！</li></ul> <h2 id="代码分析"><a href="#代码分析" class="header-anchor">#</a> 代码分析</h2> <div class="language-c++ extra-class"><pre class="language-text"><code>static void do_token_setup(USBDevice *s, USBPacket *p)                                     
{                                                                               
    int request, value, index;                                                  
                                                                                
    if (p-&gt;iov.size != 8) {                                                     
        p-&gt;status = USB_RET_STALL;                                              
        return;                                                                 
    }                                                                           
                                                                                
    usb_packet_copy(p, s-&gt;setup_buf, p-&gt;iov.size);                              
    s-&gt;setup_index = 0;                                                         
    p-&gt;actual_length = 0;                                                       
    s-&gt;setup_len   = (s-&gt;setup_buf[7] &lt;&lt; 8) | s-&gt;setup_buf[6]; //先对s-&gt;setup_len赋值     
    if (s-&gt;setup_len &gt; sizeof(s-&gt;data_buf)) { // 后对setup_len进行合法性校验                 
        fprintf(stderr,                                                         
                &quot;usb_generic_handle_packet: ctrl buffer too small (%d &gt; %zu)\n&quot;,
                s-&gt;setup_len, sizeof(s-&gt;data_buf));                             
        p-&gt;status = USB_RET_STALL;                                              
        return;                                                                 
    }                                                                           
</code></pre></div><div class="language-c++ extra-class"><pre class="language-text"><code>static void do_parameter(USBDevice *s, USBPacket *p)                            
{                                                                               
    int i, request, value, index;                                               
                                                                                
    for (i = 0; i &lt; 8; i++) {                                                   
        s-&gt;setup_buf[i] = p-&gt;parameter &gt;&gt; (i*8);                                
    }                                                                           
                                                                                
    s-&gt;setup_state = SETUP_STATE_PARAM;                                         
    s-&gt;setup_len   = (s-&gt;setup_buf[7] &lt;&lt; 8) | s-&gt;setup_buf[6]; //先对s-&gt;setup_len赋值       
    s-&gt;setup_index = 0;                                                         
                                                                                
    request = (s-&gt;setup_buf[0] &lt;&lt; 8) | s-&gt;setup_buf[1];                         
    value   = (s-&gt;setup_buf[3] &lt;&lt; 8) | s-&gt;setup_buf[2];                         
    index   = (s-&gt;setup_buf[5] &lt;&lt; 8) | s-&gt;setup_buf[4];                         
                                                                                
    if (s-&gt;setup_len &gt; sizeof(s-&gt;data_buf)) { // 后对setup_len进行合法性校验                 
        fprintf(stderr,                                                         
                &quot;usb_generic_handle_packet: ctrl buffer too small (%d &gt; %zu)\n&quot;,
                s-&gt;setup_len, sizeof(s-&gt;data_buf));                             
        p-&gt;status = USB_RET_STALL;                                              
        return;                                                                 
    }    
</code></pre></div><p>通过代码可以看到：do_token_setup以及do_parameter两个函数中，都在对s-&gt;setup_len做检查之前就设置了具体内容，并且当s-&gt;setup_len超出预定buffer大小之后，也没有对其进行更改，这使得其中被污染的数据依旧可以完成之后的越界读写功能。</p> <h2 id="影响性分析"><a href="#影响性分析" class="header-anchor">#</a> 影响性分析</h2> <ol><li>影响范围
QEMU 1.x 至今的QEMU的版本源代码之中均存在该漏洞，其中也包括了openEuler社区之前所使用的QEMU的代码。</li> <li>触发条件
触发该漏洞需要虚拟机至少连接有一个usb设备，而多数情况下libvirt会默认为虚拟机配置USB设备。</li></ol> <h2 id="漏洞修复方法"><a href="#漏洞修复方法" class="header-anchor">#</a> 漏洞修复方法</h2> <p>根据360给出的修复方案，当检测到setup_len非法之后，将s-&gt;setup_len清零表示丢弃buffer中的USB请求，同时将USB的状态设置为SETUP_STATE_ACK，重新开始接受其他请求。补丁内容为：</p> <div class="language-c extra-class"><pre class="language-c"><code>Subject<span class="token operator">:</span> <span class="token punctuation">[</span>PATCH<span class="token punctuation">]</span> hw<span class="token operator">/</span>usb<span class="token operator">/</span>core<span class="token punctuation">.</span>c fix buffer overflow

Store calculated setup_len in a local variable<span class="token punctuation">,</span> verify it<span class="token punctuation">,</span>
 and only write it to the <span class="token keyword">struct</span> <span class="token punctuation">(</span>USBDevice<span class="token operator">-&gt;</span>setup_len<span class="token punctuation">)</span> in <span class="token keyword">case</span> it passed the
 sanity checks<span class="token punctuation">.</span>

This prevents other <span class="token function">code</span> <span class="token punctuation">(</span>do_token_<span class="token punctuation">{</span>in<span class="token punctuation">,</span>out<span class="token punctuation">}</span> function specifically<span class="token punctuation">)</span>
from working with invalid USBDevice<span class="token operator">-&gt;</span>setup_len values and overruning
the USBDevice<span class="token operator">-&gt;</span>setup_buf<span class="token punctuation">[</span><span class="token punctuation">]</span> buffer<span class="token punctuation">.</span>
Store
Fixes<span class="token operator">:</span> CVE<span class="token operator">-</span><span class="token number">2020</span><span class="token operator">-</span><span class="token number">14364</span>
Signed<span class="token operator">-</span>off<span class="token operator">-</span>by<span class="token operator">:</span> Gred Hoffman <span class="token operator">&lt;</span>kraxel@redhat<span class="token punctuation">.</span>com<span class="token operator">&gt;</span>
<span class="token operator">--</span><span class="token operator">-</span>
 hw<span class="token operator">/</span>usb<span class="token operator">/</span>core<span class="token punctuation">.</span>c <span class="token operator">|</span> <span class="token number">4</span> <span class="token operator">++</span><span class="token operator">++</span>
 <span class="token number">1</span> file changed<span class="token punctuation">,</span> <span class="token number">4</span> <span class="token function">insertions</span><span class="token punctuation">(</span><span class="token operator">+</span><span class="token punctuation">)</span>

diff <span class="token operator">--</span>git a<span class="token operator">/</span>hw<span class="token operator">/</span>usb<span class="token operator">/</span>core<span class="token punctuation">.</span>c b<span class="token operator">/</span>hw<span class="token operator">/</span>usb<span class="token operator">/</span>core<span class="token punctuation">.</span>c
index <span class="token number">5</span>abd128b<span class="token punctuation">.</span><span class="token number">.12342f</span><span class="token number">13</span> <span class="token number">100644</span>
<span class="token operator">--</span><span class="token operator">-</span> a<span class="token operator">/</span>hw<span class="token operator">/</span>usb<span class="token operator">/</span>core<span class="token punctuation">.</span>c
<span class="token operator">++</span><span class="token operator">+</span> b<span class="token operator">/</span>hw<span class="token operator">/</span>usb<span class="token operator">/</span>core<span class="token punctuation">.</span>c
@@ <span class="token operator">-</span><span class="token number">144</span><span class="token punctuation">,</span><span class="token number">6</span> <span class="token operator">+</span><span class="token number">144</span><span class="token punctuation">,</span><span class="token number">8</span> @@ <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">do_token_setup</span><span class="token punctuation">(</span>USBDevice <span class="token operator">*</span>s<span class="token punctuation">,</span> USBPacket <span class="token operator">*</span>p<span class="token punctuation">)</span>
                 <span class="token string">&quot;usb_generic_handle_packet: ctrl buffer too small (%d &gt; %zu)\n&quot;</span><span class="token punctuation">,</span>
                 s<span class="token operator">-&gt;</span>setup_len<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>s<span class="token operator">-&gt;</span>data_buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         p<span class="token operator">-&gt;</span>status <span class="token operator">=</span> USB_RET_STALL<span class="token punctuation">;</span>
<span class="token operator">+</span>		s<span class="token operator">-&gt;</span>setup_len <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token operator">+</span>		s<span class="token operator">-&gt;</span>setup_state <span class="token operator">=</span> SETUP_STATE_ACK<span class="token punctuation">;</span>
         <span class="token keyword">return</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
 
@@ <span class="token operator">-</span><span class="token number">277</span><span class="token punctuation">,</span><span class="token number">6</span> <span class="token operator">+</span><span class="token number">279</span><span class="token punctuation">,</span><span class="token number">8</span> @@ <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">do_parameter</span><span class="token punctuation">(</span>USBDevice <span class="token operator">*</span>s<span class="token punctuation">,</span> USBPacket <span class="token operator">*</span>p<span class="token punctuation">)</span>
                 <span class="token string">&quot;usb_generic_handle_packet: ctrl buffer too small (%d &gt; %zu)\n&quot;</span><span class="token punctuation">,</span>
                 s<span class="token operator">-&gt;</span>setup_len<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>s<span class="token operator">-&gt;</span>data_buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         p<span class="token operator">-&gt;</span>status <span class="token operator">=</span> USB_RET_STALL<span class="token punctuation">;</span>
<span class="token operator">+</span>		s<span class="token operator">-&gt;</span>setup_len <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token operator">+</span>		s<span class="token operator">-&gt;</span>setup_state <span class="token operator">=</span> SETUP_STATE_ACK<span class="token punctuation">;</span>
         <span class="token keyword">return</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
 
<span class="token operator">--</span> 
</code></pre></div><h2 id="解决方案"><a href="#解决方案" class="header-anchor">#</a> 解决方案</h2> <ul><li><p>下载openEuler发布最新的qemu软件包：</p> <ul><li><a href="https://cve.openeuler.org/#/infoDetails/openEuler-SA-2020-1061" target="_blank" rel="noopener noreferrer">漏洞SA<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://repo.openeuler.org/openEuler-20.03-LTS/update/aarch64/Packages" target="_blank" rel="noopener noreferrer">aach64架构qemu软件包<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://repo.openeuler.org/openEuler-20.03-LTS/update/x86_64/Packages" target="_blank" rel="noopener noreferrer">x86架构qemu软件包<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></li> <li><p>升级qemu软件包</p> <ul><li>rpm -Uvh qemu-*.rpm</li></ul></li> <li><p>升级完成之后查看qemu软件包的release号码，当release号大于17表示漏洞修复成功。</p> <ul><li><p>rpm -qi qemu-4.1.0</p> <div class="language- extra-class"><pre class="language-text"><code>Name        : qemu
Epoch       : 2
Version     : 4.1.0
Release     : 18.oe1
Architecture: aarch64
Install Date: Mon 10 Aug 2020 04:53:20 PM CST
Group       : Unspecified
Size        : 19468602
License     : GPLv2 and BSD and MIT and CC-BY
Signature   : RSA/SHA1, Thu 09 Jul 2020 11:52:58 AM CST, Key ID d557065eb25e7f66
Source RPM  : qemu-4.1.0-14.oe1.src.rpm
Build Date  : Thu 09 Jul 2020 11:44:23 AM CST
Build Host  : obs-worker-004
Packager    : http://openeuler.org
Vendor      : http://openeuler.org
URL         : http://www.qemu.org
</code></pre></div></li></ul></li></ul> <h1 id="faq"><a href="#faq" class="header-anchor">#</a> FAQ</h1> <ol><li>OpenEuler社区对此漏洞采取了什么措施？
社区相关人员得知漏洞之后，立刻制作出了相对应的补丁，并且第一时间将补丁合入社区相关分支之中。</li> <li>如何获取该漏洞的具体复现场景？
可以参考360在ISC2020第八届互联网安全大会上的分享：
<ul><li>https://isc.360.com/2020/detail.html?vid=108</li> <li>https://www.anquanke.com/post/id/215405</li></ul></li></ol></div></div> <div class="bottom-line" data-v-8dab3852></div> <div class="disclaimer" data-v-8dab3852>【版权声明】Copyright © 2021 openEuler Community。本文由openEuler社区首发，欢迎遵照 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/legalcode" data-v-8dab3852>CC-BY-SA 4.0</a> 协议规定转载。转载时敬请在正文注明并保留原文链接和作者信息。</div> <div class="disclaimer" data-v-8dab3852>
        【免责声明】本文仅代表作者本人观点，与本网站无关。本网站对文中陈述、观点判断保持中立，不对所包含内容的准确性、可靠性或完整性提供任何明示或暗示的保证。本文仅供读者参考，由此产生的所有法律责任均由读者本人承担。
    </div></div> <div class="footer-wrapper" data-v-0b78f953 data-v-34596062><div class="qr-code" data-v-0b78f953><img src="/img/common/newyear-qr.png" alt data-v-0b78f953> <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyJpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMy1jMDExIDY2LjE0NTY2MSwgMjAxMi8wMi8wNi0xNDo1NjoyNyAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNiAoV2luZG93cykiIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6MTBGRjQxMDc4MTFBMTFFNDg4RUU4NENEQTQxODZDMjciIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6MTBGRjQxMDg4MTFBMTFFNDg4RUU4NENEQTQxODZDMjciPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDoxMEZGNDEwNTgxMUExMUU0ODhFRTg0Q0RBNDE4NkMyNyIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDoxMEZGNDEwNjgxMUExMUU0ODhFRTg0Q0RBNDE4NkMyNyIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/PvJh/V0AAAJMSURBVHja5Je7L0RBFMatCEEiQYcCBYKo6IgQu0SnIhuFXUsUdBL/gEqt8dhVSNajUbJsSFBqiHeBSsUqiHeyvknOTcaYuffsI9nCSX7Z2bsz8317Z848XPF4PCuTkZ2V4cixCl6vl9umCDSBOlBMz57AJTgGz5xOwuHwbwOMaABDoBfUG+qcgU2wBM7TNQSlIAhOwaSNuGVykowsgpJUDXSDa+BPYniHqa0nWQMDYIvzLxzeXgT0J2qgHaykcbKvgjaugUJyne7YAQUcA/MgT/P8C2wzhESdb81z0eeck4EqsSRoGt+DTpqUQRvxINXpoDZqDIJKOwMTNvl9SOUACBnEA1Q+pDa6GDcZEOPTZ2jkpryWU0w2EZLELTNuQ19CI//PUoxoUV+PJq9d9Gl9L5fKshmfTT/VoBkcqAZqGRPMrwj2KL87ictaB+oQcBccP6VUrvRMlKNM8V9aGd+OZQMxZhtrgn1Kz0S5i3ZBTsR0Bi6Z4vJsjyirpt+Qompc6QwcgVubRouKeIh2Oo8iOuywWN2Q1h8Dr2DDZnkdsZntPkU0QBNVF0LjzTQJZw2NGkGrNAw+Q3ZYJtrocKKLWe2ZkEIMQVizH5SBPbDrcMAQJipo39Ad95bBndNuKF71h+EA62FMMI9B/B2McbbjV6ZQouGmvlknon06kqUr+qXdlH0mXKO9/TEF4Qf65+vJnopF+tU45LUpFqhtNNV7QYzyWtwHZuh+YIpTqiPqjtKNiXc1Y8QFmALThquZ+P0EvCTymlz//nb8I8AA0Ah5h1oiyB4AAAAASUVORK5CYII=" alt class="close" data-v-0b78f953></div> <div class="atom" data-v-0b78f953><p data-v-0b78f953>openEuler 是由开放原子开源基金会（OpenAtom Foundation）孵化及运营的开源项目</p> <img src="/atom-pc.png" alt class="atom-pc" data-v-0b78f953></div> <div class="footer-content" data-v-0b78f953><div class="footer-left" data-v-0b78f953><img src="/footer-logo2.svg" class="footer-logo" data-v-0b78f953> <div class="footer-mail" data-v-0b78f953>contact@openeuler.io</div></div> <div class="footer-center" data-v-0b78f953><ul class="right-list" data-v-0b78f953><li data-v-0b78f953><a data-v-0b78f953>品牌</a></li><li data-v-0b78f953><a data-v-0b78f953>隐私政策</a></li><li data-v-0b78f953><a data-v-0b78f953>法律声明</a></li><li data-v-0b78f953><a data-v-0b78f953>服务状态</a></li></ul> <p class="footer-copyright" data-v-0b78f953>
        版权所有 © 2022 openEuler 保留一切权利
      </p></div> <div class="footer-right" data-v-0b78f953><img src="/qrcode.png" class="footer-qrcode" data-v-0b78f953> <div class="qrcode-desc" data-v-0b78f953>扫码关注公众号</div></div></div></div></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.cdfb7ee7.js" defer></script><script src="/assets/js/14.8a38dea1.js" defer></script><script src="/assets/js/282.d571fd41.js" defer></script>
  </body>
</html>
