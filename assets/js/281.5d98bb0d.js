(window.webpackJsonp=window.webpackJsonp||[]).push([[281],{1673:function(t,e,a){"use strict";a.r(e);var r=a(42),s=Object(r.a)({},(function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h3",{attrs:{id:"背景"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#背景"}},[t._v("#")]),t._v(" 背景")]),t._v(" "),a("p",[t._v("在多人使用虚拟机的场景中，每人对应一个非root用户。当某一个非root用户想要使用virsh命令起qemu虚拟机的时候，等待他的可能是一段小坑不断的试错之路。")]),t._v(" "),a("p",[t._v("非root用户起虚拟机最常遇到的是权限问题，比如运行"),a("code",[t._v("virsh start")]),t._v("的时候，出现下列报错：")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("error: Failed to start domain jzy-lts\nerror: internal error: qemu unexpectedly closed the monitor: 2020-07-14T13:29:11.323694Z qemu-kvm: -drive file=/home/jzy/kvm/openEuler-20.03-LTS.aarch64.qcow2,format=qcow2,if=none,id=drive-scsi0-0-0-0,cache=none,aio=native: Could not open '/home/jzy/kvm/openEuler-20.03-LTS.aarch64.qcow2': Permission denied\n")])])]),a("p",[t._v("有些朋友遇到类似问题会怀疑是qemu本身有bug，其实不然，很有可能操作不当才是原因。\n下面是本人总结的非root用户起qemu虚拟机的步骤，规避可能出现的权限问题。")]),t._v(" "),a("h3",{attrs:{id:"步骤"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#步骤"}},[t._v("#")]),t._v(" 步骤")]),t._v(" "),a("p",[t._v("从创建用户到起虚拟机：")]),t._v(" "),a("ol",[a("li",[t._v("创建一个用户并添加进kvm组")])]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("[root]    useradd -m jzy\n[root]\t  gpasswd -a jzy kvm\n")])])]),a("ol",{attrs:{start:"2"}},[a("li",[t._v("配置 "),a("code",[t._v("/etc/libvirt/qemu.conf")])])]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v('# user = "root"\n后面加\nuser = "jzy"\n')])])]),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v('# group = "root"\n后面加\ngroup = "jzy"\n')])])]),a("ol",{attrs:{start:"3"}},[a("li",[t._v("重启libvirtd")])]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("[root]    service libvirtd restart\n或者\n[root]    systemctl restart libvirtd.service\n")])])]),a("ol",{attrs:{start:"4"}},[a("li",[t._v("允许jzy使用sudo")])]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("[root]    vim /etc/sudoers\n")])])]),a("p",[t._v("增加 "),a("code",[t._v("jzy ALL=(ALL) ALL")]),t._v("\n然后 "),a("code",[t._v("wq！")])]),t._v(" "),a("ol",{attrs:{start:"5"}},[a("li",[t._v("切用户，到/home/jzy 准备好相关的文件\n保证文件和目录都是755的权限, 比如")])]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("[jzy@localhost ~]$ pwd\n/home/jzy\n\n[jzy@localhost ~]$ ll\ntotal 4.0K\ndrwxr-xr-x 2 jzy jzy 4.0K Jul 23 11:29 kvm\n\n[jzy@localhost ~]$ ll kvm\ntotal 7.2G\n-rwxr-xr-x 1 jzy  jzy  1.6K Jul 23 11:29 openE_jzy.xml\n-rwxr-xr-x 1 jzy  jzy  4.4G Jul 23 11:25 openEuler-20.03-LTS-aarch64-dvd.iso\n-rwxr-xr-x 1 root root 2.9G Jul 23 11:32 openEuler-image.qcow2\n")])])]),a("ol",{attrs:{start:"6"}},[a("li",[t._v("就可以起虚拟机了")])]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("[jzy@localhost ~]$ sudo virsh create kvm/openE_jzy.xml\nDomain openEulerVM created from kvm/openE_jzy.xml\n")])])]),a("p",[t._v("特别注意：\n文件的owner 和 group 不要搞错！")])])}),[],!1,null,null,null);e.default=s.exports}}]);