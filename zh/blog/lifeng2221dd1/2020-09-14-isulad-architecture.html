<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>iSulad 轻量级容器引擎功能介绍以及代码架构解析</title>
    <meta name="generator" content="VuePress 1.5.4">
    <link rel="icon" href="/favicon.ico">
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
  <script src="/js/analytics.js"></script>
  <meta name="keywords" content="openEuler, 操作系统, 开放, 生态, 开源, Linux 开源, OS, open, ecosystem, open source, Linux open source">
  <meta name="baidu-site-verification" content="code-EWzbQRssNU">
    <meta name="description" content="openEuler 是一个开源、免费的 Linux 发行版平台，将通过开放的社区形式与全球的开发者共同构建一个开放、多元和架构包容的软件生态体系。同时，openEuler 也是一个创新的平台，鼓励任何人在该平台上提出新想法、开拓新思路、实践新方案。">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    <meta name="keywords" content="openEuler, 操作系统, 开放, 生态, 开源, Linux 开源, OS, open, ecosystem, open source, Linux open source">
    <meta name="baidu-site-verification" content="code-EWzbQRssNU">
    <link rel="preload" href="/assets/css/0.styles.0df284ed.css" as="style"><link rel="preload" href="/assets/js/app.cdfb7ee7.js" as="script"><link rel="preload" href="/assets/js/14.8a38dea1.js" as="script"><link rel="preload" href="/assets/js/53.f8858a5b.js" as="script">
    <link rel="stylesheet" href="/assets/css/0.styles.0df284ed.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div id="euler-app" data-v-34596062><div class="nav-fill " data-v-fe04bb58 data-v-34596062><div class="nav-wrapper" data-v-fe04bb58><div class="nav-bar" data-v-fe04bb58><img src="/openeuler-logo.png" alt class="nav-logo" data-v-fe04bb58> <img src="/openeuler-logo.png" alt class="nav-logo nav-logo-mobile" data-v-fe04bb58> <ul class="nav-menu" data-v-fe04bb58><li data-v-fe04bb58><a class="menu-link" data-v-fe04bb58>下载
                        <span data-v-fe04bb58></span></a> <div class="sub-menu" data-v-fe04bb58><ul class="sig-menu-content" data-v-fe04bb58><li data-v-fe04bb58>
                                ISO
                            </li><li data-v-fe04bb58>
                                镜像仓列表
                            </li></ul> <span class="submenu-arrow" data-v-fe04bb58></span></div></li><li data-v-fe04bb58><a class="menu-link" data-v-fe04bb58>学习
                        <span data-v-fe04bb58></span></a> <div class="sub-menu" data-v-fe04bb58><ul class="sig-menu-content" data-v-fe04bb58><li data-v-fe04bb58>
                                文档
                            </li><li data-v-fe04bb58>
                                慕课
                            </li><li data-v-fe04bb58>
                                实习
                            </li></ul> <span class="submenu-arrow" data-v-fe04bb58></span></div></li><li data-v-fe04bb58><a class="menu-link menu-active" data-v-fe04bb58>互动
                        <span data-v-fe04bb58></span></a> <div class="sub-menu" data-v-fe04bb58><ul class="sig-menu-content" data-v-fe04bb58><li data-v-fe04bb58>
                                新闻
                            </li><li data-v-fe04bb58>
                                博客
                            </li><li data-v-fe04bb58>
                                直播
                            </li><li data-v-fe04bb58>
                                沙龙
                            </li><li data-v-fe04bb58>
                                峰会
                            </li></ul> <span class="submenu-arrow" data-v-fe04bb58></span></div></li><li data-v-fe04bb58><a class="menu-link" data-v-fe04bb58>社区
                        <span data-v-fe04bb58></span></a> <div class="sub-menu" data-v-fe04bb58><ul class="sig-menu-content" data-v-fe04bb58><li data-v-fe04bb58>
                                贡献攻略
                            </li><li data-v-fe04bb58>
                                行为守则
                            </li><li data-v-fe04bb58>
                                邮件列表
                            </li><li data-v-fe04bb58>
                                个人认证
                            </li></ul> <span class="submenu-arrow" data-v-fe04bb58></span></div></li><li data-v-fe04bb58><a class="menu-link" data-v-fe04bb58>SIG
                        <span data-v-fe04bb58></span></a> <div class="sub-menu" data-v-fe04bb58><ul class="sig-menu-content" data-v-fe04bb58><li data-v-fe04bb58>
                                查看SIG
                            </li><li data-v-fe04bb58>
                                申请流程
                            </li><li data-v-fe04bb58>
                                角色说明
                            </li></ul> <span class="submenu-arrow" data-v-fe04bb58></span></div></li><li data-v-fe04bb58><a class="menu-link" data-v-fe04bb58>探索
                        <span data-v-fe04bb58></span></a> <div class="sub-menu" data-v-fe04bb58><ul class="sig-menu-content" data-v-fe04bb58><li data-v-fe04bb58>
                                A-Tune
                            </li><li data-v-fe04bb58>
                                Bisheng JDK
                            </li><li data-v-fe04bb58>
                                iSula
                            </li><li data-v-fe04bb58>
                                secGear
                            </li><li data-v-fe04bb58>
                                StratoVirt
                            </li><li data-v-fe04bb58>
                                Compass-CI
                            </li><li data-v-fe04bb58>
                                Compliance
                            </li><li data-v-fe04bb58>
                                Pkgship
                            </li></ul> <span class="submenu-arrow" data-v-fe04bb58></span></div></li><li data-v-fe04bb58><a class="menu-link" data-v-fe04bb58>支持
                        <span data-v-fe04bb58></span></a> <div class="sub-menu" data-v-fe04bb58><ul class="sig-menu-content" data-v-fe04bb58><li data-v-fe04bb58>
                                漏洞管理
                            </li><li data-v-fe04bb58>
                                安全公告
                            </li><li data-v-fe04bb58>
                                CVE
                            </li><li data-v-fe04bb58>
                                兼容性列表
                            </li><li data-v-fe04bb58>
                                迁移指南
                            </li></ul> <span class="submenu-arrow" data-v-fe04bb58></span></div></li></ul> <ul class="nav-menu-mobile" style="display:none;" data-v-fe04bb58 data-v-fe04bb58><li data-v-fe04bb58><a class="menu-link" data-v-fe04bb58>下载<i class="icon-arrow" data-v-fe04bb58></i></a> <ul class="sub-menu" style="display:none;" data-v-fe04bb58 data-v-fe04bb58><li data-v-fe04bb58>
                                    ISO
                                </li><li data-v-fe04bb58>
                                    镜像仓列表
                                </li></ul></li><li data-v-fe04bb58><a class="menu-link" data-v-fe04bb58>学习<i class="icon-arrow" data-v-fe04bb58></i></a> <ul class="sub-menu" style="display:none;" data-v-fe04bb58 data-v-fe04bb58><li data-v-fe04bb58>
                                    文档
                                </li><li data-v-fe04bb58>
                                    慕课
                                </li><li data-v-fe04bb58>
                                    实习
                                </li></ul></li><li data-v-fe04bb58><a class="menu-link" data-v-fe04bb58>互动<i class="icon-arrow arrow-active" data-v-fe04bb58></i></a> <ul class="sub-menu" data-v-fe04bb58 data-v-fe04bb58><li data-v-fe04bb58>
                                    新闻
                                </li><li data-v-fe04bb58>
                                    博客
                                </li><li data-v-fe04bb58>
                                    直播
                                </li><li data-v-fe04bb58>
                                    沙龙
                                </li><li data-v-fe04bb58>
                                    峰会
                                </li></ul></li><li data-v-fe04bb58><a class="menu-link" data-v-fe04bb58>社区<i class="icon-arrow" data-v-fe04bb58></i></a> <ul class="sub-menu" style="display:none;" data-v-fe04bb58 data-v-fe04bb58><li data-v-fe04bb58>
                                    贡献攻略
                                </li><li data-v-fe04bb58>
                                    行为守则
                                </li><li data-v-fe04bb58>
                                    邮件列表
                                </li><li data-v-fe04bb58>
                                    个人认证
                                </li></ul></li><li data-v-fe04bb58><a class="menu-link" data-v-fe04bb58>SIG<i class="icon-arrow" data-v-fe04bb58></i></a> <ul class="sub-menu" style="display:none;" data-v-fe04bb58 data-v-fe04bb58><li data-v-fe04bb58>
                                    查看SIG
                                </li><li data-v-fe04bb58>
                                    申请流程
                                </li><li data-v-fe04bb58>
                                    角色说明
                                </li></ul></li><li data-v-fe04bb58><a class="menu-link" data-v-fe04bb58>探索<i class="icon-arrow" data-v-fe04bb58></i></a> <ul class="sub-menu" style="display:none;" data-v-fe04bb58 data-v-fe04bb58><li data-v-fe04bb58>
                                    A-Tune
                                </li><li data-v-fe04bb58>
                                    Bisheng JDK
                                </li><li data-v-fe04bb58>
                                    iSula
                                </li><li data-v-fe04bb58>
                                    secGear
                                </li><li data-v-fe04bb58>
                                    StratoVirt
                                </li><li data-v-fe04bb58>
                                    Compass-CI
                                </li><li data-v-fe04bb58>
                                    Compliance
                                </li><li data-v-fe04bb58>
                                    Pkgship
                                </li></ul></li><li data-v-fe04bb58><a class="menu-link" data-v-fe04bb58>支持<i class="icon-arrow" data-v-fe04bb58></i></a> <ul class="sub-menu" style="display:none;" data-v-fe04bb58 data-v-fe04bb58><li data-v-fe04bb58>
                                    漏洞管理
                                </li><li data-v-fe04bb58>
                                    安全公告
                                </li><li data-v-fe04bb58>
                                    CVE
                                </li><li data-v-fe04bb58>
                                    兼容性列表
                                </li><li data-v-fe04bb58>
                                    迁移指南
                                </li></ul></li> <li data-v-fe04bb58><a class="menu-link" data-v-fe04bb58>源码<i class="icon-arrow" data-v-fe04bb58></i></a> <ul class="sub-menu" style="display:none;" data-v-fe04bb58 data-v-fe04bb58><li data-v-fe04bb58>
                                    代码仓
                                </li><li data-v-fe04bb58>
                                    软件包仓
                                </li><li data-v-fe04bb58>
                                    GitHub镜像仓
                                </li></ul></li></ul> <div data-v-fe04bb58></div> <div class="search-mobile" data-v-fe04bb58><div class="el-input el-input--suffix" data-v-fe04bb58><!----><input type="text" autocomplete="off" placeholder="输入内容" class="el-input__inner"><!----><span class="el-input__suffix"><span class="el-input__suffix-inner"><i class="icon-search el-input__icon" data-v-fe04bb58></i><!----><!----><!----><!----></span><!----></span><!----><!----></div></div> <ul class="nav-other" style="display:;" data-v-fe04bb58><li class="lang" data-v-fe04bb58><span class="icon-lang" data-v-fe04bb58></span> <ul data-v-fe04bb58><li class="lang-list" data-v-fe04bb58>
                            中文
                        </li><li data-v-fe04bb58>
                            English
                        </li><li data-v-fe04bb58>
                            Русский
                        </li> <span class="submenu-arrow" data-v-fe04bb58></span></ul></li> <li data-v-fe04bb58><span data-v-fe04bb58>代码</span> <ul data-v-fe04bb58><li data-v-fe04bb58>
                            代码仓
                        </li><li data-v-fe04bb58>
                            软件包仓
                        </li><li data-v-fe04bb58>
                            GitHub镜像仓
                        </li> <span class="submenu-arrow" data-v-fe04bb58></span></ul></li> <li class="search" data-v-fe04bb58><img src="/search.png" alt data-v-fe04bb58></li></ul> <div class="search-input" style="display:none;" data-v-fe04bb58><div class="el-input el-input--small el-input--suffix" data-v-fe04bb58><!----><input type="text" autocomplete="off" placeholder="输入内容" class="el-input__inner"><!----><span class="el-input__suffix"><span class="el-input__suffix-inner"><i class="icon-search el-input__icon" data-v-fe04bb58></i><!----><!----><!----><!----></span><!----></span><!----><!----></div></div> <ul class="nav-other-mobile nav-other" data-v-fe04bb58><li class="lang" data-v-fe04bb58><span class="icon-lang" data-v-fe04bb58></span> <ul data-v-fe04bb58><li class="lang-list" data-v-fe04bb58>
                            中文
                        </li><li data-v-fe04bb58>
                            English
                        </li><li data-v-fe04bb58>
                            Русский
                        </li> <span class="submenu-arrow" data-v-fe04bb58></span></ul></li> <li class="search" data-v-fe04bb58><span class="icon-search" data-v-fe04bb58></span></li> <li class="menu" data-v-fe04bb58><span class="icon-menu" data-v-fe04bb58></span></li></ul></div></div> <!----></div> <!----> <div id="vuepress-theme-blog__post-layout" class="content" data-v-8dab3852 data-v-34596062><div class="blog-link-post" data-v-8dab3852>
        博客\
    </div> <div class="post-left" data-v-8dab3852><p class="blog-img mobile-hide" data-v-8dab3852><img src="/img/blog/blog_user.png" alt class="middle-img" data-v-8dab3852></p> <p class="mobile-hide" data-v-8dab3852><img src="/img/blog/account.svg" alt class="mobile-middle-img" data-v-8dab3852> <span class="blog-author" data-v-8dab3852>lifeng2221dd1</span></p> <p class="mobile-hide" data-v-8dab3852><img src="/img/blog/date.svg" alt class="mobile-middle-img" data-v-8dab3852> <span class="blog-date mobile" data-v-8dab3852>2020-09-14</span></p> <p class="mobile-hide" data-v-8dab3852><img src="/img/blog/visibility.svg" alt class="mobile-middle-img" data-v-8dab3852> <span class="blog-date" data-v-8dab3852><span data-v-8dab3852><span data-v-8dab3852>浏览</span> <span data-v-8dab3852></span> <span data-v-8dab3852>次</span></span></span></p> <p class="bottom-line bottom-line-none" data-v-8dab3852></p> <!----> <p class="other-blog-item" data-v-8dab3852></p></div> <div class="post-right" data-v-8dab3852><p class="blog-title" data-v-8dab3852>iSulad 轻量级容器引擎功能介绍以及代码架构解析</p> <div class="user-info-mobile" data-v-8dab3852><div class="left" data-v-8dab3852><img src="/img/blog/blog_user.png" alt data-v-8dab3852></div> <div class="right" data-v-8dab3852><p class="name" data-v-8dab3852>lifeng2221dd1</p> <p class="date-count" data-v-8dab3852><span class="date" data-v-8dab3852>2020-09-14</span> <span class="count" data-v-8dab3852>浏览次</span></p></div></div> <p class="blog-item-tag" data-v-8dab3852><span data-v-8dab3852>标签: </span> <span data-v-8dab3852><span class="tag-item" data-v-8dab3852>iSulad</span> <!----></span></p> <p class="bottom-line bottom-line-none" data-v-8dab3852></p> <div id="blog_content" class="markdown content__default" data-v-8dab3852><p><em>作者简介：李峰， 具有多年容器、操作系统软件开发经验，对容器引擎、runtime 等领域有比较深入的研究与理解。深度参与 lxc、containers 等开源容器社区。现在担任 openeuler 轻量级容器引擎 iSulad 社区 maintainer。</em></p> <p>iSulad 是一种由 C/C++编程语言编写的容器引擎，当前已经在 openeuler 社区开源(https://gitee.com/openeuler/iSulad)。 当前主流的容器引擎 docker、containerd、cri-o 等均是由 GO 语言编写。随着边缘计算、物联网等嵌入式设备场景的不断兴起，在资源受限环境下，业务容器化的需求越来越强烈。由高级语言编写的容器引擎在底噪占用上的劣势越来越凸显。另外由于容器引擎对外接口的标准化，因此用 C/C++重写一个容器引擎成为了可能。iSulad 整体架构如下图所示。</p> <img src="/assets/img/2020-09-14-isulad-architecture-01.cb57046e.png" alt="iSulad" style="zoom:100%;"> <p>iSulad 对外提供命令行以及基于 gRPC 的 CRI 两种对外接口，其中核心功能根据业务分为镜像管理和容器管理。</p> <p>通过下图可以理解 iSulad 在生态中的定位。</p> <img src="/assets/img/2020-09-14-isulad-architecture-09.85c4f48a.png" alt="iSulad" style="zoom:100%;"> <p>本文介绍 iSulad 的功能特性以及对整体架构进行介绍。</p> <h2 id="isulad-功能特性介绍"><a href="#isulad-功能特性介绍" class="header-anchor">#</a> iSulad 功能特性介绍</h2> <h3 id="提供客户端命令行进行容器、镜像操作"><a href="#提供客户端命令行进行容器、镜像操作" class="header-anchor">#</a> 提供客户端命令行进行容器、镜像操作</h3> <p>iSulad 是典型的 CS 架构模式。iSulad 作为 daemon 服务端，同时也提供了单独的客户端命令 isula，供用户使用。</p> <p>iSula 提供的命令参数覆盖了常用的大部分的应用场景。包含容器的操作接口，如运行、停止、删除、pause 等操作，也包含了镜像相关的操作，如下载、导入、删除等。</p> <div class="language- extra-class"><pre class="language-text"><code>$ sudo isula --help
USAGE:
	isula &lt;command&gt; [args...]

COMMANDS:
	attach 	Attach to a running container
	cp     	Copy files/folders between a container and the local filesystem
	create 	Create a new container
	events 	Get real time events from the server
	exec   	Run a command in a running container
	export 	export container
	images 	List images
	import 	Import the contents from a tarball to create a filesystem image
	info   	Display system-wide information
	inspect	Return low-level information on a container or image
	kill   	Kill one or more  running containers
	load   	load an image from a tar archive
	login  	Log in to a Docker registry
	logout 	Log out from a Docker registry
	logs   	Fetch the logs of a container
	pause  	Pause all processes within one or more containers
	ps     	List containers
	pull   	Pull an image or a repository from a registry
	rename 	Rename a container
	restart	Restart one or more containers
	rm     	Remove one or more containers
	rmi    	Remove one or more images
	run    	Run a command in a new container
	start  	Start one or more stopped containers
	stats  	Display a live stream of container(s) resource usage statistics
	stop   	Stop one or more containers
	tag    	Create a tag TARGET_IMAGE that refers to SOURCE_IMAGE
	top    	Display the running processes of a container
	unpause	Unpause all processes within one or more containers
	update 	Update configuration of one or more containers
	version	Display information about isula
	wait   	Block until one or more containers stop, then print their exit codes
</code></pre></div><h3 id="使用举例"><a href="#使用举例" class="header-anchor">#</a> 使用举例</h3> <p>假设您使用的为openeuler发行版本，可以采用以下方式使用iSulad。</p> <h4 id="使用yum命令安装isulad"><a href="#使用yum命令安装isulad" class="header-anchor">#</a> 使用yum命令安装isulad</h4> <div class="language- extra-class"><pre class="language-text"><code>[root@openeuler ~]# yum install -y iSulad
</code></pre></div><h4 id="安装完成后-查看服务运行状态"><a href="#安装完成后-查看服务运行状态" class="header-anchor">#</a> 安装完成后，查看服务运行状态</h4> <div class="language- extra-class"><pre class="language-text"><code>[root@openeuler ~]# systemctl status isulad
● isulad.service - iSulad Application Container Engine
   Loaded: loaded (/usr/lib/systemd/system/isulad.service; enabled; vendor preset: disabled)
   Active: active (running) since Mon 2020-09-14 15:53:43 CST; 4h 35min ago
 Main PID: 1248 (isulad)
    Tasks: 25
   Memory: 88.3M
   CGroup: /system.slice/isulad.service
           ├─1248 /usr/bin/isulad
</code></pre></div><h4 id="修改isulad的配置文件-添加镜像仓库地址"><a href="#修改isulad的配置文件-添加镜像仓库地址" class="header-anchor">#</a> 修改isulad的配置文件，添加镜像仓库地址</h4> <div class="language- extra-class"><pre class="language-text"><code>[root@openeuler iSula]# vi /etc/isulad/daemon.json   
{
    .......
    &quot;registry-mirrors&quot;: [
        &quot;hub.oepkgs.net&quot;
    ],
    .......
</code></pre></div><h4 id="重启isulad服务"><a href="#重启isulad服务" class="header-anchor">#</a> 重启isulad服务</h4> <div class="language- extra-class"><pre class="language-text"><code>[root@openeuler iSula]# systemctl restart isulad
</code></pre></div><h4 id="基于openeuler-20-09镜像运行容器"><a href="#基于openeuler-20-09镜像运行容器" class="header-anchor">#</a> 基于openeuler:20.09镜像运行容器</h4> <p>创建容器：</p> <div class="language- extra-class"><pre class="language-text"><code>[root@openeuler iSula]# isula create -it openeuler/openeuler:20.09
Unable to find image 'openeuler/openeuler:20.09' locally
Image &quot;openeuler/openeuler:20.09&quot; pulling
Image &quot;8c788f4bfb7290e434b2384340a5f9811db6ed302f9247c5fc095d6ec4fc8f32&quot; pulled
e91e5359be653f534312bc2b4703dcc6c4ca0436ac7819e09e1ff0e75ee1d733
</code></pre></div><p>由于没有运行容器，所以利用isula ps命令无法找到刚刚创建的容器：</p> <div class="language- extra-class"><pre class="language-text"><code>[root@openeuler iSula]# isula ps
CONTAINER ID	IMAGE				COMMAND	CREATED		STATUS	PORTS	NAMES
</code></pre></div><p>可以使用isula pa –a命令可以找到刚刚创建的容器：</p> <div class="language- extra-class"><pre class="language-text"><code>[root@ecs-cdf3 ~]# isula ps -a
CONTAINER ID	IMAGE				COMMAND	CREATED		STATUS	PORTS	NAMES
e91e5359be65		openeuler/openeuler:20.09	&quot;/bin/bash&quot;		8 seconds ago	Created	 e91e5359be653f534312bc2b4703dcc6c4ca0436ac7819e09e1ff0e75ee1d733
</code></pre></div><p>启动容器：</p> <div class="language- extra-class"><pre class="language-text"><code>[root@openeuler iSula]# isula start e91e5359be65
</code></pre></div><p>由于已经运行容器，可以利用isula ps命令查找运行中的容器</p> <div class="language- extra-class"><pre class="language-text"><code>[root@openeuler iSula]# isula ps
CONTAINER ID	IMAGE				COMMAND	CREATED		STATUS	PORTS	NAMES
e91e5359be65		openeuler/openeuler:20.09	&quot;/bin/bash&quot;		30 seconds ago	Up 4 seconds	     e91e5359be653f534312bc2b4703dcc6c4ca0436ac7819e09e1ff0e75ee1d733
</code></pre></div><p>执行命令输出容器系统版本信息：</p> <div class="language- extra-class"><pre class="language-text"><code>[root@ecs-cdf3 ~]# isula exec e91e5359be65 cat /etc/os-release
NAME=&quot;openEuler&quot;
VERSION=&quot;20.09&quot;
ID=&quot;openEuler&quot;
VERSION_ID=&quot;20.09&quot;
PRETTY_NAME=&quot;openEuler 20.09&quot;
ANSI_COLOR=&quot;0;31&quot;
</code></pre></div><p>可以看到我们在openeuler 20.03系统上成功运行openeuler 20.09容器。</p> <p>暂停/恢复一个容器</p> <div class="language- extra-class"><pre class="language-text"><code>[root@openeuler iSula]# isula pause e91e5359be65
e91e5359be65
[root@openeuler iSula]# isula unpause e91e5359be65
e91e5359be65
</code></pre></div><p>强制删除运行中的容器</p> <div class="language- extra-class"><pre class="language-text"><code>[root@openeuler iSula]# isula rm -f 6c1d81467d33
6c1d81467d3367a90dd6e388a16c80411d4ba76316d86b6f56463699306e1394
</code></pre></div><p>删除镜像</p> <div class="language- extra-class"><pre class="language-text"><code>[root@openeuler iSula]# isula rmi openeuler/openeuler:20.09
Image &quot; openeuler/openeuler:20.09&quot; removed
</code></pre></div><h3 id="支持-cri-标准协议"><a href="#支持-cri-标准协议" class="header-anchor">#</a> 支持 CRI 标准协议</h3> <p>CRI(Container Runtime Interface)是由 K8S 定义的容器引擎需要向 k8S 对外提供的容器和镜像的服务的接口,供容器引擎接入 K8S。</p> <p>CRI 接口基于 gRPC 实现。iSulad 遵循 CRI 接口规范，实现 CRI gRPC Server，包括 Runtime Service 和 Image Service 分别用来提供容器运行时接口和镜像操作接口。iSulad 的 gRPC Server 需要监听本地的 Unix socket，而 K8S 的组件 kubelet 则作为 gRPC Client 运行。</p> <img src="/assets/img/2020-09-14-isulad-architecture-06.50c1c0c8.png" alt="iSulad" style="zoom:100%;"> <h3 id="支持-cni-网络标准协议"><a href="#支持-cni-网络标准协议" class="header-anchor">#</a> 支持 CNI 网络标准协议</h3> <p>CNI(Container Network Interface) 是 google 和 CoreOS 主导制定的容器网络标准协议。通过 CNI 协议，iSulad 通过 JSON 格式的文件与具体网络插件进行通信，进而实现容器的网络功能。容器网络具体的功能均由网络插件来实现。iSulad 中使用 C 语言实现了 clibcni 接口模块，用来实现对应功能。</p> <img src="/assets/img/2020-09-14-isulad-architecture-05.8f6056ef.png" alt="iSulad" style="zoom:100%;"> <h3 id="遵循-oci-标准"><a href="#遵循-oci-标准" class="header-anchor">#</a> 遵循 OCI 标准</h3> <p>OCI 包含两个标准规范 <strong>容器运行时标准 （runtime spec）和 容器镜像标准（image spec）</strong>。</p> <h4 id="支持-oci-标准镜像格式"><a href="#支持-oci-标准镜像格式" class="header-anchor">#</a> 支持 OCI 标准镜像格式</h4> <p>首先介绍下，什么是容器镜像。容器运行所需的 rootfs 以及一些资源配置等信息被打包成特定的数据结构，称为容器镜像。基于容器镜像可以方便地运行容器。由于运行环境和应用被一起打包到了容器镜像中，这样就解决了应用部署时的环境依赖问题。每个容器镜像由一个或多个层数据、以及一个 config.json 配置文件组成。多个层之间有依赖关系，这种依赖关系称为父子关系（被依赖的层为父层）。运行容器之前，所有层的数据会合并挂载成一个 rootfs 供容器使用，称为容器层。合并后的数据如果有冲突，则子层的数据会覆盖父层中路径名称都相同的数据，镜像组织结构如下图所示：</p> <img src="/assets/img/2020-09-14-isulad-architecture-08.4fd5eef7.png" alt="iSulad-img-single" style="zoom:100%;"> <p>镜像的分层是为了解决空间占用问题。如果本层及其所有递归依赖的父层具有相同的数据，这些数据就可以复用，以减少空间占用。下图描述的是具有相同 layer0 层和 layer1 层的两个容器镜像的数据复用结构：</p> <img src="/assets/img/2020-09-14-isulad-architecture-07.40444c98.png" alt="iSulad-img-dual" style="zoom:100%;"> <p>iSulad 支持 OCI 标准镜像格式以及与 docker 兼容的镜像格式。能够 支持从 docker hub 等镜像仓库下载容器镜像，或者导入由 docker 导出的镜像文件来启动容器使用。</p> <h4 id="支持-oci-标准-runtime"><a href="#支持-oci-标准-runtime" class="header-anchor">#</a> 支持 OCI 标准 runtime</h4> <p>iSulad 支持标准 OCI runtime 操作接口，可以进行容器生命周期管理。iSulad 不仅支持当前主流的容器 runtime 如 runc、kata，而且针对低底噪的需求，将 C 语言编写的 lxc 进行了适配修改，使其能够作为支持 OCI 标准协议的 C 语言 runtime，进一步降低了容器引擎基础设施底噪开销。
​ 下面使用 iSulad 来运行一个新的容器，通过查看运行过程中产生的进程以及持久化的配置，理解运行新容器的过程。</p> <p>运行容器，首先需要下载镜像，我们使用 前文中提到的 openeuler/openeuler:20.09 来作为容器镜像。</p> <p>调用 isula 客户端命令下载镜像。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token function">sudo</span> isula pull openeuler/openeuler:20.09
Image <span class="token string">&quot;openeuler/openeuler:20.09&quot;</span> pulling
Image <span class="token string">&quot;c7c37e472d31c1685b48f7004fd6a64361c95965587a951692c5f298c6685998&quot;</span> pulled
</code></pre></div><p>运行容器指创建一个新的容器，并启动它。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token function">sudo</span> isula run -itd openeuler/openeuler:20.09
42fc2595f876b5a18f7729dfb10d0def29789fb73fe0f1327e0277e6d85189a1
</code></pre></div><p>运行容器后，可以通过本地文件查看持久化的容器配置文件。</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># cd /var/lib/isulad/engines/lcr/42fc2595f876b5a18f7729dfb10d0def29789fb73fe0f1327e0277e6d85189a1</span>
<span class="token comment"># ls -al</span>
total <span class="token number">92</span>
drwxr-x--- <span class="token number">3</span> root root  <span class="token number">4096</span> <span class="token number">7</span>月  <span class="token number">27</span> <span class="token number">16</span>:25 <span class="token builtin class-name">.</span>
drwxr-x--- <span class="token number">3</span> root root  <span class="token number">4096</span> <span class="token number">7</span>月  <span class="token number">27</span> <span class="token number">16</span>:25 <span class="token punctuation">..</span>
-rw-r----- <span class="token number">1</span> root root  <span class="token number">4045</span> <span class="token number">7</span>月  <span class="token number">27</span> <span class="token number">16</span>:25 config
-rw-r----- <span class="token number">1</span> root root <span class="token number">23878</span> <span class="token number">7</span>月  <span class="token number">27</span> <span class="token number">16</span>:25 config.json
-rw-r----- <span class="token number">1</span> root root  <span class="token number">2314</span> <span class="token number">7</span>月  <span class="token number">27</span> <span class="token number">16</span>:25 config.v2.json
-rw-r----- <span class="token number">1</span> root root     <span class="token number">0</span> <span class="token number">7</span>月  <span class="token number">27</span> <span class="token number">16</span>:25 console.log
-rw-r----- <span class="token number">1</span> root root   <span class="token number">101</span> <span class="token number">7</span>月  <span class="token number">27</span> <span class="token number">16</span>:25 hostconfig.json
-rw-r--r-- <span class="token number">1</span> root root    <span class="token number">10</span> <span class="token number">7</span>月  <span class="token number">27</span> <span class="token number">16</span>:25 <span class="token function">hostname</span>
-rw-r--r-- <span class="token number">1</span> root root   <span class="token number">183</span> <span class="token number">7</span>月  <span class="token number">27</span> <span class="token number">16</span>:25 hosts
drwx------ <span class="token number">3</span> root root  <span class="token number">4096</span> <span class="token number">7</span>月  <span class="token number">27</span> <span class="token number">16</span>:25 mounts
-rw-r----- <span class="token number">1</span> root root     <span class="token number">5</span> <span class="token number">7</span>月  <span class="token number">27</span> <span class="token number">16</span>:25 ocihooks.json
-rw-r--r-- <span class="token number">1</span> root root   <span class="token number">707</span> <span class="token number">7</span>月  <span class="token number">27</span> <span class="token number">16</span>:25 resolv.conf
-rw-r----- <span class="token number">1</span> root root <span class="token number">26140</span> <span class="token number">7</span>月  <span class="token number">27</span> <span class="token number">16</span>:25 seccomp
</code></pre></div><p>其中 config.json 文件为符合 OCI 标准协议的容器配置文件，内容包括启动容器所需的配置信息。</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># cat config.json</span>
<span class="token punctuation">{</span>
    <span class="token string">&quot;ociVersion&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;1.0.1&quot;</span>,
    <span class="token string">&quot;hooks&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>

    <span class="token punctuation">}</span>,
    <span class="token string">&quot;hostname&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;localhost&quot;</span>,
    <span class="token string">&quot;mounts&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
            <span class="token string">&quot;source&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;tmpfs&quot;</span>,
            <span class="token string">&quot;destination&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;/dev&quot;</span>,
            <span class="token string">&quot;options&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
                <span class="token string">&quot;nosuid&quot;</span>,
                <span class="token string">&quot;strictatime&quot;</span>,
                <span class="token string">&quot;mode=755&quot;</span>,
                <span class="token string">&quot;size=65536k&quot;</span>
            <span class="token punctuation">]</span>,
            <span class="token string">&quot;type&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;tmpfs&quot;</span>
        <span class="token punctuation">}</span>,
        <span class="token punctuation">{</span>
            <span class="token string">&quot;source&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;mqueue&quot;</span>,
            <span class="token string">&quot;destination&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;/dev/mqueue&quot;</span>,
            <span class="token string">&quot;options&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
                <span class="token string">&quot;nosuid&quot;</span>,
                <span class="token string">&quot;noexec&quot;</span>,
                <span class="token string">&quot;nodev&quot;</span>
            <span class="token punctuation">]</span>,
            <span class="token string">&quot;type&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;mqueue&quot;</span>
        <span class="token punctuation">}</span>,
        <span class="token punctuation">..</span>.
</code></pre></div><p>config.v2.json 为 iSulad 维护管理容器持久化的一些信息,包括容器的基础配置，以及创建时间，启动时间，容器的 PID、运行启动时间等信息。</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># cat config.v2.json</span>
<span class="token punctuation">{</span>
    <span class="token string">&quot;CommonConfig&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;Path&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;sh&quot;</span>,
        <span class="token string">&quot;Config&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
            <span class="token string">&quot;Hostname&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;localhost&quot;</span>,
            <span class="token string">&quot;User&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;&quot;</span>,
            <span class="token string">&quot;Tty&quot;</span><span class="token builtin class-name">:</span> true,
            <span class="token string">&quot;OpenStdin&quot;</span><span class="token builtin class-name">:</span> true,
            <span class="token string">&quot;Env&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
                <span class="token string">&quot;PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin&quot;</span>
            <span class="token punctuation">]</span>,
            <span class="token string">&quot;Cmd&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
                <span class="token string">&quot;sh&quot;</span>
            <span class="token punctuation">]</span>,
            <span class="token string">&quot;WorkingDir&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;&quot;</span>,
            <span class="token string">&quot;LogDriver&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;json-file&quot;</span>
        <span class="token punctuation">}</span>,
        <span class="token string">&quot;Created&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;2020-07-27T16:25:16.170149428+08:00&quot;</span>,
        <span class="token string">&quot;Image&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;openeuler/openeuler:20.09&quot;</span>,
        <span class="token string">&quot;ImageType&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;oci&quot;</span>,
        <span class="token string">&quot;Name&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;42fc2595f876b5a18f7729dfb10d0def29789fb73fe0f1327e0277e6d85189a1&quot;</span>,
        <span class="token string">&quot;id&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;42fc2595f876b5a18f7729dfb10d0def29789fb73fe0f1327e0277e6d85189a1&quot;</span>
    <span class="token punctuation">}</span>,
    <span class="token string">&quot;Image&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;sha256:c7c37e472d31c1685b48f7004fd6a64361c95965587a951692c5f298c6685998&quot;</span>,
    <span class="token string">&quot;State&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;FinishedAt&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;0001-01-01T00:00:00Z&quot;</span>,
        <span class="token string">&quot;Pid&quot;</span><span class="token builtin class-name">:</span> <span class="token number">19232</span>,
        <span class="token string">&quot;PPid&quot;</span><span class="token builtin class-name">:</span> <span class="token number">19229</span>,
        <span class="token string">&quot;StartTime&quot;</span><span class="token builtin class-name">:</span> <span class="token number">2731408</span>,
        <span class="token string">&quot;PStartTime&quot;</span><span class="token builtin class-name">:</span> <span class="token number">2731402</span>,
        <span class="token string">&quot;Running&quot;</span><span class="token builtin class-name">:</span> true,
        <span class="token string">&quot;StartedAt&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;2020-07-27T16:25:16.286812971+08:00&quot;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="性能表现"><a href="#性能表现" class="header-anchor">#</a> 性能表现</h2> <h3 id="与其他容器引擎性能比较"><a href="#与其他容器引擎性能比较" class="header-anchor">#</a> 与其他容器引擎性能比较</h3> <h4 id="测试环境"><a href="#测试环境" class="header-anchor">#</a> 测试环境</h4> <table><thead><tr><th>Configuration</th> <th>Information</th></tr></thead> <tbody><tr><td>OS</td> <td>Fedora32 X86_64</td></tr> <tr><td>kernel</td> <td>linux 5.7.10-201.fc32.x86_64</td></tr> <tr><td>CPU</td> <td>48 cores，Intel Xeon CPU E5-2695 v2 @ 2.4GHZ</td></tr> <tr><td>memory</td> <td>132 GB</td></tr></tbody></table> <h4 id="测试版本"><a href="#测试版本" class="header-anchor">#</a> 测试版本</h4> <table><thead><tr><th>Name</th> <th>Version</th></tr></thead> <tbody><tr><td>iSulad</td> <td>Version: 2.0.3 , Git commit: 3bb24761f07cc0ac399e1cb783053db8b33b263d</td></tr> <tr><td>docker</td> <td>Version: 19.03.11, Git commit: 42e35e6</td></tr> <tr><td>podman</td> <td>version 2.0.3</td></tr> <tr><td>CRI-O</td> <td>v1.15.4</td></tr> <tr><td>kubelet</td> <td>v1.15.0</td></tr> <tr><td>cri-tools</td> <td>v1.15.0</td></tr></tbody></table> <h4 id="单容器操作"><a href="#单容器操作" class="header-anchor">#</a> 单容器操作</h4> <p>使用客户端</p> <table><thead><tr><th>operator (ms)</th> <th>Docker</th> <th>Podman</th> <th>iSulad</th> <th>vs Docker</th> <th>vs Podman</th></tr></thead> <tbody><tr><td>create</td> <td>287</td> <td>180</td> <td>87</td> <td>-69.69%</td> <td>-51.67%</td></tr> <tr><td>start</td> <td>675</td> <td>916</td> <td>154</td> <td>-77.19%</td> <td>-83.19%</td></tr> <tr><td>stop</td> <td>349</td> <td>513</td> <td>274</td> <td>-21.49%</td> <td>-46.59%</td></tr> <tr><td>rm</td> <td>72</td> <td>187</td> <td>60</td> <td>-16.67%</td> <td>-67.91%</td></tr> <tr><td>run</td> <td>866</td> <td>454</td> <td>195</td> <td>-77.48%</td> <td>-57.05%</td></tr></tbody></table> <p>使用 CRI 接口</p> <table><thead><tr><th>operator (ms)</th> <th>Docker</th> <th>CRIO</th> <th>iSulad</th> <th>vs Docker</th> <th>vs Podman</th></tr></thead> <tbody><tr><td>runp</td> <td>681</td> <td>321</td> <td>186</td> <td>-72.69%</td> <td>-42.06%</td></tr> <tr><td>stopp</td> <td>400</td> <td>356</td> <td>169</td> <td>-57.75%</td> <td>-52.53%</td></tr></tbody></table> <h4 id="并发-100-容器操作"><a href="#并发-100-容器操作" class="header-anchor">#</a> 并发 100 容器操作</h4> <p>使用客户端</p> <table><thead><tr><th>operator (ms)</th> <th>Docker</th> <th>Podman</th> <th>iSulad</th> <th>vs Docker</th> <th>vs Podman</th></tr></thead> <tbody><tr><td>100 * create</td> <td>4995</td> <td>3993</td> <td>829</td> <td>-83.40%</td> <td>-79.24%</td></tr> <tr><td>100 * start</td> <td>10126</td> <td>5537</td> <td>1425</td> <td>-85.93%</td> <td>-74.26%</td></tr> <tr><td>100 * stop</td> <td>8066</td> <td>11100</td> <td>2273</td> <td>-71.82%</td> <td>-79.52%</td></tr> <tr><td>100 * rm</td> <td>3220</td> <td>4319</td> <td>438</td> <td>-86.40%</td> <td>-89.86%</td></tr> <tr><td>100 * run</td> <td>9822</td> <td>5979</td> <td>2117</td> <td>-78.45%</td> <td>-64.59%</td></tr></tbody></table> <p>使用 CRI 接口</p> <table><thead><tr><th>operator (ms)</th> <th>Docker</th> <th>CRIO</th> <th>iSulad</th> <th>vs Docker</th> <th>vs Podman</th></tr></thead> <tbody><tr><td>100 * runp</td> <td>13998</td> <td>4946</td> <td>2825</td> <td>-79.82%</td> <td>-42.88%</td></tr> <tr><td>100 * stopp</td> <td>8402</td> <td>4834</td> <td>4543</td> <td>-45.93%</td> <td>-6.02%</td></tr></tbody></table> <h2 id="isulad-代码架构介绍"><a href="#isulad-代码架构介绍" class="header-anchor">#</a> iSulad 代码架构介绍</h2> <p>前面介绍了 iSulad 的主要的功能特性，现在让我们深入到 iSulad 的代码中，了解下 iSulad 的代码组织架构。</p> <h3 id="ddd-分层架构设计"><a href="#ddd-分层架构设计" class="header-anchor">#</a> <strong>DDD 分层架构设计</strong></h3> <p>iSulad 采用 DDD（Domain Driven Design，领域驱动设计）的思想进行架构分层组织，层次划分如下：</p> <img src="/assets/img/2020-09-14-isulad-architecture-03.25c2992a.jpg" alt="ddd" style="zoom:100%;"> <p>各逻辑分层划分以及对应的职责如下：</p> <table><thead><tr><th><strong>层次</strong></th> <th><strong>职责划分</strong></th></tr></thead> <tbody><tr><td>用户界面</td> <td>负责向用户展现信息以及解释用户命令</td></tr> <tr><td>接口层</td> <td>客户端服务端通信接口、CRI 接口的定义与实现</td></tr> <tr><td>应用层</td> <td>调用领域层的接口，实现对应的业务应用</td></tr> <tr><td>领域层</td> <td>本层包含关于领域的信息，这是 iSulad 软件的核心所在。包含多种模块，业务逻辑实际的执行层</td></tr> <tr><td>基础设施层</td> <td>本层作为其他层的支撑库。它提供各种工具函数供其他层次调用使用</td></tr></tbody></table> <p>根据上述逻辑分层的设计思想，iSulad 对应源码目录架构设计为:</p> <img src="/assets/img/2020-09-14-isulad-architecture-04.79239aff.jpg" alt="iSulad-img-single" style="zoom:100%;"> <p>其中 api 目录中定义了 iSulad 对外提供的 gRPC 服务的 proto 文件，在编译时会使用 grpc 生成对应客户端、服务端代码。</p> <h3 id="各层代码组织结构"><a href="#各层代码组织结构" class="header-anchor">#</a> 各层代码组织结构</h3> <h4 id="用户界面层"><a href="#用户界面层" class="header-anchor">#</a> 用户界面层</h4> <p>用户界面层的代码位于 src/cmd 目录下，在该目录下，提供了 iSulad 对外的命令行接口。在 cmd 目录下，提供了 isula 客户端、isulad 服务端、isulad-shim 三个命令行相关的命令行解析、参数显示。代码组织结构如下：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>├── CMakeLists.txt
├── command_parser.c
├── command_parser.h
├── isula <span class="token comment"># 客户端命令行以及子命令的定义</span>
│   ├── base <span class="token comment"># 容器操作基础命令，如创建、启动、删除等命令</span>
│   ├── client_arguments.c
│   ├── client_arguments.h
│   ├── CMakeLists.txt
│   ├── extend  <span class="token comment"># 容器操作扩展命令，如update更新容器资源、events查看容器事件日志</span>
│   ├── images <span class="token comment"># 镜像相关操作命令，如下载、导入、删除等操作</span>
│   ├── information <span class="token comment"># 查询容器信息操作命令，如inspect、info等操作</span>
│   ├── isula_commands.c
│   ├── isula_commands.h
│   ├── main.c
│   └── stream  <span class="token comment"># 长连接命令，如cp、attach、exec等需要与服务端进行长连接操作的命令</span>
├── isulad <span class="token comment"># 服务端命令行以及参数的定义</span>
│   ├── CMakeLists.txt
│   ├── isulad_commands.c
│   ├── isulad_commands.h
│   └── main.c
└── isulad-shim <span class="token comment"># isulad-shim命令行以及参数的定义</span>
│   ├── CMakeLists.txt
│   ├── common.c
│   ├── common.h
│   ├── main.c
│   ├── process.c
│   ├── process.h
│   ├── terminal.c
│   └── terminal.h
└── options <span class="token comment"># 通用的参数解析方法</span>
│   ├── CMakeLists.txt
│   ├── opt_log.c
│   ├── opt_log.h
│   ├── opt_ulimit.c
│   └── opt_ulimit.h


</code></pre></div><h4 id="接口层"><a href="#接口层" class="header-anchor">#</a> 接口层</h4> <p>iSulad 的接口层代码位于 src/daemon/entry 目录，其中提供了客户端服务端通信接口、CRI 接口的定义。</p> <p>用以处理客户端接口的请求以及 CRI 接口请求。</p> <p>其中 CRI 接口处理中，可以从文件名中看到，iSulad 分别实现了 image 和 runtime 的两种 service。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>├── CMakeLists.txt
├── connect <span class="token comment"># 处理客户端请求</span>
│   ├── CMakeLists.txt
│   ├── grpc <span class="token comment"># grpc 请求接口处理</span>
│   ├── rest <span class="token comment"># restful 请求接口处理</span>
│   ├── service_common.c
│   └── service_common.h
└── cri  <span class="token comment"># 处理CRI接口请求</span>
    ├── checkpoint_handler.cc
    ├── checkpoint_handler.h
    ├── CMakeLists.txt
    ├── cni_network_plugin.cc
    ├── cni_network_plugin.h
    ├── cri_container.cc <span class="token comment"># cri接口中容器相关操作请求接口处理</span>
    ├── cri_container.h
    ├── cri_image_service.cc <span class="token comment"># cri接口中image相关操作请求接口处理</span>
    ├── cri_image_service.h
    ├── cri_runtime_service.cc  <span class="token comment"># cri接口中runtime相关操作请求接口处理</span>
    ├── cri_runtime_service.h
    ├── cri_sandbox.cc <span class="token comment"># cri接口中pod相关操作请求接口处理</span>
    ├── cri_sandbox.h
    ├── cri_security_context.cc <span class="token comment"># cri接口中安全配置处理</span>
    ├── cri_security_context.h
    └── websocket  <span class="token comment"># 使用websocket服务处理CRI 流式服务请求</span>
</code></pre></div><h4 id="应用层"><a href="#应用层" class="header-anchor">#</a> 应用层</h4> <p>iSulad 的应用层代码位于 src/daemon/executor 目录，其作用为调用领域层的接口，实现对应的业务应用，属于业务调度层。可以从文件夹的命名中看到，应用层分别实现了 image 和 runtime 的两种业务模块。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>├── callback.c
├── callback.h
├── CMakeLists.txt
├── container_cb <span class="token comment"># 容器业务模块</span>
│   ├── CMakeLists.txt
│   ├── execution.c
│   ├── execution_create.c
│   ├── execution_create.h
│   ├── execution_extend.c
│   ├── execution_extend.h
│   ├── execution.h
│   ├── execution_information.c
│   ├── execution_information.h
│   ├── execution_network.c
│   ├── execution_network.h
│   ├── execution_stream.c
│   ├── execution_stream.h
│   ├── list.c
│   └── list.h
└── image_cb <span class="token comment"># 镜像业务模块</span>
    ├── CMakeLists.txt
    ├── image_cb.c
    └── image_cb.h
</code></pre></div><h4 id="领域层"><a href="#领域层" class="header-anchor">#</a> 领域层</h4> <p>领域层包含领域的信息，这是 iSulad 软件的核心所在。其中包含各个业务模块，是业务逻辑实际的执行层。领域层代码位于 src/daemon/modules。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>├── api <span class="token comment"># 领域层统一对外提供的头文件，供应用层调用</span>
│   ├── CMakeLists.txt
│   ├── container_api.h
│   ├── events_collector_api.h
│   ├── events_sender_api.h
│   ├── event_type.h
│   ├── image_api.h
│   ├── io_handler.h
│   ├── log_gather_api.h
│   ├── plugin_api.h
│   ├── runtime_api.h
│   ├── service_container_api.h
│   ├── service_image_api.h
│   └── specs_api.h
├── CMakeLists.txt
├── container <span class="token comment"># 容器模块，维护容器全生命周期，维护容器状态</span>
│   ├── CMakeLists.txt
│   ├── container_events_handler.c
│   ├── container_events_handler.h
│   ├── container_gc
│   ├── containers_store.c
│   ├── containers_store.h
│   ├── container_state.c
│   ├── container_state.h
│   ├── container_unix.c
│   ├── container_unix.h
│   ├── health_check
│   ├── restart_manager
│   ├── restore
│   └── supervisor
├── events <span class="token comment"># 事件收集模块，负责收集iSulad运行过程中产生的容器、镜像事件</span>
│   ├── CMakeLists.txt
│   ├── collector.c
│   ├── monitord.c
│   └── monitord.h
├── events_sender  <span class="token comment"># 事件发送模块，该接口提供向事件收集模块发送事件的接口</span>
│   ├── CMakeLists.txt
│   └── event_sender.c
├── image <span class="token comment"># 镜像管理模块</span>
│   ├── CMakeLists.txt
│   ├── embedded <span class="token comment"># embedded格式镜像管理</span>
│   ├── external <span class="token comment"># external格式镜像管理</span>
│   ├── image.c
│   ├── image_rootfs_handler.c
│   ├── image_rootfs_handler.h
│   └── oci	<span class="token comment"># oci格式镜像管理</span>
├── log <span class="token comment"># 日志收集模块</span>
│   ├── CMakeLists.txt
│   └── log_gather.c
├── plugin <span class="token comment"># 插件机制模块</span>
│   ├── CMakeLists.txt
│   ├── plugin.c
│   ├── pspec.c
│   └── pspec.h
├── runtime <span class="token comment"># 容器运行时模块</span>
│   ├── CMakeLists.txt
│   ├── engines <span class="token comment"># 基于lxc的轻量级runtime对接接口</span>
│   ├── isula <span class="token comment"># oci 标准runtime对接接口</span>
│   └── runtime.c
├── <span class="token function">service</span> <span class="token comment"># 服务模块，包含多个模块协同调用的实现</span>
│   ├── CMakeLists.txt
│   ├── io_handler.c
│   ├── service_container.c <span class="token comment"># 容器服务操作接口</span>
│   └── service_image.c  <span class="token comment"># 镜像服务操作接口</span>
└── spec  <span class="token comment"># oci规范配置模块，对外提供OCI spec合并、校验等功能接口</span>
    ├── CMakeLists.txt
    ├── specs.c
    ├── specs_extend.c
    ├── specs_extend.h
    ├── specs_mount.c
    ├── specs_mount.h
    ├── specs_namespace.c
    ├── specs_namespace.h
    ├── specs_security.c
    ├── specs_security.h
    ├── verify.c  <span class="token comment"># 配置校验功能接口</span>
    └── verify.h
</code></pre></div><h4 id="基础设施层"><a href="#基础设施层" class="header-anchor">#</a> 基础设施层</h4> <p>基础设施层位于 src/utils 目录下，本层作为其他层的支撑库。它提供各种工具函数供其他层次调用使用：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>├── buffer <span class="token comment"># buffer 工具函数</span>
│   ├── buffer.c
│   ├── buffer.h
│   └── CMakeLists.txt
├── CMakeLists.txt
├── console <span class="token comment"># IO 终端处理工具函数</span>
│   ├── CMakeLists.txt
│   ├── console.c
│   └── console.h
├── cpputils <span class="token comment"># C++ 使用到的工具函数，包含基础字符串处理、url、线程工具</span>
│   ├── CMakeLists.txt
│   ├── cxxutils.cc
│   ├── cxxutils.h
│   ├── stoppable_thread.cc
│   ├── stoppable_thread.h
│   ├── url.cc
│   └── url.h
├── cutils <span class="token comment"># C使用到的工具函数，包含基础字符串处理、数据类型转换、文件处理、正则表达式等工具函数</span>
│   ├── CMakeLists.txt
│   ├── util_atomic.c
│   ├── util_atomic.h
│   ├── utils_aes.c
│   ├── utils_aes.h
│   ├── utils_array.c
│   ├── utils_array.h
│   ├── utils_base64.c
│   ├── utils_base64.h
│   ├── utils.c
│	<span class="token punctuation">..</span><span class="token punctuation">..</span>
├── http <span class="token comment"># http 处理工具函数，包含http请求、解析、认证等工具</span>
│   ├── certificate.c
│   ├── certificate.h
│   ├── CMakeLists.txt
│   ├── http.c
│   ├── http.h
│   ├── mediatype.h
│   ├── parser.c
│   ├── parser.h
│   ├── rest_common.c
│   └── rest_common.h
├── sha256 <span class="token comment"># sha256 工具函数，用来计算sha256</span>
│   ├── CMakeLists.txt
│   ├── sha256.c
│   └── sha256.h
└── <span class="token function">tar</span> <span class="token comment"># 压缩、解压工具函数，用来压缩、解压文件</span>
    ├── CMakeLists.txt
    ├── isulad_tar.c
    ├── isulad_tar.h
    ├── util_archive.c
    ├── util_archive.h
    ├── util_gzip.c
    └── util_gzip.h
</code></pre></div><h3 id="调用流程"><a href="#调用流程" class="header-anchor">#</a> 调用流程</h3> <p>可以借助<strong>Structure101</strong> 代码分析工具，梳理出 iSulad 各个代码目录之前的调用依赖关系。</p> <img src="/assets/img/2020-09-14-isulad-architecture-02.1efe669e.jpg" alt="iSulad" style="zoom:100%;"> <p>首先，用户界面层（cmd）作为上层，仅会调用其他模块的接口，不会被其他模块所依赖。cmd 会调用 client 目录中的函数，与 daemon 端进行通信。由于 cmd 目录中存在 iSulad daemon 的命令行接口，因此会依赖 daemon 目录下的函数定义。</p> <p>daemon 目录作为服务端代码的顶层目录，其中包含接口层（entry）、应用层（executor）、领域层（modules）的代码。接口层作为调用 daemon 服务的入口，需要调用其他层中的函数进行业务调度处理，而不会被其他层次所依赖。应用层需要调用领域层（modules）中各个模块的接口来实现具体的业务。</p> <p>modules 目录作为 iSulad 的核心领域层代码，包含各个子功能模块的具体实现。以 image 模块为例，首先在 src/daemon/modules/api 中提供了 image_api.h，屏蔽了各种不同镜像格式的差异，对外提供统一的 image 操作函数接口。</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">int</span> <span class="token function">image_module_init</span><span class="token punctuation">(</span><span class="token keyword">const</span> isulad_daemon_configs <span class="token operator">*</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">image_module_exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">im_list_images</span><span class="token punctuation">(</span><span class="token keyword">const</span> im_list_request <span class="token operator">*</span>request<span class="token punctuation">,</span> im_list_response <span class="token operator">*</span><span class="token operator">*</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">im_rm_image</span><span class="token punctuation">(</span><span class="token keyword">const</span> im_rmi_request <span class="token operator">*</span>request<span class="token punctuation">,</span> im_remove_response <span class="token operator">*</span><span class="token operator">*</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">im_tag_image</span><span class="token punctuation">(</span><span class="token keyword">const</span> im_tag_request <span class="token operator">*</span>request<span class="token punctuation">,</span> im_tag_response <span class="token operator">*</span><span class="token operator">*</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">im_inspect_image</span><span class="token punctuation">(</span><span class="token keyword">const</span> im_inspect_request <span class="token operator">*</span>request<span class="token punctuation">,</span> im_inspect_response <span class="token operator">*</span><span class="token operator">*</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">im_import_image</span><span class="token punctuation">(</span><span class="token keyword">const</span> im_import_request <span class="token operator">*</span>request<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">im_load_image</span><span class="token punctuation">(</span><span class="token keyword">const</span> im_load_request <span class="token operator">*</span>request<span class="token punctuation">,</span> im_load_response <span class="token operator">*</span><span class="token operator">*</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">im_pull_image</span><span class="token punctuation">(</span><span class="token keyword">const</span> im_pull_request <span class="token operator">*</span>request<span class="token punctuation">,</span> im_pull_response <span class="token operator">*</span><span class="token operator">*</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">char</span> <span class="token operator">*</span><span class="token function">im_get_image_type</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>image<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>external_rootfs<span class="token punctuation">)</span><span class="token punctuation">;</span>

bool <span class="token function">im_config_image_exist</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>image_name<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">im_login</span><span class="token punctuation">(</span><span class="token keyword">const</span> im_login_request <span class="token operator">*</span>request<span class="token punctuation">,</span> im_login_response <span class="token operator">*</span><span class="token operator">*</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">im_logout</span><span class="token punctuation">(</span><span class="token keyword">const</span> im_logout_request <span class="token operator">*</span>request<span class="token punctuation">,</span> im_logout_response <span class="token operator">*</span><span class="token operator">*</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">im_container_export</span><span class="token punctuation">(</span><span class="token keyword">const</span> im_export_request <span class="token operator">*</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">free_im_export_request</span><span class="token punctuation">(</span>im_export_request <span class="token operator">*</span>ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><p>在镜像管理模块内部，对不同格式的镜像操作进行区分。</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">bim_type</span> g_bims<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">ENABLE_OCI_IMAGE</span></span>
    <span class="token punctuation">{</span>
        <span class="token punctuation">.</span>image_type <span class="token operator">=</span> IMAGE_TYPE_OCI<span class="token punctuation">,</span>
        <span class="token punctuation">.</span>ops <span class="token operator">=</span> <span class="token operator">&amp;</span>g_oci_ops<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
    <span class="token punctuation">{</span> <span class="token punctuation">.</span>image_type <span class="token operator">=</span> IMAGE_TYPE_EXTERNAL<span class="token punctuation">,</span> <span class="token punctuation">.</span>ops <span class="token operator">=</span> <span class="token operator">&amp;</span>g_ext_ops <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">ENABLE_EMBEDDED_IMAGE</span></span>
    <span class="token punctuation">{</span> <span class="token punctuation">.</span>image_type <span class="token operator">=</span> IMAGE_TYPE_EMBEDDED<span class="token punctuation">,</span> <span class="token punctuation">.</span>ops <span class="token operator">=</span> <span class="token operator">&amp;</span>g_embedded_ops <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>其他模块也都是类似的设计，具体深入到不同模块的详细解析，在后续的博客中会一一进行分析。</p></div></div> <div class="bottom-line" data-v-8dab3852></div> <div class="disclaimer" data-v-8dab3852>【版权声明】Copyright © 2021 openEuler Community。本文由openEuler社区首发，欢迎遵照 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/legalcode" data-v-8dab3852>CC-BY-SA 4.0</a> 协议规定转载。转载时敬请在正文注明并保留原文链接和作者信息。</div> <div class="disclaimer" data-v-8dab3852>
        【免责声明】本文仅代表作者本人观点，与本网站无关。本网站对文中陈述、观点判断保持中立，不对所包含内容的准确性、可靠性或完整性提供任何明示或暗示的保证。本文仅供读者参考，由此产生的所有法律责任均由读者本人承担。
    </div></div> <div class="footer-wrapper" data-v-0b78f953 data-v-34596062><div class="qr-code" data-v-0b78f953><img src="/img/common/newyear-qr.png" alt data-v-0b78f953> <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyJpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMy1jMDExIDY2LjE0NTY2MSwgMjAxMi8wMi8wNi0xNDo1NjoyNyAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNiAoV2luZG93cykiIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6MTBGRjQxMDc4MTFBMTFFNDg4RUU4NENEQTQxODZDMjciIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6MTBGRjQxMDg4MTFBMTFFNDg4RUU4NENEQTQxODZDMjciPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDoxMEZGNDEwNTgxMUExMUU0ODhFRTg0Q0RBNDE4NkMyNyIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDoxMEZGNDEwNjgxMUExMUU0ODhFRTg0Q0RBNDE4NkMyNyIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/PvJh/V0AAAJMSURBVHja5Je7L0RBFMatCEEiQYcCBYKo6IgQu0SnIhuFXUsUdBL/gEqt8dhVSNajUbJsSFBqiHeBSsUqiHeyvknOTcaYuffsI9nCSX7Z2bsz8317Z848XPF4PCuTkZ2V4cixCl6vl9umCDSBOlBMz57AJTgGz5xOwuHwbwOMaABDoBfUG+qcgU2wBM7TNQSlIAhOwaSNuGVykowsgpJUDXSDa+BPYniHqa0nWQMDYIvzLxzeXgT0J2qgHaykcbKvgjaugUJyne7YAQUcA/MgT/P8C2wzhESdb81z0eeck4EqsSRoGt+DTpqUQRvxINXpoDZqDIJKOwMTNvl9SOUACBnEA1Q+pDa6GDcZEOPTZ2jkpryWU0w2EZLELTNuQ19CI//PUoxoUV+PJq9d9Gl9L5fKshmfTT/VoBkcqAZqGRPMrwj2KL87ictaB+oQcBccP6VUrvRMlKNM8V9aGd+OZQMxZhtrgn1Kz0S5i3ZBTsR0Bi6Z4vJsjyirpt+Qompc6QwcgVubRouKeIh2Oo8iOuywWN2Q1h8Dr2DDZnkdsZntPkU0QBNVF0LjzTQJZw2NGkGrNAw+Q3ZYJtrocKKLWe2ZkEIMQVizH5SBPbDrcMAQJipo39Ad95bBndNuKF71h+EA62FMMI9B/B2McbbjV6ZQouGmvlknon06kqUr+qXdlH0mXKO9/TEF4Qf65+vJnopF+tU45LUpFqhtNNV7QYzyWtwHZuh+YIpTqiPqjtKNiXc1Y8QFmALThquZ+P0EvCTymlz//nb8I8AA0Ah5h1oiyB4AAAAASUVORK5CYII=" alt class="close" data-v-0b78f953></div> <div class="atom" data-v-0b78f953><p data-v-0b78f953>openEuler 是由开放原子开源基金会（OpenAtom Foundation）孵化及运营的开源项目</p> <img src="/atom-pc.png" alt class="atom-pc" data-v-0b78f953></div> <div class="footer-content" data-v-0b78f953><div class="footer-left" data-v-0b78f953><img src="/footer-logo2.svg" class="footer-logo" data-v-0b78f953> <div class="footer-mail" data-v-0b78f953>contact@openeuler.io</div></div> <div class="footer-center" data-v-0b78f953><ul class="right-list" data-v-0b78f953><li data-v-0b78f953><a data-v-0b78f953>品牌</a></li><li data-v-0b78f953><a data-v-0b78f953>隐私政策</a></li><li data-v-0b78f953><a data-v-0b78f953>法律声明</a></li><li data-v-0b78f953><a data-v-0b78f953>服务状态</a></li></ul> <p class="footer-copyright" data-v-0b78f953>
        版权所有 © 2022 openEuler 保留一切权利
      </p></div> <div class="footer-right" data-v-0b78f953><img src="/qrcode.png" class="footer-qrcode" data-v-0b78f953> <div class="qrcode-desc" data-v-0b78f953>扫码关注公众号</div></div></div></div></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.cdfb7ee7.js" defer></script><script src="/assets/js/14.8a38dea1.js" defer></script><script src="/assets/js/53.f8858a5b.js" defer></script>
  </body>
</html>
