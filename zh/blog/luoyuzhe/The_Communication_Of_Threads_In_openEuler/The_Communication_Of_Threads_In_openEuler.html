<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>openEuler中的排队读写锁</title>
    <meta name="generator" content="VuePress 1.5.4">
    <link rel="icon" href="/favicon.ico">
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
  <script src="/js/analytics.js"></script>
  <meta name="keywords" content="openEuler, 操作系统, 开放, 生态, 开源, Linux 开源, OS, open, ecosystem, open source, Linux open source">
  <meta name="baidu-site-verification" content="code-EWzbQRssNU">
    <meta name="description" content="openEuler 是一个开源、免费的 Linux 发行版平台，将通过开放的社区形式与全球的开发者共同构建一个开放、多元和架构包容的软件生态体系。同时，openEuler 也是一个创新的平台，鼓励任何人在该平台上提出新想法、开拓新思路、实践新方案。">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    <meta name="keywords" content="openEuler, 操作系统, 开放, 生态, 开源, Linux 开源, OS, open, ecosystem, open source, Linux open source">
    <meta name="baidu-site-verification" content="code-EWzbQRssNU">
    <link rel="preload" href="/assets/css/0.styles.0df284ed.css" as="style"><link rel="preload" href="/assets/js/app.cdfb7ee7.js" as="script"><link rel="preload" href="/assets/js/14.8a38dea1.js" as="script"><link rel="preload" href="/assets/js/43.be046fb2.js" as="script">
    <link rel="stylesheet" href="/assets/css/0.styles.0df284ed.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div id="euler-app" data-v-34596062><div class="nav-fill " data-v-fe04bb58 data-v-34596062><div class="nav-wrapper" data-v-fe04bb58><div class="nav-bar" data-v-fe04bb58><img src="/openeuler-logo.png" alt class="nav-logo" data-v-fe04bb58> <img src="/openeuler-logo.png" alt class="nav-logo nav-logo-mobile" data-v-fe04bb58> <ul class="nav-menu" data-v-fe04bb58><li data-v-fe04bb58><a class="menu-link" data-v-fe04bb58>下载
                        <span data-v-fe04bb58></span></a> <div class="sub-menu" data-v-fe04bb58><ul class="sig-menu-content" data-v-fe04bb58><li data-v-fe04bb58>
                                ISO
                            </li><li data-v-fe04bb58>
                                镜像仓列表
                            </li></ul> <span class="submenu-arrow" data-v-fe04bb58></span></div></li><li data-v-fe04bb58><a class="menu-link" data-v-fe04bb58>学习
                        <span data-v-fe04bb58></span></a> <div class="sub-menu" data-v-fe04bb58><ul class="sig-menu-content" data-v-fe04bb58><li data-v-fe04bb58>
                                文档
                            </li><li data-v-fe04bb58>
                                慕课
                            </li><li data-v-fe04bb58>
                                实习
                            </li></ul> <span class="submenu-arrow" data-v-fe04bb58></span></div></li><li data-v-fe04bb58><a class="menu-link menu-active" data-v-fe04bb58>互动
                        <span data-v-fe04bb58></span></a> <div class="sub-menu" data-v-fe04bb58><ul class="sig-menu-content" data-v-fe04bb58><li data-v-fe04bb58>
                                新闻
                            </li><li data-v-fe04bb58>
                                博客
                            </li><li data-v-fe04bb58>
                                直播
                            </li><li data-v-fe04bb58>
                                沙龙
                            </li><li data-v-fe04bb58>
                                峰会
                            </li></ul> <span class="submenu-arrow" data-v-fe04bb58></span></div></li><li data-v-fe04bb58><a class="menu-link" data-v-fe04bb58>社区
                        <span data-v-fe04bb58></span></a> <div class="sub-menu" data-v-fe04bb58><ul class="sig-menu-content" data-v-fe04bb58><li data-v-fe04bb58>
                                贡献攻略
                            </li><li data-v-fe04bb58>
                                行为守则
                            </li><li data-v-fe04bb58>
                                邮件列表
                            </li><li data-v-fe04bb58>
                                个人认证
                            </li></ul> <span class="submenu-arrow" data-v-fe04bb58></span></div></li><li data-v-fe04bb58><a class="menu-link" data-v-fe04bb58>SIG
                        <span data-v-fe04bb58></span></a> <div class="sub-menu" data-v-fe04bb58><ul class="sig-menu-content" data-v-fe04bb58><li data-v-fe04bb58>
                                查看SIG
                            </li><li data-v-fe04bb58>
                                申请流程
                            </li><li data-v-fe04bb58>
                                角色说明
                            </li></ul> <span class="submenu-arrow" data-v-fe04bb58></span></div></li><li data-v-fe04bb58><a class="menu-link" data-v-fe04bb58>探索
                        <span data-v-fe04bb58></span></a> <div class="sub-menu" data-v-fe04bb58><ul class="sig-menu-content" data-v-fe04bb58><li data-v-fe04bb58>
                                A-Tune
                            </li><li data-v-fe04bb58>
                                Bisheng JDK
                            </li><li data-v-fe04bb58>
                                iSula
                            </li><li data-v-fe04bb58>
                                secGear
                            </li><li data-v-fe04bb58>
                                StratoVirt
                            </li><li data-v-fe04bb58>
                                Compass-CI
                            </li><li data-v-fe04bb58>
                                Compliance
                            </li><li data-v-fe04bb58>
                                Pkgship
                            </li></ul> <span class="submenu-arrow" data-v-fe04bb58></span></div></li><li data-v-fe04bb58><a class="menu-link" data-v-fe04bb58>支持
                        <span data-v-fe04bb58></span></a> <div class="sub-menu" data-v-fe04bb58><ul class="sig-menu-content" data-v-fe04bb58><li data-v-fe04bb58>
                                漏洞管理
                            </li><li data-v-fe04bb58>
                                安全公告
                            </li><li data-v-fe04bb58>
                                CVE
                            </li><li data-v-fe04bb58>
                                兼容性列表
                            </li><li data-v-fe04bb58>
                                迁移指南
                            </li></ul> <span class="submenu-arrow" data-v-fe04bb58></span></div></li></ul> <ul class="nav-menu-mobile" style="display:none;" data-v-fe04bb58 data-v-fe04bb58><li data-v-fe04bb58><a class="menu-link" data-v-fe04bb58>下载<i class="icon-arrow" data-v-fe04bb58></i></a> <ul class="sub-menu" style="display:none;" data-v-fe04bb58 data-v-fe04bb58><li data-v-fe04bb58>
                                    ISO
                                </li><li data-v-fe04bb58>
                                    镜像仓列表
                                </li></ul></li><li data-v-fe04bb58><a class="menu-link" data-v-fe04bb58>学习<i class="icon-arrow" data-v-fe04bb58></i></a> <ul class="sub-menu" style="display:none;" data-v-fe04bb58 data-v-fe04bb58><li data-v-fe04bb58>
                                    文档
                                </li><li data-v-fe04bb58>
                                    慕课
                                </li><li data-v-fe04bb58>
                                    实习
                                </li></ul></li><li data-v-fe04bb58><a class="menu-link" data-v-fe04bb58>互动<i class="icon-arrow arrow-active" data-v-fe04bb58></i></a> <ul class="sub-menu" data-v-fe04bb58 data-v-fe04bb58><li data-v-fe04bb58>
                                    新闻
                                </li><li data-v-fe04bb58>
                                    博客
                                </li><li data-v-fe04bb58>
                                    直播
                                </li><li data-v-fe04bb58>
                                    沙龙
                                </li><li data-v-fe04bb58>
                                    峰会
                                </li></ul></li><li data-v-fe04bb58><a class="menu-link" data-v-fe04bb58>社区<i class="icon-arrow" data-v-fe04bb58></i></a> <ul class="sub-menu" style="display:none;" data-v-fe04bb58 data-v-fe04bb58><li data-v-fe04bb58>
                                    贡献攻略
                                </li><li data-v-fe04bb58>
                                    行为守则
                                </li><li data-v-fe04bb58>
                                    邮件列表
                                </li><li data-v-fe04bb58>
                                    个人认证
                                </li></ul></li><li data-v-fe04bb58><a class="menu-link" data-v-fe04bb58>SIG<i class="icon-arrow" data-v-fe04bb58></i></a> <ul class="sub-menu" style="display:none;" data-v-fe04bb58 data-v-fe04bb58><li data-v-fe04bb58>
                                    查看SIG
                                </li><li data-v-fe04bb58>
                                    申请流程
                                </li><li data-v-fe04bb58>
                                    角色说明
                                </li></ul></li><li data-v-fe04bb58><a class="menu-link" data-v-fe04bb58>探索<i class="icon-arrow" data-v-fe04bb58></i></a> <ul class="sub-menu" style="display:none;" data-v-fe04bb58 data-v-fe04bb58><li data-v-fe04bb58>
                                    A-Tune
                                </li><li data-v-fe04bb58>
                                    Bisheng JDK
                                </li><li data-v-fe04bb58>
                                    iSula
                                </li><li data-v-fe04bb58>
                                    secGear
                                </li><li data-v-fe04bb58>
                                    StratoVirt
                                </li><li data-v-fe04bb58>
                                    Compass-CI
                                </li><li data-v-fe04bb58>
                                    Compliance
                                </li><li data-v-fe04bb58>
                                    Pkgship
                                </li></ul></li><li data-v-fe04bb58><a class="menu-link" data-v-fe04bb58>支持<i class="icon-arrow" data-v-fe04bb58></i></a> <ul class="sub-menu" style="display:none;" data-v-fe04bb58 data-v-fe04bb58><li data-v-fe04bb58>
                                    漏洞管理
                                </li><li data-v-fe04bb58>
                                    安全公告
                                </li><li data-v-fe04bb58>
                                    CVE
                                </li><li data-v-fe04bb58>
                                    兼容性列表
                                </li><li data-v-fe04bb58>
                                    迁移指南
                                </li></ul></li> <li data-v-fe04bb58><a class="menu-link" data-v-fe04bb58>源码<i class="icon-arrow" data-v-fe04bb58></i></a> <ul class="sub-menu" style="display:none;" data-v-fe04bb58 data-v-fe04bb58><li data-v-fe04bb58>
                                    代码仓
                                </li><li data-v-fe04bb58>
                                    软件包仓
                                </li><li data-v-fe04bb58>
                                    GitHub镜像仓
                                </li></ul></li></ul> <div data-v-fe04bb58></div> <div class="search-mobile" data-v-fe04bb58><div class="el-input el-input--suffix" data-v-fe04bb58><!----><input type="text" autocomplete="off" placeholder="输入内容" class="el-input__inner"><!----><span class="el-input__suffix"><span class="el-input__suffix-inner"><i class="icon-search el-input__icon" data-v-fe04bb58></i><!----><!----><!----><!----></span><!----></span><!----><!----></div></div> <ul class="nav-other" style="display:;" data-v-fe04bb58><li class="lang" data-v-fe04bb58><span class="icon-lang" data-v-fe04bb58></span> <ul data-v-fe04bb58><li class="lang-list" data-v-fe04bb58>
                            中文
                        </li><li data-v-fe04bb58>
                            English
                        </li><li data-v-fe04bb58>
                            Русский
                        </li> <span class="submenu-arrow" data-v-fe04bb58></span></ul></li> <li data-v-fe04bb58><span data-v-fe04bb58>代码</span> <ul data-v-fe04bb58><li data-v-fe04bb58>
                            代码仓
                        </li><li data-v-fe04bb58>
                            软件包仓
                        </li><li data-v-fe04bb58>
                            GitHub镜像仓
                        </li> <span class="submenu-arrow" data-v-fe04bb58></span></ul></li> <li class="search" data-v-fe04bb58><img src="/search.png" alt data-v-fe04bb58></li></ul> <div class="search-input" style="display:none;" data-v-fe04bb58><div class="el-input el-input--small el-input--suffix" data-v-fe04bb58><!----><input type="text" autocomplete="off" placeholder="输入内容" class="el-input__inner"><!----><span class="el-input__suffix"><span class="el-input__suffix-inner"><i class="icon-search el-input__icon" data-v-fe04bb58></i><!----><!----><!----><!----></span><!----></span><!----><!----></div></div> <ul class="nav-other-mobile nav-other" data-v-fe04bb58><li class="lang" data-v-fe04bb58><span class="icon-lang" data-v-fe04bb58></span> <ul data-v-fe04bb58><li class="lang-list" data-v-fe04bb58>
                            中文
                        </li><li data-v-fe04bb58>
                            English
                        </li><li data-v-fe04bb58>
                            Русский
                        </li> <span class="submenu-arrow" data-v-fe04bb58></span></ul></li> <li class="search" data-v-fe04bb58><span class="icon-search" data-v-fe04bb58></span></li> <li class="menu" data-v-fe04bb58><span class="icon-menu" data-v-fe04bb58></span></li></ul></div></div> <!----></div> <!----> <div id="vuepress-theme-blog__post-layout" class="content" data-v-8dab3852 data-v-34596062><div class="blog-link-post" data-v-8dab3852>
        博客\
    </div> <div class="post-left" data-v-8dab3852><p class="blog-img mobile-hide" data-v-8dab3852><img src="/img/blog/blog_user.png" alt class="middle-img" data-v-8dab3852></p> <p class="mobile-hide" data-v-8dab3852><img src="/img/blog/account.svg" alt class="mobile-middle-img" data-v-8dab3852> <span class="blog-author" data-v-8dab3852>luoyuzhe</span></p> <p class="mobile-hide" data-v-8dab3852><img src="/img/blog/date.svg" alt class="mobile-middle-img" data-v-8dab3852> <span class="blog-date mobile" data-v-8dab3852>2021-01-05</span></p> <p class="mobile-hide" data-v-8dab3852><img src="/img/blog/visibility.svg" alt class="mobile-middle-img" data-v-8dab3852> <span class="blog-date" data-v-8dab3852><span data-v-8dab3852><span data-v-8dab3852>浏览</span> <span data-v-8dab3852></span> <span data-v-8dab3852>次</span></span></span></p> <p class="bottom-line bottom-line-none" data-v-8dab3852></p> <!----> <p class="other-blog-item" data-v-8dab3852></p></div> <div class="post-right" data-v-8dab3852><p class="blog-title" data-v-8dab3852>openEuler中的排队读写锁</p> <div class="user-info-mobile" data-v-8dab3852><div class="left" data-v-8dab3852><img src="/img/blog/blog_user.png" alt data-v-8dab3852></div> <div class="right" data-v-8dab3852><p class="name" data-v-8dab3852>luoyuzhe</p> <p class="date-count" data-v-8dab3852><span class="date" data-v-8dab3852>2021-01-05</span> <span class="count" data-v-8dab3852>浏览次</span></p></div></div> <p class="blog-item-tag" data-v-8dab3852><span data-v-8dab3852>标签: </span> <span data-v-8dab3852><span class="tag-item" data-v-8dab3852>kernel</span> <span data-v-8dab3852>, </span></span><span data-v-8dab3852><span class="tag-item" data-v-8dab3852>排队读写锁</span> <!----></span></p> <p class="bottom-line bottom-line-none" data-v-8dab3852></p> <div id="blog_content" class="markdown content__default" data-v-8dab3852><h1 id="openeuler中的排队读写锁"><a href="#openeuler中的排队读写锁" class="header-anchor">#</a> openEuler中的排队读写锁</h1> <p>同一个线程组中的线程共享了数据结构mm_struct和vm_area_struct，从而实现对内存的共享。然而，当两个线程同时需要访问同一块被共享的内存时，会出现竞争，也就是说两个线程访问该内存的顺序可能不确定，从而导致程序的输出结果不确定。为了保证线程访问共享变量的顺序是程序员期望的，我们需要线程间通信的机制，常用的线程间通信机制有锁和信号量。锁和信号量机制可以用于保证同一时间只有一个线程进入访问某一共有资源的程序片段，这样的程序片段被称为临界区。openEuler中的锁有自旋锁和互斥锁。本期我们介绍自旋锁，包含排队自旋锁和排队读写锁。</p> <p>自旋锁用于保护较短的临界区，在临界区内不允许睡眠。自旋锁的定义代码在include/linux/spinlock_types.h文件中可以找到：</p> <p><img src="/assets/img/1.635b2d98.png" alt="1604842309144"></p> <p>这段代码封装了另一个结构体raw_spinlock,其定义代码在同一个文件中可以找到：</p> <img src="/assets/img/2.c25ee406.png" alt="1604842650827" style="zoom:200%;"> <p>arch_spinlock_t这个类型对于单处理器和SMP情形的定义是不同的，对于单处理器类型它的定义在spinlock_types_up.h这个文件中，而对于SMP情形则在spinlock_types.h文件中：</p> <img src="/assets/img/3.31eb82db.png" alt="1604843071888" style="zoom:200%;"> <p>对于单处理器情形，arch_spinlock_t类型被定义为空：</p> <p><img src="data:image/png;base64,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" alt="1605016728313"></p> <p>对于SMP的情形，我们在arch/arm64/include/asm/spinlock_types.h文件中可以看到其定义包含在两个文件中：</p> <img src="data:image/png;base64,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" alt="1604843758966" style="zoom:200%;"> <p>在qspinlock_types.h文件中我们可以找到arch_spinlock_t的定义：</p> <div class="language- extra-class"><pre class="language-text"><code>typedef struct qspinlock {
        union {
                atomic_t val;

                /*
                 * By using the whole 2nd least significant byte for the
                 * pending bit, we can allow better optimization of the lock
                 * acquisition for the pending bit holder.
                 */

#ifdef __LITTLE_ENDIAN
                struct {
                        u8      locked;
                        u8      pending;
                };
                struct {
                        u16     locked_pending;
                        u16     tail;
                };
#else
                struct {
                        u16     tail;
                        u16     locked_pending;
                };
                struct {
                        u8      reserved[2];
                        u8      pending;
                        u8      locked;

                };

#endif
        };
} arch_spinlock_t;
</code></pre></div><p>其中locked位表示锁的状态，该位为1表示锁不可获取，为0则表示锁可以获取；pending是未决位，该位为1时表示至少有一个线程在等待锁，该位为0时表示要么锁被持有但没有争用，要么等待队列已经存在[2]。</p> <p>这两个文件中分为定义了排队自旋锁和排队读写锁，读写锁是自旋锁的改进，自旋锁在同一时刻只允许一个线程进入临界区，而读写锁则允许多个读者并发地访问临界区，但只允许一个写者在同一时刻访问临界区（也就是说写者和写者、读者和写者之间是互斥的，但读者和读者之间可以并发）。排队指的是使用队列算法来管理多个希望持有锁的线程，在openEuler中使用的是FIFO算法来管理排队等待的线程。排队自旋锁在参考文献[2]中已有详细介绍，本文主要介绍排队读写锁。</p> <p>排队读写锁的定义代码在include/asm-generic/qrwlock_types.h 文件中可以找到：</p> <p><img src="/assets/img/6.7329e8eb.png" alt="1604844850419"></p> <p>其中cnts原子变量的低9位用来标识该队列读写锁是否有写者持有，将该变量右移九位则表示持有该队列读写锁的读者数量。同时，我们可以看到该读写锁中还定义了一个排队自旋锁wait_lock。为了更好地理解这段代码，我们首先来了解一下openEuler中的原子变量和其操作。原子变量可以用来实现对整数变量的互斥访问，对原子变量的原子操作是不可分割的。原子变量用atomic_t类型标识，对原子变量常用的操作有[1]：</p> <ul><li>atomic_read(v):读取原子变量的值；</li> <li>atomic_add_return(i,v):把原子变量v的值加上i并返回新值；</li> <li>atomic_sub_return(i,v):把原子变量v的值减去i,并且返回新值；</li> <li>atomic_cmpxchg(v,old,new):如果原子变量v的值等于old，那么将v的值设置为new，并返回旧值；</li></ul> <p>在openEuler中，include/linux/atomic.h文件中定义了一系列原子操作，如atomic_add_return_aquire:</p> <p><img src="/assets/img/7.67636c75.png" alt="1605003305448"></p> <p>atomic_cmpxchg_aquire:</p> <p><img src="/assets/img/8.f6822b12.png" alt="1605003249589"></p> <p>使用这些原子操作，可以对队列读写锁中的cnts变量进行操作，例如在include/asm-generic/qrwlock.h 文件中的queued_read_trylock（）函数中，首先使用atomic_read（）函数读出原子变量cnts的值，如果没有写者持有该锁，则增加持有该锁的读者数量并返回1，否则维持读者数量不变并返回0：</p> <p><img src="/assets/img/9.3b1baaff.png" alt="1605004268622"></p> <p>其中有关的定义值的定义如下：</p> <p><img src="/assets/img/10.b2477bf2.png" alt="1605004339762"></p> <p>因此cnts &amp; QW_WMASK用来检查是否有写者占有锁，而使用_QR_BIAS对cnts进行原子加则可以用cnts的高位对读者数量进行计数。再考察一下queued_write_trylock()函数：</p> <p><img src="/assets/img/11.398001c2.png" alt="1605011384999"></p> <p>该函数通过判断cnts变量是否为0来判断是否有读者或写者已经占有该读写锁，如果已经占有，则抢锁失败；如果锁没有被读者或写者占有，则将cnts的低八位置为0xff,表示锁已经被写者持有。</p> <p>再来看看queued_read_lock()函数，该函数在确认没有写者占有希望抢占的锁时调用queued__read_lock_slow_path()函数：</p> <p><img src="/assets/img/12.6dfd11f8.png" alt="1605011841027"></p> <p>该函数的代码在./kernel/locking/qrwlock.c文件中可以找到：</p> <div class="language- extra-class"><pre class="language-text"><code>/**

 * queued_read_lock_slowpath - acquire read lock of a queue rwlock

 * @lock: Pointer to queue rwlock structure
 */
   void queued_read_lock_slowpath(struct qrwlock *lock)
   {
       /*
        * Readers come here when they cannot get the lock without waiting
        */
       if (unlikely(in_interrupt())) {
               /*
                * Readers in interrupt context will get the lock immediately
                * if the writer is just waiting (not holding the lock yet),
                * so spin with ACQUIRE semantics until the lock is available
                * without waiting in the queue.
                */
               atomic_cond_read_acquire(&amp;lock-&gt;cnts, !(VAL &amp; _QW_LOCKED));
               return;
       }
       atomic_sub(_QR_BIAS, &amp;lock-&gt;cnts);

       /*
        * Put the reader into the wait queue
        */
               arch_spin_lock(&amp;lock-&gt;wait_lock);
               atomic_add(_QR_BIAS, &amp;lock-&gt;cnts);
       
               /*
                * The ACQUIRE semantics of the following spinning code ensure
                * that accesses can't leak upwards out of our subsequent critical
                * section in the case that the lock is currently held for write.
                */
               atomic_cond_read_acquire(&amp;lock-&gt;cnts, !(VAL &amp; _QW_LOCKED));
       
               /*
                * Signal the next one in queue to become queue head
                */
               arch_spin_unlock(&amp;lock-&gt;wait_lock);
       }
       EXPORT_SYMBOL(queued_read_lock_slowpath);


</code></pre></div><p>atomic_cond_read_acquire(&amp;lock-&gt;cnts, !(VAL &amp; _QW_LOCKED))的含义是等待写者释放锁，如果有写者持有锁就一直等待。arch_spin_lock（）通过排队自旋锁的机制将读者放入队列中，arch_spin_unlock（）函数则将队列中的下一个读者放到队列头。在排队自旋锁的机制中队列机制中，如果锁处于可获取的状态，则线程直接获取锁；如果锁已经被其它线程持有了，但没有其它线程等待，那么线程以自旋的方式不断尝试获取锁；如果有更多的线程等待，那么线程组成队列，队列头的线程自旋并不断尝试获取锁，其余线程休眠[2]。有关这一部分的内容可以查看参考文献[2]第6章或参考文献[3]。写者获取锁的排队机制也是类似的，区别在于读者获取锁只需要等待写者释放，而写者获取锁需要等待其他读者和写者都释放。</p> <hr> <h3 id="参考文献"><a href="#参考文献" class="header-anchor">#</a> 参考文献</h3> <p>[1]《Linux内核深度解析》，余华兵著，2019</p> <p>[2]《openEuler操作系统》，任炬、张尧学、彭许红编著，2020</p> <p>[3]https://zhuanlan.zhihu.com/p/100546935</p></div></div> <div class="bottom-line" data-v-8dab3852></div> <div class="disclaimer" data-v-8dab3852>【版权声明】Copyright © 2021 openEuler Community。本文由openEuler社区首发，欢迎遵照 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/legalcode" data-v-8dab3852>CC-BY-SA 4.0</a> 协议规定转载。转载时敬请在正文注明并保留原文链接和作者信息。</div> <div class="disclaimer" data-v-8dab3852>
        【免责声明】本文仅代表作者本人观点，与本网站无关。本网站对文中陈述、观点判断保持中立，不对所包含内容的准确性、可靠性或完整性提供任何明示或暗示的保证。本文仅供读者参考，由此产生的所有法律责任均由读者本人承担。
    </div></div> <div class="footer-wrapper" data-v-0b78f953 data-v-34596062><div class="qr-code" data-v-0b78f953><img src="/img/common/newyear-qr.png" alt data-v-0b78f953> <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyJpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMy1jMDExIDY2LjE0NTY2MSwgMjAxMi8wMi8wNi0xNDo1NjoyNyAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNiAoV2luZG93cykiIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6MTBGRjQxMDc4MTFBMTFFNDg4RUU4NENEQTQxODZDMjciIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6MTBGRjQxMDg4MTFBMTFFNDg4RUU4NENEQTQxODZDMjciPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDoxMEZGNDEwNTgxMUExMUU0ODhFRTg0Q0RBNDE4NkMyNyIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDoxMEZGNDEwNjgxMUExMUU0ODhFRTg0Q0RBNDE4NkMyNyIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/PvJh/V0AAAJMSURBVHja5Je7L0RBFMatCEEiQYcCBYKo6IgQu0SnIhuFXUsUdBL/gEqt8dhVSNajUbJsSFBqiHeBSsUqiHeyvknOTcaYuffsI9nCSX7Z2bsz8317Z848XPF4PCuTkZ2V4cixCl6vl9umCDSBOlBMz57AJTgGz5xOwuHwbwOMaABDoBfUG+qcgU2wBM7TNQSlIAhOwaSNuGVykowsgpJUDXSDa+BPYniHqa0nWQMDYIvzLxzeXgT0J2qgHaykcbKvgjaugUJyne7YAQUcA/MgT/P8C2wzhESdb81z0eeck4EqsSRoGt+DTpqUQRvxINXpoDZqDIJKOwMTNvl9SOUACBnEA1Q+pDa6GDcZEOPTZ2jkpryWU0w2EZLELTNuQ19CI//PUoxoUV+PJq9d9Gl9L5fKshmfTT/VoBkcqAZqGRPMrwj2KL87ictaB+oQcBccP6VUrvRMlKNM8V9aGd+OZQMxZhtrgn1Kz0S5i3ZBTsR0Bi6Z4vJsjyirpt+Qompc6QwcgVubRouKeIh2Oo8iOuywWN2Q1h8Dr2DDZnkdsZntPkU0QBNVF0LjzTQJZw2NGkGrNAw+Q3ZYJtrocKKLWe2ZkEIMQVizH5SBPbDrcMAQJipo39Ad95bBndNuKF71h+EA62FMMI9B/B2McbbjV6ZQouGmvlknon06kqUr+qXdlH0mXKO9/TEF4Qf65+vJnopF+tU45LUpFqhtNNV7QYzyWtwHZuh+YIpTqiPqjtKNiXc1Y8QFmALThquZ+P0EvCTymlz//nb8I8AA0Ah5h1oiyB4AAAAASUVORK5CYII=" alt class="close" data-v-0b78f953></div> <div class="atom" data-v-0b78f953><p data-v-0b78f953>openEuler 是由开放原子开源基金会（OpenAtom Foundation）孵化及运营的开源项目</p> <img src="/atom-pc.png" alt class="atom-pc" data-v-0b78f953></div> <div class="footer-content" data-v-0b78f953><div class="footer-left" data-v-0b78f953><img src="/footer-logo2.svg" class="footer-logo" data-v-0b78f953> <div class="footer-mail" data-v-0b78f953>contact@openeuler.io</div></div> <div class="footer-center" data-v-0b78f953><ul class="right-list" data-v-0b78f953><li data-v-0b78f953><a data-v-0b78f953>品牌</a></li><li data-v-0b78f953><a data-v-0b78f953>隐私政策</a></li><li data-v-0b78f953><a data-v-0b78f953>法律声明</a></li><li data-v-0b78f953><a data-v-0b78f953>服务状态</a></li></ul> <p class="footer-copyright" data-v-0b78f953>
        版权所有 © 2022 openEuler 保留一切权利
      </p></div> <div class="footer-right" data-v-0b78f953><img src="/qrcode.png" class="footer-qrcode" data-v-0b78f953> <div class="qrcode-desc" data-v-0b78f953>扫码关注公众号</div></div></div></div></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.cdfb7ee7.js" defer></script><script src="/assets/js/14.8a38dea1.js" defer></script><script src="/assets/js/43.be046fb2.js" defer></script>
  </body>
</html>
